using System;
using System.Web;
using System.Collections;
using System.Web.Services;
using System.Web.Services.Protocols;
using CrystalDecisions.CrystalReports.Engine;
using CrystalDecisions.Shared;
using System.Configuration;
using System.Diagnostics;
using System.Data;
using System.IO;
using System.Resources;
using System.Globalization;
using VLF.CLS.Interfaces;
using VLF.ERRSecurity;
using VLF.CLS;
using VLF.CLS.Def;
using VLF.Reports;
using VLF.DAS.Logic;
using System.Collections.Generic;
using System.Text;
using System.Threading;
using Syncfusion.XlsIO;
using Syncfusion.Pdf;
//using Syncfusion.DocIO;
//using Syncfusion.DocIO.DLS;
using ionic.utils.zip;


using System.Data.SqlClient;


namespace VLF.ASI.Interfaces
{
    [WebService(Namespace = "http://www.sentinelfm.com")]

    public class CrystalRpt : System.Web.Services.WebService
    {
        private string ReportsRootPath;
        private string ReportsOutputPath;
        private string ReportsDataSetPath;
        private double UnitOfMes = 0.6214;
        private double VolumeUnit = 0.26;
        private int DayLightSaving = 0;
        private int UserTimeZone = 0;
        // Changes for TimeZone Feature start
        private float UserNewFloatTimeZone = 0;
        // Changes for TimeZone Feature end
        
        //private string strPath = "";
        private bool RequestOverflowed = false;
        private string Msg = "";
        private string MethodName = "";

        public CrystalRpt()
        {
            //Uncomment the following line if using designed components 
            //InitializeComponent();
            this.ReportsRootPath = @ConfigurationManager.AppSettings["ReportsRootPath"];
            this.ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
            this.ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];
        }

        //private void InitializeComponent()
        //{
        //}

        # region Web Methods

        /*
         This is the generic version of report calls
         */

        //[WebMethod]
        //public int GenerateReport(string reportName, ReportParam param, ref bool requestOverflowed, ref bool outMaxOverflowed, ref string ReportPath)
        //{
        //    ReportGeneratorInterface generator =  ReportGeneratorFactory.GetGeneratorByReportName(reportName);
        //    generator.Parameter = param;
        //    int retCode = generator.Generate();
        //    ReportPath = generator.ReportFilePath;
        //    return retCode;
        //}


        [WebMethod]
        public int TripDetailsReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref string ReportPath)
        {
            string Msg = "";
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                Log("-->TripDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);


                GetUserPreferences(UserID);

                DataSet dsCrystal = GetTripDetails(UserID, xmlParams, lang, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal) || dsCrystal.Tables["rpt_TripReportData"] == null || dsCrystal.Tables["rpt_TripReportData"].Rows.Count==0)
                {

                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("TripDetailsReport: Update Report Status Exception-->" + Ex.Message.ToString());
                        }
                    }


                    ReportPath = "";

                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                string prm8 = Util.PairFindValue(ReportTemplate.RpDetailedTripEighthParamName, xmlParams); //Include Report Summary

                string sRpt = "";

                if (!lang.ToLower().Contains("fr"))
                {
                    if (Convert.ToBoolean(prm8))
                        sRpt = "rpt_TripReportData.rpt";
                    else
                        sRpt = "rpt_TripReportData_NoSummary.rpt";
                }
                else
                {
                    sRpt = "rpt_TripReportData_fr.rpt";
                }


                oRpt.Load(this.GetReportPath(sRpt));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripReportData)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                Resources.Const.Culture = new CultureInfo(lang);

                if (Convert.ToBoolean(prm8))
                {
                    string TripSummary = "";
                    string TripStart = "";
                    string TripEnd = "";

                    string Sensor = Util.PairFindValue(ReportTemplate.RpDetailedTripTenthParamName, xmlParams);

                    switch (Sensor)
                    {
                        case "3":
                            TripSummary = Resources.Const.TripSummary;
                            TripStart = Resources.Const.TripStart;
                            TripEnd = Resources.Const.TripEnd;
                            break;
                        case "8":
                            TripSummary = Resources.Const.TripSummaryPTO;
                            TripStart = Resources.Const.TripStartPTO;
                            TripEnd = Resources.Const.TripEndPTO;
                            break;
                        case "11":
                            TripSummary = Resources.Const.TripSummaryTP;
                            TripStart = Resources.Const.TripStartTP;
                            TripEnd = Resources.Const.TripEndTP;
                            break;
                        default:
                            TripSummary = Resources.Const.TripSummary;
                            TripStart = Resources.Const.TripStart;
                            TripEnd = Resources.Const.TripEnd;
                            break;
                    }

                    crParameterDiscreteValue.Value = TripSummary;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripSummary"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                    crParameterDiscreteValue.Value = TripStart;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripStart"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = TripEnd;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripEnd"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                }

                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptTripData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);

                        if (Convert.ToBoolean(prm8))
                            ReportName = "rpt_TripReportData" + "/" + ReportName;
                        else
                            ReportName = "rpt_TripReportData_NoSummary" + "/" + ReportName;

                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--TripDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptTripData", fileExt);
                
                Log("TripDetailsReport: begin to render report");

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TripDetail");
                }

                Log("TripDetailsReport: update report status.");

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("TripDetailsReport: update report status exception --> " + Ex.StackTrace.ToString());
                    }
                }


                ReportPath = this.GetReportURL(ReportName);

                Log("<--TripDetailsReport: render report successfully");

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                Log("TripDetailReport: render report failed for exception -->" + Ex.Message.ToString());

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Details report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("TripDetailReport: failed to update status for exception -->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int TripDetailsReportDriver(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref string ReportPath)
        {
            string Msg = "";
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                Log("-->TripDetailsReportDriver( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )",
                            UserID, FromDate, ToDate, xmlParams);


                GetUserPreferences(UserID);

                DataSet dsCrystal = GetTripDetails(UserID, xmlParams, lang, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal) || dsCrystal.Tables["rpt_TripReportData"] == null || dsCrystal.Tables["rpt_TripReportData"].Rows.Count == 0)
                {

                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }


                    ReportPath = "";

                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                string prm8 = Util.PairFindValue(ReportTemplate.RpDetailedTripEighthParamName, xmlParams); //Include Report Summary

                string sRpt = "";
                if (Convert.ToBoolean(prm8))
                    sRpt = "rpt_TripReportDataDriver.rpt";
                else
                    sRpt = "rpt_TripReportData_NoSummary.rpt";

                oRpt.Load(this.GetReportPath(sRpt));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripReportData)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                Resources.Const.Culture = new CultureInfo(lang);



                if (Convert.ToBoolean(prm8))
                {
                    string TripSummary = "";
                    string TripStart = "";
                    string TripEnd = "";

                    string Sensor = Util.PairFindValue(ReportTemplate.RpDetailedTripTenthParamName, xmlParams);

                    switch (Sensor)
                    {
                        case "3":
                            TripSummary = Resources.Const.TripSummary;
                            TripStart = Resources.Const.TripStart;
                            TripEnd = Resources.Const.TripEnd;
                            break;
                        case "8":
                            TripSummary = Resources.Const.TripSummaryPTO;
                            TripStart = Resources.Const.TripStartPTO;
                            TripEnd = Resources.Const.TripEndPTO;
                            break;
                        case "11":
                            TripSummary = Resources.Const.TripSummaryTP;
                            TripStart = Resources.Const.TripStartTP;
                            TripEnd = Resources.Const.TripEndTP;
                            break;
                        default:
                            TripSummary = Resources.Const.TripSummary;
                            TripStart = Resources.Const.TripStart;
                            TripEnd = Resources.Const.TripEnd;
                            break;
                    }


                    crParameterDiscreteValue.Value = TripSummary;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripSummary"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                    crParameterDiscreteValue.Value = TripStart;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripStart"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = TripEnd;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["TripEnd"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                }

                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptTripData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);

                        if (Convert.ToBoolean(prm8))
                            ReportName = "rpt_TripReportData" + "/" + ReportName;
                        else
                            ReportName = "rpt_TripReportData_NoSummary" + "/" + ReportName;

                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--TripDetailsReportDriver( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptTripData", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.StackTrace.ToString());
                    }
                }


                ReportPath = this.GetReportURL(ReportName);




                Log("<--TripDetailsReportDriver( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Details report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int TripSummaryReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams,
                                     int rFormat, string lang, ref string ReportPath,
                                     ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            MethodName = "TripSummaryReport";

            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                Log("-->TripSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                GetUserPreferences(UserID);

                string strTotal = "";
                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);
                Double totalCost = 0;

                DataSet dsCrystal = GetTripSummary(UserID, xmlParams, lang, ref totalTrip, ref totalIndling, ref totalStop, ref totalCost, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {

                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Summary doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log(MethodName + " Update Report Status Failed for !Util.IsDataSetValid(dsCrystal). Exception Message: " + Ex.Message.ToString());
                        }
                    }

                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();



                if (!lang.ToLower().Contains("fr"))
                {
                    oRpt.Load(this.GetReportPath("rpt_TripSummary.rpt"));
                }
                else
                {
                    oRpt.Load(this.GetReportPath("rpt_TripSummary_fr.rpt"));
                }


                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripActivity)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string DistanceType = FindExistingPreference();

                crParameterDiscreteValue.Value = DistanceType;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                strTotal = "";

                if (totalTrip.Days > 0)
                {
                    strTotal += totalTrip.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalTrip.Ticks - totalTrip.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalTrip.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTripTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                strTotal = "";

                if (totalIndling.Days > 0)
                {
                    strTotal += totalIndling.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalIndling.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                strTotal = "";

                if (totalStop.Days > 0)
                {
                    strTotal += totalStop.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalStop.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStopTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = totalCost.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotCost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string Sensor = Util.PairFindValue(ReportTemplate.RpTripFifthParamName, xmlParams);
                string TripTitle = "";

                Resources.Const.Culture = new CultureInfo(lang);
                switch (Sensor)
                {
                    case "3":
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                    case "8":
                        TripTitle = Resources.Const.TripType_PTO;
                        break;
                    case "11":
                        TripTitle = Resources.Const.TripType_TP;
                        break;
                    default:
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                }

                crParameterDiscreteValue.Value = TripTitle;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TripType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptTripSummaryData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_TripSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log(MethodName + " Update Report Status Failed for HTM Format. Exception Message: " + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--TripSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} ) for HTM Format", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptTripSummaryData", fileExt);

                Log(MethodName + " begin to render report.");

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                Log(MethodName + " render report successfully.");

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TripSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(MethodName + " Update Report Status failed after rendering report: " + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);
                Log("<--TripSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                Log(MethodName + " failed to render report: " + Ex.Message);

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Summary report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log(MethodName + "Update Report Status failed after failed to render report: " + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int TripFleetSummaryReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->TripFleetSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                GetUserPreferences(UserID);

                string strTotal = "";

                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);
                Double totalCost = 0;

                DataSet dsCrystal = GetFleetTripSummary(UserID, xmlParams, lang, ref totalTrip, ref totalIndling, ref totalStop, ref totalCost, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripSummary.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripActivity)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";
                if (totalTrip.Days > 0)
                {
                    strTotal += totalTrip.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalTrip.Ticks - totalTrip.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalTrip.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTripTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";
                if (totalIndling.Days > 0)
                {
                    strTotal += totalIndling.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalIndling.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";

                if (totalStop.Days > 0)
                {
                    strTotal += totalStop.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalStop.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStopTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = totalCost.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotCost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptTripSummaryData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_TripSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--TripFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptTripSummaryData", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);
                Log("<--TripFleetSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int TripFleetDetailsReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->TripFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();
                dsCrystal = GetTripFleetDetails(UserID, xmlParams, lang, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripReportData.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripReportData)), lang);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptTripData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_TripReportData" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--TripFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptTripData", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<--TripFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Details report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int TripFleetDetailsReportOneByOne(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {

                Log("-->TripFleetDetailsReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                string prm1 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFirstParamName, xmlParams);
                string prm2 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSecondParamName, xmlParams);
                string prm3 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripThirdParamName, xmlParams);
                string prm4 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFourthParamName, xmlParams);
                string prm5 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFifthParamName, xmlParams);
                string prm6 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSixthParamName, xmlParams);
                string prm7 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSeventhParamName, xmlParams);
                string prm8 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripEighthParamName, xmlParams);
                string prm9 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripNinthParamName, xmlParams);
                string prm10 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripTenthParamName, xmlParams);

                if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null ||
                    prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null)
                {
                    // empty result
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Details Report One By One doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }


                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);

                // VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString );

                int totalSqlRecords = 0;
                int outMaxRecords = 0;
                string fromDateTime = prm2;
                string toDateTime = prm3;
                bool includeStreetAddress = Convert.ToBoolean(prm4);
                bool includeSensors = Convert.ToBoolean(prm5);
                bool includePosition = Convert.ToBoolean(prm6);
                bool includeIdleTime = Convert.ToBoolean(prm7);
                bool includeSummary = Convert.ToBoolean(prm8);
                bool showLastStoredPosition = Convert.ToBoolean(prm9);
                int sensorId = int.Parse(prm10);
                requestOverflowed = false;
                totalSqlRecords = 0;
                outMaxOverflowed = false;
                outMaxRecords = 0;
                int sqlMaxOutRecords = 1000; // = GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records", 1000);



                //using (SystemConfig dbSystem = new SystemConfig(ConnnectionString ))
                using (SystemConfig dbSystem = new SystemConfig(ConnnectionString))
                {
                    try
                    {
                        string keyValue = dbSystem.GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records");
                        sqlMaxOutRecords = int.Parse(keyValue);
                    }
                    catch
                    {
                    }
                }
                int currSqlRecords = 0;
                int outMaxFleetRecords = 0;
                outMaxOverflowed = false;
                DataSet dsCurrVehicleTrips = null;

		  //string[] licensePlateList = prm1.Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);


                string[] licensePlateList = null;

                if (prm1.Contains(","))
                    licensePlateList = prm1.Split(',');
                else
                    licensePlateList = prm1.Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);


                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "licensePlateList: " + licensePlateList.Length));

                // prepare crystal report dataset, schema.
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSimpleTripReportData.xsd"));

                string reportTemplate = "";

                if (!lang.ToLower().Contains("fr"))
                {
                     reportTemplate = includeSummary ? "rpt_SimpleTripReportData.rpt" : "rpt_SimpleTripReportData_NoSummary.rpt";
                }
                else
                {
                    reportTemplate = "rpt_SimpleTripReportData_fr.rpt";
                }


                // prepare crystal report template
                
                //reportTemplate = Path.Combine(Server.MapPath(this.ReportsRootPath), reportTemplate);
                // get distance type
                GetUserPreferences(UserID);
                string DistanceType = FindExistingPreference();
                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                    case 4:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                }
                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.CrystalDataSet = dsCrystal;
                reportState.Lang = lang;
                reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripReportData));
                reportState.ReportTemplateFile = this.GetReportPath(reportTemplate);
                reportState.ReportParameters = new Dictionary<string, object>();
                //reportState.ReportParameters.Add("FromDate", FromDate);
                //reportState.ReportParameters.Add("ToDate", ToDate);

                reportState.ReportParameters.Add("FromDate",FormatDateTimeByLanguage(FromDate, lang));
                reportState.ReportParameters.Add("ToDate", FormatDateTimeByLanguage(ToDate, lang));
                reportState.ReportParameters.Add("DistanceType", DistanceType);
                reportState.ReportParameters.Add("UserTimeZone", "GMT" + UserTimeZone);


                Resources.Const.Culture = new CultureInfo(lang);

                string TripSummary = "";
                string TripStart = "";
                string TripEnd = "";
                switch (sensorId)
                {
                    case 3:
                        TripSummary = Resources.Const.TripSummary;
                        TripStart = Resources.Const.TripStart;
                        TripEnd = Resources.Const.TripEnd;
                        break;
                    case 8:
                        TripSummary = Resources.Const.TripSummaryPTO;
                        TripStart = Resources.Const.TripStartPTO;
                        TripEnd = Resources.Const.TripEndPTO;
                        break;
                    case 11:
                        TripSummary = Resources.Const.TripSummaryTP;
                        TripStart = Resources.Const.TripStartTP;
                        TripEnd = Resources.Const.TripEndTP;
                        break;
                    default:
                        TripSummary = Resources.Const.TripSummary;
                        TripStart = Resources.Const.TripStart;
                        TripEnd = Resources.Const.TripEnd;
                        break;
                }
                if (includeSummary)
                {
                    reportState.ReportParameters.Add("TripSummary", TripSummary);
                    reportState.ReportParameters.Add("TripStart", TripStart);
                    reportState.ReportParameters.Add("TripEnd", TripEnd);
                }

                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("rptTripData-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(this.ReportsOutputPath), string.Format("rptTripData-{0}{1}", Guid.NewGuid(), fileExt));

                // generate report one by one.
                TimeSpan retrievingTime = new TimeSpan();
                TimeSpan preparingTime = new TimeSpan();
                TimeSpan exportingTime = new TimeSpan();
                TimeSpan totalTime = new TimeSpan();
                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;
                for (int i = 0; i < licensePlateList.Length; i++)
                {
                    string licensePlate = licensePlateList[i].Trim();
                    try
                    {
                        currSqlRecords = 0;
                        // 2. Retrieves trip info for every vehicle
                        DateTime t1 = DateTime.Now;
                        dsCurrVehicleTrips = detailedTrip.GetDetailedTripReport(licensePlate,
                                                                     fromDateTime,
                                                                     toDateTime,
                                                                     includeStreetAddress,
                                                                     includeSensors,
                                                                     includePosition,
                                                                     includeIdleTime,
                                                                     includeSummary,
                                                                     showLastStoredPosition,
                                                                     UserID, sensorId, lang,
                                                                     ref requestOverflowed,
                                                                     ref currSqlRecords,
                                                                     ref outMaxOverflowed,
                                                                     ref outMaxRecords);
                        DateTime t2 = DateTime.Now;
                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }
                        totalSqlRecords += currSqlRecords;
                        outMaxFleetRecords += outMaxRecords;
                        if (sqlMaxOutRecords < outMaxFleetRecords)
                            outMaxOverflowed = true;
                        if (requestOverflowed || outMaxOverflowed)
                        {
                            break;
                        }
                        DateTime t3 = DateTime.Now;
                        if (dsCurrVehicleTrips != null && currSqlRecords > 0 && dsCurrVehicleTrips.Tables["TripReportData"]!=null && dsCurrVehicleTrips.Tables["TripReportData"] .Rows.Count>0)
                        {
                            dsCrystal.Clear();
                            if (includeSummary)
                            {
                                MergeTripSummaryTable(dsCurrVehicleTrips, dsCrystal, false);
                            }
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportData"], false, MissingSchemaAction.Ignore);
                            // parameters
                            string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                            reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);
                            asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                        }
                        DateTime t4 = DateTime.Now;
                        TimeSpan ts1, ts2, ts3, ts4;
                        ts1 = t2.Subtract(t1);
                        ts2 = t3.Subtract(t2);
                        ts3 = t4.Subtract(t3);
                        ts4 = t4.Subtract(t1);
                        retrievingTime += ts1;
                        preparingTime += ts3;
                        exportingTime += ts2;
                        totalTime += ts4;
                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                           String.Format("License Plate {0}: {1}, outMaxRecords {2}, currSqlRecords {3}, retrieve: {4:f2}, prepare: {5:f2}, export: {6:f2}, total: {7:f2}",
                           i + 1, licensePlate, outMaxRecords, currSqlRecords, ts1.TotalSeconds, ts3.TotalSeconds, ts2.TotalSeconds, ts4.TotalSeconds)));
                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error,
                           String.Format("Vehicle: [LP={0}] Error: {1}", licensePlate, ex.Message)));
                    }
                }
                DateTime t5 = DateTime.Now;
                // check and wait last report is done.
                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }

                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));
                //"http://" + ConfigurationManager.AppSettings["ServerIp"] + 
                //ConfigurationManager.AppSettings["ReportsRootPath"] + "/TmpReports/" + Path.GetFileName(reportState.MergedReportFile);

                DateTime t6 = DateTime.Now;
                TimeSpan ts5 = t6.Subtract(t5);
                totalTime += ts5;
                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   String.Format("TripFleetDetailsReportOneByOne end: outMaxFleetRecords {0}, totalSqlRecords {1}, sqlMaxOutRecords {2}, retrieve: {3:f2}, prepare: {4:f2}, export: {5:f2}, merge: {6:f2}, total: {7:f2}",
                   outMaxFleetRecords, totalSqlRecords, sqlMaxOutRecords, retrievingTime.TotalSeconds, preparingTime.TotalSeconds, exportingTime.TotalSeconds, ts5.TotalSeconds, totalTime.TotalSeconds)));

                Log("<--TripFleetDetailsReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                if (rFormat == 2)
                {
                    ManipulateExcelFile(reportState.MergedReportFile, "TripDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Details Report One By One failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int TripFleetSummaryReportOneByOne(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                Log("-->TripFleetSummaryReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);
                //VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString );

                string prm1 = Util.PairFindValue(ReportTemplate.RpFleetTripFirstParamName, xmlParams);
                string prm2 = Util.PairFindValue(ReportTemplate.RpFleetTripSecondParamName, xmlParams);
                string prm3 = Util.PairFindValue(ReportTemplate.RpFleetTripThirdParamName, xmlParams);
                string prm4 = Util.PairFindValue(ReportTemplate.RpFleetTripFourthParamName, xmlParams);
                string prm5 = Util.PairFindValue(ReportTemplate.RpFleetTripFifthParamName, xmlParams);

                if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null)
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Summary Report One By One doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    // empty result


                    return (int)InterfaceError.InvalidParameter;
                }
                int totalSqlRecords = 0;
                int outMaxRecords = 0;
                string fromDateTime = prm2;
                string toDateTime = prm3;
                bool showLastStoredPosition = Convert.ToBoolean(prm4);
                int sensorId = int.Parse(prm5);
                requestOverflowed = false;
                totalSqlRecords = 0;
                outMaxOverflowed = false;
                outMaxRecords = 0;
                int sqlMaxOutRecords = 1000; // = GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records", 1000);
                using (SystemConfig dbSystem = new SystemConfig(ConnnectionString))
                {
                    try
                    {
                        string keyValue = dbSystem.GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records");
                        sqlMaxOutRecords = int.Parse(keyValue);
                    }
                    catch
                    {
                    }
                }
                int currSqlRecords = 0;
                int outMaxFleetRecords = 0;
                outMaxOverflowed = false;
                DataSet dsCurrVehicleTrips = null;
		  //string[] licensePlateList = prm1.Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);


                string[] licensePlateList = null;

                if (prm1.Contains(","))
                    licensePlateList = prm1.Split(',');
                else
                    licensePlateList = prm1.Split(Environment.NewLine.ToCharArray(), StringSplitOptions.RemoveEmptyEntries);


                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "licensePlateList: " + licensePlateList.Length));

                // prepare crystal report dataset, schema.
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSimpleTripReportData.xsd"));

                // get distance type
                GetUserPreferences(UserID);
                string DistanceType = FindExistingPreference();
                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                    case 4:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.CrystalDataSet = dsCrystal;
                reportState.Lang = lang;
                reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                

                //if (!lang.ToLower().Contains("fr"))
                //{
                    reportState.ReportTemplateFile = this.GetReportPath("rpt_SimpleTripSummary.rpt");
                //}
                //else
                //{
                //    reportState.ReportTemplateFile = this.GetReportPath("rpt_SimpleTripSummary_fr.rpt");
                //}



                reportState.ReportParameters = new Dictionary<string, object>();

                reportState.ReportParameters.Add("FromDate", FormatDateTimeByLanguage(FromDate, lang));
                reportState.ReportParameters.Add("ToDate", FormatDateTimeByLanguage(ToDate, lang));
                reportState.ReportParameters.Add("DistanceType", DistanceType);
                reportState.ReportParameters.Add("TotTripTime", null);
                reportState.ReportParameters.Add("TotIdling", null);
                reportState.ReportParameters.Add("TotStopTime", null);
                reportState.ReportParameters.Add("TotCost", null);
                reportState.ReportParameters.Add("UserTimeZone", "GMT" + UserTimeZone);
                Resources.Const.Culture = new CultureInfo(lang);

                string TripTitle = "";

                switch (sensorId)
                {
                    case 3:
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                    case 8:
                        TripTitle = Resources.Const.TripType_PTO;
                        break;
                    case 11:
                        TripTitle = Resources.Const.TripType_TP;
                        break;
                    default:
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                }

                reportState.ReportParameters.Add("TripType", TripTitle);



                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(ReportsOutputPath), String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));

                // generate report one by one.
                TimeSpan retrievingTime = new TimeSpan();
                TimeSpan preparingTime = new TimeSpan();
                TimeSpan exportingTime = new TimeSpan();
                TimeSpan totalTime = new TimeSpan();
                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;

                for (int i = 0; i < licensePlateList.Length; i++)
                {
                    string licensePlate = licensePlateList[i].Trim();

                    try
                    {
                        currSqlRecords = 0;
                        string strTotal = "";
                        TimeSpan totalTrip = new TimeSpan(0);
                        TimeSpan totalIdling = new TimeSpan(0);
                        TimeSpan totalStop = new TimeSpan(0);
                        Double totalCost = 0;

                        // 2. Retrieves trip info for every vehicle
                        DateTime t1 = DateTime.Now;
                        dsCurrVehicleTrips = detailedTrip.GetTripReport(licensePlate,
                                                                    fromDateTime,
                                                                    toDateTime,
                                                                    UserID,
                                                                    showLastStoredPosition,
                                                                    sensorId,
                                                                    lang,
                                                                    ref requestOverflowed,
                                                                    ref currSqlRecords,
                                                                    ref outMaxOverflowed,
                                                                    ref outMaxRecords);
                        DateTime t2 = DateTime.Now;
                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }
                        totalSqlRecords += currSqlRecords;
                        outMaxFleetRecords += outMaxRecords;
                        if (sqlMaxOutRecords < outMaxFleetRecords)
                            outMaxOverflowed = true;
                        if (requestOverflowed || outMaxOverflowed)
                        {
                            break;
                        }
                        DateTime t3 = DateTime.Now;
                        if (dsCurrVehicleTrips != null && currSqlRecords > 0)
                        {

                            if (lang.ToLower().Contains("fr"))
                            { 
                                foreach (DataRow dr in dsCurrVehicleTrips.Tables["TripStart"].Rows)
                                {
                                    dr["Summary"] = Convert.ToDateTime(dr["Summary"]).ToString("d/M/yyyy HH:mm:ss");
                                }

                                foreach (DataRow dr in dsCurrVehicleTrips.Tables["TripEnd"].Rows)
                                {
                                    dr["Summary"] = Convert.ToDateTime(dr["Summary"]).ToString("d/M/yyyy HH:mm:ss");
                                }
                                
                            }

                            dsCrystal.Clear();
                            Dictionary<string, string> vehicleSummary = MergeTripSummaryTable(dsCurrVehicleTrips, dsCrystal, true);
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
                            // parameters
                            string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                            reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);
                            reportState.ReportParameters["TotTripTime"] = vehicleSummary["TotTripTime"];
                            reportState.ReportParameters["TotIdling"] = vehicleSummary["TotIdling"]; ;
                            reportState.ReportParameters["TotStopTime"] = vehicleSummary["TotStopTime"];
                            reportState.ReportParameters["TotCost"] = vehicleSummary["TotCost"]; ;
                            asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                        }
                        DateTime t4 = DateTime.Now;
                        TimeSpan ts1 = new TimeSpan(), ts2 = new TimeSpan(), ts3 = new TimeSpan(), ts4 = new TimeSpan();
                        ts1 = t2.Subtract(t1);
                        ts2 = t3.Subtract(t2);
                        ts3 = t4.Subtract(t3);
                        ts4 = t4.Subtract(t1);
                        retrievingTime += ts1;
                        preparingTime += ts3;
                        exportingTime += ts2;
                        totalTime += ts4;

                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                          String.Format("License Plate {0}: {1}, outMaxRecords {2}, currSqlRecords {3}, retrieve: {4:f2}, prepare: {5:f2}, export: {6:f2}, total: {7:f2}",
                          i + 1, licensePlate, outMaxRecords, currSqlRecords, ts1.TotalSeconds, ts3.TotalSeconds, ts2.TotalSeconds, ts4.TotalSeconds)));

                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error,
                           String.Format("Vehicle: [LP={0}] Error: {1}", licensePlate, ex.Message)));
                    }
                    finally
                    {
                    }
                }
                DateTime t5 = DateTime.Now;
                // check and wait last report is done.
                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }

                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));
                //"http://" + ConfigurationManager.AppSettings["ServerIp"] + 
                //ConfigurationManager.AppSettings["ReportsRootPath"] + "/TmpReports/" + Path.GetFileName(reportState.MergedReportFile);

                DateTime t6 = DateTime.Now;
                TimeSpan ts5 = t6.Subtract(t5);
                totalTime += ts5;
                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   String.Format("TripFleetSummaryReportOneByOne end: outMaxFleetRecords {0}, totalSqlRecords {1}, sqlMaxOutRecords {2}, retrieve: {3:f2}, prepare: {4:f2}, export: {5:f2}, merge: {6:f2}, total: {7:f2}",
                   outMaxFleetRecords, totalSqlRecords, sqlMaxOutRecords, retrievingTime.TotalSeconds, preparingTime.TotalSeconds, exportingTime.TotalSeconds, ts5.TotalSeconds, totalTime.TotalSeconds)));

                Log("<--TripFleetSummaryReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                if (rFormat == 2)
                {
                    ManipulateExcelFile(reportState.MergedReportFile, "TripSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");


                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Fleet Summary Report One By One", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int StopReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StopReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);


                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);

                int StopCount = 0;
                string strTotalStopTime = "";
                string strTotalIdlingTime = "";
                int IdlingCount = 0;


                GetUserPreferences(UserID);

                DataSet dsCrystal = GetStopReportData(UserID, xmlParams, lang, ref IdlingCount, ref totalIndling, ref StopCount, ref totalStop, ref  requestOverflowed, ref  outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Stop Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripStopReport.rpt"));


                if (lang.ToLower().Contains("fr"))
                {
                    foreach (DataRow dr in dsCrystal.Tables["rpt_StopData"].Rows)
                    {
                        dr["ArrivalDateTime_"] = Convert.ToDateTime(dr["ArrivalDateTime_"]).ToString("d/M/yyyy HH:mm:ss");
                        try
                        {
                            dr["DepartureDateTime_"] = Convert.ToDateTime(dr["DepartureDateTime_"]).ToString("d/M/yyyy HH:mm:ss");
                        }
                        catch
                        {
                        }
                    }



                }

                oRpt.SetDataSource(dsCrystal);



                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_StopReport)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                if (lang=="fr") 
                    crParameterDiscreteValue.Value = "";
                else 
                    crParameterDiscreteValue.Value = Util.PairFindValue(ReportTemplate.RpStopEighthParamName, xmlParams);


                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                strTotalIdlingTime = "";
                if (totalIndling.Days > 0)
                {
                    strTotalIdlingTime += totalIndling.Days.ToString() + " d, ";
                    strTotalIdlingTime += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotalIdlingTime = totalIndling.ToString();
                }


                crParameterDiscreteValue.Value = IdlingCount;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = strTotalIdlingTime;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTimeIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                strTotalStopTime = "";
                if (totalStop.Days > 0)
                {
                    strTotalStopTime += totalStop.Days.ToString() + " d, ";
                    strTotalStopTime += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotalStopTime = totalStop.ToString();
                }


                crParameterDiscreteValue.Value = StopCount;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStops"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = strTotalStopTime;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTimeStop"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptStopReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_TripStopReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--StopReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptStopReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "StopIdling");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);
                Log("<--StopReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Stop Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int StopFleetReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StopFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);

                int StopCount = 0;
                string strTotalStopTime = "";
                string strTotalIdlingTime = "";
                int IdlingCount = 0;

                GetUserPreferences(UserID);

                DataSet dsCrystal =
                   GetStopFleetReportData(UserID, xmlParams, lang, ref IdlingCount, ref totalIndling, ref StopCount, ref totalStop, ref requestOverflowed, ref  outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Stop Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                if (lang.ToLower().Contains("fr"))
                {
                    foreach (DataRow dr in dsCrystal.Tables["rpt_StopData"].Rows)
                    {
                        dr["ArrivalDateTime_"] = Convert.ToDateTime(dr["ArrivalDateTime_"]).ToString("d/M/yyyy HH:mm:ss");
                         try
                        {
                            dr["DepartureDateTime_"] = Convert.ToDateTime(dr["DepartureDateTime_"]).ToString("d/M/yyyy HH:mm:ss");
                        }
                        catch
                        {
                        }
                    }

                   

                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripStopReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_StopReport)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (lang == "fr")
                    crParameterDiscreteValue.Value = "";
                else
                    crParameterDiscreteValue.Value = Util.PairFindValue(ReportTemplate.RpStopEighthParamName, xmlParams);

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                strTotalIdlingTime = "";
                if (totalIndling.Days > 0)
                {
                    strTotalIdlingTime += totalIndling.Days.ToString() + " d, ";
                    strTotalIdlingTime += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotalIdlingTime = totalIndling.ToString();
                }


                crParameterDiscreteValue.Value = IdlingCount;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = strTotalIdlingTime;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTimeIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotalStopTime = "";
                if (totalStop.Days > 0)
                {
                    strTotalStopTime += totalStop.Days.ToString() + " d, ";
                    strTotalStopTime += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotalStopTime = totalStop.ToString();
                }


                crParameterDiscreteValue.Value = StopCount;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStops"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = strTotalStopTime;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTimeStop"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptStopReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_TripStopReport" + "/" + ReportName; if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--StopFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptStopReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "StopIdling");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--StopFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Stop Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int AlarmsReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstAlarmReport.xsd"));
                //StringReader strrXML = null;

                DataSet dsAlarms = GetAlarams(UserID, xmlParams, lang, ref RequestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsAlarms))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                string LicensePlate = Util.PairFindValue(ReportTemplate.RpAlarmFirstParamName, xmlParams);

                DataSet dsVehicle = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString))
                {
                    dsVehicle = dbVehicle.GetVehicleInfoByLicensePlate(LicensePlate);
                }

                if (Util.IsDataSetValid(dsVehicle))
                    //CopyRows(dsVehicle.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);
                    dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);


                // Alarm Severity Name 
                DataColumn dc = new DataColumn();
                dc.ColumnName = "AlarmTypeMsg";
                dc.DataType = Type.GetType("System.String");
                dc.DefaultValue = false;
                dsAlarms.Tables[0].Columns.Add(dc);


                foreach (DataRow rowItem in dsAlarms.Tables[0].Rows)
                {
                    if (Convert.ToInt16(rowItem["AlarmType"]) == 18)
                        rowItem["AlarmTypeMsg"] = "Alarm";
                    else if (Convert.ToInt16(rowItem["AlarmType"]) == 2)
                        rowItem["AlarmTypeMsg"] = "Sensor";
                    else
                        rowItem["AlarmTypeMsg"] = "Message";
                }

                //CopyRows(dsAlarms.Tables[0], dsCrystal.Tables["rpt_AlarmReport"]);
                dsCrystal.Tables["rpt_AlarmReport"].Merge(dsAlarms.Tables[0], false, MissingSchemaAction.Ignore);

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Alarms.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Alarms)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptAlarmData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Alarms" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptAlarmData", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "AlarmReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int AlarmsFleetReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->AlarmsReportFleet( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan currDuration;
                GetUserPreferences(UserID);

                DataSet dsVehicle = new DataSet();
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstAlarmReport.xsd"));
                //StringReader strrXML = null;
                DataSet dsAlarms = new DataSet();

                dsAlarms = GetFleetAlarams(UserID, xmlParams, lang, ref requestOverflowed, ref  outMaxOverflowed);

                if (!Util.IsDataSetValid(dsAlarms))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                if (/*dsAlarms.Tables.IndexOf("VehicleAlarms") != -1 && */dsAlarms.Tables[0].Rows.Count > 0)
                {
                    string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    using (VLF.DAS.Logic.User dbUser = new VLF.DAS.Logic.User(ConnnectionString))
                    {
                        dsVehicle = dbUser.GetUserAllVehiclesActiveInfo(UserID);
                    }

                    if (Util.IsDataSetValid(dsVehicle))
                        dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);
                    //CopyRows(dsVehicle.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);


                    // Alarm Severity Name 
                    DataColumn dc = new DataColumn();
                    dc.ColumnName = "AlarmTypeMsg";
                    dc.DataType = Type.GetType("System.String");
                    dc.DefaultValue = false;
                    dsAlarms.Tables[0].Columns.Add(dc);


                    foreach (DataRow rowItem in dsAlarms.Tables[0].Rows)
                    {
                        if (Convert.ToInt16(rowItem["AlarmType"]) == 18)
                            rowItem["AlarmTypeMsg"] = "Alarm";
                        else if (Convert.ToInt16(rowItem["AlarmType"]) == 2)
                            rowItem["AlarmTypeMsg"] = "Sensor";
                        else
                            rowItem["AlarmTypeMsg"] = "Message";
                    }


                    dsCrystal.Tables["rpt_AlarmReport"].Merge(dsAlarms.Tables[0], false, MissingSchemaAction.Ignore);

                    LocalizeAddress(lang, ref dsCrystal);

                    ReportDocument oRpt = new ReportDocument();

                    DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                    oRpt.Load(this.GetReportPath("rpt_AlarmsFleet.rpt"));


                    oRpt.SetDataSource(dsCrystal);

                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_AlarmsFleet)), lang);

                    ParameterFieldDefinitions crParameterFieldDefinitions;
                    ParameterFieldDefinition crParameterFieldDefinition;
                    ParameterValues crParameterValues = new ParameterValues();
                    ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                    crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                    crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    string FleetId = Util.PairFindValue(ReportTemplate.RpFleetAlarmsFirstParamName, xmlParams);


                    crParameterDiscreteValue.Value = GetFleetName(UserID, Convert.ToInt32(FleetId),lang);
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                    string fileExt = "";
                    string ReportName = "";

                    switch (rFormat)
                    {
                        case 1:
                            oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                            fileExt = ".pdf";
                            break;
                        case 2:
                            oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                            fileExt = ".xls";
                            break;
                        case 3:
                            oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                            fileExt = ".doc";
                            break;

                        case 4:
                            fileExt = ".htm";
                            ReportName = this.GetReportName("rptAlarmData", fileExt);
                            ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                            ReportName = "rpt_AlarmsFleet" + "/" + ReportName;
                            if (IsNumeric(ReportPath))
                            {
                                try
                                {
                                    if (ReportName.Trim() != "")
                                        UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                    else
                                        UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                                }
                                catch (Exception Ex)
                                {
                                    Log("UpdateReportStatus-->" + Ex.Message.ToString());
                                }
                            }
                            ReportPath = this.GetReportURL(ReportName);
                            Log("<--AlarmsReportFleet( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                            return (int)InterfaceError.NoError;
                    }

                    ReportName = this.GetReportName("rptAlarmData", fileExt);

                    oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                    diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                    oRpt.ExportOptions.DestinationOptions = diskOpt;
                    oRpt.Export();
                    oRpt.Close();

                    if (rFormat == 2)
                    {
                        ManipulateExcelFile(diskOpt.DiskFileName, "AlarmReport");
                    }

                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            if (ReportName.Trim() != "")
                                UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                            else
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }

                    ReportPath = this.GetReportURL(ReportName);
                    Log("<--AlarmsReportFleet( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                    return (int)InterfaceError.NoError;
                }
                else
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Server Error", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.ServerError;
                }
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int HistoryReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, Int16 DclId, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                TimeSpan currDuration;

                GetUserPreferences(UserID);

                string[] ParamList = new string[4];
                ParamList = xmlParams.ToString().Split(';');

                string LicensePlate = ParamList[4].TrimEnd();

                //string xml = "";
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHistory.xsd"));

                //StringReader strrXML = null;
                DataSet dsHistory = new DataSet();
                dsHistory = dsHistory_Fill(UserID, LicensePlate, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), xmlParams, DclId, lang, ref  requestOverflowed, ref  outMaxOverflowed);

		    if (requestOverflowed == true)
                {

                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Too much data requested. Please reduce your search criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }

                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                if (!Util.IsDataSetValid(dsHistory))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "History Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }
                

                //CopyRows(dsHistory.Tables[0], dsCrystal.Tables["rpt_History"]);

                if (lang.ToLower().Contains("en"))
                {
                    foreach (DataRow dr in dsHistory.Tables[0/*"rpt_TripStart"*/].Rows)
                    {
                        try
                        {
                            string DateTimeString = dr["OriginDateTime"].ToString();

                            int mo = int.Parse(DateTimeString.Substring(DateTimeString.IndexOf('/') + 1, DateTimeString.LastIndexOf('/') - DateTimeString.IndexOf('/') - 1));
                            int dy = int.Parse(DateTimeString.Substring(0, DateTimeString.IndexOf('/')));
                            int yr = int.Parse(DateTimeString.Substring(DateTimeString.LastIndexOf('/') + 1, 4));
                            string tm = DateTimeString.Substring(DateTimeString.LastIndexOf('/') + 5);
                            dr["OriginDateTime"] = Convert.ToDateTime(string.Format("{0}/{1}/{2} {3}", mo, dy, yr, tm.Trim()), new System.Globalization.CultureInfo("en-US"));
                        }
                        catch { }
                    }
                }

                dsCrystal.Tables["rpt_History"].Merge(dsHistory.Tables[0], false, MissingSchemaAction.Ignore);


                DataSet dsVehicle = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString))
                {
                    dsVehicle = dbVehicle.GetVehicleInfoByLicensePlate(LicensePlate);
                }

                if (Util.IsDataSetValid(dsVehicle))
                    dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);
                //CopyRows(dsVehicle.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);


                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_History.rpt"));

                oRpt.SetDataSource(dsCrystal);

                ReportDocument oRptSub = new ReportDocument();

                oRptSub = oRpt.Subreports["rpt_History_Summary"];


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_History)), lang);
                LocalizeTextObject(ref oRptSub, new ResourceManager(typeof(Resources.Report_History)), lang);





                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string DistanceType = FindExistingPreference();

                crParameterDiscreteValue.Value = DistanceType;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //if (rFormat == 0)
                //{
                //    DateTime dt = System.DateTime.Now;
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance Start : Loading Crystal report. User:" + sn.UserID.ToString() + " Form:Report_History"));

                //    //Hide Header
                //    crParameterDiscreteValue.Value = false;
                //    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //    crParameterFieldDefinition = crParameterFieldDefinitions["suppressHeader"];
                //    crParameterValues = crParameterFieldDefinition.CurrentValues;
                //    crParameterValues.Add(crParameterDiscreteValue);
                //    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //    currDuration = new TimeSpan(System.DateTime.Now.Ticks - dt.Ticks);
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance End  : Loading Crystal report. User:" + sn.UserID.ToString() + " Total Time:" + currDuration.ToString() + " Form:Report_History"));
                //}



                //else if (rFormat == 1)
                //{

                //Hide Header



                crParameterDiscreteValue.Value = false;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["suppressHeader"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //crParameterDiscreteValue.Value = (lang.ToLower().Contains("fr") ? true : false);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["IsFr"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        // ExcelFormatOptions objExcelOptions =new ExcelFormatOptions();
                        //  objExcelOptions.ExcelUseConstantColumnWidth = false;
                        //oRpt.ExportOptions.ExportFormatOptions = objExcelOptions;
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:

                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptHistoryData", fileExt);
                        ReportName = "rpt_History" + "/" + ReportName;
                        ExportToHTML(oRpt, this.GetReportName("rptHistoryData", fileExt), this.ReportsOutputPath, false, false);
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptHistoryData", fileExt);
                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "HistoryReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;

                //}


                //else if (rFormat == 2)
                //{
                //    //Hide Header

                //    DateTime dt = System.DateTime.Now;
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance Start : Loading Crystal report. User:" + sn.UserID.ToString() + " Form:Report_History"));


                //    crParameterDiscreteValue.Value = false;
                //    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //    crParameterFieldDefinition = crParameterFieldDefinitions["suppressHeader"];
                //    crParameterValues = crParameterFieldDefinition.CurrentValues;
                //    crParameterValues.Add(crParameterDiscreteValue);
                //    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //    strPath = ReportsOutputPath;
                //    strPath = MapPath(strPath) + @"\" + ReportName + ".xls";
                //    oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;

                //    oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                //    diskOpt.DiskFileName = strPath;
                //    oRpt.ExportOptions.DestinationOptions = diskOpt;
                //    oRpt.Export();
                //    oRpt.Close();
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsReports.Enabled | AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Ending History Report..."));

                //    currDuration = new TimeSpan(System.DateTime.Now.Ticks - dt.Ticks);
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance End  : History Report. User:" + sn.UserID.ToString() + " Total Time:" + currDuration.ToString() + " Form:Report_History"));

                //    Response.Expires = 10;
                //    Response.AddHeader("pragma", "no-cache");
                //    Response.AddHeader("cache-control", "private");
                //    Response.CacheControl = "no-cache";
                //    Response.Redirect(ReportsOutputPathURL + ReportName + ".xls");
                //}


                //else if (rFormat == 3)
                //{
                //    //Hide Header

                //    DateTime dt = System.DateTime.Now;
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance Start : Loading Crystal report. User:" + sn.UserID.ToString() + " Form:Report_History"));


                //    crParameterDiscreteValue.Value = false;
                //    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //    crParameterFieldDefinition = crParameterFieldDefinitions["suppressHeader"];
                //    crParameterValues = crParameterFieldDefinition.CurrentValues;
                //    crParameterValues.Add(crParameterDiscreteValue);
                //    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //    strPath = ReportsOutputPath;
                //    strPath = MapPath(strPath) + @"\" + ReportName + ".doc";
                //    oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;

                //    oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                //    diskOpt.DiskFileName = strPath;
                //    oRpt.ExportOptions.DestinationOptions = diskOpt;
                //    oRpt.Export();
                //    oRpt.Close();
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsReports.Enabled | AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Ending History Report..."));

                //    currDuration = new TimeSpan(System.DateTime.Now.Ticks - dt.Ticks);
                //    System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "Performance End  : History Report. User:" + sn.UserID.ToString() + " Total Time:" + currDuration.ToString() + " Form:Report_History"));


                //    Response.Expires = 10;
                //    Response.AddHeader("pragma", "no-cache");
                //    Response.AddHeader("cache-control", "private");
                //    Response.CacheControl = "no-cache";
                //    Response.Redirect(ReportsOutputPathURL + ReportName + ".doc");
                //    //}
                //}
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "History Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int ExceptionReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ExceptionReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                DataSet dsCrystal = new DataSet();
                dsCrystal = GetExceptionData(UserID, xmlParams, ref  requestOverflowed, ref  outMaxOverflowed);

                GetUserPreferences(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Exception Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Exceptions.rpt"));


                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Exception)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptExceptionReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Exceptions" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--ExceptionReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptExceptionReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", ""); UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ExceptionReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Exception Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int ExceptionFleetReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ExceptionFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                DataSet dsCrystal = new DataSet();
                dsCrystal = GetFleetExceptionData(UserID, xmlParams, ref  requestOverflowed, ref  outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Exception Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Exceptions.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Exception)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptExceptionReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Exceptions" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--ExceptionFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptExceptionReport", fileExt);


                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ExceptionFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Exception Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int MessagesReport(Int32 UserID, string SID, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->MessageReport( userId = {0}, xmlParams={1} )", UserID, xmlParams);

                string FromDate = Util.PairFindValue(ReportTemplate.RpMessagesFirstParamName, xmlParams);
                string ToDate = Util.PairFindValue(ReportTemplate.RpMessagesSecondParamName, xmlParams);
                Int32 FleetId = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RpMessagesThirdParamName, xmlParams));
                string FleetName = Util.PairFindValue(ReportTemplate.RpMessagesFourthParamName, xmlParams);
                Int32 BoxId = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RpMessagesFifthParamName, xmlParams));
                string VehicleName = Util.PairFindValue(ReportTemplate.RpMessagesSixthParamName, xmlParams);


                DataSet dsCrystal = new DataSet();

                DataSet ds = GetMessages(UserID, BoxId, FromDate, ToDate, (Int16)VLF.CLS.Def.Enums.TxtMsgDirectionType.Both, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Message Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                foreach (DataRow rowItem in ds.Tables[0].Rows)
                    rowItem["MsgDateTime"] = Convert.ToDateTime(rowItem["MsgDateTime"].ToString());

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstMessages.xsd"));

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_Messages"]);

                dsCrystal.Tables["rpt_Messages"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Messages.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Messages)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FleetName;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VehicleName;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Vehicle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rpt_Messages", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Messages" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--MessageReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rpt_Messages", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "MessageReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--MessageReport( userId = {0}, xmlParams={1} )", UserID, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Message Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int MessagesFleetReport(Int32 UserID, string SID, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->MessageFleetReport( userId = {0}, xmlParams={1} )", UserID, xmlParams);

                string FromDate = Util.PairFindValue(ReportTemplate.RpMessagesFirstParamName, xmlParams);
                string ToDate = Util.PairFindValue(ReportTemplate.RpMessagesSecondParamName, xmlParams);
                Int32 FleetId = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RpMessagesThirdParamName, xmlParams));
                string FleetName = Util.PairFindValue(ReportTemplate.RpMessagesFourthParamName, xmlParams);
                Int32 BoxId = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RpMessagesFifthParamName, xmlParams));
                string VehicleName = Util.PairFindValue(ReportTemplate.RpMessagesSixthParamName, xmlParams);


                DataSet dsCrystal = new DataSet();

                DataSet ds = GetFleetMessages(UserID, FleetId, FromDate, ToDate, (Int16)VLF.CLS.Def.Enums.TxtMsgDirectionType.Both, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Message Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                foreach (DataRow rowItem in ds.Tables[0].Rows)
                    rowItem["MsgDateTime"] = Convert.ToDateTime(rowItem["MsgDateTime"].ToString());

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstMessages.xsd"));

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_Messages"]);
                dsCrystal.Tables["rpt_Messages"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Messages.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Messages)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FleetName;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VehicleName;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Vehicle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rpt_Messages", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Messages" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--MessageFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rpt_Messages", fileExt);


                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "MessageReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<--MessageFleetReport( userId = {0},xmlParams={1} )", UserID, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Message Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationReport(Int32 UserID, string SID, int FleetId,
                                     string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilization.xsd"));

                GetUtilizationInfo(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), " Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_Utilization.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Utilization)), lang);
                GetUserPreferences(UserID);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Utilization" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--UtilizationReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptUtilizationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationSummaryReport(Int32 UserID, string SID, int FleetId,
                                            string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationSummaryReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilization.xsd"));

                GetUtilizationInfo(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Utilization Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_UtilizationSummary.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_UtilizationSummary)), lang);
                GetUserPreferences(UserID);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_UtilizationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--UtilizationSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }

                ReportName = this.GetReportName("rptUtilizationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationSummaryReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Utilization Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationByVehicleTypeReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationByVehicleTypeReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilizationSummary.xsd"));

                GetUtilizationInfoByVehicleType(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                GetUserPreferences(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Utilization By Vehicle Type Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_VehicleTypeUtilization.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_VehicleTypeUtilization)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_VehicleTypeUtilization" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--UtilizationByVehicleTypeReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptUtilizationReport", fileExt);


                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationByVehicleTypeReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Utilization By Vehicle Type Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationWeeklyReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationWeeklyReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilizationSummary.xsd"));

                GetUtilizationWeekly(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                GetUserPreferences(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Weekly Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_WeeklyUtilizationReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_WeeklyUtilizationReport)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_WeeklyUtilizationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--UtilizationWeeklyReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptUtilizationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationWeeklyReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Weekly Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationDailyDetailReport(Int32 UserID, string SID, int FleetId, string FromDate,
                                      string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationDailyDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilizationSummary.xsd"));

                GetUtilizationDailyDetails(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                GetUserPreferences(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_DailyDetailUtilizationReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_DailyDetailUtilizationReport)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_DailyDetailUtilizationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--UtilizationDailyDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;


                }
                ReportName = this.GetReportName("rptUtilizationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationDailyDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int UtilizationDailyFleetReport(Int32 UserID, string SID, int FleetId, string FromDate,
                                         string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->UtilizationDailyFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilizationSummary.xsd"));

                GetUtilizationDailyFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                GetUserPreferences(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Fleet Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_DailyFleetUtilization.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_DailyFleetUtilization)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";


                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptUtilizationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_DailyFleetUtilization" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptUtilizationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--UtilizationDailyFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Fleet Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int OffHoursReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams,
                         int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->OffHoursReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);
                Double totalCost = 0;
                string strTotal = "";

                DataSet dsCrystal = new DataSet();
                dsCrystal = GetOffHoursInfo(UserID, xmlParams, lang, ref  requestOverflowed, ref  outMaxOverflowed, ref totalTrip, ref totalIndling, ref totalStop, ref totalCost);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Off Hours Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_OffHoursReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_OffHours)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (lang.ToLower().Contains("fr") ? true : false);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsFr"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";
                if (totalTrip.Days > 0)
                {
                    strTotal += totalTrip.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalTrip.Ticks - totalTrip.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalTrip.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTripTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";
                if (totalIndling.Days > 0)
                {
                    strTotal += totalIndling.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalIndling.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";

                if (totalStop.Days > 0)
                {
                    strTotal += totalStop.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalStop.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStopTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = totalCost.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotCost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourFifthParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDayH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourSixthParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDayM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourSeventhParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDayH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourEightParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDayM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourNineParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromWeekH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourTenParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromWeekM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourElevenParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToWeekH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourTwelveParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToWeekM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptOffHours", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_OffHoursReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptOffHours", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "OffHoursOperation");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--OffHoursReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Off Hours Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int OffHoursFleetReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->OffHoursFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan totalTrip = new TimeSpan(0);
                TimeSpan totalIndling = new TimeSpan(0);
                TimeSpan totalStop = new TimeSpan(0);
                Double totalCost = 0;
                string strTotal = "";

                DataSet dsCrystal = new DataSet();
                dsCrystal = GetFleetOffHoursInfo(UserID, xmlParams, lang, ref  requestOverflowed, ref  outMaxOverflowed, ref totalTrip, ref totalIndling, ref totalStop, ref totalCost);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Off Hours Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_OffHoursFleetReport.rpt"));


                //if (lang.ToLower().Contains("fr"))
                //{
                //    foreach (DataRow dr in dsCrystal.Tables["rpt_TripStart"].Rows)
                //    {
                //        dr["Summary"] = Convert.ToDateTime(dr["Summary"]).ToString("d/M/yyyy HH:mm:ss");
                //    }

                //    foreach (DataRow dr in dsCrystal.Tables["rpt_TripEnd"].Rows)
                //    {
                //        dr["Summary"] = Convert.ToDateTime(dr["Summary"]).ToString("d/M/yyyy HH:mm:ss");
                //    }
                //}


                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_OffHours)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string DistanceType = FindExistingPreference();



                crParameterDiscreteValue.Value = DistanceType;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (lang.ToLower().Contains("fr") ? true : false);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsFr"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                strTotal = "";
                if (totalTrip.Days > 0)
                {
                    strTotal += totalTrip.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalTrip.Ticks - totalTrip.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalTrip.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotTripTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";
                if (totalIndling.Days > 0)
                {
                    strTotal += totalIndling.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalIndling.Ticks - totalIndling.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalIndling.ToString();
                }

                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotIdling"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                strTotal = "";

                if (totalStop.Days > 0)
                {
                    strTotal += totalStop.Days.ToString() + " d, ";
                    strTotal += new TimeSpan(totalStop.Ticks - totalStop.Days * TimeSpan.TicksPerDay).ToString();
                }
                else
                {
                    strTotal = totalStop.ToString();
                }


                crParameterDiscreteValue.Value = strTotal;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotStopTime"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = totalCost.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["TotCost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourFifthParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDayH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourSixthParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDayM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourSeventhParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDayH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourEightParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDayM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourNineParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromWeekH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourTenParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromWeekM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourElevenParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToWeekH"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = ReportTemplate.PairFindValue(ReportTemplate.RpOffHourTwelveParamName, xmlParams);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToWeekM"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptOffHours", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_OffHoursReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptOffHours", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "OffHoursOperation");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--OffHoursFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Off Hours Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int LandmarkActivityReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkActivityReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                DataSet dsCrystal = new DataSet();
                dsCrystal = GetLandmarkActivityInfo(UserID, xmlParams, lang, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_LandmarkActivity.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_LandmarkActivity)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarkActivity", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_LandmarkActivity" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptLandmarkActivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkActivityReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int LandmarkFleetActivityReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                Log("-->LandmarkFleetActivityReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                DataSet dsCrystal = GetLandmarkFleetActivityInfo(UserID, xmlParams, lang, ref requestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);
                GetUserPreferences(UserID);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_LandmarkActivity.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_LandmarkActivity)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarkActivity", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_LandmarkActivity" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptLandmarkActivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkFleetActivityReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        // Changes for TimeZone Feature start

        [WebMethod]
        public int ViolationReport_NewTZ(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
           

            try
            {
                orgId = GetOrganizationIdByUserId(UserID);
                Log("-->ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();
                string[] tmp = xmlParams.Split('*');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                GetViolationInfo_NewTZ(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(tmp[1]), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            if (orgId == 951 || orgId == 999994)
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report doesn't contain any data", "");
                            else
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();




                if (orgId == 999994)
                    oRpt.Load(this.GetReportPath("rpt_ViolationReport_UP.rpt"));
                else
                {
                    if (lang.ToLower().Contains("fr"))
                        oRpt.Load(this.GetReportPath("rpt_ViolationReport_fr.rpt"));
                    else
                        oRpt.Load(this.GetReportPath("rpt_ViolationReport.rpt"));
                }



                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserNewFloatTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        // Changes for TimeZone Feature end

        [WebMethod]
        public int ViolationReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
 
            try
            {
                 orgId = GetOrganizationIdByUserId(UserID);
                Log("-->ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();
                string[] tmp = xmlParams.Split('*');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                GetViolationInfo(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(tmp[1]), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            if (orgId == 951 || orgId == 999994)
                                  UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report doesn't contain any data", "");
                                             else
                                  UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();


                

                 if ( orgId == 999994)
                  oRpt.Load(this.GetReportPath("rpt_ViolationReport_UP.rpt"));
		  else
                {
                    if (lang.ToLower().Contains("fr"))
                        oRpt.Load(this.GetReportPath("rpt_ViolationReport_fr.rpt"));
                    else
                        oRpt.Load(this.GetReportPath("rpt_ViolationReport.rpt"));
                }

             

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int ViolationReport_NewSafetyMatrix(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;

            try
            {
                orgId = GetOrganizationIdByUserId(UserID);
                Log("-->ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                string[] tmp = xmlParams.Split('*');
                string[] extraParams = xmlParams.Split('|');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReportExtended.xsd"));

                //if (extraParams[1] != null && extraParams[1] != "" && extraParams[1] != "-1")
                     GetViolationInfo_NewSafetyMatrix (UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang,0,extraParams[1], ref dsCrystal);
                //else
                //    GetViolationInfo_NewSafetyMatrix(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, 0, ref dsCrystal);
                   

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {

                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report doesn't contain any data", "");

                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                 oRpt.Load(this.GetReportPath("rpt_ViolationReport_UP_Extended.rpt"));


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = orgId;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["OrgId"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string[] mFleet;
                string FleetName = "";

                try
                {
                    string tmpFleets = Util.PairFindValue("OrganizationHierarchyFleetId", xmlParams);
                  

                    if (FleetId == 0 && tmpFleets != "")
                    {
                        mFleet = tmpFleets.Split(',');
                        for (int i = 0; i <= mFleet.GetUpperBound(0); i++)
                        {
                            FleetName += GetFleetName(UserID, Convert.ToInt32(mFleet[i])) + " ; ";
                        }

                    }
                    else
                        FleetName = GetFleetName(UserID, FleetId);
                }
                catch
                {
                }

                crParameterDiscreteValue.Value = FleetName;// GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

              //  if (rFormat == 2)
               // {
               //     ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
               // }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int ViolationReport_NewSafetyMatrix_WithoutRailData(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;

            try
            {
                orgId = GetOrganizationIdByUserId(UserID);
                Log("-->ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                string[] tmp = xmlParams.Split('*');
                string[] extraParams = xmlParams.Split('|');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReportExtended.xsd"));

                //if (extraParams[1] != null && extraParams[1] != "" && extraParams[1] != "-1")
                GetViolationInfo_NewSafetyMatrix_WithoutRail(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, 0, extraParams[1], ref dsCrystal);
                //else
                //    GetViolationInfo_NewSafetyMatrix(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, 0, ref dsCrystal);


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {

                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report doesn't contain any data", "");

                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_ViolationReport_NewSafetyMatrix.rpt"));


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string[] mFleet;
                string FleetName = "";

                try
                {
                    string tmpFleets = Util.PairFindValue("OrganizationHierarchyFleetId", xmlParams);


                    if (FleetId == 0 && tmpFleets != "")
                    {
                        mFleet = tmpFleets.Split(',');
                        for (int i = 0; i <= mFleet.GetUpperBound(0); i++)
                        {
                            FleetName += GetFleetName(UserID, Convert.ToInt32(mFleet[i])) + " ; ";
                        }

                    }
                    else
                        FleetName = GetFleetName(UserID, FleetId);
                }
                catch
                {
                }

                crParameterDiscreteValue.Value = FleetName;// GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int ViolationVehicleReport(Int32 UserID, string SID, int boxId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;

            try
            {
                orgId = GetOrganizationIdByUserId(UserID);
                Log("-->ViolationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, boxId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();
                string[] tmp = xmlParams.Split('*');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

               // GetViolationInfoVehicle(UserID, boxId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(tmp[1]), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            if (orgId != 951 || orgId != 999994)
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                            else
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();




                if (orgId == 951 || orgId == 999994)
                    oRpt.Load(this.GetReportPath("rpt_ViolationVehicleReport_UP.rpt"));
                //else if (lang.ToLower().Contains("fr"))
                //    oRpt.Load(this.GetReportPath("rpt_ViolationReport_fr.rpt"));
                //else
                //    oRpt.Load(this.GetReportPath("rpt_ViolationReport.rpt"));




                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                ////            if (lang == "fr" && lang != null)
                //if (ASIErrorCheck.IsLangSupported(lang))
                //{
                //    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                //    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                //}

                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport( userId = {0}, fromDate = {1}, toDate={2},BoxId={3} )", UserID, FromDate, ToDate, boxId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int ViolationReport_Hierarchy(Int32 UserID, string SID, string  nodeCode, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log("-->ViolationReport_Hierarchy( userId = {0}, fromDate = {1}, toDate={2},nodeCode={3} )", UserID, FromDate, ToDate, nodeCode);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();
                string[] tmp = xmlParams.Split('*');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                GetViolationInfo_Hierarchy(UserID, nodeCode, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(tmp[1]), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_ViolationReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = nodeCode; 

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport_Hierarchy( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate,nodeCode );
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int DriverViolationReportNew(Int32 UserID, string SID, int DriverId, string FromDate, string ToDate, int speed, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;

            try
            {
                Log("-->DriverViolationReportNew( userId = {0}, fromDate = {1}, toDate={2},DriverId={3} )", UserID, FromDate, ToDate, DriverId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                 orgId = GetOrganizationIdByUserId(UserID);
                DataSet dsCrystal = new DataSet();


                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtDriverViolations(UserID, DriverId, 63, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), speed);
                    dsCrystal.Tables[0].TableName = "rpt_ViolationReport";
                }



                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        { 
			   if (orgId == 951 || orgId == 999994)
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Infraction Report doesn't contain any data", "");
                            else
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();
               
                if (orgId == 999994)
                    oRpt.Load(this.GetReportPath("rpt_ViolationDriverReport_UP.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_ViolationDriverReport.rpt"));

             

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptDriverViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_DriverViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--DriverViolationReportNew( userId = {0}, fromDate = {1}, toDate={2} )", UserID, FromDate, ToDate);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationDetail");
                }



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--DriverViolationReportNew( userId = {0}, fromDate = {1}, toDate={2},DriverId={3} )", UserID, FromDate, ToDate, DriverId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (orgId != 951)
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Violation Report failed", "");
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Infraction Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int ViolationReport_CP(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log("-->ViolationReport_CP( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();
                string[] tmp = xmlParams.Split('*');

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                GetViolationInfo(UserID, FleetId, Convert.ToInt32(tmp[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(tmp[1]), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();


                //System.Drawing.Printing.PrintDocument printDoc = new System.Drawing.Printing.PrintDocument();
                //printDoc.PrinterSettings.PrinterName = "Microsoft XPS Document Writer";

                //PaperSize pkSize = new PaperSize();
                //int rawKind = 0;

                //for (int a = 0; a < printDoc.PrinterSettings.PaperSizes.Count; a++)
                //{

                //    if (printDoc.PrinterSettings.PaperSizes[a].PaperName == "15x11")
                //    {
                //        rawKind = Convert.ToInt16(printDoc.PrinterSettings.PaperSizes[a].GetType().GetField("kind", System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic).GetValue(printDoc.PrinterSettings.PaperSizes[a]));
                //        break;

                //    }

                //}

                //oRpt.PrintOptions.PaperSize = (CrystalDecisions.Shared.PaperSize)rawKind;

                //System.Drawing.Printing.PaperSize pkSize = new System.Drawing.Printing.PaperSize();
                //pkSize.Height=20; 
                //pkSize.Width=20;
                ////oRpt.PrintOptions.PaperSize = (CrystalDecisions.Shared.PaperSize)pkSize.ToString()  ;
                //oRpt.PrintOptions.PaperSize = (CrystalDecisions.Shared.PaperSize)pkSize.RawKind; 


                oRpt.Load(this.GetReportPath("rpt_ViolationReport_CP.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Violation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReport_CP( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int IdlingMessagesDetailReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->IdlingMessagesDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilization.xsd"));

                GetIdlingMessagesDetails(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Detail Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_IdlingMessagesDetailsFleet.rpt"));


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingDetailsFleet)), lang);

                GetUserPreferences(UserID);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptIdlingReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_IdlingDetailsFleet" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--IdlingMessagesDetailReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptIdlingReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--IdlingMessagesDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Detail Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int IdlingDetailReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->IdlingDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUtilization.xsd"));

                GetIdlingDetails(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Detail Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_IdlingDetailsFleet.rpt"));


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingDetailsFleet)), lang);

                GetUserPreferences(UserID);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptIdlingReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_IdlingDetailsFleet" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptIdlingReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "IdlingDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--IdlingDetailReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Detail Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int IdlingSummaryOrgReport(Int32 UserID, string SID, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->IdlingSummaryOrgReport( userId = {0}, fromDate = {1}, toDate={2} )", UserID, FromDate, ToDate);

                bool requestOverflowed = false;

                DataSet ds = new DataSet();


                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstIdlingSummaryReport.xsd"));

                DataSet dsFleets = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Fleet dbFleet = new VLF.DAS.Logic.Fleet(ConnnectionString ))
                using (VLF.DAS.Logic.Fleet dbFleet = new VLF.DAS.Logic.Fleet(ConnnectionString))
                {
                    dsFleets = dbFleet.GetFleetsInfoByUserId(UserID);
                }

                if (!Util.IsDataSetValid(dsFleets))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Organization Idling Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                foreach (DataRow dr in dsFleets.Tables[0].Rows)
                {
                    GetIdlingDataByFleetID(UserID, Convert.ToInt32(dr["FleetId"]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                }




                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_IdlingSummaryReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingSummaryOrg)), lang);

                GetUserPreferences(UserID);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptIdlingReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_IdlingSummaryReport" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptIdlingReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "IdlingSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--IdlingSummaryOrgReport( userId = {0}, fromDate = {1}, toDate={2} )", UserID, FromDate, ToDate);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Organization Idling Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int IdlingSummaryReportByOrgId(Int32 UserID, string SID, Int32 OrgId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->IdlingSummaryOrgReport( userId = {0}, fromDate = {1}, toDate={2} )", UserID, FromDate, ToDate);



                DataSet ds = new DataSet();


                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstIdlingSummaryReportNew.xsd"));

                GetIdlingDataByOrganizationID(UserID, OrgId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ref dsCrystal);
                GetUserPreferences(UserID);


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_IdlingSummaryReportNew.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingSummaryReportNew)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptIdlingReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_IdlingSummaryReportNew" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, "");
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptIdlingReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--IdlingSummaryOrgReport( userId = {0}, fromDate = {1}, toDate={2} )", UserID, FromDate, ToDate);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Summary Report by Organization ID failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int ViolationReportWithScore(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                //ReportsOutputPathURL = ConfigurationManager.AppSettings["ReportsOutputPathURL"];
                //ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
                //ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);

                GetViolationInfoWithScore(UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);
                orgId = GetOrganizationIdByUserId(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            if (orgId != 951)
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score doesn't contain any data", "");
                            else
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report with Score doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                
		string[] points = ViolationPoints.Split(';');

               // if (orgId == 951 || orgId == 999994)
                if (points.Length>8)
                    oRpt.Load(this.GetReportPath("rpt_ViolationSummary_UP.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_ViolationSummary.rpt"));

                

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                 points = ViolationPoints.Split(';');


                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


		 if (points.Length > 8)
                {

                    crParameterDiscreteValue.Value = points[8];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseSpeed"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[9];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseDistance"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[10];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["HighRail"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                }


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string Speed1 = "120";
                string Speed2 = "130";
                string Speed3 = "140";

                if (UnitOfMes != 1)
                {
                    Speed1 = "75";
                    Speed2 = "80";
                    Speed3 = "85";
                }

                crParameterDiscreteValue.Value = Speed1;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed2;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed3;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //export to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (orgId != 951)
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score failed", "");
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report with Score failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int ViolationReportWithScore_NewSafetyMatrix(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3},xmlParams={4} )", UserID, FromDate, ToDate, FleetId, xmlParams);

                //ReportsOutputPathURL = ConfigurationManager.AppSettings["ReportsOutputPathURL"];
                //ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
                //ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReportExtended_NewSafetyMatrix.xsd"));

                string[] extraParams = xmlParams.Split('|');

                if (xmlParams.Contains("|"))
                    xmlParams = xmlParams.Substring(0, xmlParams.IndexOf("|"));

                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);



                ///if (extraParams[1] != null && extraParams[1] != "" && extraParams[1] != "-1")
                    GetViolationInfoWithScore_NewSafetyMatrix (UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang,extraParams[1], ref dsCrystal);
                ///else
                 ///   GetViolationInfoWithScore_NewSafetyMatrix(UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);

                orgId = GetOrganizationIdByUserId(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                string[] points = ViolationPoints.Split(';');


                oRpt.Load(this.GetReportPath("rpt_ViolationSummary_UP_Extended_NewSafetyMatrix.rpt"));
                


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string[] mFleet;
                string FleetName = "";

                try
                {
                    string tmpFleets = Util.PairFindValue("OrganizationHierarchyFleetId", xmlParams);


                    if (FleetId == 0 && tmpFleets != "")
                    {
                        mFleet = tmpFleets.Split(',');
                        for (int i = 0; i <= mFleet.GetUpperBound(0); i++)
                        {
                            FleetName += GetFleetName(UserID, Convert.ToInt32(mFleet[i])) + " ; ";
                        }

                    }
                    else
                        FleetName = GetFleetName(UserID, FleetId);
                }
                catch
                {
                }

                crParameterDiscreteValue.Value = FleetName;// GetFleetName(UserID, FleetId);



                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);







                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //if (orgId == 951 ||  orgId ==999994)
                if (points.Length > 8)
                {

                    crParameterDiscreteValue.Value = points[8];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseSpeed"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[9];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseDistance"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[10];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["HighRail"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                }


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = orgId;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["OrgId"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string Speed1 = "120";
                string Speed2 = "130";
                string Speed3 = "140";

                if (UnitOfMes != 1)
                {
                    Speed1 = "75";
                    Speed2 = "80";
                    Speed3 = "85";
                }

                crParameterDiscreteValue.Value = Speed1;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed2;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed3;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //export to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (orgId != 951 || orgId != 999994)
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score failed", "");
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report with Score failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                Log("ViolationReportWithScore-->" + Ex.Message.ToString());

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int ViolationReportWithScore_NewSafetyMatrix_WithoutRailData(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3},xmlParams={4} )", UserID, FromDate, ToDate, FleetId, xmlParams);

                //ReportsOutputPathURL = ConfigurationManager.AppSettings["ReportsOutputPathURL"];
                //ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
                //ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];

                bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolation_NewSafetyMatrix.xsd"));

                string[] extraParams = xmlParams.Split('|');

                if (xmlParams.Contains("|"))
                    xmlParams = xmlParams.Substring(0, xmlParams.IndexOf("|"));

                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);



                ///if (extraParams[1] != null && extraParams[1] != "" && extraParams[1] != "-1")
                GetViolationInfoWithScore_NewSafetyMatrix_WithoutRail (UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, extraParams[1], ref dsCrystal);
                ///else
                ///   GetViolationInfoWithScore_NewSafetyMatrix(UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);

                orgId = GetOrganizationIdByUserId(UserID);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                string[] points = ViolationPoints.Split(';');


                oRpt.Load(this.GetReportPath("rpt_ViolationSummary_NewSafetyMatrix.rpt"));



                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string[] mFleet;
                string FleetName = "";

                try
                {
                    string tmpFleets = Util.PairFindValue("OrganizationHierarchyFleetId", xmlParams);


                    if (FleetId == 0 && tmpFleets != "")
                    {
                        mFleet = tmpFleets.Split(',');
                        for (int i = 0; i <= mFleet.GetUpperBound(0); i++)
                        {
                            FleetName += GetFleetName(UserID, Convert.ToInt32(mFleet[i])) + " ; ";
                        }

                    }
                    else
                        FleetName = GetFleetName(UserID, FleetId);
                }
                catch
                {
                }

                crParameterDiscreteValue.Value = FleetName;// GetFleetName(UserID, FleetId);



                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);







                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = points[8];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[9];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[10];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[11];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseSpeed"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[12];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseDistance"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[13];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["HighRail"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //export to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (orgId != 951 || orgId != 999994)
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score failed", "");
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Infraction Report with Score failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                Log("ViolationReportWithScore-->" + Ex.Message.ToString());

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }       
        
        [WebMethod]
        public int ViolationReportWithScore_Hierarchy(Int32 UserID, string SID, string  NodeCode, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationReportWithScore_Hierarchy( userId = {0}, fromDate = {1}, toDate={2},NodeCode={3} )", UserID, FromDate, ToDate, NodeCode);

                //ReportsOutputPathURL = ConfigurationManager.AppSettings["ReportsOutputPathURL"];
                //ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
                //ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];

                
                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);

                GetViolationInfoWithScore_Hierarchy(UserID, NodeCode, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_ViolationSummary.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = NodeCode;

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string[] points = ViolationPoints.Split(';');


                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string Speed1 = "120";
                string Speed2 = "130";
                string Speed3 = "140";

                if (UnitOfMes != 1)
                {
                    Speed1 = "75";
                    Speed2 = "80";
                    Speed3 = "85";
                }

                crParameterDiscreteValue.Value = Speed1;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed2;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed3;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--ViolationReportWithScore_Hierarchy( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //export to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetViolationSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReportWithScore_Hierarchy( userId = {0}, fromDate = {1}, toDate={2},NodeCode={3} )", UserID, FromDate, ToDate, NodeCode);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        private void ManipulateExcelFile(string fileName, string xmlTempName)
        {
            string path = Server.MapPath("~/Reports");
            string excelTemplate = System.IO.Path.Combine(path, @"ExcelTemplates\" + xmlTempName + ".xml");
            if (System.IO.File.Exists(excelTemplate) && System.IO.File.Exists(fileName))
            {
                try
                {
                    Log("Mainipulate Excel File Start");
                    //The code for using Excel Automation to do excel file changes
                    //ExcelOperationLib.ExcelOperatorInterface intr = new ExcelOperationImplOA.ExcelOperatorOA();
                    //Using NPOI open source library to do excel file changes
                    //This is preferred way
                    ExcelOperationLib.ExcelOperatorInterface intr = new ExcelOperationImplNPOI.ExcelOperatorNPOI();
                    intr.FileName = fileName;
                    intr.Commands = ExcelOperationLib.Helper.ReadFromXml(excelTemplate);
                    intr.Run();
                    Log("Mainipulate Excel File End");
                }
                catch (Exception ex)
                {
                    Log("Mainipulate Excel File Failed =>" + ex.Message);
                    //If failed to manipulate excel file, just leave it as originally one generated by CrystalReport
                }
            }
        }







        [WebMethod]
        public int ViolationsMonthlyData(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, ref string xml)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationsMonthlyData( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                string xmlParams = "63;10;20;50;20;10;20;10;50";


                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString ))
                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationMonthlyData(FleetId, UserID, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints);
                }


                Log("<--ViolationsMonthlyData( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;


            }
            catch (Exception Ex)
            {

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int ViolationReportWithScore_Special(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->ViolationReportWithScore_Special( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                //ReportsOutputPathURL = ConfigurationManager.AppSettings["ReportsOutputPathURL"];
                //ReportsOutputPath = @ConfigurationManager.AppSettings["ReportsOutputPath"];
                //ReportsDataSetPath = @ConfigurationManager.AppSettings["ReportsDataSetPath"];


                DataSet dsCrystal = new DataSet();
                DataSet ds = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);

                GetViolationInfoWithScore_Special(UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_ViolationSummary_Special.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string[] points = ViolationPoints.Split(';');


                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string Speed1 = "120";
                string Speed2 = "130";
                string Speed3 = "140";

                if (UnitOfMes != 1)
                {
                    Speed1 = "75";
                    Speed2 = "80";
                    Speed3 = "85";
                }

                crParameterDiscreteValue.Value = Speed1;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed2;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed3;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptViolationReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_ViolationSummary" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }
                ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--ViolationReportWithScore( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report with Score failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int FleetMaintenaceReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->FleetMaintenaceReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstMaintenanceReport.xsd"));

                //StringReader strrXML = null;
                DataSet ds = GetFleetMaintenance(UserID, xmlParams, lang, ref RequestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Maintenance Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                //DataColumn colCurrentValue = new DataColumn("CurrentValue", Type.GetType("System.String"));
                //ds.Tables[0].Columns.Add(colCurrentValue);

                //DataColumn colStatus = new DataColumn("Status", Type.GetType("System.String"));
                //ds.Tables[0].Columns.Add(colStatus);

                //GetUserPreferences(UserID);

                //foreach (DataRow dr in ds.Tables[0].Rows)
                //{
                //   if (Convert.ToSingle(dr["CurrentEngHrs"]) != 0)
                //   {
                //      dr["CurrentValue"] = dr["CurrentEngHrs"] + " Hrs";
                //      dr["Status"] = Convert.ToString(Math.Round((Convert.ToSingle(dr["CurrentEngHrs"]) * 100) / (Convert.ToSingle(dr["LastSrvEngHrs"]) + Convert.ToSingle(dr["EngHrsSrvInterval"])), 2));
                //   }
                //   else if (Convert.ToSingle(dr["CurrentOdo"]) != 0)
                //   {
                //      if (UnitOfMes == 1)
                //         dr["CurrentValue"] = dr["CurrentOdo"] + " km";
                //      if (UnitOfMes == 0.6214)
                //         dr["CurrentValue"] = dr["CurrentOdo"] + " mi";

                //      if (Convert.ToSingle(dr["LastSrvOdo"]) != 0 && Convert.ToSingle(dr["MaxSrvInterval"]) != 0)
                //         dr["Status"] = Convert.ToString(Math.Round((Convert.ToSingle(dr["CurrentOdo"]) * 100) / (Convert.ToSingle(dr["LastSrvOdo"]) + Convert.ToSingle(dr["MaxSrvInterval"])), 2));
                //      else
                //         dr["Status"] = null;
                //   }
                //}

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_MaintenanceReport"]);
                dsCrystal.Tables["rpt_MaintenanceReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                // LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_FleetMaintenance.rpt"));

                oRpt.SetDataSource(dsCrystal);
                GetUserPreferences(UserID);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (lang.ToLower().Contains("fr") ? true : false);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsFr"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptFleetMaintenance", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_FleetMaintenance" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }

                ReportName = this.GetReportName("rptFleetMaintenance", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "FleetMaintenance");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--FleetMaintenaceReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Maintenance Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      Get landmark summary report for fleet
        ///      GUID : 21
        ///      xmlParams : LM=what is there;
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark summary report for fleet")]
        public int LandmarkFleetReport(Int32 UserID, string SID, int fleetId, string FromDate, string ToDate,
                                      string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                string landmark = "";

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];              
                //}


                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);


                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                if (String.IsNullOrEmpty(FromDate))
                    throw new ArgumentException("XML Params string error: FromDate is null or empty");
                if (String.IsNullOrEmpty(ToDate))
                    throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //   dsCrystal = rpt.GetLandmarkFleetSummaryReport(UserID, fleetId, landmark,
                //                                             Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //}

                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //   ReportPath = "";
                //   return (int)InterfaceError.NoError;
                //}

                //LocalizeAddress(lang, ref dsCrystal);

                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));
                //dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarksReport.xsd"));
                //oRpt.SetDataSource(dsCrystal);



                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkFleetDetailsReport(UserID, fleetId, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Landmarks)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarksReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Landmarks" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }

                ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      Get landmark summary report for vehicle
        ///      GUID : 21
        ///      xmlParams : LM=why is there;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark summary report for vehicle")]
        public int LandmarkVehicleReport(Int32 UserID, string SID, string FromDate, string ToDate,
                                         string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                string landmark = "", plateNo = "", strFrom = "", strTo = "";
                //long vehicleId = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];
                //   plateNo = json[ReportTemplate.RptParamLicensePlate];
                //}

                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);
                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);



                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: License Plate is null or empty");
                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                //DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //   dsCrystal = rpt.GetLandmarkVehicleSummaryReport(UserID, plateNo, landmark,
                //                                    Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //}

                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //   ReportPath = "";
                //   return (int)InterfaceError.NoError;
                //}

                //LocalizeAddress(lang, ref dsCrystal);

                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));

                //dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarksReport.xsd"));

                //oRpt.SetDataSource(dsCrystal);




                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkVehicleDetailsReport(UserID, plateNo, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Landmarks)), lang);

                # region Report parameters

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarksReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Landmarks" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkSummary");
                }
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      Get landmark details report for vehicle
        ///      GUID : 23
        ///      xmlParams : LM=what is there;LicensePlate=LP_234543
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark details report for vehicle")]
        public int LandmarkVehicleDetailsReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkVehicleDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                string landmark = "", plateNo = "", strFrom = "", strTo = "";
                //long vehicleId = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];
                //   plateNo = json[ReportTemplate.RptParamLicensePlate];
                //   //strFrom = json[ReportTemplate.RptParamFromDateTime];
                //   //strTo = json[ReportTemplate.RptParamToDateTime];
                //}


                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);
                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);


                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: License Plate is null or empty");
                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkVehicleDetailsReport(UserID, plateNo, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_LandmarkDetails.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_LandmarkDetails)), lang);

                # region Report parameters

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkVehicleDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Details Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      Get landmark details report for fleet
        ///      GUID : 23
        ///      xmlParams : LM=what is there
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark details report for fleet")]
        public int LandmarkFleetDetailsReport(Int32 UserID, string SID, int fleetId, string FromDate, string ToDate,
                                               string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                string landmark = "", strFrom = "", strTo = "";

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];
                //   //strFrom = json[ReportTemplate.RptParamFromDateTime];
                //   //strTo = json[ReportTemplate.RptParamToDateTime];
                //}


                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);



                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkFleetDetailsReport(UserID, fleetId, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_LandmarkDetails.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_LandmarkDetails)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Details Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      this is the summary geozone report for fleet
        ///      GUID : 22
        ///      xmlParams : GZ=2
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get Geozone report for fleet")]
        public int GeozoneFleetReport(Int32 UserID, string SID, int fleetId, string FromDate,
                                string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                string strFrom = "", strTo = "";
                long geozone = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   if (!Int64.TryParse(json[ReportTemplate.RptParamGeozone], out geozone))
                //      throw new ArgumentException("XML Params string error: Geozone is null or empty");
                //}

                geozone = Convert.ToInt64(Util.PairFindValue(ReportTemplate.RptParamGeozone, xmlParams));

                if (String.IsNullOrEmpty(FromDate))
                    throw new ArgumentException("XML Params string error: FromDate is null or empty");
                if (String.IsNullOrEmpty(ToDate))
                    throw new ArgumentException("XML Params string error: ToDate is null or empty");

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetGeozoneReport(UserID, fleetId, geozone,
                                                           Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                
		 if (!lang.ToLower().Contains("fr"))
                    oRpt.Load(this.GetReportPath("rpt_Geozone.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_Geozone_fr.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstGeozoneReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptGeozoneReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "GeozoneSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///         return a detail of the geozone activity for fleet
        ///         GUID: 30
        ///         xmlParams : GZ=2
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get Geozone report for fleet")]
        public int GeozoneFleetDetailsReport(Int32 UserID, string SID, int fleetId, string FromDate, string ToDate,
                                              string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                bool chkShowOdometer = false;
                long geozone = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //    if (!Int64.TryParse(json[ReportTemplate.RptParamGeozone], out geozone))
                //        throw new ArgumentException("XML Params string error: Geozone is null or empty");
                //}


                geozone = Convert.ToInt64(Util.PairFindValue(ReportTemplate.RptParamGeozone, xmlParams));
                string[] tmp = xmlParams.Split('|');  
                if (tmp.Length>1) 
                    chkShowOdometer=Convert.ToBoolean(tmp[1]);


                if (String.IsNullOrEmpty(FromDate))
                    throw new ArgumentException("XML Params string error: FromDate is null or empty");
                if (String.IsNullOrEmpty(ToDate))
                    throw new ArgumentException("XML Params string error: ToDate is null or empty");

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetGeozoneDetailsReport(UserID, fleetId, geozone,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Fleet Details Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                   if (!lang.ToLower().Contains("fr"))
                    oRpt.Load(this.GetReportPath("rpt_GeoZoneDetails.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_GeoZoneDetails_fr.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstGeozoneReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_GeoZoneDetails )), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = chkShowOdometer;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ShowOdometer"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptGeozoneReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "GeozoneDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneFleetDetailsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Fleet Details Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        /// <summary>
        ///         get detailed geozone activity per vehicle 
        ///         GUID:30
        ///         xmlParams : GZ=2;LicensePlate=LP_3456
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get Geozone Details report for vehicle")]
        public int GeozoneDetailsVehicleReport(Int32 UserID, string SID, string FromDate, string ToDate,
                                                   string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneDetailsVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                long geozone = -1/*, vehicleId = -1*/;
                string plateNo = "";
                bool chkShowOdometer = false;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //    if (!Int64.TryParse(json[ReportTemplate.RptParamGeozone], out geozone))
                //        throw new ArgumentException("XML Params string error: Geozone is null or empty");
                //    plateNo = json[ReportTemplate.RptParamLicensePlate];                  
                //}

                geozone = Convert.ToInt64(Util.PairFindValue(ReportTemplate.RptParamGeozone, xmlParams));
                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);

                string[] tmp = xmlParams.Split('|');
                if (tmp.Length > 1)
                    chkShowOdometer = Convert.ToBoolean(tmp[1]);


                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: Vehicle is null or empty");

                if (String.IsNullOrEmpty(FromDate))
                    throw new ArgumentException("XML Params string error: FromDate is null or empty");
                if (String.IsNullOrEmpty(ToDate))
                    throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleGeozoneDetailsReport(UserID, plateNo, geozone,
                                                             Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Details for Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_GeoZoneDetails.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstGeozoneReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_GeoZoneDetails )), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = chkShowOdometer;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ShowOdometer"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptGeozoneDetailsReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "GeozoneDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneDetailsVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Details for Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///      Get summary Geozone report for vehicle
        ///      GUID : 22
        ///      xmlParams : GZ=20;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get summary geozone report for vehicle")]
        public int GeozoneVehicleReport(Int32 UserID, string SID, string FromDate, string ToDate,
                                   string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                long geozone = -1/*, vehicleId = -1*/;
                string plateNo = "", strFrom = "", strTo = "";

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   if (!Int64.TryParse(json[ReportTemplate.RptParamGeozone], out geozone))
                //      throw new ArgumentException("XML Params string error: Geozone is null or empty");
                //   plateNo = json[ReportTemplate.RptParamLicensePlate];
                //   //strFrom = json[ReportTemplate.RptParamFromDateTime];
                //   //strTo = json[ReportTemplate.RptParamToDateTime];
                //}


                geozone = Convert.ToInt64(Util.PairFindValue(ReportTemplate.RptParamGeozone, xmlParams));
                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);




                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: Vehicle is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleGeozoneReport(UserID, plateNo, geozone,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Geozone.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstGeozoneReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptGeozoneReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "GeozoneSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Geozone Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///      Get summary Geozone report for vehicle
        ///      GUID : 22
        ///      xmlParams : GZ=20;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get Time Sheet Report by Geozone")]
        public int GeozoneTimeSheetReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate,
                                   string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);



                DataSet dsCrystal = new DataSet();

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleGeozoneTimeSheetReport(UserID, FleetId,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Timesheet  Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables[0].TableName = "GeozoneDetails";
                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (xmlParams == "Details")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetReport.rpt"));
                else if (xmlParams == "Summary")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetSummaryReport.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstBrickmanTimesheet.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptTimeSheetValidationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "TimeSheet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      Get summary Geozone report for vehicle
        ///      GUID : 22
        ///      xmlParams : GZ=20;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get Time Sheet Report by Geozone")]
        public int GeozoneTimeSheetReport_ActiveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate,
                                   string xmlParams, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);



                DataSet dsCrystal = new DataSet();

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleGeozoneTimeSheetReport(UserID, FleetId,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), activeVehicles);
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Timesheet  Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables[0].TableName = "GeozoneDetails";
                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (xmlParams == "Details")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetReport.rpt"));
                else if (xmlParams == "Summary")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetSummaryReport.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstBrickmanTimesheet.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptTimeSheetValidationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "TimeSheet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod(Description = "Get Time Sheet Report by Geozone")]
        public int GeozoneTimeSheetReport201107(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate,
                                   string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);



                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleGeozoneTimeSheetReport201107(UserID, FleetId,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Timesheet  Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables[0].TableName = "GeozoneDetails";
                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (xmlParams == "Details")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetReport.rpt"));
                else if (xmlParams == "Summary")
                    oRpt.Load(this.GetReportPath("BrickmanTimesheetSummaryReport.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstBrickmanTimesheet.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptTimeSheetValidationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--GeozoneTimeSheetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "TimeSheet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod(Description = "Get WorkSite Activity Per Day")]
        public int WorksiteActivityPerDay(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate,
                                   string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->WorksiteActivityPerDay( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);



                DataSet dsCrystal = new DataSet();

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetWorksiteActivityPerDay(UserID, FleetId,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables[0].TableName = "Details";
                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("BrickmanWorksiteActivityPerDay.rpt"));

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstBrickmanActivitiesPerDay.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Geozone)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                // gz name
                //crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("BrickmanWorksiteActivityPerDay", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--WorksiteActivityPerDay( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "TimeSheet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      Vehicle Inactivity Report
        ///      GUID : 24
        ///      xmlParams : SENSOR_NUM=3;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Vehicle Inactivity Report")]
        public int InactivityReport4Vehicle(Int32 UserID, string SID, string FromDate, string ToDate,
                                      string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->InactivityReport4Vehicle( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                long vehicleId = -1;
                short sensorId = -1;
                string plateNo = "", strFrom = "", strTo = "";

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   plateNo = json[ReportTemplate.RptParamLicensePlate];
                //   sensorId = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                //   //strFrom = json[ReportTemplate.RptParamFromDateTime];
                //   //strTo = json[ReportTemplate.RptParamToDateTime];
                //}


                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);
                sensorId = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));




                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: Vehicle is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal =
                       rpt.GetVehicleInactivityReport(UserID, plateNo, sensorId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Inactivity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                //LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Inactivity.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstInactivityReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Inactivity)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                // name
                //crParameterDiscreteValue.Value = "";
                //crParameterFieldDefinition = crParameterFieldDefinitions[""];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptInactivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "InactivityReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--InactivityReport4Vehicle( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), " Vehicle Inactivity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      Fleet Inactivity Report
        ///      GUID :  24
        ///      xmlParams : SENSOR_NUM=3
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat">1 pdf, 2 xls, 3 doc, 4 html </param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Fleet Inactivity Report")]
        public int InactivityReport4Fleet(Int32 UserID, string SID, int fleetId, string FromDate, string ToDate,
                                            string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->InactivityReport4Fleet( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                string strFrom = "", strTo = "";
                short sensorId = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   sensorId = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                //   //strFrom = json[ReportTemplate.RptParamFromDateTime];
                //   //strTo = json[ReportTemplate.RptParamToDateTime];
                //}


                sensorId = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetInactivityReport(UserID, fleetId, sensorId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Inactivity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                //LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Inactivity.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstInactivityReport.xsd"));
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Inactivity)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                // sns name
                //crParameterDiscreteValue.Value = sensor;
                //crParameterFieldDefinition = crParameterFieldDefinitions["Sensor"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                # endregion

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptInactivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "InactivityReport");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--InactivityReport4Fleet( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Inactivity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        #region Driver reports

        [WebMethod(Description = "Driver Trip Details Report one by one")]
        public int DriverTripDetailsReportOneByOne(Int32 UserID, string SID, string FromDate, string ToDate,
                                         string xmlParams, int rFormat, string lang, ref bool requestOverflowed,
                                         ref bool outMaxOverflowed, ref string ReportPath)
        {
            try
            {
                Log("-->DriverTripDetailsReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                string prm1 = Util.PairFindValue(ReportTemplate.RptParamDriverId, xmlParams);
                string fromDateTime = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSecondParamName, xmlParams);
                string toDateTime = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripThirdParamName, xmlParams);
                string prm4 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFourthParamName, xmlParams);
                string prm5 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFifthParamName, xmlParams);
                string prm6 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSixthParamName, xmlParams);
                string prm7 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSeventhParamName, xmlParams);
                string prm8 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripEighthParamName, xmlParams);
                string prm9 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripNinthParamName, xmlParams);
                string prm10 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripTenthParamName, xmlParams);

                if (xmlParams == null || prm1 == null || fromDateTime == null || toDateTime == null || prm4 == null ||
                    prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null || prm10 == null)
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    // empty result
                    return (int)InterfaceError.InvalidParameter;
                }

                int totalSqlRecords = 0;
                int outMaxRecords = 0;

                int driverId;
                if (!Int32.TryParse(prm1, out driverId))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }
                bool includeStreetAddress = Convert.ToBoolean(prm4);
                bool includeSensors = Convert.ToBoolean(prm5);
                bool includePosition = Convert.ToBoolean(prm6);
                bool includeIdleTime = Convert.ToBoolean(prm7);
                bool includeSummary = Convert.ToBoolean(prm8);
                bool showLastStoredPosition = Convert.ToBoolean(prm9);
                int sensorId = int.Parse(prm10);
                requestOverflowed = false;
                totalSqlRecords = 0;
                outMaxOverflowed = false;
                outMaxRecords = 0;
                int sqlMaxOutRecords = 1000; // = GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records", 1000);
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (SystemConfig dbSystem = new SystemConfig(ConnnectionString))
                {
                    try
                    {
                        string keyValue = dbSystem.GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records");
                        sqlMaxOutRecords = int.Parse(keyValue);
                    }
                    catch
                    {
                        Trace.WriteLineIf(AppConfig.tsMain.TraceInfo,
                          VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info, "SystemConfig.GetConfigParameter failed"));
                    }
                }

                int currSqlRecords = 0;
                int outMaxFleetRecords = 0;
                outMaxOverflowed = false;
                DataSet dsCurrVehicleTrips = null;

                // prepare crystal report dataset, schema.
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSimpleTripReportData.xsd"));

                // prepare crystal report template
                string reportTemplate = includeSummary ? "rpt_SimpleTripReportData.rpt" : "rpt_SimpleTripReportData_NoSummary.rpt";
                //reportTemplate = Path.Combine(Server.MapPath(this.ReportsRootPath), reportTemplate);

                // get distance type
                GetUserPreferences(UserID);

                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }

                GetUserPreferences(UserID);

                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.CrystalDataSet = dsCrystal;
                reportState.Lang = lang;
                reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripReportData));
                reportState.ReportTemplateFile = this.GetReportPath(reportTemplate);
                reportState.ReportParameters = new Dictionary<string, object>();
                reportState.ReportParameters.Add("FromDate", FromDate);
                reportState.ReportParameters.Add("ToDate", ToDate);
                reportState.ReportParameters.Add("DistanceType", FindExistingPreference());
                reportState.ReportParameters.Add("UserTimeZone", "GMT" + UserTimeZone);

                string TripSummary = "";
                string TripStart = "";
                string TripEnd = "";
                switch (sensorId)
                {
                    case 3:
                        TripSummary = Resources.Const.TripSummary;
                        TripStart = Resources.Const.TripStart;
                        TripEnd = Resources.Const.TripEnd;
                        break;
                    case 8:
                        TripSummary = Resources.Const.TripSummaryPTO;
                        TripStart = Resources.Const.TripStartPTO;
                        TripEnd = Resources.Const.TripEndPTO;
                        break;
                    case 11:
                        TripSummary = Resources.Const.TripSummaryTP;
                        TripStart = Resources.Const.TripStartTP;
                        TripEnd = Resources.Const.TripEndTP;
                        break;
                    default:
                        TripSummary = Resources.Const.TripSummary;
                        TripStart = Resources.Const.TripStart;
                        TripEnd = Resources.Const.TripEnd;
                        break;
                }
                if (includeSummary)
                {
                    reportState.ReportParameters.Add("TripSummary", TripSummary);
                    reportState.ReportParameters.Add("TripStart", TripStart);
                    reportState.ReportParameters.Add("TripEnd", TripEnd);
                }

                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("rptTripData-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(this.ReportsOutputPath), String.Format("rptTripData-{0}{1}", Guid.NewGuid(), fileExt));

                // generate report one by one.
                TimeSpan retrievingTime = new TimeSpan();
                TimeSpan preparingTime = new TimeSpan();
                TimeSpan exportingTime = new TimeSpan();
                TimeSpan totalTime = new TimeSpan();
                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;

                DataSet licensePlateList = null;

                using (DAS.Logic.DriverManager driver = new DriverManager(ConnnectionString))
                {
                    licensePlateList = driver.GetAssignmentVehiclesByDriverId(driverId, Convert.ToDateTime(fromDateTime), Convert.ToDateTime(toDateTime));

                    if (!Util.IsDataSetValid(licensePlateList))
                    {
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                UpdateReportStatus(Convert.ToInt64(ReportPath), "Drivet Trip Details Report one by one doesn't contain any data", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        Trace.WriteLineIf(AppConfig.tsMain.TraceInfo,
                           VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                           String.Format("Driver [{0}] Assignment History for [{1} - {2}] not found", driverId, fromDateTime, toDateTime)));

                        return (int)InterfaceError.NoError;
                    }
                }

                Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   "licensePlateList: " + licensePlateList.Tables[0].Rows.Count));

                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);

                string licensePlate = "", endDT = "", startDT = "";

                for (int i = 0; i < licensePlateList.Tables[0].Rows.Count; i++)
                {
                    try
                    {
                        currSqlRecords = 0;
                        // 2. Retrieves trip info for every vehicle
                        DateTime t1 = DateTime.Now;
                        licensePlate = licensePlateList.Tables[0].Rows[i]["LicensePlate"].ToString().Trim();

                        if (Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["AssignedDateTime"]) < Convert.ToDateTime(fromDateTime))
                            startDT = fromDateTime;
                        else
                            startDT = Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["AssignedDateTime"]).ToString("MM/dd/yyyy");


                        if (!String.IsNullOrEmpty(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"].ToString()))
                        {
                            if (Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"]) > Convert.ToDateTime(toDateTime))
                                endDT = toDateTime;
                            else
                                endDT = Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"]).ToString("MM/dd/yyyy");
                        }

                        else
                            endDT = toDateTime;


                        dsCurrVehicleTrips = report.GetDetailedTripReport(licensePlate,
                                                                          startDT,
                                                                          endDT,
                                                                          includeStreetAddress,
                                                                          includeSensors,
                                                                          includePosition,
                                                                          includeIdleTime,
                                                                          includeSummary,
                                                                          showLastStoredPosition,
                                                                          UserID, sensorId, lang,
                                                                          ref requestOverflowed,
                                                                          ref currSqlRecords,
                                                                          ref outMaxOverflowed,
                                                                          ref outMaxRecords);

                        DateTime t2 = DateTime.Now;
                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }
                        totalSqlRecords += currSqlRecords;
                        outMaxFleetRecords += outMaxRecords;
                        if (sqlMaxOutRecords < outMaxFleetRecords)
                            outMaxOverflowed = true;
                        if (requestOverflowed || outMaxOverflowed)
                        {
                            break;
                        }
                        DateTime t3 = DateTime.Now;
                        if (dsCurrVehicleTrips != null && currSqlRecords > 0 && dsCurrVehicleTrips.Tables["TripReportData"]!=null && dsCurrVehicleTrips.Tables["TripReportData"] .Rows.Count>0)
                        {
                            dsCrystal.Clear();
                            if (includeSummary)
                            {
                                MergeTripSummaryTable(dsCurrVehicleTrips, dsCrystal, false);
                            }
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportData"], false, MissingSchemaAction.Ignore);
                            // parameters
                            string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                            reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);
                            asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                        }
                        DateTime t4 = DateTime.Now;
                        TimeSpan ts1, ts2, ts3, ts4;
                        ts1 = t2.Subtract(t1);
                        ts2 = t3.Subtract(t2);
                        ts3 = t4.Subtract(t3);
                        ts4 = t4.Subtract(t1);
                        retrievingTime += ts1;
                        preparingTime += ts3;
                        exportingTime += ts2;
                        totalTime += ts4;

                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                           String.Format("License Plate {0}: {1}, outMaxRecords {2}, currSqlRecords {3}, retrieve: {4:f2}, prepare: {5:f2}, export: {6:f2}, total: {7:f2}",
                           i + 1, licensePlate, outMaxRecords, currSqlRecords, ts1.TotalSeconds, ts3.TotalSeconds, ts2.TotalSeconds, ts4.TotalSeconds)));
                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error,
                           String.Format("Vehicle: [LP={0}] Error: {1}", licensePlate, ex.Message)));
                    }
                }

                DateTime t5 = DateTime.Now;
                // check and wait last report is done.
                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }


                string tmpReportName = "";

                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = tmpReportName;

                DateTime t6 = DateTime.Now;
                TimeSpan ts5 = t6.Subtract(t5);
                totalTime += ts5;

                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   String.Format("TripFleetDetailsReportOneByOne end: outMaxFleetRecords {0}, totalSqlRecords {1}, sqlMaxOutRecords {2}, retrieve: {3:f2}, prepare: {4:f2}, export: {5:f2}, merge: {6:f2}, total: {7:f2}",
                   outMaxFleetRecords, totalSqlRecords, sqlMaxOutRecords, retrievingTime.TotalSeconds, preparingTime.TotalSeconds, exportingTime.TotalSeconds, ts5.TotalSeconds, totalTime.TotalSeconds)));

                Log("<--DriverTripDetailsReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Trip Details Report one by one failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod(Description = "Driver Trip Summary Report one by one")]
        public int DriverTripSummaryReportOneByOne(Int32 UserID, string SID, string FromDate, string ToDate,
                                         string xmlParams, int rFormat, string lang, ref string ReportPath,
                                         ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                Log("-->DriverTripSummaryReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                string prm1 = Util.PairFindValue(ReportTemplate.RptParamDriverId, xmlParams);
                //string prm1 = Util.PairFindValue(ReportTemplate.RpFleetTripFirstParamName, xmlParams);
                string fromDateTime = Util.PairFindValue(ReportTemplate.RpFleetTripSecondParamName, xmlParams);
                string toDateTime = Util.PairFindValue(ReportTemplate.RpFleetTripThirdParamName, xmlParams);
                string prm4 = Util.PairFindValue(ReportTemplate.RpFleetTripFourthParamName, xmlParams);
                string prm5 = Util.PairFindValue(ReportTemplate.RpFleetTripFifthParamName, xmlParams);

                if (xmlParams == null || prm1 == null || fromDateTime == null || toDateTime == null || prm4 == null || prm5 == null)
                {
                    // empty result
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }

                int driverId;
                if (!Int32.TryParse(prm1, out driverId))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }
                int totalSqlRecords = 0;
                int outMaxRecords = 0;
                bool showLastStoredPosition;
                if (!Boolean.TryParse(prm4, out showLastStoredPosition))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }
                int sensorId;
                if (!int.TryParse(prm5, out sensorId))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.InvalidParameter;
                }
                requestOverflowed = false;
                totalSqlRecords = 0;
                outMaxOverflowed = false;
                outMaxRecords = 0;
                int sqlMaxOutRecords = 1000; // = GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records", 1000);
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (SystemConfig dbSystem = new SystemConfig(ConnnectionString))
                {
                    try
                    {
                        string keyValue = dbSystem.GetConfigParameter("ASI", (short)VLF.CLS.Def.Enums.ConfigurationGroups.Common, "Max Output Records");
                        sqlMaxOutRecords = int.Parse(keyValue);
                    }
                    catch
                    {
                    }
                }
                int currSqlRecords = 0;
                int outMaxFleetRecords = 0;
                outMaxOverflowed = false;
                DataSet dsCurrVehicleTrips = null;

                // prepare crystal report dataset, schema.
                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSimpleTripReportData.xsd"));

                // get distance type
                GetUserPreferences(UserID);
                string DistanceType = FindExistingPreference();
                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.CrystalDataSet = dsCrystal;
                reportState.Lang = lang;
                reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                reportState.ReportTemplateFile = this.GetReportPath("rpt_SimpleTripSummary.rpt");
                reportState.ReportParameters = new Dictionary<string, object>();
                reportState.ReportParameters.Add("FromDate", FromDate);
                reportState.ReportParameters.Add("ToDate", ToDate);
                reportState.ReportParameters.Add("DistanceType", DistanceType);
                reportState.ReportParameters.Add("TotTripTime", null);
                reportState.ReportParameters.Add("TotIdling", null);
                reportState.ReportParameters.Add("TotStopTime", null);
                reportState.ReportParameters.Add("TotCost", null);
                reportState.ReportParameters.Add("UserTimeZone", "GMT" + UserTimeZone);

                string TripTitle = "";

                switch (sensorId)
                {
                    case 3:
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                    case 8:
                        TripTitle = Resources.Const.TripType_PTO;
                        break;
                    case 11:
                        TripTitle = Resources.Const.TripType_TP;
                        break;
                    default:
                        TripTitle = Resources.Const.TripType_Trip;
                        break;
                }

                reportState.ReportParameters.Add("TripType", TripTitle);



                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(ReportsOutputPath), String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));

                // generate report one by one.
                TimeSpan retrievingTime = new TimeSpan();
                TimeSpan preparingTime = new TimeSpan();
                TimeSpan exportingTime = new TimeSpan();
                TimeSpan totalTime = new TimeSpan();
                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;

                DataSet licensePlateList = null;
                using (DAS.Logic.DriverManager driver = new DriverManager(ConnnectionString))
                {
                    licensePlateList = driver.GetAssignmentVehiclesByDriverId(driverId, Convert.ToDateTime(fromDateTime), Convert.ToDateTime(toDateTime));

                    if (!Util.IsDataSetValid(licensePlateList))
                    {
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                UpdateReportStatus(Convert.ToInt64(ReportPath), " Report doesn't contain any data", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        Trace.WriteLineIf(AppConfig.tsMain.TraceInfo,
                           VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                           String.Format("Driver [{0}] Assignment History for [{1} - {2}] not found", driverId, fromDateTime, toDateTime)));

                        return (int)InterfaceError.NoError;
                    }
                }

                Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   "licensePlateList: " + licensePlateList.Tables[0].Rows.Count));

                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);

                string licensePlate = "", endDT = "", startDT = "";

                for (int i = 0; i < licensePlateList.Tables[0].Rows.Count; i++)
                {
                    try
                    {
                        currSqlRecords = 0;
                        string strTotal = "";
                        TimeSpan totalTrip = new TimeSpan(0);
                        TimeSpan totalIdling = new TimeSpan(0);
                        TimeSpan totalStop = new TimeSpan(0);
                        Double totalCost = 0;

                        // 2. Retrieves trip info for every vehicle
                        DateTime t1 = DateTime.Now;

                        licensePlate = licensePlateList.Tables[0].Rows[i]["LicensePlate"].ToString().Trim();

                        if (Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["AssignedDateTime"]) < Convert.ToDateTime(fromDateTime))
                            startDT = fromDateTime;
                        else
                            startDT = Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["AssignedDateTime"]).ToString("MM/dd/yyyy");

                        if (!String.IsNullOrEmpty(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"].ToString()))
                        {
                            if (Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"]) > Convert.ToDateTime(toDateTime))
                                endDT = toDateTime;
                            else
                                endDT = Convert.ToDateTime(licensePlateList.Tables[0].Rows[i]["UnassignedDateTime"]).ToString("MM/dd/yyyy");
                        }

                        else
                            endDT = toDateTime;

                        dsCurrVehicleTrips = report.GetTripReport(licensePlate,
                                                                  startDT,
                                                                  endDT,
                                                                  UserID,
                                                                  showLastStoredPosition,
                                                                  sensorId,
                                                                  lang,
                                                                  ref requestOverflowed,
                                                                  ref currSqlRecords,
                                                                  ref outMaxOverflowed,
                                                                  ref outMaxRecords);

                        DateTime t2 = DateTime.Now;
                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }
                        totalSqlRecords += currSqlRecords;
                        outMaxFleetRecords += outMaxRecords;
                        if (sqlMaxOutRecords < outMaxFleetRecords)
                            outMaxOverflowed = true;
                        if (requestOverflowed || outMaxOverflowed)
                        {
                            break;
                        }
                        DateTime t3 = DateTime.Now;
                        if (dsCurrVehicleTrips != null && currSqlRecords > 0 )
                        {
                            dsCrystal.Clear();
                            Dictionary<string, string> vehicleSummary = MergeTripSummaryTable(dsCurrVehicleTrips, dsCrystal, true);
                            dsCrystal.Merge(dsCurrVehicleTrips.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
                            // parameters
                            string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                            reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);
                            reportState.ReportParameters["TotTripTime"] = vehicleSummary["TotTripTime"];
                            reportState.ReportParameters["TotIdling"] = vehicleSummary["TotIdling"]; ;
                            reportState.ReportParameters["TotStopTime"] = vehicleSummary["TotStopTime"];
                            reportState.ReportParameters["TotCost"] = vehicleSummary["TotCost"]; ;
                            asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                        }
                        DateTime t4 = DateTime.Now;
                        TimeSpan ts1 = new TimeSpan(), ts2 = new TimeSpan(), ts3 = new TimeSpan(), ts4 = new TimeSpan();
                        ts1 = t2.Subtract(t1);
                        ts2 = t3.Subtract(t2);
                        ts3 = t4.Subtract(t3);
                        ts4 = t4.Subtract(t1);
                        retrievingTime += ts1;
                        preparingTime += ts3;
                        exportingTime += ts2;
                        totalTime += ts4;

                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                          String.Format("License Plate {0}: {1}, outMaxRecords {2}, currSqlRecords {3}, retrieve: {4:f2}, prepare: {5:f2}, export: {6:f2}, total: {7:f2}",
                          i + 1, licensePlate, outMaxRecords, currSqlRecords, ts1.TotalSeconds, ts3.TotalSeconds, ts2.TotalSeconds, ts4.TotalSeconds)));
                    }
                    catch (Exception ex)
                    {
                        System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error,
                           String.Format("Vehicle: [LP={0}] Error: {1}", licensePlate, ex.Message)));
                    }
                    finally
                    {
                    }
                }
                DateTime t5 = DateTime.Now;
                // check and wait last report is done.
                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }

                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));
                //"http://" + ConfigurationManager.AppSettings["ServerIp"] + 
                //ConfigurationManager.AppSettings["ReportsRootPath"] + "/TmpReports/" + Path.GetFileName(reportState.MergedReportFile);

                DateTime t6 = DateTime.Now;
                TimeSpan ts5 = t6.Subtract(t5);
                totalTime += ts5;
                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceInfo, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
                   String.Format("TripFleetSummaryReportOneByOne end: outMaxFleetRecords {0}, totalSqlRecords {1}, sqlMaxOutRecords {2}, retrieve: {3:f2}, prepare: {4:f2}, export: {5:f2}, merge: {6:f2}, total: {7:f2}",
                   outMaxFleetRecords, totalSqlRecords, sqlMaxOutRecords, retrievingTime.TotalSeconds, preparingTime.TotalSeconds, exportingTime.TotalSeconds, ts5.TotalSeconds, totalTime.TotalSeconds)));
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<--DriverTripSummaryReportOneByOne( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Driver Trip Summary Report one by one failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod(Description = "Driver Violation Report")]
        public int DriverViolationReport(Int32 UserID, string SID, string FromDate, string ToDate,
                       string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;

            try
            {
                Log("-->DriverViolationReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);


                orgId = GetOrganizationIdByUserId(UserID);
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                string prm1 = Util.PairFindValue(ReportTemplate.RptParamDriverId, xmlParams);
                int driverId;
                if (!Int32.TryParse(prm1, out driverId))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.InvalidParameter;
                }

                string[] prms = xmlParams.Split(';');
                //bool requestOverflowed = false;
                //DataSet ds = new DataSet();
                string[] violations = prms[1].Split('*');

                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                DataSet ds = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                     if (orgId != 999994)
                        ds = dbReport.GetViolationReportForDriverByLang(
                            driverId, UserID, Convert.ToInt32(violations[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(violations[1]));
                    else
                        ds = dbReport.GetViolationReportForDriverByLang_Main(
                            driverId, UserID, Convert.ToInt32(violations[0]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), lang, Convert.ToInt32(violations[1]));

                }

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.NoError;
                }

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);
                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.NoError;
                }
                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();
                orgId = GetOrganizationIdByUserId(UserID);
               // if (orgId != 951)
                //    oRpt.Load(this.GetReportPath("rpt_DriverViolationReport.rpt"));
               // else
                 //   oRpt.Load(this.GetReportPath("rpt_DriverViolationReport_UP.rpt"));

		if (orgId !=999994)
                    oRpt.Load(this.GetReportPath("rpt_DriverViolationReport.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_DriverViolationReport_UP.rpt"));


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_DriverViolation)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                string DistanceType = FindExistingPreference();
                crParameterDiscreteValue.Value = "(" + DistanceType + @"\h)";
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // driver parameter
                crParameterDiscreteValue.Value = GetDriverFullName(UserID, driverId);
                crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }

                string ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "DriverViolationDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<--DriverViolationReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod(Description = "Driver Violation Summary Report")]
        public int DriverViolationSummaryReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {

            Int32 orgId = 0;
 

            try
            {

                Log("-->DriverViolationSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                int driverId;
                if (!Int32.TryParse(Util.PairFindValue(ReportTemplate.RptParamDriverId, xmlParams), out driverId))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Invalid Parameters", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.InvalidParameter;
                }
                //bool requestOverflowed = false;
                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationReport.xsd"));

                string[] prms = xmlParams.Split(';');

                string[] points = new string[prms.Length - 2];
                for (int i = 0; i < points.Length; i++)
                {
                    points[i] = prms[i + 2];
                }

                //GetViolationInfoWithScore(UserID, FleetId, Convert.ToInt32(ViolationMask), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ViolationPoints, lang, ref dsCrystal);
                DataSet ds = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                     if (orgId != 999994)
                        ds = dbReport.GetViolationReportForDriverWithScore(
                        driverId, UserID, Convert.ToInt32(prms[1]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), points);
                    else
                        ds = dbReport.GetViolationReportForDriverWithScore_Main(
                        driverId, UserID, Convert.ToInt32(prms[1]), Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), points);
                }

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), " Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
		      ReportPath = "";	
                      return (int)InterfaceError.NotFound ;
                }
                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);
                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                if (!Util.IsDataSetValid(dsCrystal))
                    return (int)InterfaceError.NoError;

                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                orgId = GetOrganizationIdByUserId(UserID);

                if (points.Length > 8)
			 oRpt.Load(this.GetReportPath("rpt_DriverViolationSummary_UP.rpt"));
	
                else

                    oRpt.Load(this.GetReportPath("rpt_DriverViolationSummary.rpt"));
                   



                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_DriverViolationSummary)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetDriverFullName(UserID, driverId);

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = points[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed120"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed130"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed140"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[4];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["AccHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[5];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingExtreme"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[6];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["BrakingHarsh"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = points[7];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["SeatBelt"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


		   //if (orgId == 951 ||  orgId ==999994)
                if (points.Length > 8)
                {

                    crParameterDiscreteValue.Value = points[8];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseSpeed"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[9];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["ReverseDistance"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                    crParameterDiscreteValue.Value = points[10];
                    crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                    crParameterFieldDefinition = crParameterFieldDefinitions["HighRail"];
                    crParameterValues = crParameterFieldDefinition.CurrentValues;
                    crParameterValues.Add(crParameterDiscreteValue);
                    crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                }


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string Speed1 = "120";
                string Speed2 = "130";
                string Speed3 = "140";

                if (UnitOfMes != 1)
                {
                    Speed1 = "75";
                    Speed2 = "80";
                    Speed3 = "85";
                }

                crParameterDiscreteValue.Value = Speed1;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed2;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = Speed3;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptViolationReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "DriverViolationSummary");
                }


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--DriverViolationSummaryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        #endregion Driver reports

        private void Log(string strFormat, params object[] objects)
        {
            try
            {
                //Trace.WriteLineIf(AppConfig.tsWeb.Enabled | AppConfig.tsMain.TraceVerbose,
                //     CLS.Util.TraceFormat(CLS.Def.Enums.TraceSeverity.WebInterfaces,
                //                       string.Format(strFormat, objects)));


                string constr = ConfigurationManager.ConnectionStrings["DBConnectionString"].ToString();

                //if any one point of a geozone exist within boundary retrieve it...

                string sqlb = "ReportLog_Add";
                SqlConnection con = new SqlConnection(constr);
                SqlCommand com = new SqlCommand(sqlb, con);
                com.Parameters.Clear();
                com.Parameters.AddWithValue("@LogData", string.Format(strFormat, objects));
                com.CommandType = CommandType.StoredProcedure;
                con.Open();
                com.ExecuteNonQuery();
                con.Close();
            }
            catch
            {

            }
        }



        /// <summary>
        ///      the exception should be saved in a separate file or in the Event log of the computer
        /// </summary>
        /// <param name="strFormat"></param>
        /// <param name="objects"></param>
        private void LogException(string strFormat, params object[] objects)
        {
            try
            {
                Trace.WriteLineIf(AppConfig.tsWeb.Enabled | AppConfig.tsMain.TraceError,
                     CLS.Util.TraceFormat(CLS.Def.Enums.TraceSeverity.Error,
                                       string.Format(strFormat, objects)));
            }
            catch (Exception exc)
            {

            }
        }

        /// <summary>
        ///         utility function to generate a report
        /// </summary>
        /// <param name="reportPath">Ex: rpt_FuelTransactionHist.rpt </param>
        /// <param name="reportName">Ex: rptFuelTransaction </param>
        /// <param name="dsCrystal">the dataset generated for the report </param>
        /// <param name="mapParams"> an array of params name (in report) and the object</param>
        /// <returns></returns>
        private string CreateReport(string reportPath, string reportName, DataSet dsCrystal, int rFormat,
                                      Dictionary<string, object> mapParams)
        {
            /*
                     if (!Util.IsDataSetValid(dsCrystal))
                     {
                        ReportPath = "";
                        return (int)InterfaceError.NoError;
                     }
            */

            CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt =
                           new CrystalDecisions.CrystalReports.Engine.ReportDocument();

            oRpt.Load(this.GetReportPath(reportPath));

            DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
            oRpt.SetDataSource(dsCrystal);

            ParameterFieldDefinitions crParameterFieldDefinitions;
            ParameterFieldDefinition crParameterFieldDefinition;
            ParameterValues crParameterValues = new ParameterValues();
            ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

            crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;

            foreach (string key in mapParams.Keys)
            {
                crParameterDiscreteValue.Value = mapParams[key];
                crParameterFieldDefinition = crParameterFieldDefinitions[key];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
            }

            string fileExt = "";
            switch (rFormat)
            {
                case 1:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                    fileExt = ".pdf";
                    break;
                case 2:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                    fileExt = ".xls";
                    break;
                case 3:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                    fileExt = ".doc";
                    break;
            }

            string ReportName = this.GetReportName(reportName, fileExt);

            oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
            diskOpt.DiskFileName = this.GetOutputPath(ReportName);
            oRpt.ExportOptions.DestinationOptions = diskOpt;
            oRpt.Export();
            oRpt.Close();

            return this.GetReportURL(ReportName);
        }


        [WebMethod(Description = "Fuel Transaction History Report")]
        public int FuelTransactionHistReport(Int32 UserID, string SID, Int32 OrganizationId,
                                     string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3})",
                             UserID, FromDate, ToDate, OrganizationId);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFuelTransaction.xsd"));

                DataSet ds = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (Wex dbWex = new Wex(ConnnectionString))
                {
                    ds = dbWex.GetFuelTransactionHist(OrganizationId, UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction History Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }
                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_FuelTransactionReport"]);

                dsCrystal.Tables["rpt_FuelTransactionReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);



#if NEW
                Dictionary<string,object> mapParams=new Dictionary<string,object>();
                mapParams.Add("FromDate", FromDate);
                mapParams.Add("ToDate", ToDate);
              

              ReportPath = CreateReport("rpt_FuelTransactionHist.rpt",
                                  "rptFuelTransaction",
                                  dsCrystal,rFormat,
                                  mapParams ) ;
#else
                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_FuelTransactionHist.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FuelTransactionHist)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }

                string ReportName = this.GetReportName("rptFuelTransaction", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3}, RepPath={4})",
                               UserID, FromDate, ToDate, OrganizationId, ReportPath);


                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction History Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FuelTransactionHistReport : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }


        }




        [WebMethod(Description = "Fuel Transaction Report")]
        public int FuelTransactionReport(Int32 UserID, string SID, Int32 OrganizationId,
                                     string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3})",
                             UserID, FromDate, ToDate, OrganizationId);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFuelTransaction.xsd"));

                DataSet ds = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (Wex dbWex = new Wex(ConnnectionString))
                {
                    ds = dbWex.GetFuelTransactionHist(OrganizationId, UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }
                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_FuelTransactionReport"]);

                dsCrystal.Tables["rpt_FuelTransactionReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.NoError;
                }
#if NEW
                Dictionary<string,object> mapParams=new Dictionary<string,object>();
                mapParams.Add("FromDate", FromDate);
                mapParams.Add("ToDate", ToDate);
              

              ReportPath = CreateReport("rpt_FuelTransactionReport.rpt",
                                  "rptFuelTransaction",
                                  dsCrystal,rFormat,
                                  mapParams ) ;
#else
                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                oRpt.Load(this.GetReportPath("rpt_FuelTransactionReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FuelTransactionHist)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }

                string ReportName = this.GetReportName("rptFuelTransaction", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3}, RepPath={4})",
                               UserID, FromDate, ToDate, OrganizationId, ReportPath);


                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FuelTransactionHistReport : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }


        }




        [WebMethod(Description = "Fuel Transaction Report")]
        public int FuelFraudTransactionReport(Int32 UserID, string SID, Int32 OrganizationId,
                                     string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3})",
                             UserID, FromDate, ToDate, OrganizationId);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFuelTransaction.xsd"));

                DataSet ds = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (Wex dbWex = new Wex(ConnnectionString))
                {
                    ds = dbWex.GetFuelFraudTransactionHist(OrganizationId, UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }
                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_FuelTransactionReport"]);

                dsCrystal.Tables["rpt_FuelTransactionReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    return (int)InterfaceError.NoError;
                }
#if NEW
                Dictionary<string,object> mapParams=new Dictionary<string,object>();
                mapParams.Add("FromDate", FromDate);
                mapParams.Add("ToDate", ToDate);
              

              ReportPath = CreateReport("rpt_FuelTransactionReport.rpt",
                                  "rptFuelTransaction",
                                  dsCrystal,rFormat,
                                  mapParams ) ;
#else
                CrystalDecisions.CrystalReports.Engine.ReportDocument oRpt = new CrystalDecisions.CrystalReports.Engine.ReportDocument();

                if (rFormat==2)
                   oRpt.Load(this.GetReportPath("rpt_FuelFraudTransactionReport_Combine.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_FuelFraudTransactionReport.rpt"));

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FuelTransactionHist)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

		       crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Distance"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }

                string ReportName = this.GetReportName("rptFuelTransaction", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< FuelTransactionHistReport(uId={0}, dtFrom={1}, dtTo={2},Org={3}, RepPath={4})",
                               UserID, FromDate, ToDate, OrganizationId, ReportPath);


                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Transaction Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FuelTransactionHistReport : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }


        }



        /// <summary>
        ///      
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Summary"></param>
        /// <param name="rFormat"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int StateMileageReportPerFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 Summary, int rFormat, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StateMileageReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //Int16 Summary = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Summary = Convert.ToInt16(json[ReportTemplate.RptParamIncludeSummary]);
                ////}

                //Summary =Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));




                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("StateMileage.xsd"));

                int TotalSqlRecords = 0;
                int OutMaxRecords = 0;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                Report dbReport = new Report(ConnnectionString);
                DataSet ds = new DataSet();
                ds = dbReport.GetStateMileagePerFleet(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Summary);


                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables["rpt_FleetMileage"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptStateMileage.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //if (lang != "en" && lang != null)
                //{
                //    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                //    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                //}

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, getUserPreference(UserID, 37, "en-US")) ;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, getUserPreference(UserID, 37, "en-US")); 
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["toDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // duplicated
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptFleetMaintenance", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //Rendering to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "StateMileageDetail");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--StateMileageReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int StateMileageReportPerFleet_StateBased(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StateMileageReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //Summary =Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));




                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("StateMileage_StateBased.xsd"));

                int TotalSqlRecords = 0;
                int OutMaxRecords = 0;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                Report dbReport = new Report(ConnnectionString);
                DataSet ds = new DataSet();
                ds = dbReport.GetStateMileagePerFleet_StateBased(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));


                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Fleet State Based Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                if (UnitOfMes != 1 && ds != null && ds.Tables.Count > 0 && ds.Tables[0].Rows.Count > 0)
                {
                    foreach (DataRow dr in ds.Tables[0].Rows)
                        dr["Mileage"] = Convert.ToDouble(dr["Mileage"]) * UnitOfMes;

                }

                dsCrystal.Tables["rpt_FleetMileage"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);




                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_StateMilage_Pivot.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);



                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FromDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ToDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["toDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                //crParameterDiscreteValue.Value = UnitOfMes;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptFleetMaintenance", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--StateMileageReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int StateMileageSummaryReportPerFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 Summary, int rFormat, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StateMileageSummaryReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //Int16 Summary = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Summary = Convert.ToInt16(json[ReportTemplate.RptParamIncludeSummary]);
                ////}

                //Summary = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("StateMileage.xsd"));

                int TotalSqlRecords = 0;
                int OutMaxRecords = 0;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                Report dbReport = new Report(ConnnectionString);
                DataSet ds = new DataSet();
                ds = dbReport.GetStateMileagePerFleet(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Summary);


                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Summary Per Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables["rpt_FleetMileage"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptStateMileageSummary.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);

                //if (lang != "en" && lang != null)
                //{
                //    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                //    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                //}

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FromDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ToDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["toDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptFleetMaintenance", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2) //Rendering to excel format
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "StateMileageSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--StateMileageSummaryReportPerFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Summary Per Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///         this a detailed breakdown list with the mileage in every state per vehicle
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="licensePlate"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Summary">0 or 1</param>
        /// <param name="rFormat">PDF = 1, Excel = 2, Word = 3</param>
        /// <param name="ReportPath"> where the report is saved</param>
        /// <returns>InterfaceError.NoError (0) for success </returns>
        [WebMethod]
        public int StateMileageReportPerVehicle(Int32 UserID, string SID, string licensePlate, string FromDate, string ToDate, Int16 Summary, int rFormat, ref string ReportPath)
        {
            try
            {

                //Int16 Summary = 0;
                //string licensePlate = "";

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Summary = Convert.ToInt16(json[ReportTemplate.RptParamIncludeSummary]);
                ////    licensePlate = json[ReportTemplate.RptParamLicensePlate];
                ////}


                //Summary = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));
                //licensePlate = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->StateMileageReportPerVehicle( userId = {0}, fromDate = {1}, toDate={2},lic={3} )", UserID, FromDate, ToDate, licensePlate);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("StateMileage.xsd"));

                int TotalSqlRecords = 0;
                int OutMaxRecords = 0;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                Report dbReport = new Report(ConnnectionString);
                DataSet ds = new DataSet();
                ds = dbReport.GetStateMileagePerVehicle(licensePlate, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Summary);


                if (!Util.IsDataSetValid(ds))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                dsCrystal.Tables["rpt_VehicleMileage"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptStateMileageVehicle.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();



                //if (lang != "en" && lang != null)
                //{
                //    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                //    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                //}



                crParameterDiscreteValue.Value = FromDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["fromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = ToDate;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["toDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // duplicated
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptFleetMaintenance", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--StateMileageReportPerVehicle( userId = {0}, fromDate = {1}, toDate={2},lic={3} )", UserID, FromDate, ToDate, licensePlate);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "State Mileage Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        # endregion

        # region Private Methods

        private void ZipReports(string inputPath, string inputFile, string outputFile)
        {
            ZipFile zipFile = new ZipFile(outputFile);
            DirectoryInfo directoryInfo = new DirectoryInfo(inputPath);
            string currentDirecotrory = Directory.GetCurrentDirectory();
            Directory.SetCurrentDirectory(inputPath);
            FileInfo[] fileInfoList = directoryInfo.GetFiles(inputFile);
            for (int i = 0; i < fileInfoList.Length; i++)
            {
                zipFile.AddFile(fileInfoList[i].Name);
            }
            zipFile.Save();
            Directory.SetCurrentDirectory(currentDirecotrory);
        }

        private static Dictionary<string, string> MergeTripSummaryTable(DataSet sourceDataSet, DataSet destDataSet, bool isVehicleSummaryRequired)
        {
            DataTable summaryTable;
            summaryTable = destDataSet.Tables["TripReportSummary"];
            Dictionary<string, string> vehicleSummary = null;
            float totalCost = 0;
            Int64 totalDuration = 0;
            Int64 totalStopsDuration = 0;
            Int64 totalStopsDurationBetweenTrips = 0;
            // IMPORTANT ASSUMPTION: the trip index is in the same order in each source table.
            // if the assumption ever goes broken, a primary key should be created and use Find(PK) instead.
            for (int i = 0; i < sourceDataSet.Tables["TripStart"].Rows.Count; i++)
            {
                DataRow summaryRow = summaryTable.NewRow();
                summaryRow["TripIndex"] = sourceDataSet.Tables["TripStart"].Rows[i]["TripIndex"];
                summaryRow["StartTime"] = sourceDataSet.Tables["TripStart"].Rows[i]["Summary"];
                summaryRow["StartLocation"] = sourceDataSet.Tables["TripStart"].Rows[i]["Remarks"];
                try
                {
                    summaryRow["EndTime"] = sourceDataSet.Tables["TripEnd"].Rows[i]["Summary"];
                    summaryRow["EndLocation"] = sourceDataSet.Tables["TripEnd"].Rows[i]["Remarks"];
                    summaryRow["AverageSpeed"] = sourceDataSet.Tables["TripAverageSpeed"].Rows[i]["Summary"];
                    summaryRow["Cost"] = sourceDataSet.Tables["TripCost"].Rows[i]["Summary"];
                    summaryRow["Distance"] = sourceDataSet.Tables["TripDistance"].Rows[i]["Summary"];
                    //Convert time to user format							
                    Int64 duration = Int64.Parse((string)sourceDataSet.Tables["TripDuration"].Rows[i]["Remarks"]);
                    summaryRow["Duration"] = FormatDuration(duration);
                    Int64 stopsDuration = Int64.Parse((string)sourceDataSet.Tables["TripStopsDuration"].Rows[i]["Remarks"]);
                    summaryRow["StopsDuration"] = FormatDuration(stopsDuration);
                    Int64 stopsDurationBetweenTrips = Int64.Parse((string)sourceDataSet.Tables["StopDurationBetweenTrips"].Rows[i]["Remarks"]);
                    summaryRow["StopsDurationBetweenTrips"] = FormatDuration(stopsDurationBetweenTrips);
                    if (isVehicleSummaryRequired)
                    {
                        totalCost += float.Parse((string)summaryRow["Cost"]);
                        totalDuration += duration;
                        totalStopsDuration += stopsDuration;
                        totalStopsDurationBetweenTrips += stopsDurationBetweenTrips;
                    }
                }
                catch (Exception ex)
                {
                    // if a trip is still ongoing, we will get here.
                }
                summaryTable.Rows.Add(summaryRow);
            }
            if (isVehicleSummaryRequired)
            {
                vehicleSummary = new Dictionary<string, string>();
                vehicleSummary.Add("TotCost", totalCost.ToString());
                vehicleSummary.Add("TotTripTime", FormatDuration(totalDuration));
                vehicleSummary.Add("TotIdling", FormatDuration(totalStopsDuration));
                vehicleSummary.Add("TotStopTime", FormatDuration(totalStopsDurationBetweenTrips));
            }
            return vehicleSummary;
        }

        internal class ReportState
        {
            public DataSet CrystalDataSet;
            public string Lang;
            public ResourceManager ReportResourceManager;
            public string ReportTemplateFile;
            public Dictionary<string, object> ReportParameters;
            public ExportFormatType FormatType;
            public string OutputFile;
            public string PdfMerger;
            public string MergedReportFile;
        }

        private static void GenerateVehicleTripReport(ReportState reportState)
        {
            // localization
            LocalizeAddress(reportState.Lang, ref reportState.CrystalDataSet);
            // export
            ReportDocument reportDocument = new ReportDocument();
            reportDocument.Load(reportState.ReportTemplateFile);
            reportDocument.SetDataSource(reportState.CrystalDataSet);
            LocalizeTextObject(ref reportDocument, reportState.ReportResourceManager, reportState.Lang);
            foreach (KeyValuePair<string, object> parameter in reportState.ReportParameters)
            {
                reportDocument.SetParameterValue(parameter.Key, parameter.Value);
            }
            reportDocument.ExportToDisk(reportState.FormatType, reportState.OutputFile);
            reportDocument.Close();
        }

        private static void GenerateVehicleTripReportDelegateCallBack(IAsyncResult asyncResult)
        {
            GenerateVehicleTripReportDelegate reportDelegate = (GenerateVehicleTripReportDelegate)asyncResult.AsyncState;
            reportDelegate.EndInvoke(asyncResult);
        }

        private delegate void GenerateVehicleTripReportDelegate(ReportState reportState);

        private static int MergePDF(string pdfMerger, string inputPath, string inputFile, string outputFile)
        {
            int exitCode;
            // command line: pdftk *.pdf cat output cn.pdf dont_ask
            // note: pdftk can not take path that has space in it.
            Process pdfMergerProcess = new Process();
            pdfMergerProcess.StartInfo.FileName = pdfMerger;
            pdfMergerProcess.StartInfo.Arguments = string.Format("{0} cat output {1} dont_ask", inputFile, outputFile);
            pdfMergerProcess.StartInfo.CreateNoWindow = true;
            pdfMergerProcess.StartInfo.UseShellExecute = false;
            pdfMergerProcess.StartInfo.WorkingDirectory = inputPath;
            pdfMergerProcess.Start();
            pdfMergerProcess.WaitForExit();
            exitCode = pdfMergerProcess.ExitCode;
            pdfMergerProcess.Close();
            return exitCode;
        }

        private static void MergePDF(string inputPath, string searchPattern, string outputFile)
        {
            Trace.WriteLineIf(AppConfig.tsMain.TraceInfo,
               VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
               String.Format("Path [{0}] Pattern [{1}] Output File [{2}]", inputPath, searchPattern, outputFile)));

            DirectoryInfo directoryInfo = new DirectoryInfo(inputPath);
            FileInfo[] fileInfoList = directoryInfo.GetFiles(searchPattern);

            Trace.WriteLineIf(AppConfig.tsMain.TraceInfo,
               VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Info,
               String.Format("Files No.: [{0}]", fileInfoList.Length)));

            if (fileInfoList != null && fileInfoList.Length > 0)
            {
                string[] inputFileNames = new string[fileInfoList.Length];

                for (int i = 0; i < fileInfoList.Length; i++)
                {
                    inputFileNames[i] = fileInfoList[i].FullName;
                }

                PDFDocument.Merge(outputFile, inputFileNames);
            }
            //return exitCode;
        }

        // Sometimes Syncfusion pdf merger does not release files, retry delete up to 3 times.
        private static bool DeleteDirectory(string path)
        {
            bool deleted = false;
            int i = 0;
            do
            {
                try
                {
                    Directory.Delete(path, true);
                    deleted = true;
                    break;
                }
                catch
                {
                    Thread.Sleep(500);
                    i++;
                }
            } while (i < 3);
            return deleted;
        }

        private static int MergeExcel(string inputPath, string inputFile, string outputFile, bool oneSheet)
        {
            int exitCode = 0;

            ExcelEngine excelEngine = new ExcelEngine();
            IApplication application = excelEngine.Excel;
            DirectoryInfo directoryInfo = new DirectoryInfo(inputPath);
            FileInfo[] fileInfoList = directoryInfo.GetFiles(inputFile);
            if (fileInfoList.Length > 0)
            {
                IWorkbook srcWorkbook;
                IWorkbook dstWorkbook = application.Workbooks.Open(fileInfoList[0].FullName);
                IRange srcRange, dstRange;
                for (int i = 1; i < fileInfoList.Length; i++)
                {
                    srcWorkbook = application.Workbooks.Open(fileInfoList[i].FullName);
                    //Copy the first worksheet from Source workbook to destination workbook.
                    if (oneSheet)
                    {
                        srcRange = srcWorkbook.Worksheets[0].UsedRange;
                        dstRange = dstWorkbook.Worksheets[0].Range[dstWorkbook.Worksheets[0].UsedRange.LastRow + 1, 1];
                        srcRange.CopyTo(dstRange);
                    }
                    else
                    {
                        dstWorkbook.Worksheets.AddCopy(srcWorkbook.Worksheets);
                    }
                    srcWorkbook.Close();
                }
                dstWorkbook.SaveAs(outputFile);
                dstWorkbook.Close();
            }
            //No exception will be thrown if there are unsaved workbooks.
            excelEngine.ThrowNotSavedOnDestroy = false;
            excelEngine.Dispose();

            return exitCode;
        }

        /*
        private static int MergeWord(string inputPath, string inputFile, string outputFile)
        {
            int exitCode = 0;

            DirectoryInfo directoryInfo = new DirectoryInfo(inputPath);
            FileInfo[] fileInfoList = directoryInfo.GetFiles(inputFile);
            if (fileInfoList.Length > 0)
            {
                WordDocument destinationDoc = new WordDocument();
                for (int i = 0; i < fileInfoList.Length; i++)
                {
                    WordDocument sourceDoc = new WordDocument(fileInfoList[i].FullName);
                    foreach (IWSection section in sourceDoc.Sections)
                    {
                        // Cloning all the sections one by one and merging it to the new document.
                        destinationDoc.Sections.Add(section.Clone(destinationDoc));
                        // Setting section break code to be the same as the template.
                        destinationDoc.LastSection.BreakCode = section.BreakCode;
                    }
                }
                // Saving the document to disk.
                destinationDoc.Save(outputFile, FormatType.Doc);
            }

            return exitCode;
        }
        */

        private static string FormatDuration(Int64 durationInSecond)
        {
            string outputString = "";
            TimeSpan durationSpan = new TimeSpan(durationInSecond * TimeSpan.TicksPerSecond);

            if (durationSpan.Days > 0)
            {
                outputString += durationSpan.Days.ToString() + " d, ";
                outputString += new TimeSpan(durationSpan.Ticks - durationSpan.Days * TimeSpan.TicksPerDay).ToString();
            }
            else
            {
                outputString = durationSpan.ToString();
            }
            return outputString;
        }

        /// <summary>
        /// Get full output path on server
        /// </summary>
        /// <param name="fileName"></param>
        /// <returns></returns>
        private string GetOutputPath(string fileName)
        {
            if (String.IsNullOrEmpty(fileName))
                throw new ArgumentNullException("File name can not be empty!");
            return Path.Combine(Server.MapPath(this.ReportsOutputPath), fileName);
        }

        /// <summary>
        /// Get full report path on server
        /// </summary>
        /// <param name="rptName"></param>
        /// <returns></returns>
        private string GetReportPath(string fileName)
        {
            if (String.IsNullOrEmpty(fileName))
                throw new ArgumentNullException("Report name can not be empty!");
            return Path.Combine(Server.MapPath(this.ReportsRootPath), fileName);
        }

        /// <summary>
        /// Get full dataset file path on server
        /// </summary>
        /// <param name="dataSetName"></param>
        /// <returns></returns>
        private string GetDataSetPath(string fileName)
        {
            if (String.IsNullOrEmpty(fileName))
                throw new ArgumentNullException("DataSet name can not be empty!");
            return Path.Combine(Server.MapPath(this.ReportsDataSetPath), fileName);
        }

        /// <summary>
        /// Build report name + day and milliseconds
        /// </summary>
        /// <param name="rptName"></param>
        /// <param name="fileExt"></param>
        /// <returns></returns>
        private string GetReportName(string rptName, string fileExt)
        {
            if (String.IsNullOrEmpty(rptName))
                throw new ArgumentNullException("Report name can not be empty!");
            if (String.IsNullOrEmpty(fileExt))
                throw new ArgumentNullException("File extension can not be empty!");
            return String.Format("{0}{1}{2}{3}", rptName, DateTime.Now.Day, DateTime.Now.Ticks, fileExt);
        }

        /// <summary>
        /// Build report url string on server
        /// </summary>
        /// <param name="fileName"></param>
        /// <returns></returns>
        private string GetReportURL(string fileName)
        {
            if (String.IsNullOrEmpty(fileName))
                throw new ArgumentNullException("File name can not be empty!");
            return String.Format("http://{0}{1}/TmpReports/{2}", ConfigurationManager.AppSettings["ServerIp"], this.ReportsRootPath, fileName);
        }

        private string FindExistingPreference()
        {
            try
            {
                if (UnitOfMes == 1)
                    return "km";
                else 
                    return "mi";
            }
            catch (Exception Ex)
            {
                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceError, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error, Ex.Message.ToString() + " FindExistingPreference()"));
                return "";
            }
        }

        private DataSet dsHistory_Fill(Int32 UserID, string LicensePlate, DateTime FromDate, DateTime ToDate, string XmlParams, Int16 DclId, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {

                DataSet dsHistory = new DataSet();
                DataSet dsVehicle = new DataSet();
                StringReader strrXML = null;

                string xml = "";
                VLF.DAS.Logic.Vehicle dbVehicle = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString);
                dsVehicle = dbVehicle.GetVehicleInfoByLicensePlate(LicensePlate);
                Int64 VehicleId = 0;
                if (dsVehicle.Tables[0].Rows.Count > 0)
                    VehicleId = Convert.ToInt64(dsVehicle.Tables[0].Rows[0]["VehicleId"]);
                else
                    return null;


                VLF.DAS.Logic.MessageQueue dbMessageQueue = new VLF.DAS.Logic.MessageQueue(ConnnectionString);

                string[] ParamList = new string[4];
                ParamList = XmlParams.ToString().Split(';');

                int totalSqlRecords = 0;


                dsHistory = dbMessageQueue.GetMessagesFromHistoryByVehicleId_Report (UserID, VehicleId, FromDate.AddHours(-UserTimeZone - DayLightSaving), ToDate.AddHours(-UserTimeZone - DayLightSaving), Convert.ToBoolean(ParamList[0]), Convert.ToBoolean(ParamList[1]), Convert.ToBoolean(ParamList[2]), Convert.ToBoolean(ParamList[3]), DclId, lang, "", "", ref requestOverflowed, ref totalSqlRecords);
                if (requestOverflowed)
                    return null;


                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    LocalizationLayer.ServerLocalizationLayer dbl = new LocalizationLayer.ServerLocalizationLayer(ConnnectionString);
                    dbl.LocalizationData(lang, "BoxMsgInTypeId", "BoxMsgInTypeName", "MessageType", ref dsHistory);
                }

                if (dsHistory.Tables[0].Columns.IndexOf("StreetAddress") == -1)
                {
                    DataColumn colStreetAddress = new DataColumn("StreetAddress", Type.GetType("System.String"));
                    dsHistory.Tables[0].Columns.Add(colStreetAddress);
                }

                // Show Heading

                DataColumn dc = new DataColumn();
                dc.ColumnName = "MyHeading";
                dc.DataType = Type.GetType("System.String");
                dc.DefaultValue = "";
                dsHistory.Tables[0].Columns.Add(dc);


                if (dsHistory.Tables[0].Columns.IndexOf("Speed") != -1 && lang == "en")
                {
                    foreach (DataRow rowItem in dsHistory.Tables[0].Rows)
                    {
                        // Heading
                        if ((rowItem["Speed"].ToString().TrimEnd() != "0") && (rowItem["Speed"].ToString().TrimEnd() != "N/A") && (rowItem["Speed"].ToString().TrimEnd() != VLF.CLS.Def.Const.blankValue))
                        {

                            if ((rowItem["Heading"] != null) &&
                                (rowItem["Heading"].ToString() != "") && rowItem["Heading"].ToString() != "N/A")
                            {
                                rowItem["MyHeading"] = Heading(rowItem["Heading"].ToString());
                            }
                        }


                        if ((Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.ExtremeAcceleration)) ||
                      (Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.ExtremeBraking)) ||
                      (Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.HarshAcceleration)) ||
                      (Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.HarshBraking)) ||
                      (Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.SeatBelt)) ||
                      (Convert.ToInt16(rowItem["BoxMsgInTypeId"]) == Convert.ToInt16(VLF.CLS.Def.Enums.MessageType.Idling)))
                            rowItem["Speed"] = VLF.CLS.Def.Const.defNA.ToString();

                    }
                }

                return dsHistory;

            }
            catch (Exception Ex)
            {

                return null;
            }
        }

        public string Heading(string heading)
        {
            int intHeading = 0;
            try
            {
                intHeading = Convert.ToInt16(heading);

            }
            catch
            {
                return "N/A";
            }


            try
            {
                if ((intHeading >= 337) || (intHeading < 22))
                    return "N";

                if ((intHeading >= 22) && (intHeading < 67))
                    return "NE";

                if ((intHeading >= 67) && (intHeading < 112))
                    return "E";


                if ((intHeading >= 112) && (intHeading < 157))
                    return "SE";

                if ((intHeading >= 157) && (intHeading < 202))
                    return "S";


                if ((intHeading >= 202) && (intHeading < 247))
                    return "SW";


                if ((intHeading >= 247) && (intHeading < 292))
                    return "W";


                if ((intHeading >= 292) && (intHeading < 337))
                    return "NW";
                else
                    return "N/A";
            }
            catch (Exception Ex)
            {
                return "N/A";
            }
        }

        private void CopyRows(DataTable oSrcDataTable, DataTable oDstDataTable)
        {
            try
            {
                // oDstDataTable = oSrcDataTable.Copy() ;
                foreach (DataRow oDataRow in oSrcDataTable.Rows)
                    oDstDataTable.ImportRow(oDataRow);
            }
            catch (Exception Ex)
            {
                System.Diagnostics.Trace.WriteLineIf(AppConfig.tsMain.TraceError, VLF.CLS.Util.TraceFormat(VLF.CLS.Def.Enums.TraceSeverity.Error, Ex.Message.ToString() + " CopyRows()"));
            }
        }

        private DataSet GetAlarams(Int32 UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {

            int TotalSqlRecords = 0;
            int OutMaxRecords = 0;
            //string ConnnectionString = LoginManager.GetConnnectionString(UserID);
            string FromDate = "";
            string ToDate = "";

            FromDate = Util.PairFindValue(ReportTemplate.RpDetailedTripSecondParamName, xmlParams);
            ToDate = Util.PairFindValue(ReportTemplate.RpDetailedTripThirdParamName, xmlParams);

            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

            ReportGenerator dbReport = new ReportGenerator(ConnnectionString);
            string xml = dbReport.GetXml(ReportTemplate.ReportTypes.Alarm, xmlParams, UserID, lang, ref RequestOverflowed, ref TotalSqlRecords, ref outMaxOverflowed, ref OutMaxRecords);

            if (xml == "")
                return null;

            StringReader strrXML = new StringReader(xml);
            DataSet ds = new DataSet();
            ds.ReadXml(strrXML);

            //         if (lang == "fr" && lang != null)
            if (ASIErrorCheck.IsLangSupported(lang))
            {
                foreach (DataRow dr in ds.Tables[0].Rows)
                    dr["Description"] = LocalizationLayer.GUILocalizationLayer.LocalizeAlarms(dr["Description"].ToString(), lang);
            }

            return ds;
        }

        private DataSet GetFleetMaintenance(Int32 UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {

            int TotalSqlRecords = 0;
            int OutMaxRecords = 0;
            string ConnnectionString = LoginManager.GetConnnectionString(UserID);
            ReportGenerator dbReport = new ReportGenerator(ConnnectionString);
            string xml = dbReport.GetXml(ReportTemplate.ReportTypes.FleetMaintenanceReport, xmlParams, UserID, lang, ref RequestOverflowed, ref TotalSqlRecords, ref outMaxOverflowed, ref OutMaxRecords);

            if (xml == "")
                return null;

            StringReader strrXML = new StringReader(xml);
            DataSet ds = new DataSet();
            ds.ReadXml(strrXML);
            return ds;
        }

        private DataSet GetFleetAlarams(Int32 UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {

            int TotalSqlRecords = 0;
            int OutMaxRecords = 0;
           //string ConnnectionString = LoginManager.GetConnnectionString(UserID);
            string FromDate = "";
            string ToDate = "";

            FromDate = Util.PairFindValue(ReportTemplate.RpDetailedTripSecondParamName, xmlParams);
            ToDate = Util.PairFindValue(ReportTemplate.RpDetailedTripThirdParamName, xmlParams);

            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

            ReportGenerator dbReport = new ReportGenerator(ConnnectionString);
            string xml = dbReport.GetXml(ReportTemplate.ReportTypes.FleetAlarms, xmlParams, UserID, lang, ref RequestOverflowed, ref TotalSqlRecords, ref outMaxOverflowed, ref OutMaxRecords);

            StringReader strrXML = new StringReader(xml);
            DataSet ds = new DataSet();
            ds.ReadXml(strrXML);

            //         if (lang == "fr" && lang != null)
            if (ASIErrorCheck.IsLangSupported(lang))
            {
                foreach (DataRow dr in ds.Tables[0].Rows)
                    dr["Description"] = LocalizationLayer.GUILocalizationLayer.LocalizeAlarms(dr["Description"].ToString(), lang);

            }

            return ds;
        }

        private DataSet GetTripDetails(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            //string prm11 = "";
            //string prm12 = "";
            //string prm13 = "";
            //string prm14 = "";
            //string prm15 = "";
            //string prm16 = "";
            //string prm17 = "";
            //string prm18 = "";
            //string prm19 = "";
            //string prm20 = "";
            //string prm21 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;

            prm1 = Util.PairFindValue(ReportTemplate.RpDetailedTripFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpDetailedTripSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpDetailedTripThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpDetailedTripFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpDetailedTripFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpDetailedTripSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpDetailedTripSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpDetailedTripEighthParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpDetailedTripNinthParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpDetailedTripTenthParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null ||
                prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null || prm10 == null)
            {
                // empty result
                return null;
            }

            bool prm8Result;
            if (!Boolean.TryParse(prm8, out prm8Result))
                return null;

            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;

            DataSet ds = null;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            using (VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString))
            {
                ds = detailedTrip.GetDetailedTripReport(prm1, prm2, prm3,
                     Convert.ToBoolean(prm4),
                     Convert.ToBoolean(prm5),
                     Convert.ToBoolean(prm6),
                     Convert.ToBoolean(prm7),
                     Convert.ToBoolean(prm8),
                     Convert.ToBoolean(prm9),
                     UserID, Convert.ToInt32(prm10), lang,
                     ref requestOverflowed,
                     ref totalSqlRecords,
                     ref outMaxOverflowed,
                     ref outMaxRecords);
            }

            DataSet dsCrystal = new DataSet();
            //string tmpXml = ds.GetXml();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));

            string strTotal = "";

            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripReportData") != -1)
                //CopyRows(ds.Tables["TripReportData"], dsCrystal.Tables["rpt_TripReportData"]);
                dsCrystal.Tables["rpt_TripReportData"].Merge(ds.Tables["TripReportData"], false, MissingSchemaAction.Ignore);
            else
            {
                return null;
            }

            if (Convert.ToBoolean(prm8)) //with Summary
            {

                if (ds.Tables.IndexOf("TripStart") != -1 && ds.Tables["TripStart"].Rows.Count > 0)
                    //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                    dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
                else
                {
                    return null;
                }

                if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                    //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                    dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripCost") != -1)
                    //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                    dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripDistance") != -1)
                    //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                    dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripDuration") != -1)
                {
                    foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                    {
                        //Convert time to user format
                        strTotal = "";
                        /*
                        TimeSpan TripDuration;
                        TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                        if (TripDuration.Days > 0)
                        {
                           strTotal += TripDuration.Days.ToString() + " d, ";
                           strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotal = TripDuration.ToString();
                        }
                        */
                        CalculateDuration(rowItem["Remarks"], ref strTotal);
                        rowItem["Summary"] = strTotal;
                    }

                    //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);

                    dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);

                }


                if (ds.Tables.IndexOf("TripStopsDuration") != -1)
                {
                    foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                    {
                        //Convert time to user format		
                        strTotal = "";
                        /*
                        TimeSpan TripIndling;
                        TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                        if (TripIndling.Days > 0)
                        {
                           strTotal += TripIndling.Days.ToString() + " d, ";
                           strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotal = TripIndling.ToString();
                        }
                        */
                        CalculateDuration(rowItem["Remarks"], ref strTotal);
                        rowItem["Summary"] = strTotal;
                    }
                    //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);

                    dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);

                }
                if (ds.Tables.IndexOf("TripEnd") != -1)
                    //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                    dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripFuelCons") != -1)
                    //CopyRows(ds.Tables["TripFuelCons"], dsCrystal.Tables["rpt_TripFuel"]);
                    dsCrystal.Tables["rpt_TripFuel"].Merge(ds.Tables["TripFuelCons"], false, MissingSchemaAction.Ignore);
            }
            return dsCrystal;
        }

        private DataSet GetTripSummary(int UserID, string xmlParams, string lang, ref TimeSpan totalTrip, ref TimeSpan totalIdling, ref TimeSpan totalStop, ref Double totalCost, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;

            MethodName = "GetTripSummary";

            prm1 = Util.PairFindValue(ReportTemplate.RpTripFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpTripSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpTripThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpTripFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpTripFifthParamName, xmlParams);

            if ((xmlParams == null) || (prm1 == null) || (prm2 == null) || (prm3 == null) || (prm4 == null) || (prm5 == null))
            {
                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet ds = detailedTrip.GetTripReport(prm1, prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), lang,
                ref requestOverflowed, ref totalSqlRecords,
                ref outMaxOverflowed, ref outMaxRecords);


            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));
            string strTotal = "";

            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("TripStart") != -1 && ds.Tables["TripStart"].Rows.Count > 0)
                //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
            else
                return null;

            if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripCost") != -1)
                //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDistance") != -1)
                //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                {
                    //Convert time to user format					
                    strTotal = "";
                    /*
                    TimeSpan TripDuration;
                    TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripDuration.Days > 0)
                    {
                       strTotal += TripDuration.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripDuration.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalTrip += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);

                dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripStopsDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                {
                    //Convert time to user format		
                    strTotal = "";
                    /*
                    TimeSpan TripIndling;
                    TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripIndling.Days > 0)
                    {
                       strTotal += TripIndling.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripIndling.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalIdling += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);
                dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);
            }
            if (ds.Tables.IndexOf("TripEnd") != -1)
                //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("StopDurationBetweenTrips") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["StopDurationBetweenTrips"].Rows)
                {
                    //Convert time to user format				
                    strTotal = "";
                    /*
                    TimeSpan TripStop;
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                       strTotal += TripStop.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripStop.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalStop += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["StopDurationBetweenTrips"], dsCrystal.Tables["rpt_StopDurationBetweenTrips"]);

                dsCrystal.Tables["rpt_StopDurationBetweenTrips"].Merge(ds.Tables["StopDurationBetweenTrips"], false, MissingSchemaAction.Ignore);

            }

            if (ds.Tables.IndexOf("TripCost") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripCost"].Rows)
                {
                    totalCost += Convert.ToDouble(rowItem["Summary"]);
                }
            }
            if (ds.Tables.IndexOf("TripFuelCons") != -1)
                //CopyRows(ds.Tables["TripFuelCons"], dsCrystal.Tables["rpt_TripFuel"]);
                dsCrystal.Tables["rpt_TripFuel"].Merge(ds.Tables["TripFuelCons"], false, MissingSchemaAction.Ignore);

            return dsCrystal;
        }

        private DataSet GetFleetTripSummary(int UserID, string xmlParams, string lang, ref TimeSpan totalTrip, ref TimeSpan totalIdling, ref TimeSpan totalStop, ref Double totalCost, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;


            prm1 = Util.PairFindValue(ReportTemplate.RpFleetTripFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpFleetTripSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpFleetTripThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpFleetTripFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpFleetTripFifthParamName, xmlParams);
            if ((xmlParams == null) || (prm1 == null) || (prm2 == null) || (prm3 == null) || (prm4 == null) || (prm5 == null))
            {
                // empty result
                return null;
            }

            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet ds = detailedTrip.GetFleetTripReport(Convert.ToInt16(prm1), prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), lang,
                ref requestOverflowed, ref totalSqlRecords,
                ref outMaxOverflowed, ref outMaxRecords);

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));
            string strTotal = "";

            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripStart") != -1)
                //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
            else
                return null;

            if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripCost") != -1)
                //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDistance") != -1)
                //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                {
                    //Convert time to user format		
                    strTotal = "";
                    /*
                    TimeSpan TripDuration;
                    TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripDuration.Days > 0)
                    {
                       strTotal += TripDuration.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripDuration.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalTrip += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                }

                //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);

                dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripStopsDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                {
                    //Convert time to user format						
                    strTotal = "";
                    /*
                    TimeSpan TripIndling;
                    TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripIndling.Days > 0)
                    {
                       strTotal += TripIndling.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripIndling.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalIdling += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);

                dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripEnd") != -1)
                //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("StopDurationBetweenTrips") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["StopDurationBetweenTrips"].Rows)
                {
                    //Convert time to user format			
                    strTotal = "";
                    /*
                    TimeSpan TripStop;
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                       strTotal += TripStop.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripStop.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalStop += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["StopDurationBetweenTrips"], dsCrystal.Tables["rpt_StopDurationBetweenTrips"]);

                dsCrystal.Tables["rpt_StopDurationBetweenTrips"].Merge(ds.Tables["StopDurationBetweenTrips"], false, MissingSchemaAction.Ignore);

            }

            if (ds.Tables.IndexOf("TripCost") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripCost"].Rows)
                {
                    totalCost += Convert.ToDouble(rowItem["Summary"]);
                }
            }

            return dsCrystal;
        }

        private DataSet GetTripFleetDetails(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            //string prm11 = "";
            //string prm12 = "";
            //string prm13 = "";
            //string prm14 = "";
            //string prm15 = "";
            //string prm16 = "";
            //string prm17 = "";
            //string prm18 = "";
            //string prm19 = "";
            //string prm20 = "";
            //string prm21 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;

            prm1 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripEighthParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripNinthParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpFleetDetailedTripTenthParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null ||
                prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null || prm10 == null)
            {
                // empty result
                return null;
            }

            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;

            DataSet ds = null;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            using (VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString))
            {
                ds = detailedTrip.GetFleetDetailedTripReport(Convert.ToInt16(prm1), prm2, prm3,
                     Convert.ToBoolean(prm4),
                     Convert.ToBoolean(prm5),
                     Convert.ToBoolean(prm6),
                     Convert.ToBoolean(prm7),
                     Convert.ToBoolean(prm8),
                     Convert.ToBoolean(prm9),
                     UserID, Convert.ToInt32(prm10), lang,
                     ref requestOverflowed,
                     ref totalSqlRecords,
                     ref outMaxOverflowed,
                     ref outMaxRecords);
            }

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));

            string strTotal = "";

            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("TripReportData") != -1)
                //CopyRows(ds.Tables["TripReportData"], dsCrystal.Tables["rpt_TripReportData"]);
                dsCrystal.Tables["rpt_TripReportData"].Merge(ds.Tables["TripReportData"], false, MissingSchemaAction.Ignore);


            if (Convert.ToBoolean(prm8)) //with Summary
            {

                if (ds.Tables.IndexOf("TripStart") != -1 && ds.Tables["TripStart"].Rows.Count > 0)
                    //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                    dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
                else
                    return null;

                if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                    //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                    dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripCost") != -1)
                    //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                    dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripDistance") != -1)
                    //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                    dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
                if (ds.Tables.IndexOf("TripDuration") != -1)
                {
                    foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                    {
                        //Convert time to user format		
                        strTotal = "";
                        /*
                        TimeSpan TripDuration;
                        TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                        if (TripDuration.Days > 0)
                        {
                           strTotal += TripDuration.Days.ToString() + " d, ";
                           strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotal = TripDuration.ToString();
                        }
                        */
                        CalculateDuration(rowItem["Remarks"], ref strTotal);
                        rowItem["Summary"] = strTotal;
                    }

                    //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);

                    dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);

                }
                if (ds.Tables.IndexOf("TripStopsDuration") != -1)
                {
                    foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                    {
                        //Convert time to user format		
                        strTotal = "";
                        /*
                        TimeSpan TripIndling;
                        TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                        if (TripIndling.Days > 0)
                        {
                           strTotal += TripIndling.Days.ToString() + " d, ";
                           strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotal = TripIndling.ToString();
                        }
                        */
                        CalculateDuration(rowItem["Remarks"], ref strTotal);
                        rowItem["Summary"] = strTotal;
                    }

                    //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);

                    dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);

                }
                if (ds.Tables.IndexOf("TripEnd") != -1)
                    //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                    dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);

                if (ds.Tables.IndexOf("TripFuelCons") != -1)
                    //CopyRows(ds.Tables["TripFuelCons"], dsCrystal.Tables["rpt_TripFuel"]);
                    dsCrystal.Tables["rpt_TripFuel"].Merge(ds.Tables["TripFuelCons"], false, MissingSchemaAction.Ignore);
            }

            return dsCrystal;
        }

        private DataSet GetStopReportData(int UserID, string xmlParams, string lang, ref int IdlingCount, ref TimeSpan totalIdling, ref int StopCount, ref TimeSpan totalStop, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;
            string strTotalTime = "";


            prm1 = Util.PairFindValue(ReportTemplate.RpStopFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpStopSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpStopThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpStopFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpStopFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpStopSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpStopSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpStopEighthParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null || prm6 == null || prm7 == null)
            {
                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet ds = detailedTrip.GetStopReport(prm1, prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), Convert.ToBoolean(prm6), Convert.ToBoolean(prm7), Convert.ToInt32(prm8), lang, ref requestOverflowed, ref totalSqlRecords);


            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstStopReport.xsd"));

            string strTotal = "";



            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("StopData") != -1 && ds.Tables["StopData"].Rows.Count > 0)
            {

                //ArrivalDate_
                DataColumn col = new DataColumn("ArrivalDateTime_", Type.GetType("System.String"));
                ds.Tables["StopData"].Columns.Add(col);

                //DepartureDate_
                col = new DataColumn("DepartureDateTime_", Type.GetType("System.String"));
                ds.Tables["StopData"].Columns.Add(col);

                //Summary
                col = new DataColumn("Summary", Type.GetType("System.Int32"));
                ds.Tables["StopData"].Columns.Add(col);

                foreach (DataRow rowItem in ds.Tables["StopData"].Rows)
                {
                    //TimeSpan TripStop = new TimeSpan(0);
                    //TimeSpan TripIdling = new TimeSpan(0);

                    if (rowItem["Remarks"].ToString().TrimEnd() == "Stopped" || rowItem["Remarks"].ToString().TrimEnd() == "Arrt")
                    {
                        StopCount++;
                        strTotalTime = "";
                        //Convert time to user format							
                        /*
                        TripStop = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                        if (TripStop.Days > 0)
                        {
                           strTotalStopTime += TripStop.Days.ToString() + " d, ";
                           strTotalStopTime += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotalStopTime = TripStop.ToString();
                        }
                        */
                        rowItem["Summary"] = CalculateDuration(rowItem["StopDurationVal"], ref strTotalTime);
                        totalStop += new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);
                        rowItem["StopDurationVal"] = strTotalTime;
                    }
                    else if (rowItem["Remarks"].ToString().TrimEnd() == "Idling" || rowItem["Remarks"].ToString().TrimEnd() == "Moteur au ralenti")
                    {
                        IdlingCount++;
                        strTotalTime = "";
                        //Convert time to user format							
                        /*
                        TripIdling = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                        if (TripIdling.Days > 0)
                        {
                           strTotalIdlingTime += TripIdling.Days.ToString() + " d, ";
                           strTotalIdlingTime += new TimeSpan(TripIdling.Ticks - TripIdling.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotalIdlingTime = TripIdling.ToString();
                        }
                        */
                        rowItem["Summary"] = CalculateDuration(rowItem["StopDurationVal"], ref strTotalTime);
                        totalIdling += new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);
                        rowItem["StopDurationVal"] = strTotalTime;
                    }

                    rowItem["ArrivalDateTime_"] = Convert.ToDateTime(rowItem["ArrivalDateTime"]).ToString();
                    //rowItem["DepartureDateTime_"]=rowItem["DepartureDateTime"].ToString();					

                    if (Convert.ToDateTime(rowItem["DepartureDateTime"]) == VLF.CLS.Def.Const.unassignedDateTime)
                        rowItem["DepartureDateTime_"] = VLF.CLS.Def.Const.blankValue;
                    else
                        rowItem["DepartureDateTime_"] = Convert.ToDateTime(rowItem["DepartureDateTime"]).ToString();
                }

                //CopyRows(ds.Tables["StopData"], dsCrystal.Tables["rpt_StopData"]);

                dsCrystal.Tables["rpt_StopData"].Merge(ds.Tables["StopData"], false, MissingSchemaAction.Ignore);

            }
            else
            {
                return null;
            }

            return dsCrystal;
        }

        private DataSet GetStopFleetReportData(int UserID, string xmlParams, string lang, ref int IdlingCount, ref TimeSpan totalIdling, ref int StopCount, ref TimeSpan totalStop, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;

            //string strTotalStopTime = "";
            //string strTotalIdlingTime = "";


            prm1 = Util.PairFindValue(ReportTemplate.RpFleetStopFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpFleetStopSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpFleetStopThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpFleetStopFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpFleetStopFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpFleetStopSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpFleetStopSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpStopEighthParamName, xmlParams);


            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null || prm6 == null || prm7 == null)
            {
                // empty result
                return null;
            }

            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;

            // BUG: prmX are often empty strings, so exceptions are thrown during int and bool conversions
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);

            DataSet ds = detailedTrip.GetFleetStopReport(Convert.ToInt32(prm1), prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), Convert.ToBoolean(prm6), Convert.ToBoolean(prm7), Convert.ToInt32(prm8), lang, ref requestOverflowed, ref totalSqlRecords);

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstStopReport.xsd"));

            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("StopData") != -1 && ds.Tables["StopData"].Rows.Count > 0)
            {

                //ArrivalDate_
                DataColumn col = new DataColumn("ArrivalDateTime_", Type.GetType("System.String"));
                ds.Tables["StopData"].Columns.Add(col);

                //DepartureDate_
                col = new DataColumn("DepartureDateTime_", Type.GetType("System.String"));
                ds.Tables["StopData"].Columns.Add(col);

                //Summary
                col = new DataColumn("Summary", Type.GetType("System.Int32"));
                ds.Tables["StopData"].Columns.Add(col);

                string strTotal = "";
                foreach (DataRow rowItem in ds.Tables["StopData"].Rows)
                {
                    //TimeSpan TripStop = new TimeSpan(0);
                    //TimeSpan TripIndling = new TimeSpan(0);

                    if (rowItem["Remarks"].ToString().TrimEnd() == "Stopped" || rowItem["Remarks"].ToString().TrimEnd() == "Arrt")
                    {
                        StopCount++;
                        strTotal = "";
                        //Convert time to user format							
                        /*
                        TripStop = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                        if (TripStop.Days > 0)
                        {
                           strTotalStopTime += TripStop.Days.ToString() + " d, ";
                           strTotalStopTime += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotalStopTime = TripStop.ToString();
                        }
                        */
                        rowItem["Summary"] = CalculateDuration(rowItem["StopDurationVal"], ref strTotal);
                        totalStop += new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);
                        rowItem["StopDurationVal"] = strTotal;
                    }
                    else if (rowItem["Remarks"].ToString().TrimEnd() == "Idling" || rowItem["Remarks"].ToString().TrimEnd() == "Moteur au ralenti")
                    {
                        IdlingCount++;
                        //Convert time to user format							
                        strTotal = "";
                        /*
                        TripIndling = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                        if (TripIndling.Days > 0)
                        {
                           strTotalIdlingTime += TripIndling.Days.ToString() + " d, ";
                           strTotalIdlingTime += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                        }
                        else
                        {
                           strTotalIdlingTime = TripIndling.ToString();
                        }
                        */
                        rowItem["Summary"] = CalculateDuration(rowItem["StopDurationVal"], ref strTotal);
                        totalIdling += new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);
                        rowItem["StopDurationVal"] = strTotal;
                    }

                    rowItem["ArrivalDateTime_"] = Convert.ToDateTime(rowItem["ArrivalDateTime"]).ToString();
                    //rowItem["DepartureDateTime_"]=rowItem["DepartureDateTime"].ToString();					

                    if (Convert.ToDateTime(rowItem["DepartureDateTime"]) == VLF.CLS.Def.Const.unassignedDateTime)
                        rowItem["DepartureDateTime_"] = VLF.CLS.Def.Const.blankValue;
                    else
                        rowItem["DepartureDateTime_"] = Convert.ToDateTime(rowItem["DepartureDateTime"]).ToString();
                }

                //CopyRows(ds.Tables["StopData"], dsCrystal.Tables["rpt_StopData"]);

                dsCrystal.Tables["rpt_StopData"].Merge(ds.Tables["StopData"], false, MissingSchemaAction.Ignore);

            }
            else
            {
                return null;
            }

            return dsCrystal;
        }

        private DataSet GetExceptionData(int UserID, string xmlParams, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            string prm11 = "";
            string prm12 = "";
            string prm13 = "";
            string prm14 = "";
            string prm15 = "";
            string prm16 = "";
            string prm17 = "";
            string prm18 = "";
            string prm19 = "";
            string prm20 = "";
            string prm21 = "";
            string prm22 = "";
            string prm23 = "";
            string prm24 = "";
            string prm25 = "";
            string prm26 = "";
            string prm27 = "";
            string prm28 = "";
            string prm29 = "";
            string prm30 = "";

            int totalSqlRecords = 0;
            int outMaxRecords = 0;



            prm1 = Util.PairFindValue(ReportTemplate.RpExceptionFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpExceptionSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpExceptionThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpExceptionFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpExceptionFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpExceptionSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpExceptionSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpExceptionEightParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpExceptionNineParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpExceptionTenParamName, xmlParams);
            prm11 = Util.PairFindValue(ReportTemplate.RpExceptionElevenParamName, xmlParams);
            prm12 = Util.PairFindValue(ReportTemplate.RpExceptionTwelveParamName, xmlParams);
            prm13 = Util.PairFindValue(ReportTemplate.RpExceptionThirteenParamName, xmlParams);
            prm14 = Util.PairFindValue(ReportTemplate.RpExceptionFourteenParamName, xmlParams);
            prm15 = Util.PairFindValue(ReportTemplate.RpExceptionFifteenParamName, xmlParams);
            prm16 = Util.PairFindValue(ReportTemplate.RpExceptionSixteenParamName, xmlParams);
            prm17 = Util.PairFindValue(ReportTemplate.RpExceptionSeventeenParamName, xmlParams);
            prm18 = Util.PairFindValue(ReportTemplate.RpExceptionEighteenParamName, xmlParams);
            prm19 = Util.PairFindValue(ReportTemplate.RpExceptionNineteenParamName, xmlParams);
            prm20 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyParamName, xmlParams);
            prm21 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyFirstParamName, xmlParams);
            prm22 = Util.PairFindValue(ReportTemplate.RpExceptionTwentySecondParamName, xmlParams);
            prm23 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyThirdParamName, xmlParams);
            prm24 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyFourthParamName, xmlParams);
            prm25 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyFifthParamName, xmlParams);
            prm26 = Util.PairFindValue(ReportTemplate.RpExceptionTwentySixthParamName, xmlParams);
            prm27 = Util.PairFindValue(ReportTemplate.RpExceptionTwentySeventParamName, xmlParams);
            prm28 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyEightParamName, xmlParams);
            prm29 = Util.PairFindValue(ReportTemplate.RpExceptionTwentyNineParamName, xmlParams);
            prm30 = Util.PairFindValue(ReportTemplate.RpExceptionThirtyParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null ||
                prm4 == null || prm5 == null || prm6 == null || prm7 == null ||
                prm8 == null || prm9 == null || prm10 == null || prm11 == null ||
                prm12 == null || prm13 == null || prm14 == null || prm15 == null || prm16 == null ||
                prm17 == null || prm18 == null || prm19 == null || prm20 == null || prm21 == null ||
                prm22 == null || prm23 == null || prm24 == null || prm25 == null || prm26 == null ||
                prm27 == null || prm28 == null || prm29 == null || prm30 == null)
            {

                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);

            DataSet ds = detailedTrip.GetExceptionReport(prm1,
                                                       prm2,//fromDateTime,
                                                       prm3,//toDateTime,
                                                       UserID,
                                                       Convert.ToInt16(prm4),//sosLimit,
                                                       Convert.ToInt32(prm5),//noDoorSnsHrs,
                                                       Convert.ToBoolean(prm6),//IncludeTar
                                                       Convert.ToBoolean(prm7),//IncludeMobilize
                                                       Convert.ToBoolean(prm8),//15SecDoorSns
                                                       Convert.ToBoolean(prm9),//50%ofLeash
                                                       Convert.ToBoolean(prm10),//MainAndBackupBatterySns
                                                       Convert.ToBoolean(prm11),//TamperSns
                                                       Convert.ToBoolean(prm12),//AnyPanicSns
                                                       Convert.ToBoolean(prm13),//ThreeKeypadAttemptsSns
                                                       Convert.ToBoolean(prm14),//AltGPSAntennaSns
                                                       Convert.ToBoolean(prm15),//ControllerStatus
                                                       Convert.ToBoolean(prm16),//LeashBrokenSns
                                                       Convert.ToBoolean(prm17),//DriverDoor
                                                       Convert.ToBoolean(prm18),//PassengerDoor
                                                       Convert.ToBoolean(prm19),//SideHopperDoor
                                                       Convert.ToBoolean(prm20),//RearHopperDoor
                                                       Convert.ToBoolean(prm21),//IncludeCurrentTar
                                                       Convert.ToBoolean(prm22),//Locker1
                                                       Convert.ToBoolean(prm23),//Locker2
                                                       Convert.ToBoolean(prm24),//Locker3
                                                       Convert.ToBoolean(prm25),//Locker4
                                                       Convert.ToBoolean(prm26),//Locker5
                                                       Convert.ToBoolean(prm27),//Locker6
                                                       Convert.ToBoolean(prm28),//Locker7
                                                       Convert.ToBoolean(prm29),//Locker8
                                                       Convert.ToBoolean(prm30),//Locker9

                                                       ref requestOverflowed,
                                                       ref totalSqlRecords);

            if (ds == null)
                return null;

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExceptionReport.xsd"));

            //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_Exception"]);

            dsCrystal.Tables["rpt_Exception"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

            foreach (DataRow oDataRow in dsCrystal.Tables["rpt_Exception"].Rows)
            {
                oDataRow["DateTime"] = Convert.ToDateTime(oDataRow["DateTime"]).ToString();
            }

            return dsCrystal;

        }

        private DataSet GetFleetExceptionData(int UserID, string xmlParams, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            string prm11 = "";
            string prm12 = "";
            string prm13 = "";
            string prm14 = "";
            string prm15 = "";
            string prm16 = "";
            string prm17 = "";
            string prm18 = "";
            string prm19 = "";
            string prm20 = "";
            string prm21 = "";
            string prm22 = "";
            string prm23 = "";
            string prm24 = "";
            string prm25 = "";
            string prm26 = "";
            string prm27 = "";
            string prm28 = "";
            string prm29 = "";
            string prm30 = "";


            int totalSqlRecords = 0;
            int outMaxRecords = 0;



            prm1 = Util.PairFindValue(ReportTemplate.RpFleetExceptionFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpFleetExceptionSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpFleetExceptionThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpFleetExceptionFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpFleetExceptionFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpFleetExceptionSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpFleetExceptionSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpFleetExceptionEightParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpFleetExceptionNineParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTenParamName, xmlParams);
            prm11 = Util.PairFindValue(ReportTemplate.RpFleetExceptionElevenParamName, xmlParams);
            prm12 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwelveParamName, xmlParams);
            prm13 = Util.PairFindValue(ReportTemplate.RpFleetExceptionThirteenParamName, xmlParams);
            prm14 = Util.PairFindValue(ReportTemplate.RpFleetExceptionFourteenParamName, xmlParams);
            prm15 = Util.PairFindValue(ReportTemplate.RpFleetExceptionFifteenParamName, xmlParams);
            prm16 = Util.PairFindValue(ReportTemplate.RpFleetExceptionSixteenParamName, xmlParams);
            prm17 = Util.PairFindValue(ReportTemplate.RpFleetExceptionSeventeenParamName, xmlParams);
            prm18 = Util.PairFindValue(ReportTemplate.RpFleetExceptionEighteenParamName, xmlParams);
            prm19 = Util.PairFindValue(ReportTemplate.RpFleetExceptionNineteenParamName, xmlParams);
            prm20 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyParamName, xmlParams);
            prm21 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyFirstParamName, xmlParams);

            prm22 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentySecondParamName, xmlParams);
            prm23 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyThirdParamName, xmlParams);
            prm24 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyFourthParamName, xmlParams);
            prm25 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyFifthParamName, xmlParams);
            prm26 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentySixthParamName, xmlParams);
            prm27 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentySeventParamName, xmlParams);
            prm28 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyEightParamName, xmlParams);
            prm29 = Util.PairFindValue(ReportTemplate.RpFleetExceptionTwentyNineParamName, xmlParams);
            prm30 = Util.PairFindValue(ReportTemplate.RpFleetExceptionThirtyParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null ||
                prm4 == null || prm5 == null || prm6 == null || prm7 == null ||
                prm8 == null || prm9 == null || prm10 == null || prm11 == null ||
                prm12 == null || prm13 == null || prm14 == null || prm15 == null || prm16 == null ||
                prm17 == null || prm18 == null || prm19 == null || prm20 == null || prm21 == null)
            {

                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report detailedTrip = new VLF.DAS.Logic.Report(ConnnectionString);

            DataSet ds = detailedTrip.GetFleetExceptionReport(Convert.ToInt16(prm1),
                                                             prm2,//fromDateTime,
                                                             prm3,//toDateTime,
                                                             UserID,
                                                             Convert.ToInt16(prm4),//sosLimit,
                                                             Convert.ToInt32(prm5),//noDoorSnsHrs,
                                                             Convert.ToBoolean(prm6),//IncludeTar
                                                             Convert.ToBoolean(prm7),//IncludeMobilize
                                                             Convert.ToBoolean(prm8),//15SecDoorSns
                                                             Convert.ToBoolean(prm9),//50%ofLeash
                                                             Convert.ToBoolean(prm10),//MainAndBackupBatterySns
                                                             Convert.ToBoolean(prm11),//TamperSns
                                                             Convert.ToBoolean(prm12),//AnyPanicSns
                                                             Convert.ToBoolean(prm13),//ThreeKeypadAttemptsSns
                                                             Convert.ToBoolean(prm14),//AltGPSAntennaSns
                                                             Convert.ToBoolean(prm15),//ControllerStatus
                                                             Convert.ToBoolean(prm16),//LeashBrokenSns
                                                             Convert.ToBoolean(prm17),//DriverDoor
                                                             Convert.ToBoolean(prm18),//PassengerDoor
                                                             Convert.ToBoolean(prm19),//SideHopperDoor
                                                             Convert.ToBoolean(prm20),//RearHopperDoor
                                                             Convert.ToBoolean(prm21),//IncludeCurrentTar
                                                             Convert.ToBoolean(prm22),//Locker1
                                                           Convert.ToBoolean(prm23),//Locker2
                                                           Convert.ToBoolean(prm24),//Locker3
                                                           Convert.ToBoolean(prm25),//Locker4
                                                           Convert.ToBoolean(prm26),//Locker5
                                                           Convert.ToBoolean(prm27),//Locker6
                                                           Convert.ToBoolean(prm28),//Locker7
                                                           Convert.ToBoolean(prm29),//Locker8
                                                           Convert.ToBoolean(prm30),//Locker9

                                                             ref requestOverflowed,
                                                             ref totalSqlRecords);

            if (ds == null)
                return null;

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExceptionReport.xsd"));

            //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_Exception"]);

            dsCrystal.Tables["rpt_Exception"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

            foreach (DataRow oDataRow in dsCrystal.Tables["rpt_Exception"].Rows)
            {
                oDataRow["DateTime"] = Convert.ToDateTime(oDataRow["DateTime"]).ToString();
            }

            return dsCrystal;
        }

        private DataSet GetMessages(Int32 UserID, Int32 BoxId, string fromDate, string toDate, Int16 msgDirection, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {

                StringReader strrXML = null;
                string xml = "";
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(fromDate), Convert.ToDateTime(toDate));
                VLF.DAS.Logic.MessageQueue dbMessageQueue = new VLF.DAS.Logic.MessageQueue(ConnnectionString);
                DataSet dsInfo = new DataSet();
                dsInfo = dbMessageQueue.GetTextMessagesFullInfo(UserID, BoxId, Convert.ToDateTime(fromDate), Convert.ToDateTime(toDate), msgDirection);
                return dsInfo;

            }
            catch (Exception Ex)
            {

                return null;
            }
        }

        private DataSet GetFleetMessages(Int32 UserID, Int32 FleetId, string fromDate, string toDate, Int16 msgDirection, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {

                StringReader strrXML = null;
                string xml = "";
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(fromDate), Convert.ToDateTime(toDate));
                VLF.DAS.Logic.MessageQueue dbMessageQueue = new VLF.DAS.Logic.MessageQueue(ConnnectionString);
                DataSet dsInfo = new DataSet();

                dsInfo = dbMessageQueue.GetFleetTextMessagesFullInfo(UserID, FleetId, Convert.ToDateTime(fromDate), Convert.ToDateTime(toDate), msgDirection);
                return dsInfo;

            }
            catch (Exception Ex)
            {

                return null;
            }
        }

        /// <summary>
        ///      it extract sensor activity for
        ///      - ignition     (sensor 3)
        ///      - high rail    (sensor 7)
        ///      - crane        (sensor 2)
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="fleetId"></param>
        /// <param name="dtFrom"></param>
        /// <param name="dtTo"></param>
        /// <param name="dsCrystal"></param>
        /// <returns></returns>
        private DataSet GetUtilizationInfo(Int32 userId, Int32 fleetId,
                                            DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {

            try
            {
                DataSet dsFleet = new DataSet();
                ReportGenerator dbReport;
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                VLF.DAS.Logic.Fleet dbf = new VLF.DAS.Logic.Fleet(ConnnectionString);
                dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);



                string xml = "";
                StringReader strrXML;

                #region Ignition Sensors calculation

                using (dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetSensorReportForFleet(fleetId, userId, 3, dtFrom, dtTo);
                }

                if (string.IsNullOrEmpty(xml))
                    return null;


                DataSet ds = new DataSet();
                strrXML = new StringReader(xml);
                ds.ReadXml(strrXML);

                if (ds.Tables.Count == 0)
                    return null;

                DataColumn TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                ds.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                DataColumn Day = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(Day);


                DataColumn Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["SensorsUtilization"].Columns.Add(Utilization);


                DataColumn WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(WorkingHours);


                TimeSpan TotalDayHours;
                TimeSpan DateDiff;


                for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    TotalDayHours = new TimeSpan(Convert.ToInt64(DateDiff.TotalMinutes) * TimeSpan.TicksPerMinute);
                    rowItem["TotalHours"] = TotalDayHours.ToString();
                    if (DateDiff.Minutes != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                    else
                        rowItem["Utilization"] = 0;

                    rowItem["WorkingHours"] = DateDiff.TotalMinutes;

                }

                #endregion Ignition Sensors calculation

                //CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Ignition"]);

                dsCrystal.Tables["rpt_Ignition"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);



                #region Idling calculation
                DataColumn Day1 = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["IdlingDuration"].Columns.Add(Day1);

                DataColumn Utilization1 = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["IdlingDuration"].Columns.Add(Utilization1);



                for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    if (DateDiff.TotalSeconds != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalSeconds) * 100;
                    else
                        rowItem["Utilization"] = 0;

                }
                #endregion Idling calculation

                //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling_Utilization"]);

                dsCrystal.Tables["rpt_Idling_Utilization"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);




                #region High Rail calculation
                xml = dbReport.GetSensorReportForFleet(fleetId, userId, 7, dtFrom, dtTo);
                if (xml != "")
                {
                    ds.Tables.Clear();
                    strrXML = new StringReader(xml);
                    ds.ReadXml(strrXML);
                    if (ds.Tables.IndexOf("SensorsUtilization") != -1)
                    {


                        DataColumn Day2 = new DataColumn("Day", Type.GetType("System.Int32"));
                        ds.Tables[0].Columns.Add(Day2);

                        DataColumn Utilization2 = new DataColumn("Utilization", Type.GetType("System.Single"));
                        ds.Tables[0].Columns.Add(Utilization2);

                        for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
                        {

                            DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                            if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                            {
                                ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                                i--;
                                continue;
                            }



                            rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                            DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                            if (DateDiff.Minutes != 0)
                                rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                            else
                                rowItem["Utilization"] = 0;
                        }


                        //CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Rail_Utilization"]);

                        dsCrystal.Tables["rpt_Rail_Utilization"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);

                    }
                }
                #endregion High Rail calculation


                #region Crane calculation
                xml = dbReport.GetSensorReportForFleet(fleetId, userId, 2, dtFrom, dtTo);
                if (xml != "")
                {
                    ds.Tables.Clear();
                    strrXML = new StringReader(xml);
                    ds.ReadXml(strrXML);

                    if (ds.Tables.IndexOf("SensorsUtilization") != -1)
                    {
                        DataColumn Day3 = new DataColumn("Day", Type.GetType("System.Int32"));
                        ds.Tables[0].Columns.Add(Day3);

                        DataColumn Utilization3 = new DataColumn("Utilization", Type.GetType("System.Single"));
                        ds.Tables[0].Columns.Add(Utilization3);

                        for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
                        {

                            DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                            if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                            {
                                ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                                i--;
                                continue;
                            }

                            rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                            DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                            if (DateDiff.Minutes != 0)
                                rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                            else
                                rowItem["Utilization"] = 0;
                        }


                        //CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Crane_Utilization"]);

                        dsCrystal.Tables["rpt_Crane_Utilization"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);

                    }
                }
                #endregion crane calculation

                return dsCrystal;

            }
            catch (Exception Ex)
            {

                return null;
            }

        }

        /// <summary>
        ///   
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="fleetId"></param>
        /// <param name="dtFrom"></param>
        /// <param name="dtTo"></param>
        /// <param name="dsCrystal"></param>
        /// <returns></returns>
        private DataSet GetUtilizationInfoByVehicleType(Int32 userId, Int32 fleetId,
                                                     DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {

            try
            {


                DataSet dsFleet = new DataSet();
                ReportGenerator dbReport;
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                VLF.DAS.Logic.Fleet dbf = new VLF.DAS.Logic.Fleet(ConnnectionString);
                dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);



                string xml = "";
                StringReader strrXML;


                using (dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetActivityReportForFleet(3, fleetId, userId, dtFrom, dtTo);
                }

                if (xml == "")
                    return null;


                DataSet ds = new DataSet();
                strrXML = new StringReader(xml);
                ds.ReadXml(strrXML);

                if (ds.Tables.Count == 0)
                    return null;


                for (int i = 0; i < ds.Tables["DailyActivity"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["DailyActivity"].Rows[i];

                    if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["DailyActivity"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["WorkingMinutes"] = Convert.ToInt32(rowItem["WorkingMinutes"]) / 60;
                    rowItem["OnMinutes"] = Convert.ToInt32(rowItem["OnMinutes"]) / 60;
                }

                //CopyRows(ds.Tables["DailyActivity"], dsCrystal.Tables["rpt_DailyActivity"]);

                dsCrystal.Tables["rpt_DailyActivity"].Merge(ds.Tables["DailyActivity"], false, MissingSchemaAction.Ignore);


                if (ds.Tables.Count > 1)
                {

                    for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                    {

                        DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                        if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                        {
                            ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }

                        rowItem["IdlingMinutes"] = Convert.ToInt32(rowItem["IdlingMinutes"]) / 60;
                    }

                    //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling"]);

                    dsCrystal.Tables["rpt_Idling"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);


                }

                return dsCrystal;

            }
            catch (Exception Ex)
            {

                return null;
            }

        }

        private DataSet GetUtilizationWeekly(Int32 userId, Int32 fleetId, DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }

                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


                string xml = "";

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetActivityReportForFleet(3, fleetId, userId, dtFrom, dtTo);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                DataColumn WeekDesc = new DataColumn("WeekDesc", Type.GetType("System.String"));
                ds.Tables["DailyActivity"].Columns.Add(WeekDesc);


                for (int i = 0; i < ds.Tables["DailyActivity"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["DailyActivity"].Rows[i];

                    if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["DailyActivity"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["WorkingMinutes"] = Convert.ToInt32(rowItem["WorkingMinutes"]) / 60;
                    rowItem["OnMinutes"] = Convert.ToInt32(rowItem["OnMinutes"]) / 60;
                    rowItem["WeekDesc"] = GetWeekDesc(Convert.ToDateTime(rowItem["Date"]));

                }

                //CopyRows(ds.Tables["DailyActivity"], dsCrystal.Tables["rpt_DailyActivity"]);

                dsCrystal.Tables["rpt_DailyActivity"].Merge(ds.Tables["DailyActivity"], false, MissingSchemaAction.Ignore);


                if (ds.Tables.Count > 1)
                {

                    for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                    {

                        DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                        if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() == "1/1/2000")
                        {
                            ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }


                        rowItem["IdlingMinutes"] = Convert.ToInt32(rowItem["IdlingMinutes"]) / 60;
                    }

                    //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling"]);

                    dsCrystal.Tables["rpt_Idling"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);

                }
                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }


        /// <summary>
        ///      
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="fleetId"></param>
        /// <param name="dtFrom"></param>
        /// <param name="dtTo"></param>
        /// <param name="dsCrystal"></param>
        /// <returns></returns>
        private DataSet GetUtilizationDailyFleet(Int32 userId, Int32 fleetId,
                                                 DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {

            try
            {


                DataSet dsFleet = new DataSet();
                ReportGenerator dbReport;
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                VLF.DAS.Logic.Fleet dbf = new VLF.DAS.Logic.Fleet(ConnnectionString);
                dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);



                string xml = "";
                StringReader strrXML;


                using (dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetActivityReportForFleet(3, fleetId, userId, dtFrom, dtTo);
                }

                if (string.IsNullOrEmpty(xml))
                    return null;


                DataSet ds = new DataSet();
                strrXML = new StringReader(xml);
                ds.ReadXml(strrXML);

                if (ds.Tables.Count == 0)
                    return null;



                DataColumn sDate = new DataColumn("sDate", Type.GetType("System.String"));
                ds.Tables["DailyActivity"].Columns.Add(sDate);



                for (int i = 0; i < ds.Tables["DailyActivity"].Rows.Count; i++)
                {
                    DataRow rowItem = ds.Tables["DailyActivity"].Rows[i];

                    if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["DailyActivity"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }

                    rowItem["sDate"] = Convert.ToDateTime(rowItem["Date"]).ToShortDateString();
                    rowItem["WorkingMinutes"] = Convert.ToInt32(rowItem["WorkingMinutes"]) / 60;
                    rowItem["OnMinutes"] = Convert.ToInt32(rowItem["OnMinutes"]) / 60;
                }

                //CopyRows(ds.Tables["DailyActivity"], dsCrystal.Tables["rpt_DailyActivity"]);

                dsCrystal.Tables["rpt_DailyActivity"].Merge(ds.Tables["DailyActivity"], false, MissingSchemaAction.Ignore);


                if (ds.Tables.Count > 1)
                {
                    DataColumn sDate1 = new DataColumn("sDate", Type.GetType("System.String"));
                    ds.Tables["IdlingDuration"].Columns.Add(sDate1);


                    for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                    {
                        DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                        if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                        {
                            ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }


                        rowItem["sDate"] = Convert.ToDateTime(rowItem["Date"]).ToShortDateString();
                        rowItem["IdlingMinutes"] = Convert.ToInt32(rowItem["IdlingMinutes"]) / 60;
                    }

                    //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling"]);

                    dsCrystal.Tables["rpt_Idling"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);

                }


                return dsCrystal;

            }
            catch (Exception Ex)
            {

                return null;
            }

        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="userId"></param>
        /// <param name="fleetId"></param>
        /// <param name="dtFrom"></param>
        /// <param name="dtTo"></param>
        /// <param name="dsCrystal"></param>
        /// <returns></returns>
        private DataSet GetUtilizationDailyDetails(Int32 userId, Int32 fleetId,
                                                   DateTime dtFrom, DateTime dtTo,
                                                   ref DataSet dsCrystal)
        {

            try
            {


                DataSet dsFleet = new DataSet();
                ReportGenerator dbReport;
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                VLF.DAS.Logic.Fleet dbf = new VLF.DAS.Logic.Fleet(ConnnectionString);
                dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);



                string xml = "";
                StringReader strrXML;


                // STEP 1 : get sensor activity 
                using (dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetActivityReportForFleet(3, fleetId, userId, dtFrom, dtTo);
                }

                if (xml == "")
                    return null;


                DataSet ds = new DataSet();
                strrXML = new StringReader(xml);
                ds.ReadXml(strrXML);

                if (ds.Tables.Count == 0)
                    return null;


                DataColumn Weekend = new DataColumn("Weekend", Type.GetType("System.Boolean"));
                ds.Tables["DailyActivity"].Columns.Add(Weekend);

                DataColumn sDate = new DataColumn("sDate", Type.GetType("System.String"));
                ds.Tables["DailyActivity"].Columns.Add(sDate);



                for (int i = 0; i < ds.Tables["DailyActivity"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["DailyActivity"].Rows[i];

                    if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                    {
                        ds.Tables["DailyActivity"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }

                    if (DayOfWeek.Saturday == Convert.ToDateTime(rowItem["Date"]).DayOfWeek ||
                         DayOfWeek.Sunday == Convert.ToDateTime(rowItem["Date"]).DayOfWeek)
                        rowItem["Weekend"] = "true";
                    else
                        rowItem["Weekend"] = "false";

                    rowItem["sDate"] = Convert.ToDateTime(rowItem["Date"]).ToShortDateString();
                    rowItem["WorkingMinutes"] = Convert.ToInt32(rowItem["WorkingMinutes"]) / 60;
                    rowItem["OnMinutes"] = Convert.ToInt32(rowItem["OnMinutes"]) / 60;
                }

                //CopyRows(ds.Tables["DailyActivity"], dsCrystal.Tables["rpt_DailyActivity"]);

                dsCrystal.Tables["rpt_DailyActivity"].Merge(ds.Tables["DailyActivity"], false, MissingSchemaAction.Ignore);

                // here the assumption is the secondary table is named "IdlingDuration" 
                // STEP 2: remove totals and recognize weekends 
                // I really don't understand that sDate is shortDate !!!
                if (ds.Tables.Count > 1)
                {
                    DataColumn Weekend1 = new DataColumn("Weekend", Type.GetType("System.Boolean"));
                    ds.Tables["IdlingDuration"].Columns.Add(Weekend1);

                    DataColumn sDate1 = new DataColumn("sDate", Type.GetType("System.String"));
                    ds.Tables["IdlingDuration"].Columns.Add(sDate1);



                    for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                    {

                        DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                        if (Convert.ToDateTime(rowItem["Date"]).ToShortDateString() == "1/1/2000")
                        {
                            ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }

                        if ((DayOfWeek.Saturday == Convert.ToDateTime(rowItem["Date"]).DayOfWeek) || (DayOfWeek.Sunday == Convert.ToDateTime(rowItem["Date"]).DayOfWeek))
                            rowItem["Weekend"] = "true";
                        else
                            rowItem["Weekend"] = "false";

                        rowItem["sDate"] = Convert.ToDateTime(rowItem["Date"]).ToShortDateString();
                        rowItem["IdlingMinutes"] = Convert.ToInt32(rowItem["IdlingMinutes"]) / 60;
                    }

                    //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling"]);

                    dsCrystal.Tables["rpt_Idling"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);

                }

                // STEP 3: remove totals and recognize weekends for this table
                xml = dbReport.GetActiveVehiclesPerDay(fleetId, userId, dtFrom, dtTo);

                if (xml != "")
                {
                    ds.Tables.Clear();
                    strrXML = new StringReader(xml);
                    ds.ReadXml(strrXML);

                    DataColumn Weekend2 = new DataColumn("Weekend", Type.GetType("System.Boolean"));
                    ds.Tables[0].Columns.Add(Weekend2);


                    DataColumn sDate2 = new DataColumn("sDate", Type.GetType("System.String"));
                    ds.Tables[0].Columns.Add(sDate2);


                    for (int i = 0; i < ds.Tables[0].Rows.Count; i++)
                    {
                        DataRow rowItem = ds.Tables[0].Rows[i];


                        if ((DayOfWeek.Saturday == Convert.ToDateTime(rowItem["OriginDateTime"]).DayOfWeek) || (DayOfWeek.Sunday == Convert.ToDateTime(rowItem["OriginDateTime"]).DayOfWeek))
                            rowItem["Weekend"] = "true";
                        else
                            rowItem["Weekend"] = "false";

                        rowItem["sDate"] = Convert.ToDateTime(rowItem["OriginDateTime"]).ToShortDateString();

                    }


                    //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ActiveVehicles"]);

                    dsCrystal.Tables["rpt_ActiveVehicles"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);


                }

                return dsCrystal;

            }
            catch (Exception Ex)
            {

                return null;
            }

        }

        private DataSet GetIdlingDetails(Int32 userId, Int32 fleetId,
                                         DateTime dtFrom, DateTime dtTo,
                                         ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";
                ReportGenerator dbReport = new ReportGenerator(ConnnectionString);
                xml = dbReport.GetSensorReportForFleet(fleetId, userId, 3, dtFrom, dtTo);

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (ds.Tables.Count == 0)
                    return null;

                DataColumn TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                ds.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                DataColumn Day = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(Day);


                DataColumn Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["SensorsUtilization"].Columns.Add(Utilization);


                DataColumn WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(WorkingHours);



                TimeSpan TotalDayHours;
                TimeSpan DateDiff;

                #region Sensor Utilization
                for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                    {
                        ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }



                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    TotalDayHours = new TimeSpan(Convert.ToInt64(DateDiff.TotalMinutes) * TimeSpan.TicksPerMinute);
                    rowItem["TotalHours"] = TotalDayHours.ToString();
                    if (DateDiff.Minutes != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                    else
                        rowItem["Utilization"] = 0;

                    rowItem["WorkingHours"] = DateDiff.TotalMinutes;

                }


                //CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Ignition"]);
                dsCrystal.Tables["rpt_Ignition"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);
                #endregion

                #region Idling calculation

                if (ds.Tables.IndexOf("IdlingDuration") == -1)
                    return dsCrystal;


                DataColumn Day1 = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["IdlingDuration"].Columns.Add(Day1);

                DataColumn Utilization1 = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["IdlingDuration"].Columns.Add(Utilization1);



                for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                {
                    DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                    {
                        ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    if (DateDiff.TotalSeconds != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalSeconds) * 100;
                    else
                        rowItem["Utilization"] = 0;
                }

                //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling_Utilization"]);

                dsCrystal.Tables["rpt_Idling_Utilization"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);

                #endregion

                #region PTO

                xml = dbReport.GetSensorReportForFleet(fleetId, userId, 8, dtFrom, dtTo);

                DataSet dsPTO = new DataSet();
                dsPTO.ReadXml(new StringReader(xml));

                if (dsPTO.Tables.IndexOf("SensorsUtilization") != -1)
                {


                    TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                    Day = new DataColumn("Day", Type.GetType("System.Int32"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(Day);


                    Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(Utilization);


                    WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(WorkingHours);


                    for (int i = 0; i < dsPTO.Tables["SensorsUtilization"].Rows.Count; i++)
                    {

                        DataRow rowItem = dsPTO.Tables["SensorsUtilization"].Rows[i];

                        if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                        {
                            dsPTO.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }
                    }
                    //CopyRows(dsPTO.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Rail_Utilization"]);

                    dsCrystal.Tables["rpt_Rail_Utilization"].Merge(dsPTO.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);


                }
                #endregion
                #region FuelConsumption
                DataSet dsFuel = dbReport.GetFuelConsumption(fleetId, dtFrom, dtTo, userId);
                if (dsFuel != null && dsFuel.Tables.Count > 0 && dsFuel.Tables[0].Rows.Count > 0)
                    dsCrystal.Tables["rpt_FuelConsumption"].Merge(dsFuel.Tables[0], false, MissingSchemaAction.Ignore);
                #endregion

                return dsCrystal;
            }
            catch
            {
                return null;
            }
        }

        private DataSet GetIdlingMessagesDetails(Int32 userId, Int32 fleetId,
                                       DateTime dtFrom, DateTime dtTo,
                                       ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";
                ReportGenerator dbReport = new ReportGenerator(ConnnectionString);
                xml = dbReport.GetSensorIdlingReportForFleet(fleetId, userId, 3, dtFrom, dtTo);

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (ds.Tables.Count == 0)
                    return null;

                DataColumn TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                ds.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                DataColumn Day = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(Day);


                DataColumn Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["SensorsUtilization"].Columns.Add(Utilization);


                DataColumn WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                ds.Tables["SensorsUtilization"].Columns.Add(WorkingHours);



                TimeSpan TotalDayHours;
                TimeSpan DateDiff;

                #region Sensor Utilization
                for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
                {

                    DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                    {
                        ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }



                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    TotalDayHours = new TimeSpan(Convert.ToInt64(DateDiff.TotalMinutes) * TimeSpan.TicksPerMinute);
                    rowItem["TotalHours"] = TotalDayHours.ToString();
                    if (DateDiff.Minutes != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                    else
                        rowItem["Utilization"] = 0;

                    rowItem["WorkingHours"] = DateDiff.TotalMinutes;

                }


                //CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Ignition"]);
                dsCrystal.Tables["rpt_Ignition"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);
                #endregion

                #region Idling calculation

                if (ds.Tables.IndexOf("IdlingDuration") == -1)
                    return dsCrystal;


                DataColumn Day1 = new DataColumn("Day", Type.GetType("System.Int32"));
                ds.Tables["IdlingDuration"].Columns.Add(Day1);

                DataColumn Utilization1 = new DataColumn("Utilization", Type.GetType("System.Single"));
                ds.Tables["IdlingDuration"].Columns.Add(Utilization1);



                for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
                {
                    DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                    {
                        ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                    rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                    DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                    if (DateDiff.TotalSeconds != 0)
                        rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalSeconds) * 100;
                    else
                        rowItem["Utilization"] = 0;
                }

                //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling_Utilization"]);

                dsCrystal.Tables["rpt_Idling_Utilization"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);

                #endregion

                #region PTO

                xml = dbReport.GetSensorReportForFleet(fleetId, userId, 8, dtFrom, dtTo);

                DataSet dsPTO = new DataSet();
                dsPTO.ReadXml(new StringReader(xml));

                if (dsPTO.Tables.IndexOf("SensorsUtilization") != -1)
                {


                    TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                    Day = new DataColumn("Day", Type.GetType("System.Int32"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(Day);


                    Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(Utilization);


                    WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                    dsPTO.Tables["SensorsUtilization"].Columns.Add(WorkingHours);


                    for (int i = 0; i < dsPTO.Tables["SensorsUtilization"].Rows.Count; i++)
                    {

                        DataRow rowItem = dsPTO.Tables["SensorsUtilization"].Rows[i];

                        if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                        {
                            dsPTO.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                            i--;
                            continue;
                        }
                    }
                    //CopyRows(dsPTO.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Rail_Utilization"]);

                    dsCrystal.Tables["rpt_Rail_Utilization"].Merge(dsPTO.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);

                #endregion
                    #region FuelConsumption
                    DataSet dsFuel = dbReport.GetFuelConsumption(fleetId, dtFrom, dtTo, userId);
                    if (dsFuel != null && dsFuel.Tables.Count > 0 && dsFuel.Tables[0].Rows.Count > 0)
                        dsCrystal.Tables["rpt_FuelConsumption"].Merge(dsFuel.Tables[0], false, MissingSchemaAction.Ignore);
                    #endregion

                }
                return dsCrystal;
            }
            catch
            {
                return null;
            }
        }

        private DataSet GetOffHoursInfo(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref  TimeSpan totalTrip, ref TimeSpan totalIdling, ref TimeSpan totalStop, ref  Double totalCost)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            string prm11 = "";
            string prm12 = "";




            int totalSqlRecords = 0;
            int outMaxRecords = 0;
            string strTotal = "";


            prm1 = Util.PairFindValue(ReportTemplate.RpOffHourFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpOffHourSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpOffHourThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpOffHourFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpOffHourFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpOffHourSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpOffHourSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpOffHourEightParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpOffHourNineParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpOffHourTenParamName, xmlParams);
            prm11 = Util.PairFindValue(ReportTemplate.RpOffHourElevenParamName, xmlParams);
            prm12 = Util.PairFindValue(ReportTemplate.RpOffHourTwelveParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null || prm10 == null || prm11 == null || prm12 == null)
                return null;


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string xmlDataSet = "";
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report offHoursReport = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet dsReport = offHoursReport.GetOffHourReport(prm1, prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt16(prm5), Convert.ToInt16(prm6), Convert.ToInt16(prm7), Convert.ToInt16(prm8), Convert.ToInt16(prm9), Convert.ToInt16(prm10), Convert.ToInt16(prm11), Convert.ToInt16(prm12), lang, ref requestOverflowed, ref totalSqlRecords, ref outMaxOverflowed, ref outMaxRecords);
            if (dsReport != null)
                xmlDataSet = dsReport.GetXml();


            StringReader strrXML = new StringReader(xmlDataSet);
            DataSet ds = new DataSet();
            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));

            ds.ReadXml(strrXML);
            if (ds.Tables.Count == 0)
            {
                return null;
            }


            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);

            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripStart") != -1)
            {
                //Delete In Hours records from dataset   
                for (int i = 0; i < ds.Tables["TripStart"].Rows.Count; i++)
                {
                    DataRow rowItem = ds.Tables["TripStart"].Rows[i];
                    if (!Convert.ToBoolean(rowItem["IsLandmark"]))
                    {
                        ds.Tables["TripStart"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }
                }

                if (ds.Tables["TripStart"].Rows.Count > 0)
                {
                    DataSet dsTemp = new DataSet();

                    dsTemp.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));
                    dsTemp.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);

                    DataTable dtTemp = DataTableSorting(dsTemp.Tables["rpt_TripStart"], "Summary ASC");
                    //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                    //dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
                    dsCrystal.Tables["rpt_TripStart"].Merge(dtTemp, false, MissingSchemaAction.Ignore);
                }
                else
                    return null;
            }
            else
            {
                return null;
            }

            if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripCost") != -1)
                //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDistance") != -1)
                //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                {
                    //Convert time to user format			
                    strTotal = "";
                    /*
                    TimeSpan TripDuration;
                    TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripDuration.Days > 0)
                    {
                       strTotal += TripDuration.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripDuration.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalTrip += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);
                dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);
            }
            if (ds.Tables.IndexOf("TripStopsDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                {
                    //Convert time to user format			
                    strTotal = "";
                    /*
                    TimeSpan TripIndling;
                    TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripIndling.Days > 0)
                    {
                       strTotal += TripIndling.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripIndling.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalIdling += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);

                dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripEnd") != -1)
                //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("StopDurationBetweenTrips") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["StopDurationBetweenTrips"].Rows)
                {
                    //Convert time to user format		
                    strTotal = "";
                    /*
                    TimeSpan TripStop;
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                       strTotal += TripStop.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripStop.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalStop += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["StopDurationBetweenTrips"], dsCrystal.Tables["rpt_StopDurationBetweenTrips"]);

                dsCrystal.Tables["rpt_StopDurationBetweenTrips"].Merge(ds.Tables["StopDurationBetweenTrips"], false, MissingSchemaAction.Ignore);
            }


            if (ds.Tables.IndexOf("TripCost") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripCost"].Rows)
                {

                    totalCost += Convert.ToDouble(rowItem["Summary"]);
                }


            }
            return dsCrystal;
        }

        private DataSet GetFleetOffHoursInfo(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed, ref  TimeSpan totalTrip, ref TimeSpan totalIdling, ref TimeSpan totalStop, ref  Double totalCost)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";
            string prm6 = "";
            string prm7 = "";
            string prm8 = "";
            string prm9 = "";
            string prm10 = "";
            string prm11 = "";
            string prm12 = "";


            int totalSqlRecords = 0;
            int outMaxRecords = 0;
            string strTotal = "";


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string xmlDataSet = "";


            prm1 = Util.PairFindValue(ReportTemplate.RpFleetOffHourFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpOffHourSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpOffHourThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpOffHourFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpOffHourFifthParamName, xmlParams);
            prm6 = Util.PairFindValue(ReportTemplate.RpOffHourSixthParamName, xmlParams);
            prm7 = Util.PairFindValue(ReportTemplate.RpOffHourSeventhParamName, xmlParams);
            prm8 = Util.PairFindValue(ReportTemplate.RpOffHourEightParamName, xmlParams);
            prm9 = Util.PairFindValue(ReportTemplate.RpOffHourNineParamName, xmlParams);
            prm10 = Util.PairFindValue(ReportTemplate.RpOffHourTenParamName, xmlParams);
            prm11 = Util.PairFindValue(ReportTemplate.RpOffHourElevenParamName, xmlParams);
            prm12 = Util.PairFindValue(ReportTemplate.RpOffHourTwelveParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null || prm6 == null || prm7 == null || prm8 == null || prm9 == null || prm10 == null || prm11 == null || prm12 == null)
                return null;

            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report fleetOffHoursReport = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet dsReport = fleetOffHoursReport.GetFleetOffHourReport(Convert.ToInt32(prm1), prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt16(prm5), Convert.ToInt16(prm6), Convert.ToInt16(prm7), Convert.ToInt16(prm8), Convert.ToInt16(prm9), Convert.ToInt16(prm10), Convert.ToInt16(prm11), Convert.ToInt16(prm12), lang, ref requestOverflowed, ref totalSqlRecords, ref outMaxOverflowed, ref outMaxRecords);
            if (dsReport != null)
                xmlDataSet = dsReport.GetXml();


            DataSet ds = new DataSet();
            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripReportData.xsd"));

            ds.ReadXml(new StringReader(xmlDataSet));

            if (ds.Tables.Count == 0)
            {
                return null;
            }


            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripReportDriverInfo") != -1)
                //CopyRows(ds.Tables["TripReportDriverInfo"], dsCrystal.Tables["rpt_DriverInfo"]);
                dsCrystal.Tables["rpt_DriverInfo"].Merge(ds.Tables["TripReportDriverInfo"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripStart") != -1)
            {
                //Delete In Hours records from dataset   
                for (int i = 0; i < ds.Tables["TripStart"].Rows.Count; i++)
                {
                    DataRow rowItem = ds.Tables["TripStart"].Rows[i];
                    if (!Convert.ToBoolean(rowItem["IsLandmark"]))
                    {
                        ds.Tables["TripStart"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }
                }

                if (ds.Tables["TripStart"].Rows.Count > 0)
                    //CopyRows(ds.Tables["TripStart"], dsCrystal.Tables["rpt_TripStart"]);
                    dsCrystal.Tables["rpt_TripStart"].Merge(ds.Tables["TripStart"], false, MissingSchemaAction.Ignore);
                else
                    return null;
            }
            else
            {
                return null;
            }

            if (ds.Tables.IndexOf("TripAverageSpeed") != -1)
                //CopyRows(ds.Tables["TripAverageSpeed"], dsCrystal.Tables["rpt_TripAverageSpeed"]);
                dsCrystal.Tables["rpt_TripAverageSpeed"].Merge(ds.Tables["TripAverageSpeed"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripCost") != -1)
                //CopyRows(ds.Tables["TripCost"], dsCrystal.Tables["rpt_TripCost"]);
                dsCrystal.Tables["rpt_TripCost"].Merge(ds.Tables["TripCost"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDistance") != -1)
                //CopyRows(ds.Tables["TripDistance"], dsCrystal.Tables["rpt_TripDistance"]);
                dsCrystal.Tables["rpt_TripDistance"].Merge(ds.Tables["TripDistance"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("TripDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripDuration"].Rows)
                {
                    //Convert time to user format			
                    strTotal = "";
                    /*
                    TimeSpan TripDuration;
                    TripDuration = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripDuration.Days > 0)
                    {
                       strTotal += TripDuration.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripDuration.Ticks - TripDuration.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripDuration.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalTrip += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripDuration"], dsCrystal.Tables["rpt_TripDuration"]);

                dsCrystal.Tables["rpt_TripDuration"].Merge(ds.Tables["TripDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripStopsDuration") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripStopsDuration"].Rows)
                {
                    //Convert time to user format				
                    strTotal = "";
                    /*
                    TimeSpan TripIndling;
                    TripIndling = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripIndling.Days > 0)
                    {
                       strTotal += TripIndling.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripIndling.Ticks - TripIndling.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripIndling.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalIdling += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["TripStopsDuration"], dsCrystal.Tables["rpt_TripStopsDuration"]);

                dsCrystal.Tables["rpt_TripStopsDuration"].Merge(ds.Tables["TripStopsDuration"], false, MissingSchemaAction.Ignore);

            }
            if (ds.Tables.IndexOf("TripEnd") != -1)
                //CopyRows(ds.Tables["TripEnd"], dsCrystal.Tables["rpt_TripEnd"]);
                dsCrystal.Tables["rpt_TripEnd"].Merge(ds.Tables["TripEnd"], false, MissingSchemaAction.Ignore);
            if (ds.Tables.IndexOf("StopDurationBetweenTrips") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["StopDurationBetweenTrips"].Rows)
                {
                    //Convert time to user format		
                    strTotal = "";
                    /*
                    TimeSpan TripStop;
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                       strTotal += TripStop.Days.ToString() + " d, ";
                       strTotal += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                       strTotal = TripStop.ToString();
                    }
                    */
                    CalculateDuration(rowItem["Remarks"], ref strTotal);
                    rowItem["Summary"] = strTotal;

                    totalStop += new TimeSpan(Convert.ToInt64(rowItem["Remarks"]) * TimeSpan.TicksPerSecond);
                }

                //CopyRows(ds.Tables["StopDurationBetweenTrips"], dsCrystal.Tables["rpt_StopDurationBetweenTrips"]);

                dsCrystal.Tables["rpt_StopDurationBetweenTrips"].Merge(ds.Tables["StopDurationBetweenTrips"], false, MissingSchemaAction.Ignore);
            }


            if (ds.Tables.IndexOf("TripCost") != -1)
            {
                foreach (DataRow rowItem in ds.Tables["TripCost"].Rows)
                {

                    totalCost += Convert.ToDouble(rowItem["Summary"]);
                }


            }
            return dsCrystal;
        }

        private DataSet GetLandmarkActivityInfo(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {

            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";


            int totalSqlRecords = 0;
            int outMaxRecords = 0;



            prm1 = Util.PairFindValue(ReportTemplate.RpStopFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpStopSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpStopThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpStopFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpStopFifthParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null)
            {
                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string xmlDataSet = "";
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report stopReportByLandmark = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet dsReport = stopReportByLandmark.GetStopReportByLandmark(prm1, prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), lang, ref requestOverflowed, ref totalSqlRecords);


            if (dsReport != null)
                xmlDataSet = dsReport.GetXml();


            StringReader strrXML = new StringReader(xmlDataSet);
            DataSet ds = new DataSet();

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkActivity.xsd"));

            ds.ReadXml(strrXML);
            if (ds.Tables.Count == 0)
            {
                return null;
            }


            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);



            string strTotalStopTime = "";

            if (ds.Tables.IndexOf("StopReportByLandmark") != -1 && ds.Tables["StopReportByLandmark"].Rows.Count > 0)
            {

                DataColumn col = new DataColumn("StopDuration", Type.GetType("System.String"));
                ds.Tables["StopReportByLandmark"].Columns.Add(col);

                foreach (DataRow rowItem in ds.Tables["StopReportByLandmark"].Rows)
                {
                    strTotalStopTime = "";
                    TimeSpan TripStop = new TimeSpan(0);
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                        strTotalStopTime += TripStop.Days.ToString() + " d, ";
                        strTotalStopTime += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                        strTotalStopTime = TripStop.ToString();
                    }

                    rowItem["StopDuration"] = strTotalStopTime;

                }


                //CopyRows(ds.Tables["StopReportByLandmark"], dsCrystal.Tables["StopReportByLandmark"]);

                dsCrystal.Tables["StopReportByLandmark"].Merge(ds.Tables["StopReportByLandmark"], false, MissingSchemaAction.Ignore);
            }
            else
            {
                return null;
            }


            return dsCrystal;

        }

        private DataSet GetLandmarkFleetActivityInfo(int UserID, string xmlParams, string lang, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            string prm1 = "";
            string prm2 = "";
            string prm3 = "";
            string prm4 = "";
            string prm5 = "";


            int totalSqlRecords = 0;
            int outMaxRecords = 0;


            prm1 = Util.PairFindValue(ReportTemplate.RpFleetStopFirstParamName, xmlParams);
            prm2 = Util.PairFindValue(ReportTemplate.RpFleetStopSecondParamName, xmlParams);
            prm3 = Util.PairFindValue(ReportTemplate.RpFleetStopThirdParamName, xmlParams);
            prm4 = Util.PairFindValue(ReportTemplate.RpFleetStopFourthParamName, xmlParams);
            prm5 = Util.PairFindValue(ReportTemplate.RpFleetStopFifthParamName, xmlParams);

            if (xmlParams == null || prm1 == null || prm2 == null || prm3 == null || prm4 == null || prm5 == null)
            {
                // empty result
                return null;
            }


            requestOverflowed = false;
            totalSqlRecords = 0;
            outMaxOverflowed = false;
            outMaxRecords = 0;
            string xmlDataSet = "";
            string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(prm2), Convert.ToDateTime(prm3));
            VLF.DAS.Logic.Report fleetStopReportByLandmark = new VLF.DAS.Logic.Report(ConnnectionString);
            DataSet dsReport = fleetStopReportByLandmark.GetFleetStopReportByLandmark(Convert.ToInt32(prm1), prm2, prm3, UserID, Convert.ToBoolean(prm4), Convert.ToInt32(prm5), lang, ref requestOverflowed, ref totalSqlRecords);


            if (dsReport != null)
                xmlDataSet = dsReport.GetXml();


            StringReader strrXML = new StringReader(xmlDataSet);
            DataSet ds = new DataSet();

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkActivity.xsd"));

            ds.ReadXml(strrXML);
            if (ds.Tables.Count == 0)
            {
                return null;
            }


            if (ds.Tables.IndexOf("TripReportVehicleInfo") != -1)
                //CopyRows(ds.Tables["TripReportVehicleInfo"], dsCrystal.Tables["rpt_VechicleInfo"]);
                dsCrystal.Tables["rpt_VechicleInfo"].Merge(ds.Tables["TripReportVehicleInfo"], false, MissingSchemaAction.Ignore);



            string strTotalStopTime = "";

            if (ds.Tables.IndexOf("StopReportByLandmark") != -1 && ds.Tables["StopReportByLandmark"].Rows.Count > 0)
            {

                DataColumn col = new DataColumn("StopDuration", Type.GetType("System.String"));
                ds.Tables["StopReportByLandmark"].Columns.Add(col);

                foreach (DataRow rowItem in ds.Tables["StopReportByLandmark"].Rows)
                {
                    strTotalStopTime = "";
                    TimeSpan TripStop = new TimeSpan(0);
                    TripStop = new TimeSpan(Convert.ToInt64(rowItem["StopDurationVal"]) * TimeSpan.TicksPerSecond);

                    if (TripStop.Days > 0)
                    {
                        strTotalStopTime += TripStop.Days.ToString() + " d, ";
                        strTotalStopTime += new TimeSpan(TripStop.Ticks - TripStop.Days * TimeSpan.TicksPerDay).ToString();
                    }
                    else
                    {
                        strTotalStopTime = TripStop.ToString();
                    }

                    rowItem["StopDuration"] = strTotalStopTime;

                }


                //CopyRows(ds.Tables["StopReportByLandmark"], dsCrystal.Tables["StopReportByLandmark"]);

                dsCrystal.Tables["StopReportByLandmark"].Merge(ds.Tables["StopReportByLandmark"], false, MissingSchemaAction.Ignore);
            }
            else
            {
                return null;
            }

            return dsCrystal;

        }

        private void GetUserPreferences(Int32 UserId)
        {

            DataSet dsPref = new DataSet();


            VLF.DAS.Logic.User dbUser = new VLF.DAS.Logic.User(LoginManager.GetConnnectionString(UserId));
            dsPref = dbUser.GetAllUserPreferencesInfo(UserId);
            Int16 PreferenceId = 0;

            foreach (DataRow rowItem in dsPref.Tables[0].Rows)
            {
                PreferenceId = Convert.ToInt16(rowItem["PreferenceId"]);
                switch (PreferenceId)
                {
                    case (Int16)VLF.CLS.Def.Enums.Preference.MeasurementUnits:
                        if (rowItem["PreferenceValue"].ToString().TrimEnd() != "")
                            UnitOfMes = Convert.ToDouble(rowItem["PreferenceValue"].ToString().TrimEnd());

                        break;

                    case (Int16)VLF.CLS.Def.Enums.Preference.VolumeUnits:
                        if (rowItem["PreferenceValue"].ToString().TrimEnd() != "")
                            VolumeUnit = Convert.ToDouble(rowItem["PreferenceValue"].ToString().TrimEnd());

                        break;
                    case (Int16)VLF.CLS.Def.Enums.Preference.TimeZone:
                        if (rowItem["PreferenceValue"].ToString().TrimEnd() != "")
                            UserTimeZone = Convert.ToInt16(rowItem["PreferenceValue"].ToString().TrimEnd());
                        break;

                    case (Int16)VLF.CLS.Def.Enums.Preference.DayLightSaving:
                        if (rowItem["PreferenceValue"].ToString().TrimEnd() == "1")
                            DayLightSaving = 1;
                        else
                            DayLightSaving = 0;
                        break;

                }

            }

        }
        // Changes for TimeZone Feature start
        private DataSet GetViolationInfo_NewTZ(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string lang, int speed, ref DataSet dsCrystal)
        {
            try
            {
                
                ////DataSet dsFleet = new DataSet();
                //string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                //string ConnnectionString = LoginManager.GetConnnectionString(userId);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                ////using (Fleet dbf = new Fleet(ConnnectionString))
                ////{
                ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                ////}


                //  dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


                string xml = "";
                Int32 orgId = GetOrganizationIdByUserId(userId);

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    if (orgId != 999994)
                        xml = dbReport.GetViolationReportForFleetByLang_NewTZ(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed);
                    else
                        xml = dbReport.GetViolationReportForFleetByLang_Main(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }




        // Changes for TimeZone Feature end

        private DataSet GetViolationInfo(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string lang, int speed, ref DataSet dsCrystal)
        {
            try
            {
                ////DataSet dsFleet = new DataSet();
                //string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
               //string ConnnectionString = LoginManager.GetConnnectionString(userId);
 		string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                ////using (Fleet dbf = new Fleet(ConnnectionString))
                ////{
                ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                ////}
                

                //  dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


                string xml = "";
		Int32 orgId = GetOrganizationIdByUserId(userId);

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                      if (orgId!=999994)
                        xml = dbReport.GetViolationReportForFleetByLang(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed);
                    else
                        xml = dbReport.GetViolationReportForFleetByLang_Main(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }




        private DataSet GetViolationInfo_Hierarchy(Int32 userId, string  nodeCode, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string lang, int speed, ref DataSet dsCrystal)
        {
            try
            {
                ////DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);

                ////using (Fleet dbf = new Fleet(ConnnectionString))
                ////{
                ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                ////}


                //  dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


                string xml = "";

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationReportForFleetByLang_Hierarchy(nodeCode, userId, maskViolations, dtFrom, dtTo, lang, speed);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }

	
   private DataSet GetViolationInfoWithScore(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string ViolationPoints, string lang, ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
               // string ConnnectionString = LoginManager.GetConnnectionString(userId);

                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                //dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";
                Int32 orgId = GetOrganizationIdByUserId(userId);


                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    if (orgId == 999994)
                         xml = dbReport.GetViolationReportForFleetWithScore_Main(fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints);
                    ///else if  (orgId == 951)
                    ///    xml = dbReport.GetViolationReportForFleetWithScore_Extended (fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints);
                    else
                        xml = dbReport.GetViolationReportForFleetWithScore(fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints);
                       
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                //           if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new CultureInfo(lang);
                    xml = xml.Replace("Acc. Extreme", Resources.Const.ViolationWithScore_AccExtreme)
                             .Replace("Acc. Harsh", Resources.Const.ViolationWithScore_AccHarsh)
                             .Replace("Braking Extreme", Resources.Const.ViolationWithScore_BrakingExtreme)
                             .Replace("Braking Harsh", Resources.Const.ViolationWithScore_BrakingHarsh)
                             .Replace("Seat Belt", Resources.Const.ViolationWithScore_SeatBelt)
                             .Replace("Speed", Resources.Const.MessageType_Speed);
                }

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                // CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }




   private DataSet GetViolationInfoWithScore_NewSafetyMatrix_WithoutRail(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string ViolationPoints, string lang, string extraParams, ref DataSet dsCrystal)
   {
       try
       {
           DataSet dsFleet = new DataSet();
           string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
           // string ConnnectionString = LoginManager.GetConnnectionString(userId);

           using (Fleet dbf = new Fleet(ConnnectionString))
           {
               dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
           }
           //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

           //dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

           string xml = "";
           Int32 orgId = GetOrganizationIdByUserId(userId);


           using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
           {
               xml = dbReport.GetViolationReportForFleetWithScore_NewSafetyMatrix(fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints, extraParams);

           }

           if (String.IsNullOrEmpty(xml))
               return null;

           //           if (lang == "fr" && lang != null)
           if (ASIErrorCheck.IsLangSupported(lang))
           {
               Resources.Const.Culture = new CultureInfo(lang);
               xml = xml.Replace("Acc. Extreme", Resources.Const.ViolationWithScore_AccExtreme)
                        .Replace("Acc. Harsh", Resources.Const.ViolationWithScore_AccHarsh)
                        .Replace("Braking Extreme", Resources.Const.ViolationWithScore_BrakingExtreme)
                        .Replace("Braking Harsh", Resources.Const.ViolationWithScore_BrakingHarsh)
                        .Replace("Seat Belt", Resources.Const.ViolationWithScore_SeatBelt)
                        .Replace("Speed", Resources.Const.MessageType_Speed);
           }

           DataSet ds = new DataSet();
           ds.ReadXml(new StringReader(xml));

           if (!Util.IsDataSetValid(ds))
               return null;

           // CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

           dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

           return dsCrystal;
       }
       catch (Exception Ex)
       {
           return null;
       }
   }



        private DataSet GetViolationInfoWithScore_NewSafetyMatrix(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string ViolationPoints, string lang,string extraParams, ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                // string ConnnectionString = LoginManager.GetConnnectionString(userId);

                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                //dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";
                Int32 orgId = GetOrganizationIdByUserId(userId);


                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationReportForFleetWithScore_Extended_NewSafetyMatrix(fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints, extraParams);

                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                //           if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new CultureInfo(lang);
                    xml = xml.Replace("Acc. Extreme", Resources.Const.ViolationWithScore_AccExtreme)
                             .Replace("Acc. Harsh", Resources.Const.ViolationWithScore_AccHarsh)
                             .Replace("Braking Extreme", Resources.Const.ViolationWithScore_BrakingExtreme)
                             .Replace("Braking Harsh", Resources.Const.ViolationWithScore_BrakingHarsh)
                             .Replace("Seat Belt", Resources.Const.ViolationWithScore_SeatBelt)
                             .Replace("Speed", Resources.Const.MessageType_Speed);
                }

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                // CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }


        private DataSet GetViolationInfoWithScore_Hierarchy(Int32 userId, string  nodeCode, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string ViolationPoints, string lang, ref DataSet dsCrystal)
        {
            try
            {
                ////DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                ////using (Fleet dbf = new Fleet(ConnnectionString))
                ////{
                ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                ////}
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                //dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationReportForFleetWithScore_Hierarchy(nodeCode, userId, maskViolations, dtFrom, dtTo, ViolationPoints);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                //           if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new CultureInfo(lang);
                    xml = xml.Replace("Acc. Extreme", Resources.Const.ViolationWithScore_AccExtreme)
                             .Replace("Acc. Harsh", Resources.Const.ViolationWithScore_AccHarsh)
                             .Replace("Braking Extreme", Resources.Const.ViolationWithScore_BrakingExtreme)
                             .Replace("Braking Harsh", Resources.Const.ViolationWithScore_BrakingHarsh)
                             .Replace("Seat Belt", Resources.Const.ViolationWithScore_SeatBelt)
                             .Replace("Speed", Resources.Const.MessageType_Speed);
                }

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                // CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }





        private DataSet GetViolationInfoWithScore_Special(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string ViolationPoints, string lang, ref DataSet dsCrystal)
        {
            try
            {
                DataSet dsFleet = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(userId, Convert.ToDateTime(dtFrom), Convert.ToDateTime(dtFrom));
                using (Fleet dbf = new Fleet(ConnnectionString))
                {
                    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                }
                //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

                //dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

                string xml = "";

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationReportForFleetWithScore_Special(fleetId, userId, maskViolations, dtFrom, dtTo, ViolationPoints);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                //           if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new CultureInfo(lang);
                    xml = xml.Replace("Acc. Extreme", Resources.Const.ViolationWithScore_AccExtreme)
                             .Replace("Acc. Harsh", Resources.Const.ViolationWithScore_AccHarsh)
                             .Replace("Braking Extreme", Resources.Const.ViolationWithScore_BrakingExtreme)
                             .Replace("Braking Harsh", Resources.Const.ViolationWithScore_BrakingHarsh)
                             .Replace("Seat Belt", Resources.Const.ViolationWithScore_SeatBelt)
                             .Replace("Speed", Resources.Const.MessageType_Speed);
                }

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                // CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }

        private DataSet GetIdlingDataByFleetID(Int32 userId, Int32 fleetId, DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {
            DataSet dsVehicle = new DataSet();
            StringReader strrXML = null;

            string xml = "";
            DataSet dsFleet = new DataSet();
            string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
            VLF.DAS.Logic.Fleet dbf = new VLF.DAS.Logic.Fleet(ConnnectionString);
            dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
            //CopyRows(dsFleet.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);

            dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);

            ReportGenerator dbReport = new ReportGenerator(ConnnectionString);

            xml = dbReport.GetSensorReportForFleet(fleetId, userId, 3, dtFrom, dtTo);

            if (xml == "")
                return dsCrystal;


            DataSet ds = new DataSet();
            strrXML = new StringReader(xml);
            ds.ReadXml(strrXML);

            if (ds.Tables.Count == 0)
                return dsCrystal;

            if (ds.Tables.IndexOf("SensorsUtilization") == -1)
                return dsCrystal;

            DataColumn TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
            ds.Tables["SensorsUtilization"].Columns.Add(TotalHours);

            DataColumn Day = new DataColumn("Day", Type.GetType("System.Int32"));
            ds.Tables["SensorsUtilization"].Columns.Add(Day);


            DataColumn Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
            ds.Tables["SensorsUtilization"].Columns.Add(Utilization);


            DataColumn WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
            ds.Tables["SensorsUtilization"].Columns.Add(WorkingHours);

            DataColumn colFleetId = new DataColumn("FleetId", Type.GetType("System.Int32"));
            ds.Tables["SensorsUtilization"].Columns.Add(colFleetId);


            TimeSpan TotalDayHours;
            Int64 TotalVehicleInUse = 0;
            TimeSpan DateDiff;


            for (int i = 0; i < ds.Tables["SensorsUtilization"].Rows.Count; i++)
            {

                DataRow rowItem = ds.Tables["SensorsUtilization"].Rows[i];

                if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                {
                    ds.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                    i--;
                    continue;
                }

                rowItem["FleetId"] = fleetId;
                rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                TotalDayHours = new TimeSpan(Convert.ToInt64(DateDiff.TotalMinutes) * TimeSpan.TicksPerMinute);
                rowItem["TotalHours"] = TotalDayHours.ToString();
                if (DateDiff.Minutes != 0)
                    rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalMinutes) * 100;
                else
                    rowItem["Utilization"] = 0;

                rowItem["WorkingHours"] = DateDiff.TotalMinutes;

            }


            // CopyRows(ds.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_Ignition"]);


            dsCrystal.Tables["rpt_Ignition"].Merge(ds.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);


            // Idling calculation

            if (ds.Tables.IndexOf("IdlingDuration") == -1)
                return dsCrystal;


            DataColumn Day1 = new DataColumn("Day", Type.GetType("System.Int32"));
            ds.Tables["IdlingDuration"].Columns.Add(Day1);

            DataColumn Utilization1 = new DataColumn("Utilization", Type.GetType("System.Single"));
            ds.Tables["IdlingDuration"].Columns.Add(Utilization1);

            DataColumn colFleetId1 = new DataColumn("FleetId", Type.GetType("System.Int32"));
            ds.Tables["IdlingDuration"].Columns.Add(colFleetId1);




            for (int i = 0; i < ds.Tables["IdlingDuration"].Rows.Count; i++)
            {
                DataRow rowItem = ds.Tables["IdlingDuration"].Rows[i];

                if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                {
                    ds.Tables["IdlingDuration"].Rows.RemoveAt(i);
                    i--;
                    continue;
                }

                rowItem["FleetId"] = fleetId;
                rowItem["Day"] = Convert.ToDateTime(rowItem["EndTime"]).DayOfYear;
                DateDiff = Convert.ToDateTime(rowItem["EndTime"]).Subtract(Convert.ToDateTime(rowItem["StartTime"]));
                if (DateDiff.TotalSeconds != 0)
                    rowItem["Utilization"] = (Convert.ToInt64(rowItem["MinutesInUse"]) / DateDiff.TotalSeconds) * 100;
                else
                    rowItem["Utilization"] = 0;
            }


            //CopyRows(ds.Tables["IdlingDuration"], dsCrystal.Tables["rpt_Idling_Utilization"]);

            dsCrystal.Tables["rpt_Idling_Utilization"].Merge(ds.Tables["IdlingDuration"], false, MissingSchemaAction.Ignore);


            //PTO

            xml = dbReport.GetSensorReportForFleet(fleetId, userId, 8, dtFrom, dtTo);

            DataSet dsPTO = new DataSet();
            strrXML = new StringReader(xml);
            dsPTO.ReadXml(strrXML);

            if (dsPTO.Tables.IndexOf("SensorsUtilization") != -1)
            {


                TotalHours = new DataColumn("TotalHours", Type.GetType("System.String"));
                dsPTO.Tables["SensorsUtilization"].Columns.Add(TotalHours);

                Day = new DataColumn("Day", Type.GetType("System.Int32"));
                dsPTO.Tables["SensorsUtilization"].Columns.Add(Day);


                Utilization = new DataColumn("Utilization", Type.GetType("System.Single"));
                dsPTO.Tables["SensorsUtilization"].Columns.Add(Utilization);


                WorkingHours = new DataColumn("WorkingHours", Type.GetType("System.Int32"));
                dsPTO.Tables["SensorsUtilization"].Columns.Add(WorkingHours);

                colFleetId = new DataColumn("FleetId", Type.GetType("System.Int32"));
                dsPTO.Tables["SensorsUtilization"].Columns.Add(colFleetId);


                for (int i = 0; i < dsPTO.Tables["SensorsUtilization"].Rows.Count; i++)
                {

                    DataRow rowItem = dsPTO.Tables["SensorsUtilization"].Rows[i];
                    rowItem["FleetId"] = fleetId;

                    if (Convert.ToDateTime(rowItem["StartTime"]).ToShortDateString() != "1/1/2000")
                    {
                        dsPTO.Tables["SensorsUtilization"].Rows.RemoveAt(i);
                        i--;
                        continue;
                    }


                }


                //CopyRows(dsPTO.Tables["SensorsUtilization"], dsCrystal.Tables["rpt_PTO"]);


                dsCrystal.Tables["rpt_PTO"].Merge(dsPTO.Tables["SensorsUtilization"], false, MissingSchemaAction.Ignore);


            }
            return dsCrystal;
        }

        private DataSet GetIdlingDataByOrganizationID(Int32 userId, Int32 orgId, DateTime dtFrom, DateTime dtTo, ref DataSet dsCrystal)
        {


            DataSet dsOrg = new DataSet();
            DataSet dsFuel = new DataSet();
            string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
            VLF.DAS.Logic.Report dbReport = new VLF.DAS.Logic.Report(ConnnectionString);
            ReportGenerator dbReportGen = new ReportGenerator(ConnnectionString);

            dsOrg = dbReport.GetIdlingSummaryReportPerOrganization(userId, orgId, dtFrom, dtTo);
            dsFuel = dbReportGen.GetFuelConsumptionPerOrganization(orgId, dtFrom, dtTo, userId);
            dsCrystal.Tables["rpt_Idling_Utilization"].Merge(dsOrg.Tables[0], false, MissingSchemaAction.Ignore);
            if (dsFuel != null && dsFuel.Tables.Count > 0)
                dsCrystal.Tables["rpt_FuelConsumption"].Merge(dsFuel.Tables[0], false, MissingSchemaAction.Ignore);

            return dsCrystal;
        }

        private string GetWeekDesc(DateTime dtDate)
        {

            DateTime weekStartDate, weekEndDate;
            weekStartDate = dtDate.AddDays(0 - dtDate.DayOfWeek);
            weekEndDate = dtDate.AddDays(Convert.ToDouble(6 - dtDate.DayOfWeek));
            string sweek = weekStartDate.ToShortDateString() + " - " + weekEndDate.ToShortDateString();
            return sweek;

        }

        /// <summary>
        ///         Get fleet name by fleet id
        /// </summary>
        /// <param name="fleetId"></param>
        /// <returns></returns>
        private string GetFleetName(int UserID, Int32 fleetId)
        {
            string fleetName = "";
            using (VLF.DAS.Logic.Fleet fleet = new VLF.DAS.Logic.Fleet(LoginManager.GetConnnectionString(UserID)))
            {
                //DataSet dsFleetInfo = fleet.GetFleetInfoByFleetId(Convert.ToInt32(fleetId));
                fleetName = fleet.GetFleetNameByFleetId(fleetId);
            }
            return fleetName;
            //dsFleetInfo.Tables[0].Rows[0]["FleetName"].ToString();
        }


        private string GetFleetName(int UserID, Int32 fleetId,string language)
        {
            string fleetName = "";
            using (VLF.DAS.Logic.Fleet fleet = new VLF.DAS.Logic.Fleet(LoginManager.GetConnnectionString(UserID)))
            {
                //DataSet dsFleetInfo = fleet.GetFleetInfoByFleetId(Convert.ToInt32(fleetId));
                fleetName = fleet.GetFleetNameByFleetId(fleetId);

                if (language == "fr" && fleetName == "All Vehicles")
                    fleetName = "Tous les vhicules";
            }
            return fleetName;
            //dsFleetInfo.Tables[0].Rows[0]["FleetName"].ToString();
        }

        /// <summary>
        ///         Get driver name by driver id
        /// </summary>
        /// <comment>
        ///         replace it with a function instead of using a DataSet
        /// </comment>
        /// <param name="driverId"></param>
        /// <returns></returns>
        private string GetDriverFullName(int UserID, int driverId)
        {
            string name = "";

            using (DriverManager driver = new DriverManager(LoginManager.GetConnnectionString(UserID)))
            {
                DataRow drDriver = driver.GetDriver(driverId).Tables[0].Rows[0];
                name = drDriver["LastName"].ToString() + " " + drDriver["FirstName"].ToString();
            }
            return name;
        }

        private static void LocalizeTextObject(ref ReportDocument rd, ResourceManager rm, string lang)
        {
            if (lang == "en" || String.IsNullOrEmpty(lang))
                return;

            CultureInfo ci = new CultureInfo(lang);

            foreach (CrystalDecisions.CrystalReports.Engine.ReportObject ro in rd.ReportDefinition.ReportObjects)
                if ((ro.GetType() == typeof(CrystalDecisions.CrystalReports.Engine.TextObject) ||
                     ro.GetType() == typeof(CrystalDecisions.CrystalReports.Engine.FieldHeadingObject)) &&
                     rm.GetString(ro.Name, ci) != null)
                    ((CrystalDecisions.CrystalReports.Engine.TextObject)ro).Text = rm.GetString(ro.Name, ci);
        }


        /// <summary>
        ///         can't you do a replace in DataTable instead of enumerating through it 
        /// </summary>
        /// <param name="lang"></param>
        /// <param name="dsCrystal"></param>
        private static void LocalizeAddress(string lang, ref DataSet dsCrystal)
        {
            if (lang == "en" || lang == null)
                return;

            Resources.Const.Culture = new CultureInfo(lang);

            foreach (DataTable dt in dsCrystal.Tables)
            {
                if (dt.Columns.Contains("Remarks"))
                    foreach (DataRow dr in dt.Rows)
                        dr["Remarks"] = dr["Remarks"].ToString().Replace(Const.addressNA, Resources.Const.InvalidAddress_addressNA)
                                                                .Replace(Const.noGPSData, Resources.Const.InvalidAddress_noGPSData)
                                                                .Replace(Const.noValidAddress, Resources.Const.InvalidAddress_noValidAddress);

                if (dt.Columns.Contains("StreetAddress"))
                    foreach (DataRow dr in dt.Rows)
                        dr["StreetAddress"] = dr["StreetAddress"].ToString().Replace(Const.addressNA, Resources.Const.InvalidAddress_addressNA)
                                                                            .Replace(Const.noGPSData, Resources.Const.InvalidAddress_noGPSData)
                                                                            .Replace(Const.noValidAddress, Resources.Const.InvalidAddress_noValidAddress);

                if (dt.Columns.Contains("Location"))
                    foreach (DataRow dr in dt.Rows)
                        dr["Location"] = dr["Location"].ToString().Replace(Const.addressNA, Resources.Const.InvalidAddress_addressNA)
                                                                  .Replace(Const.noGPSData, Resources.Const.InvalidAddress_noGPSData)
                                                                  .Replace(Const.noValidAddress, Resources.Const.InvalidAddress_noValidAddress);
            }
        }

        /// <summary>
        /// Calculates Trip Duration and builds a string, returns total duration minutes
        /// </summary>
        /// <param name="time">Seconds</param>
        /// <param name="result">Result string</param>
        /// <returns>Total minutes</returns>
        private double CalculateDuration(object time, ref string result)
        {
            if (time == null)
                throw new ArgumentNullException("Time object is null");

            StringBuilder strTotal = new StringBuilder();
            TimeSpan tsDuration = new TimeSpan(Convert.ToInt64(time) * TimeSpan.TicksPerSecond);

            if (tsDuration.Days > 0)
            {
                strTotal.AppendFormat("{0} d, ", tsDuration.Days);
                strTotal.Append(new TimeSpan(tsDuration.Ticks - tsDuration.Days * TimeSpan.TicksPerDay).ToString());
            }
            else
            {
                strTotal.Append(tsDuration.ToString());
            }

            result = strTotal.ToString();

            return tsDuration.TotalMinutes;
        }

        # endregion

        #region Extended Utilization Reports for CN (mostly)
        [WebMethod]
        public int GetExtendedDailyVehicleUtilizationReport(Int32 UserID, string SID, int VehicleId, string FromDate, string ToDate, int rFormat, Single Cost, string lang, ref string ReportPath)
        {

            try
            {
                //int VehicleId=0;
                //Single Cost = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////     VehicleId = Convert.ToInt32(json[ReportTemplate.RptParamVehicleId]);
                ////     Cost = Convert.ToSingle(json[ReportTemplate.RptParamCost]);
                ////}


                //VehicleId = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RptParamVehicleId, xmlParams));
                //Cost = Convert.ToSingle(Util.PairFindValue(ReportTemplate.RptParamCost, xmlParams));



                Log("-->GetExtendedDailyVehicleUtilizationReport( userId = {0}, fromDate = {1}, toDate={2},VehicleId={3} )", UserID, FromDate, ToDate, VehicleId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                string strFrom = "", strTo = "";
                short sensorId = -1;

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedDailyUtilizationReport.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetDailyVehicleUtilizationReport(UserID, VehicleId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "rpt_DailyUtilizationReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Daily Vehicle Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rptExtendedDailyUtilizationReportNoHeader.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptExtendedDailyUtilizationReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = Cost;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptDailyUtilization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<--GetExtendedDailyVehicleUtilizationReport( userId = {0}, fromDate = {1}, toDate={2},VehicleId={3} )", UserID, FromDate, ToDate, VehicleId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Daily Vehicle Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }
        [WebMethod]
        public int GetExtendedDailyFleetUtilizationReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Single Cost, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log("-->GetExtendedDailyFleetUtilizationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //Single Cost = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Cost = Convert.ToSingle(json[ReportTemplate.RptParamCost]);
                ////}


                //Cost = Convert.ToSingle(Util.PairFindValue(ReportTemplate.RptParamCost, xmlParams));





                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedDailyFleetUtilizationReport.xsd"));
                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetDailyFleetUtilizationReport(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Cost);
                    dsCrystal.Tables[0].TableName = "rpt_DailyFleetUtilizationReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Daily Fleet Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rptExtendedDailyFleetUtilizationReportNoHeader.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptExtendedDailyFleetUtilizationReport.rpt"));

                oRpt.SetDataSource(dsCrystal);


                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = Cost;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptDailyUtilization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<--GetExtendedDailyFleetUtilizationReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Daily Fleet Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///         report for CN, with all their custom fields
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type"> 0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetExtendedSpeedViolationsReportForFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int Type, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log("-->GetExtendedSpeedViolationsReportForFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //int Type = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Type = Convert.ToInt32(json[ReportTemplate.RptParamIncludeSummary]);
                ////}
                //Type = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsReportForFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSpeedViolationsReportForFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, "%");
                    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for a Fleet doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                #region create report
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleetNoHeader.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleet.rpt"));



                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "(km/h)";
                else
                    crParameterDiscreteValue.Value = "(mph)";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                #endregion

                Log("<--GetExtendedSpeedViolationsReportForFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for a Fleet failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }






        [WebMethod]
        public int GetExtendedSpeedSummaryViolationsReportForFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int Type, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log("-->GetExtendedSpeedSummaryViolationsReportForFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);


                //int Type = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Type = Convert.ToInt32(json[ReportTemplate.RptParamIncludeSummary]);
                ////}
                //Type = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsReportForFleet.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSpeedSummaryViolationsReportForFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, "%");
                    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for a Fleet doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                #region create report
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_ExtendedSpeedSummaryViolationReport.rpt"));



                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "(km/h)";
                else
                    crParameterDiscreteValue.Value = "(mph)";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                #endregion

                Log("<--GetExtendedSpeedSummaryViolationsReportForFleet( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, FleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for a Fleet failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }






        /// <summary>
        ///         CN Speed Violations Report based on Fleets Id's
        /// </summary>
        /// 
        [WebMethod]
        public int GetExtendedSpeedViolationsReportForFleets(Int32 UserID, string SID, int[] FleetIds, string FromDate, string ToDate, int Type, string ColorFilter, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log("-->GetExtendedSpeedViolationsReportForFleets( userId = {0}, fromDate = {1}, toDate={2},FleetCount={3} )", UserID, FromDate, ToDate, FleetIds.Length);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);
                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsReportForFleet.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);

                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }


                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;


                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.Lang = lang;
                //reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                // reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsReportForFleet.rpt");

                reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsReportForFleet.rpt");

                reportState.ReportParameters = new Dictionary<string, object>();
                reportState.ReportParameters.Add("FromDate", FromDate);
                reportState.ReportParameters.Add("ToDate", ToDate);
                reportState.ReportParameters.Add("UnitOfMes", Type == 1 ? "(km/h)" : "(mph)");
                reportState.ReportParameters.Add("FleetName", "");

                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("ExtendedSpeedViolationsReportForFleet-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(ReportsOutputPath), String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));


                for (int i = 0; i < FleetIds.Length; i++)
                {
                    try
                    {
                        //reportState.ReportParameters.Add("FleetName", GetFleetName(UserID, FleetIds[i]));


                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }


                        reportState.ReportParameters["FleetName"] = GetFleetName(UserID, FleetIds[i]);
                        string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                        reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);

                        dsCrystal.Clear();
                        dsCrystal = report.GetSpeedViolationsReportForFleet(UserID, FleetIds[i], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                        dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                        reportState.CrystalDataSet = dsCrystal;


                        asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                    }
                    catch
                    {
                    }
                }

                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }


                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));


                #region create report
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //    dsCrystal = rpt.GetSpeedViolationsReportForFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type);
                //    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                //}


                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //    ReportPath = "";
                //    return (int)InterfaceError.NoError;
                //}

                //
                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleetNoHeader.rpt"));
                //else
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleet.rpt"));



                //oRpt.SetDataSource(dsCrystal);

                //ParameterFieldDefinitions crParameterFieldDefinitions;
                //ParameterFieldDefinition crParameterFieldDefinition;
                //ParameterValues crParameterValues = new ParameterValues();
                //ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //if (Type == 1)
                //    crParameterDiscreteValue.Value = "(km/h)";
                //else
                //    crParameterDiscreteValue.Value = "(mph)";

                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //string fileExt = "";
                //switch (rFormat)
                //{
                //    case 1:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                //        fileExt = ".pdf";
                //        break;
                //    case 2:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                //        fileExt = ".xls";
                //        break;
                //    case 3:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                //        fileExt = ".doc";
                //        break;
                //}
                //string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                //oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                //diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                //oRpt.ExportOptions.DestinationOptions = diskOpt;
                //oRpt.Export();
                //oRpt.Close();

                //ReportPath = this.GetReportURL(ReportName);
                #endregion
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<--GetExtendedSpeedViolationsReportForFleets( userId = {0}, fromDate = {1}, toDate={2},FleetCount={3} )", UserID, FromDate, ToDate, FleetIds.Length);

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for Fleets failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///         CN Speed Violations Report based on Fleets Id's
        /// </summary>
        /// 
        [WebMethod]
        public int GetExtendedSpeedViolationsReportForFleets_ByRoadSpeed(Int32 UserID, string SID, int[] FleetIds, string FromDate, string ToDate, int Type, string ColorFilter, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log("-->GetExtendedSpeedViolationsReportForFleets( userId = {0}, fromDate = {1}, toDate={2},FleetCount={3} )", UserID, FromDate, ToDate, FleetIds.Length);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);
                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsReportForFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);

                ////// report format
                ////ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                ////string fileExt = "";
                ////switch (rFormat)
                ////{
                ////    case 1:
                ////        exportFormatType = ExportFormatType.PortableDocFormat;
                ////        fileExt = ".pdf";
                ////        break;
                ////    case 2:
                ////        exportFormatType = ExportFormatType.ExcelRecord;
                ////        fileExt = ".xls";
                ////        break;
                ////    case 3:
                ////        exportFormatType = ExportFormatType.WordForWindows;
                ////        fileExt = ".doc";
                ////        break;
                ////}


                ////GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                ////IAsyncResult asyncResult = null;


                ////// prepare report parameters
                ////ReportState reportState = new ReportState();
                ////reportState.Lang = lang;
                //////reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                ////// reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsReportForFleet.rpt");

                ////reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsReportForFleetByRoadSpeed.rpt");

                ////reportState.ReportParameters = new Dictionary<string, object>();
                ////reportState.ReportParameters.Add("FromDate", FromDate);
                ////reportState.ReportParameters.Add("ToDate", ToDate);
                ////reportState.ReportParameters.Add("UnitOfMes", Type == 1 ? "(km/h)" : "(mph)");
                ////reportState.ReportParameters.Add("FleetName", "");

                ////reportState.FormatType = exportFormatType;
                ////reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //////string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                ////string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                ////Directory.CreateDirectory(tempOutputPath);

                ////reportState.MergedReportFile = this.GetOutputPath(String.Format("ExtendedSpeedViolationsReportForFleet-{0}{1}", Guid.NewGuid(), fileExt));
                //////Path.Combine(Server.MapPath(ReportsOutputPath), String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));


                ////for (int i = 0; i < FleetIds.Length; i++)
                ////{
                ////    try
                ////    {
                ////        //reportState.ReportParameters.Add("FleetName", GetFleetName(UserID, FleetIds[i]));


                ////        // check and wait previous report is done.
                ////        if (asyncResult != null)
                ////        {
                ////            if (!asyncResult.IsCompleted)
                ////            {
                ////                asyncResult.AsyncWaitHandle.WaitOne();
                ////            }
                ////        }


                ////        reportState.ReportParameters["FleetName"] = GetFleetName(UserID, FleetIds[i]);
                ////        string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                ////        reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);

                ////        dsCrystal.Clear();

                ////        dsCrystal = report.GetSpeedViolationsReportForFleet_RoadSpeed(UserID, FleetIds[i], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                ////        dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                ////        reportState.CrystalDataSet = dsCrystal;


                ////        asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                ////    }
                ////    catch
                ////    {
                ////    }
                ////}

                ////if (asyncResult != null)
                ////{
                ////    if (!asyncResult.IsCompleted)
                ////    {
                ////        asyncResult.AsyncWaitHandle.WaitOne();
                ////    }
                ////}

                ////try
                ////{
                ////    // merge report files.
                ////    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                ////    {
                ////        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                ////        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                ////    }
                ////    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                ////    {
                ////        //reportState.MergedReportFile += ".zip";
                ////        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                ////        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                ////    }
                ////    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                ////    {
                ////        reportState.MergedReportFile += ".zip";
                ////        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                ////        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                ////    }
                ////}
                ////finally
                ////{
                ////    DeleteDirectory(tempOutputPath);
                ////}


                ////string tmpReportName = "";
                ////if (File.Exists(reportState.MergedReportFile))
                ////    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));


                #region create report
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = report.GetSpeedViolationsReportForFleet_RoadSpeed(UserID, FleetIds[0], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }


                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleetNoHeader.rpt"));
                //else
                oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsReportForFleetByRoadSpeed.rpt"));



                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetIds[0]);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "(km/h)";
                else
                    crParameterDiscreteValue.Value = "(mph)";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();


                #endregion
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<--GetExtendedSpeedViolationsReportForFleets( userId = {0}, fromDate = {1}, toDate={2},FleetCount={3} )", UserID, FromDate, ToDate, FleetIds.Length);

                ReportPath = this.GetReportURL(ReportName);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violations Report for Fleets failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///         report for CN, is based on special tables 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetExtendedSpeedViolationsDetailsReportForFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int Type, int rFormat, string lang, ref string ReportPath)
        {

            try
            {

                Log(">> GetExtendedSpeedViolationsDetailsReportForFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                            UserID, FromDate, ToDate, FleetId);



                //int Type = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Type = Convert.ToInt32(json[ReportTemplate.RptParamIncludeSummary]);
                ////}


                //Type = Convert.ToInt32(Util.PairFindValue(ReportTemplate.RptParamIncludeSummary, xmlParams));


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsDetailsReportForFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSpeedViolationsDetailsReportForFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, "%");
                    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violation Details Report for a Fleet doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              if (1 == Type)
              {
                mapParams.Add("FromDate", FromDate.Substring(0, 11)); 
                mapParams.Add("ToDate", ToDate.Substring(0, 11));
                mapParams.Add("FleetName", GetFleetName(UserID,FleetId) );
                mapParams.Add("Speed1", "111 - 120");
                mapParams.Add("Speed2", "121 - 130");
                mapParams.Add("Speed3", "Greater than 130"); 
              }
              else
              {
                mapParams.Add("FromDate", FromDate.Substring(0, 11)); 
                mapParams.Add("ToDate", ToDate.Substring(0, 11));
                mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
                mapParams.Add("Speed1", "76 - 80");
                mapParams.Add("Speed2", "81 - 85"); 
                mapParams.Add("Speed3", "Greater than 85");
              }

               if (rFormat==2)
               {
                ReportPath = CreateReport ("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt",
                                         "rptSpeedFleetViolation",
                                         dsCrystal,
                                         rFormat,       
                                         mapParams );
               }
               else
               {
                  ReportPath = CreateReport ("rptExtendedSpeedViolationsDetailsReportForFleet.rpt",
                                         "rptSpeedFleetViolation",
                                         dsCrystal,
                                         rFormat,       
                                         mapParams );
               }
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleet.rpt"));



                oRpt.SetDataSource(dsCrystal);


                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "111 - 120";
                else
                    crParameterDiscreteValue.Value = "76 - 80";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                if (Type == 1)
                    crParameterDiscreteValue.Value = "121 - 130";
                else
                    crParameterDiscreteValue.Value = "81 - 85";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "Greater than 130";
                else
                    crParameterDiscreteValue.Value = "Greater than 85";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetExtendedSpeedViolationsDetailsReportForFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                            UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended Speed Violation Details Report for a Fleet failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetExtendedSpeedViolationsDetailsReportForFleet : uId={0}, EXC={1}",
                             UserID, ReportPath);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary> Based on Fleets Id's array
        ///         report for CN, is based on special tables 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetExtendedSpeedViolationsDetailsReportForFleets(Int32 UserID, string SID, int[] FleetIds, string FromDate, string ToDate, int Type, string ColorFilter, int rFormat, string lang, ref string ReportPath)
        {

            try
            {

                Log(">> GetExtendedSpeedViolationsDetailsReportForFleets(uId={0}, dtFrom={1}, dtTo={2}, FleetIdsCount={3})",
                            UserID, FromDate, ToDate, FleetIds.Length);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsDetailsReportForFleet.xsd"));
                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;

                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);


                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }


                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;



                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.Lang = lang;
                //reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleet.rpt");
                reportState.ReportParameters = new Dictionary<string, object>();
                reportState.ReportParameters.Add("FromDate", FromDate);
                reportState.ReportParameters.Add("ToDate", ToDate);
                reportState.ReportParameters.Add("FleetName", "");

                reportState.ReportParameters.Add("Speed1", Type == 1 ? "111 - 120" : "76 - 80");
                reportState.ReportParameters.Add("Speed2", Type == 1 ? "121 - 130" : "81 - 85");
                reportState.ReportParameters.Add("Speed3", Type == 1 ? "Greater than 130" : "Greater than 85");

                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("ExtendedSpeedViolationsDetailsReportForFleet-{0}{1}", Guid.NewGuid(), fileExt));




                for (int i = 0; i < FleetIds.Length; i++)
                {
                    try
                    {
                        //reportState.ReportParameters.Add("FleetName", GetFleetName(UserID, FleetIds[i]));


                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }


                        reportState.ReportParameters["FleetName"] = GetFleetName(UserID, FleetIds[i]);
                        string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                        reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);

                        dsCrystal.Clear();
                        dsCrystal = report.GetSpeedViolationsDetailsReportForFleet(UserID, FleetIds[i], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                        dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                        reportState.CrystalDataSet = dsCrystal;


                        asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                    }
                    catch
                    {
                    }
                }

                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }

                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }

                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));





                //    dsCrystal = rpt.GetSpeedViolationsDetailsReportForFleet(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type);
                //    dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";



                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //    ReportPath = "";
                //    return (int)InterfaceError.NoError;
                //}



                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                //else
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleet.rpt"));



                //oRpt.SetDataSource(dsCrystal);


                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                //ParameterFieldDefinitions crParameterFieldDefinitions;
                //ParameterFieldDefinition crParameterFieldDefinition;
                //ParameterValues crParameterValues = new ParameterValues();
                //ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //if (Type == 1)
                //    crParameterDiscreteValue.Value = "111 - 120";
                //else
                //    crParameterDiscreteValue.Value = "76 - 80";

                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //if (Type == 1)
                //    crParameterDiscreteValue.Value = "121 - 130";
                //else
                //    crParameterDiscreteValue.Value = "81 - 85";

                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //if (Type == 1)
                //    crParameterDiscreteValue.Value = "Greater than 130";
                //else
                //    crParameterDiscreteValue.Value = "Greater than 85";

                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //string fileExt = "";
                //switch (rFormat)
                //{
                //    case 1:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                //        fileExt = ".pdf";
                //        break;
                //    case 2:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                //        fileExt = ".xls";
                //        break;
                //    case 3:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                //        fileExt = ".doc";
                //        break;
                //}
                //string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                //oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                //diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                //oRpt.ExportOptions.DestinationOptions = diskOpt;
                //oRpt.Export();
                //oRpt.Close();

                //ReportPath = this.GetReportURL(ReportName);
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<< GetExtendedSpeedViolationsDetailsReportForFleets(uId={0}, dtFrom={1}, dtTo={2}, FleetIds={3}, reportPath={4})",
                            UserID, FromDate, ToDate, FleetIds.Length, ReportPath);

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended SpPeed Violation Details Report for Fleets failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetExtendedSpeedViolationsDetailsReportForFleets : uId={0}, EXC={1}",
                             UserID, ReportPath);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary> Based on Fleets Id's array
        ///         report for CN, is based on special tables 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetExtendedSpeedViolationsDetailsReportForFleets_RoadSpeed(Int32 UserID, string SID, int[] FleetIds, string FromDate, string ToDate, int Type, string ColorFilter, int rFormat, string lang, ref string ReportPath)
        {

            try
            {

                Log(">> GetExtendedSpeedViolationsDetailsReportForFleets_RoadSpeed(uId={0}, dtFrom={1}, dtTo={2}, FleetIdsCount={3})",
                            UserID, FromDate, ToDate, FleetIds.Length);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;




                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsDetailsReportForFleet.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);


                //////////// report format
                //////////ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                //////////string fileExt = "";
                //////////switch (rFormat)
                //////////{
                //////////    case 1:
                //////////        exportFormatType = ExportFormatType.PortableDocFormat;
                //////////        fileExt = ".pdf";
                //////////        break;
                //////////    case 2:
                //////////        exportFormatType = ExportFormatType.ExcelRecord;
                //////////        fileExt = ".xls";
                //////////        break;
                //////////    case 3:
                //////////        exportFormatType = ExportFormatType.WordForWindows;
                //////////        fileExt = ".doc";
                //////////        break;
                //////////}


                //////////GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                //////////IAsyncResult asyncResult = null;



                //////////// prepare report parameters
                //////////ReportState reportState = new ReportState();
                //////////reportState.Lang = lang;
                ////////////reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                ////////////reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleet.rpt");
                //////////reportState.ReportTemplateFile = this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetRoadSpeed.rpt");

                //////////reportState.ReportParameters = new Dictionary<string, object>();
                //////////reportState.ReportParameters.Add("FromDate", FromDate);
                //////////reportState.ReportParameters.Add("ToDate", ToDate);
                //////////reportState.ReportParameters.Add("FleetName", "");

                //////////reportState.ReportParameters.Add("Speed1", Type == 1 ? "11 - 20" : "6 - 10");
                //////////reportState.ReportParameters.Add("Speed2", Type == 1 ? "21 - 30" : "11 - 15");
                //////////reportState.ReportParameters.Add("Speed3", Type == 1 ? "Over 30" : "Over 15");

                //////////reportState.FormatType = exportFormatType;
                //////////reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                ////////////string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                //////////string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                //////////Directory.CreateDirectory(tempOutputPath);

                //////////reportState.MergedReportFile = this.GetOutputPath(String.Format("ExtendedSpeedViolationsDetailsReportForFleet-{0}{1}", Guid.NewGuid(), fileExt));




                //////////for (int i = 0; i < FleetIds.Length; i++)
                //////////{
                //////////    try
                //////////    {
                //////////        //reportState.ReportParameters.Add("FleetName", GetFleetName(UserID, FleetIds[i]));


                //////////        // check and wait previous report is done.
                //////////        if (asyncResult != null)
                //////////        {
                //////////            if (!asyncResult.IsCompleted)
                //////////            {
                //////////                asyncResult.AsyncWaitHandle.WaitOne();
                //////////            }
                //////////        }


                //////////        reportState.ReportParameters["FleetName"] = GetFleetName(UserID, FleetIds[i]);
                //////////        string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                //////////        reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);

                //////////        dsCrystal.Clear();
                //////////        dsCrystal = report.GetSpeedViolationsDetailsReportForFleet_RoadSpeed (UserID, FleetIds[i], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                //////////        dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";
                //////////        reportState.CrystalDataSet = dsCrystal;


                //////////        asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                //////////    }
                //////////    catch
                //////////    {
                //////////    }
                //////////}

                //////////if (asyncResult != null)
                //////////{
                //////////    if (!asyncResult.IsCompleted)
                //////////    {
                //////////        asyncResult.AsyncWaitHandle.WaitOne();
                //////////    }
                //////////}

                //////////try
                //////////{
                //////////    // merge report files.
                //////////    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                //////////    {
                //////////        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                //////////        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                //////////    }
                //////////    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                //////////    {
                //////////        //reportState.MergedReportFile += ".zip";
                //////////        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                //////////        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                //////////    }
                //////////    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                //////////    {
                //////////        reportState.MergedReportFile += ".zip";
                //////////        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                //////////        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                //////////    }
                //////////}
                //////////finally
                //////////{
                //////////    DeleteDirectory(tempOutputPath);
                //////////}

                //////////string tmpReportName = "";
                //////////if (File.Exists(reportState.MergedReportFile))
                //////////    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));





                dsCrystal = report.GetSpeedViolationsDetailsReportForFleet_RoadSpeed(UserID, FleetIds[0], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, ColorFilter);
                dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";



                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                //else
                oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetRoadSpeed.rpt"));



                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetIds[0]);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                if (Type == 1)
                    crParameterDiscreteValue.Value = "11 - 20";
                else
                    crParameterDiscreteValue.Value = "6 - 10";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                if (Type == 1)
                    crParameterDiscreteValue.Value = "21 - 30";
                else
                    crParameterDiscreteValue.Value = "11 - 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "Over 30";
                else
                    crParameterDiscreteValue.Value = "Over 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                ReportPath = this.GetReportURL(ReportName);
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<< GetExtendedSpeedViolationsDetailsReportForFleets_RoadSpeed(uId={0}, dtFrom={1}, dtTo={2}, FleetIds={3}, reportPath={4})",
                            UserID, FromDate, ToDate, FleetIds.Length, ReportPath);

                //ReportPath = ReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Extended SpPeed Violation Details Report for Fleets failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetExtendedSpeedViolationsDetailsReportForFleets_RoadSpeed : uId={0}, EXC={1}",
                             UserID, ReportPath);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        // <summary> Based on Fleets Id's array
        ///         report for CN, is based on special tables 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetSpeedViolationsDetailsReport_RoadSpeed(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 PostedSpeedOnly, Int32 Delta, int rFormat, string lang, ref string ReportPath)
        {

            Int32 orgId = 0;

            try
            {
                orgId = GetOrganizationIdByUserId(UserID);

                Log(">> GetSpeedViolationsDetailsReport_RoadSpeed(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                            UserID, FromDate, ToDate, FleetId);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);



                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSpeedViolationsDetailsReport_RoadSpeed.xsd"));
               // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);







                dsCrystal = report.GetSpeedViolationsDetailsReport_RoadSpeed(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), PostedSpeedOnly, Delta);
                dsCrystal.Tables[0].TableName = "Table";



                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                //else




           

               // if (orgId == 951)
                //    oRpt.Load(this.GetReportPath("rptSpeedViolationsDetailsReport_RoadSpeed_UP.rpt"));
               // else
                  //  oRpt.Load(this.GetReportPath("rptSpeedViolationsDetailsReport_RoadSpeed.rpt"));


		 if (orgId ==999994)
                    oRpt.Load(this.GetReportPath("rptSpeedViolationsDetailsReport_RoadSpeed_UP.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptSpeedViolationsDetailsReport_RoadSpeed.rpt"));

              



                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<< GetSpeedViolationsDetailsReport_RoadSpeed(uId={0}, dtFrom={1}, dtTo={2}, FleetIds={3}, reportPath={4})",
                            UserID, FromDate, ToDate, FleetId, ReportPath);

                ReportPath = this.GetReportURL(ReportName);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (orgId != 951)
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Speed Violation Details Report for Fleets failed", "");
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Speed Infraction Details Report for Fleets failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetSpeedViolationsDetailsReport_RoadSpeed : uId={0}, EXC={1}",
                             UserID, ReportPath);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }







       



        /// <summary> Based on Fleets Id's array
        ///       
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetSpeedViolationSummaryReport_RoadSpeed(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate,Int16 PostedSpeedOnly, int rFormat, string lang, ref string ReportPath)
        {

            Int32 orgId = 0;
            try
            {

                Log(">> GetSpeedViolationsReport_RoadSpeed(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                            UserID, FromDate, ToDate, FleetId);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                int Type = 1;


                GetUserPreferences(UserID);

                if (UnitOfMes != 1.0)
                    Type = 2;



                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsDetailsReportForFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //  string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);




                dsCrystal = report.GetSpeedViolationsSummaryReportForFleet_RoadSpeed(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, "", PostedSpeedOnly);
                dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";



                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                //else

                orgId = GetOrganizationIdByUserId(UserID);

                  if (orgId !=999994)
                    oRpt.Load(this.GetReportPath("rptSpeedViolationsSummaryReport_RoadSpeed.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptSpeedViolationsSummaryReport_RoadSpeed_UP.rpt"));


                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_SpeedViolationSummaryByRoad)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);// FromDate.Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);// ToDate.Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                if (Type == 1)
                    crParameterDiscreteValue.Value = "11 - 20";
                else
                    crParameterDiscreteValue.Value = "6 - 10";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                if (Type == 1)
                    crParameterDiscreteValue.Value = "21 - 30";
                else
                    crParameterDiscreteValue.Value = "11 - 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "> 30";
                else
                    crParameterDiscreteValue.Value = "> 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);

                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--GetSpeedViolationsReport_RoadSpeed( userId = {0}, fromDate = {1}, toDate={2})", UserID, FromDate, ToDate);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);
                Log("<--GetSpeedViolationsReport_RoadSpeed( userId = {0}, fromDate = {1}, toDate={2})", UserID, FromDate, ToDate);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }







        /// <summary> Based on Fleets Id's array
        ///       
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Type">0 for summary, 1 for details
        /// </param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetSpeedViolationSummaryReport_RoadSpeed_Hierarchy(Int32 UserID, string SID, string  nodeCode, string FromDate, string ToDate,Int16 PostedSpeedOnly, int rFormat, string lang, ref string ReportPath)
        {

            try
            {

                Log(">> GetSpeedViolationSummaryReport_RoadSpeed_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3})",
                            UserID, FromDate, ToDate, nodeCode);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                int Type = 1;


                GetUserPreferences(UserID);

                if (UnitOfMes != 1.0)
                    Type = 2;



                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedSpeedViolationsDetailsReportForFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //  string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);




                dsCrystal = report.GetSpeedViolationsSummaryReportForFleet_RoadSpeed_Hierarchy(UserID, nodeCode, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), Type, "", PostedSpeedOnly);
                dsCrystal.Tables[0].TableName = "rpt_ExtendedSpeedViolationsReportForFleet";



                if (!Util.IsDataSetValid(dsCrystal))
                {
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedSpeedViolationsDetailsReportForFleetNoHeader.rpt"));
                //else
                oRpt.Load(this.GetReportPath("rptSpeedViolationsSummaryReport_RoadSpeed.rpt"));



                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);// FromDate.Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);// ToDate.Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = nodeCode;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                if (Type == 1)
                    crParameterDiscreteValue.Value = "11 - 20";
                else
                    crParameterDiscreteValue.Value = "6 - 10";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                if (Type == 1)
                    crParameterDiscreteValue.Value = "21 - 30";
                else
                    crParameterDiscreteValue.Value = "11 - 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                if (Type == 1)
                    crParameterDiscreteValue.Value = "> 30";
                else
                    crParameterDiscreteValue.Value = "> 15";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Speed3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);

                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--GetSpeedViolationsReport_RoadSpeed( userId = {0}, fromDate = {1}, toDate={2})", UserID, FromDate, ToDate);
                        return (int)InterfaceError.NoError;
                }

                ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();



                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);
                Log("<--GetSpeedViolationSummaryReport_RoadSpeed_Hierarchy( userId = {0}, fromDate = {1}, toDate={2})", UserID, FromDate, ToDate);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Speed Violations Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary> 
        ///         this is a CN report with all their weird numbers
        ///         GUID : 37 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Cost"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetCNFleetUtilizationReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Single Cost, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log(">> GetCNFleetUtilizationReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}",
                 UserID, FromDate, ToDate, FleetId);


                //Single Cost = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    Cost = Convert.ToSingle(json[ReportTemplate.RptParamCost]);
                ////}


                //Cost = Convert.ToSingle(Util.PairFindValue(ReportTemplate.RptParamCost, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstCNFleetUtilizationReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetCNFleetUtilizationReport(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), "%");
                    dsCrystal.Tables[0].TableName = "rpt_CNFleetUtilization";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "CN Fleet Utilization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
               Dictionary<string,object> mapParams=new Dictionary<string,object>();
               mapParams.Add("FromDate", FromDate.Substring(0, 11));
               mapParams.Add("ToDate", ToDate.Substring(0, 11));
               mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
               mapParams.Add("Cost", Cost.ToString());
               mapParams.Add("UnitOfMes", UnitOfMes );
               mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")"  );

               if (rFormat==2)
               {
                    ReportPath = CreateReport ("rptExtendedIdlingUtilizationReportForFleetNoHeader.rpt",
                                         "rptExtendedIdlingUtilizationReportForFleet",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                
                          ) ;
               }
               else
               {
                                   ReportPath = CreateReport ("rptExtendedIdlingUtilizationReportForFleet.rpt",
                                         "rptExtendedIdlingUtilizationReportForFleet",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                
                          ) ;

               }

#else

                ReportDocument oRpt = new ReportDocument();
                //PaperSize pkSize = new PaperSize();
                //PrintOptions printOptions = oRpt.PrintOptions;
                //printOptions.PaperSize = CrystalDecisions.Shared.PaperSize.DefaultPaperSize;


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rptExtendedIdlingUtilizationReportForFleetNoHeader.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rptExtendedIdlingUtilizationReportForFleet.rpt"));


                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = Cost.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // duplicated
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetCNFleetUtilizationReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                               UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "CN Fleet Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetCNFleetUtilizationReport : uId={0}, EXC={1}", Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary> Based on array of Fleets Id's
        ///         this is a CN report with all their weird numbers
        ///         GUID : 37 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="Cost"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetCNFleetsUtilizationReport(Int32 UserID, string SID, int[] FleetIds, string FromDate, string ToDate, Single Cost, String ColorFilter, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log(">> GetCNFleetsUtilizationReport(uId={0}, dtFrom={1}, dtTo={2}, FleetIds={3}",
                 UserID, FromDate, ToDate, FleetIds.Length);



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);
                DataSet dsCrystal = new DataSet();
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstCNFleetUtilizationReport.xsd"));
                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                VLF.DAS.Logic.Report report = new VLF.DAS.Logic.Report(ConnnectionString);


                // report format
                ExportFormatType exportFormatType = ExportFormatType.NoFormat;
                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        exportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        exportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        exportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }


                GenerateVehicleTripReportDelegate reportDelegate = new GenerateVehicleTripReportDelegate(GenerateVehicleTripReport);
                IAsyncResult asyncResult = null;


                // prepare report parameters
                ReportState reportState = new ReportState();
                reportState.Lang = lang;
                //reportState.ReportResourceManager = new ResourceManager(typeof(Resources.Report_TripActivity));
                reportState.ReportTemplateFile = this.GetReportPath("rptExtendedIdlingUtilizationReportForFleet.rpt");
                reportState.ReportParameters = new Dictionary<string, object>();
                reportState.ReportParameters.Add("FromDate", FromDate);
                reportState.ReportParameters.Add("ToDate", ToDate);
                reportState.ReportParameters.Add("FleetName", "");
                reportState.ReportParameters.Add("UnitOfMes", UnitOfMes);
                reportState.ReportParameters.Add("Cost", Cost.ToString());
                reportState.ReportParameters.Add("DistanceType", "(" + FindExistingPreference() + ")");

                reportState.FormatType = exportFormatType;
                reportState.PdfMerger = ConfigurationManager.AppSettings["PdfMerger"];
                //string fullReportsOutputPath = Server.MapPath(ReportsOutputPath);

                string tempOutputPath = Path.Combine(Path.GetTempPath(), Guid.NewGuid().ToString());
                Directory.CreateDirectory(tempOutputPath);

                reportState.MergedReportFile = this.GetOutputPath(String.Format("ExtendedIdlingUtilizationReportForFleet-{0}{1}", Guid.NewGuid(), fileExt));
                //Path.Combine(Server.MapPath(ReportsOutputPath), String.Format("rptTripSummaryData-{0}{1}", Guid.NewGuid(), fileExt));


                for (int i = 0; i < FleetIds.Length; i++)
                {
                    try
                    {
                        //reportState.ReportParameters.Add("FleetName", GetFleetName(UserID, FleetIds[i]));


                        // check and wait previous report is done.
                        if (asyncResult != null)
                        {
                            if (!asyncResult.IsCompleted)
                            {
                                asyncResult.AsyncWaitHandle.WaitOne();
                            }
                        }


                        reportState.ReportParameters["FleetName"] = GetFleetName(UserID, FleetIds[i]);
                        string outputFileName = string.Format("{0:d5}{1}", i + 1, fileExt);
                        reportState.OutputFile = Path.Combine(tempOutputPath, outputFileName);

                        dsCrystal.Clear();
                        dsCrystal = report.GetCNFleetUtilizationReport(FleetIds[i], Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), ColorFilter);
                        dsCrystal.Tables[0].TableName = "rpt_CNFleetUtilization";
                        reportState.CrystalDataSet = dsCrystal;

                        asyncResult = reportDelegate.BeginInvoke(reportState, new AsyncCallback(GenerateVehicleTripReportDelegateCallBack), reportDelegate);
                    }
                    catch
                    {
                    }
                }

                if (asyncResult != null)
                {
                    if (!asyncResult.IsCompleted)
                    {
                        asyncResult.AsyncWaitHandle.WaitOne();
                    }
                }


                try
                {
                    // merge report files.
                    if (reportState.FormatType == ExportFormatType.PortableDocFormat)
                    {
                        //MergePDF(reportState.PdfMerger, tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergePDF(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                    }
                    else if (reportState.FormatType == ExportFormatType.ExcelRecord)
                    {
                        //reportState.MergedReportFile += ".zip";
                        //ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        MergeExcel(tempOutputPath, "*" + fileExt, reportState.MergedReportFile, true);
                    }
                    else if (reportState.FormatType == ExportFormatType.WordForWindows)
                    {
                        reportState.MergedReportFile += ".zip";
                        ZipReports(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);
                        //MergeWord(tempOutputPath, "*" + fileExt, reportState.MergedReportFile);                    
                    }
                }
                finally
                {
                    DeleteDirectory(tempOutputPath);
                }

                string tmpReportName = "";
                if (File.Exists(reportState.MergedReportFile))
                    tmpReportName = this.GetReportURL(Path.GetFileName(reportState.MergedReportFile));




                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //    dsCrystal = rpt.GetCNFleetUtilizationReport(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //    dsCrystal.Tables[0].TableName = "rpt_CNFleetUtilization";
                //}


                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //    ReportPath = "";
                //    return (int)InterfaceError.NoError;
                //}



                //ReportDocument oRpt = new ReportDocument();
                ////PaperSize pkSize = new PaperSize();
                ////PrintOptions printOptions = oRpt.PrintOptions;
                ////printOptions.PaperSize = CrystalDecisions.Shared.PaperSize.DefaultPaperSize;


                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (rFormat == 2)
                //    oRpt.Load(this.GetReportPath("rptExtendedIdlingUtilizationReportForFleetNoHeader.rpt"));
                //else
                //    oRpt.Load(this.GetReportPath("rptExtendedIdlingUtilizationReportForFleet.rpt"));


                //oRpt.SetDataSource(dsCrystal);

                ////               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                //ParameterFieldDefinitions crParameterFieldDefinitions;
                //ParameterFieldDefinition crParameterFieldDefinition;
                //ParameterValues crParameterValues = new ParameterValues();
                //ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                //crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang).Substring(0, 11);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //crParameterDiscreteValue.Value = Cost.ToString();
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //// duplicated
                ////               GetUserPreferences(UserID);

                //crParameterDiscreteValue.Value = UnitOfMes;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                //string fileExt = "";
                //switch (rFormat)
                //{
                //    case 1:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                //        fileExt = ".pdf";
                //        break;
                //    case 2:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                //        fileExt = ".xls";
                //        break;
                //    case 3:
                //        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                //        fileExt = ".doc";
                //        break;
                //}
                //string ReportName = this.GetReportName("rptSpeedFleetViolation", fileExt);

                //oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                //diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                //oRpt.ExportOptions.DestinationOptions = diskOpt;
                //oRpt.Export();
                //oRpt.Close();

                //ReportPath = this.GetReportURL(ReportName);
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (tmpReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, tmpReportName);
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                Log("<< GetCNFleetsUtilizationReport(uId={0}, dtFrom={1}, dtTo={2}, FleetIds={3}, reportPath={4})",
                               UserID, FromDate, ToDate, FleetIds.Length, ReportPath);

                ReportPath = tmpReportName;
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "CN Fleets Utilization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetCNFleetsUtilizationReport : uId={0}, EXC={1}", Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetExtendedMonthlyFleetSummary(Int32 UserID, string SID, int FleetId, string FromDate, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;
            try
            {

                Log("-->GetExtendedMonthlyFleetSummary( userId = {0}, fromDate = {1}, FleetId={2} )", UserID, FromDate, FleetId);


                GetCNFleetMonthlySummaryReport(UserID, SID, FleetId, FromDate, rFormat, lang, 42, ref ReportPath);

                Log("<--GetExtendedMonthlyFleetSummary( userId = {0}, fromDate = {1},FleetId={2} )", UserID, FromDate, FleetId);

                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Monthly Fleet Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetExtendedMonthlyAverageDaysUtilized(Int32 UserID, string SID, string FromDate, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;

            try
            {


                Log("-->GetExtendedMonthlyAverageDaysUtilized( userId = {0}, fromDate = {1} )", UserID, FromDate);



                GetCNFleetMonthlySummaryReport(UserID, SID, -1, FromDate, rFormat, lang, 43, ref ReportPath);

                Log("<--GetExtendedMonthlyAverageDaysUtilized( userId = {0}, fromDate = {1})", UserID, FromDate);
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Monthly Average Days Utilized Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetExtendedMonthlyServiceHrsUtilized(Int32 UserID, string SID, string FromDate, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;
            try
            {


                Log("-->GetExtendedMonthlyServiceHrsUtilized( userId = {0}, fromDate = {1} )", UserID, FromDate);


                GetCNFleetMonthlySummaryReport(UserID, SID, -1, FromDate, rFormat, lang, 44, ref ReportPath);

                Log("<--GetExtendedMonthlyServiceHrsUtilized( userId = {0}, fromDate = {1})", UserID, FromDate);
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Monthly Service Hours Utilized Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetExtendedMonthlyEngineOnHrsUtilized(Int32 UserID, string SID, string FromDate, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;

            try
            {



                Log("-->GetExtendedMonthlyEngineOnHrsUtilized( userId = {0}, fromDate = {1} )", UserID, FromDate);



                GetCNFleetMonthlySummaryReport(UserID, SID, -1, FromDate, rFormat, lang, 45, ref ReportPath);

                Log("<--GetExtendedMonthlyEngineOnHrsUtilized( userId = {0}, fromDate = {1})", UserID, FromDate);
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Monthly Engine On Hours Utilized Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int GetExtendedAverageTravelledDistance(Int32 UserID, string SID, string FromDate, int rFormat, string lang, ref string ReportPath)
        {

            string tmpReportPath = ReportPath;

            try
            {


                Log("-->GetExtendedAverageTravelledDistance( userId = {0}, fromDate = {1} )", UserID, FromDate);

                GetCNFleetMonthlySummaryReport(UserID, SID, -1, FromDate, rFormat, lang, 48, ref ReportPath);

                Log("<--GetExtendedAverageTravelledDistance( userId = {0}, fromDate = {1})", UserID, FromDate);
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Average Travelled Distance Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetExtendedMonthlyUnnecessaryIdlingHrsUtilized(Int32 UserID, string SID, string FromDate, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;

            try
            {


                Log("-->GetExtendedMonthlyUnnecessaryIdlingHrsUtilized( userId = {0}, fromDate = {1} )", UserID, FromDate);


                GetCNFleetMonthlySummaryReport(UserID, SID, -1, FromDate, rFormat, lang, 46, ref ReportPath);

                Log("<--GetExtendedMonthlyUnnecessaryIdlingHrsUtilized( userId = {0}, fromDate = {1})", UserID, FromDate);

                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Monthly Unnecessary Idling Hours Utilized Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetExtendedUnnecessaryIdlingFuelCosts(Int32 UserID, string SID, string FromDate, Single Cost, int rFormat, string lang, ref string ReportPath)
        {
            string tmpReportPath = ReportPath;

            try
            {


                Log("-->GetExtendedUnnecessaryIdlingFuelCosts( userId = {0}, fromDate = {1} )", UserID, FromDate);


                GetExtendedUnnecessaryIdlingFuelCostsReport(UserID, SID, -1, Cost, FromDate, rFormat, lang, 46, ref ReportPath);

                Log("<--GetExtendedUnnecessaryIdlingFuelCosts( userId = {0}, fromDate = {1})", UserID, FromDate);
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), Msg, ReportPath);
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(tmpReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(tmpReportPath), "Extended Unnecessary Idling Fuel Costs Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        #endregion


        /// <summary>
        ///      the report shows some metrics based on sensor information and idling 
        ///      computed for the interval defined by FromDate, toDate
        ///      GUID : 38
        ///      xmlParams for ReportScheduler ORGID=3;SENSOR_NUM=3
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="OrgId">   organization id </param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"> sensor num </param>
        /// <param name="rFormat"> format for the output report </param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"> where the report is saved </param>
        /// <returns>
        ///      if succesful, returns (int) InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerOrganization(Int32 UserID, string SID, int OrgId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3})",
                                  UserID, FromDate, ToDate, OrgId);




                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}


                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {

                    dsCrystal = rpt.GetActivitySummaryReportPerOrganization(UserID, OrgId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Organization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
               Dictionary<string,object> mapParams=new Dictionary<string,object>();

                                                      mapParams.Add("FromDate", FromDate ); 
                                                      mapParams.Add("ToDate", ToDate);
                                                      mapParams.Add("UnitOfMes", UnitOfMes ); 
                                                      mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
                                                      mapParams.Add("VolumeUnit", VolumeUnit);
               

              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleet.rpt",
                                         "rptActivitySummaryReportPerOrganization",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
              
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleet.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ActivitySummaryReportPerFleet)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerOrganization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "ActivitySummary");
                }


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3}, reportPath={4})",
                                   UserID, FromDate, ToDate, OrgId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Organization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerOrganization : uId={0}, EXC={1}", Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetIdlingSummaryReportPerOrganization(Int32 UserID, string SID, int OrgId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetIdlingSummaryReportPerOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3})",
                                  UserID, FromDate, ToDate, OrgId);




                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}


                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {

                    dsCrystal = rpt.GetActivitySummaryReportPerOrganization(UserID, OrgId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Organization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
               Dictionary<string,object> mapParams=new Dictionary<string,object>();

                                                      mapParams.Add("FromDate", FromDate ); 
                                                      mapParams.Add("ToDate", ToDate);
                                                      mapParams.Add("UnitOfMes", UnitOfMes ); 
                                                      mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
                                                      mapParams.Add("VolumeUnit", VolumeUnit);
               

              ReportPath = CreateReport ("rpt_IdlingSummaryFleet.rpt",
                                         "rptActivitySummaryReportPerOrganization",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
              
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_IdlingSummaryFleet.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingSummaryReportNew)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerOrganization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetIdlingSummaryReportPerOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3}, reportPath={4})",
                                   UserID, FromDate, ToDate, OrgId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Organization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetIdlingSummaryReportPerOrganization : uId={0}, EXC={1}", Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      the report shows some metrics based on sensor information and idling 
        ///      computed for the interval defined by FromDate, toDate
        ///      GUID : 51
        ///      xmlParams for ReportScheduler ORGID=3;SENSOR_NUM=3
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="OrgId">   organization id </param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"> sensor num </param>
        /// <param name="rFormat"> format for the output report </param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"> where the report is saved </param>
        /// <returns>
        ///      if succesful, returns (int) InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetTripSummaryTotalsReportperOrganization(Int32 UserID, string SID, int OrgId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetTripSummaryTotalsReportperOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3})",
                                  UserID, FromDate, ToDate, OrgId);




                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}


                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleet.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerOrganization(UserID, OrgId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trips Summary Totals Per Organization Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
               Dictionary<string,object> mapParams=new Dictionary<string,object>();

                                                      mapParams.Add("FromDate", FromDate ); 
                                                      mapParams.Add("ToDate", ToDate);
                                                      mapParams.Add("UnitOfMes", UnitOfMes ); 
                                                      mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
                                                      mapParams.Add("VolumeUnit", VolumeUnit);
               

              ReportPath = CreateReport ("rpt_TripSummaryTotalsReportOrganization.rpt",
                                         "rptActivitySummaryReportPerOrganization",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
              
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripSummaryTotalsReportOrganization.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ActivitySummaryReportPerFleet)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerOrganization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTripSummaryTotalsReportperOrganization(uId={0}, dtFrom={1}, dtTo={2},OrgId={3}, reportPath={4})",
                                   UserID, FromDate, ToDate, OrgId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Summary Totals Per Organization Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTripSummaryTotalsReportperOrganization : uId={0}, EXC={1}", Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle.rpt"));

                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ActivitySummaryReportPerVehicle)), lang);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "ActivitySummaryPerVehicle");
                }


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }






        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_Hierarchy(Int32 UserID, string SID, string NodeCode, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, NodeCode={3})",
                                  UserID, FromDate, ToDate, NodeCode);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Hierarchy(UserID, NodeCode, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = NodeCode;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "ActivitySummaryPerVehicle");
                }


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, NodeCode={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, NodeCode , ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle_Hierarchy: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 106
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicleWithCost(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, Single cost, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicleWithCost(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicleWithCost.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = cost;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "ActivitySummaryPerVehicle");
                }


                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicleWithCost(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicleWithCost: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicleGasType(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicleGasType(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicleGasType.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicleGasType(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicleGasType: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicleGasTypeSummary(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicleGasTypeSummary(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicleGasTypeSummary.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicleGasTypeSummary(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicleGasType: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetIdlingDetailsReportNew(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicleGasType(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_IdlingDetailsReportNew.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_IdlingDetailsReportNew.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_IdlingDetailsFleet)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId,lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_Fuel(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_Fuel(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBoxFuel.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Fuel(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "dstActivitySummaryReportPerBoxFuel";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Fuel Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicleFuel.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_Special(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            Int32 orgId = 0;
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_Special(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);

                 orgId = GetOrganizationIdByUserId(UserID);

                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Special(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_Special.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //if (orgId != 951)
                    oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_Special.rpt"));
              // else
                //    oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_Special_UP.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


             

                if (orgId == 951)
                    crParameterDiscreteValue.Value = "Truck Utilization Summary Report";
                else
                    crParameterDiscreteValue.Value = "Good Idling vs Bad Idling";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportTitle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                

                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle_Special(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle_Special: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_Special_Hierarchy(Int32 UserID, string SID, string nodeCode, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_Special_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3})",
                                  UserID, FromDate, ToDate, nodeCode);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Hierarchy(UserID, nodeCode, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_Special.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_Special.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value =nodeCode;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                Int32 orgId = GetOrganizationIdByUserId(UserID);

                if (orgId == 951)
                    crParameterDiscreteValue.Value = "Truck Utilization Summary Report";
                else
                    crParameterDiscreteValue.Value = "Good Idling vs Bad Idling";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportTitle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle_Special(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, nodeCode, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle_Special: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_BadGoodIdling(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            string ReportNameCustom = "Good Idling vs Bad Idling & Fuel";
            try
            {


               
                Int32 orgId = GetOrganizationIdByUserId(UserID);

                if (orgId == 951)
                    ReportNameCustom = "Truck Utilization Summary Report with Fuel";

                Log(">> BadVsGoodIdling(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Special(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), ReportNameCustom+" doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_Special.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_BadGoodIdling.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


               

                if (orgId == 951)
                    crParameterDiscreteValue.Value = "Truck Utilization Summary Report with Fuel";
                else
                    crParameterDiscreteValue.Value = "Good Idling vs Bad Idling & Fuel";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportTitle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptBadvsGoodIdling", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< BadVsGoodIdling(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath),ReportNameCustom+ " failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< BadVsGoodIdling: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_BadGoodIdling_Hierarchy(Int32 UserID, string SID, string nodeCode, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> BadVsGoodIdling(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3})",
                                  UserID, FromDate, ToDate, nodeCode);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Hierarchy (UserID, nodeCode , Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Good vs Bad Idling Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_Special.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_BadGoodIdling.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = nodeCode;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                Int32 orgId = GetOrganizationIdByUserId(UserID);

                if (orgId == 951)
                    crParameterDiscreteValue.Value = "Truck Utilization Summary Report with Fuel";
                else
                    crParameterDiscreteValue.Value = "Good Idling vs Bad Idling & Fuel";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ReportTitle"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptBadvsGoodIdling", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< BadVsGoodIdling(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, nodeCode, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Good vs Bad Idling Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< BadVsGoodIdling: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetSensorActivityReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetSensorActivityReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSensorActivityReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSensorActivityReport(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "SensorActivityReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_SensorActivityReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSensorActivityReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< GetSensorActivityReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetSensorActivityReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetSensorActivityReport_Hierarchy(Int32 UserID, string SID, string  nodeCode, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetSensorActivityReport_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3})",
                                  UserID, FromDate, ToDate, nodeCode);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSensorActivityReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSensorActivityReport_Hierarchy(UserID, nodeCode, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "SensorActivityReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_SensorActivityReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = nodeCode;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSensorActivityReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< GetSensorActivityReport_Hierarchy(uId={0}, dtFrom={1}, dtTo={2}, nodeCode={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, nodeCode , ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetSensorActivityReport_Hierarchy: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetHighRailMileageReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetHighRailMileageReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSensorActivityReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSensorActivityReport(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "SensorActivityReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_HighRailMileage.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptSensorActivityReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< GetSensorActivityReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Sensor Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetSensorActivityReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 39
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_Daily(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_Daily(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle_Daily(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_Daily.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_Daily.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle_Daily(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Daily Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 56
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetActivitySummaryReportPerVehicle_CP(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivitySummaryReportPerVehicle_CP(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "CP Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerVehicle_CP.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerVehicle_CP.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivitySummaryReportPerVehicle_CP(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "CP Activity Summary Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummaryReportPerVehicle_CP: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        /// <summary>
        ///      shows statistics for every vehicle for the interval defined by FromDate, ToDate
        ///      GUID : 50
        ///     xmlParams : SENSOR_NUM=3
        /// 
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns>
        ///   if succesful, (int)InterfaceError.NoError
        /// </returns>
        [WebMethod]
        public int GetTripSummaryTotalsReportperVehicle(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetTripSummaryTotalsReportperVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerBox.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummaryReportPerVehicle(UserID, FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), sensorNum);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerBox";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Summary Totals Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_TripSummaryTotalsReportVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripSummaryTotalsReportVehicle.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTripSummaryTotalsReportperVehicle(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trip Summary Totals Per Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTripSummaryTotalsReportperVehicle: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int GetTimeAtLandmarkReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GetTimeAtLandmarkReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);


                string licensePlate = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);
                string landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();
                DataSet dsLandmarks = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTimeAtLandmark.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsLandmarks = rpt.GetTimeAtLandmarkReport(UserID, licensePlate, landmark, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables["TimeAtLandmark"].Merge(dsLandmarks.Tables[0], false, MissingSchemaAction.Ignore);

                }


                DataSet dsVehicle = new DataSet();

                using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString))
                {
                    dsVehicle = dbVehicle.GetVehicleInfoByLicensePlate(licensePlate);
                }

                if (Util.IsDataSetValid(dsVehicle))
                    dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);




                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Time At Landmark Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }




#if NEW
               Dictionary<string, object> mapParams = new Dictionary<string, object>();
               mapParams.Add("FromDate", FromDate);
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("Landmark", landmark);

               ReportPath = CreateReport("rpt_TimeAtLandmark.rpt",
                                          "rptTimeAtLandmark",
                                          dsCrystal,
                                          rFormat,
                                          mapParams
                                           );
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TimeAtLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TimeAtLandmark)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = landmark;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Landmark"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptLandmarkActivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TimeAtLandmark");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif

                Log("<--LandmarkActivityReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Time At Landmark Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int GetTimeAtLandmarkFleetReport(Int32 UserID, string SID, Int32 FleetId, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->GetTimeAtLandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3},fleetId={4} )", UserID, FromDate, ToDate, xmlParams, FleetId);


                string landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();
                DataSet dsLandmarks = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTimeAtLandmark.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsLandmarks = rpt.GetTimeAtLandmarkFleetReport(UserID, FleetId, landmark, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables["TimeAtLandmark"].Merge(dsLandmarks.Tables[0], false, MissingSchemaAction.Ignore);

                }


                DataSet dsVehicle = new DataSet();

                using (VLF.DAS.Logic.Fleet dbFleet = new VLF.DAS.Logic.Fleet(ConnnectionString))
                {
                    dsVehicle = dbFleet.GetVehiclesFullInfobyFleetId(FleetId);
                }

                if (Util.IsDataSetValid(dsVehicle))
                    dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);




                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Time At Landmark Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }




#if NEW
               Dictionary<string, object> mapParams = new Dictionary<string, object>();
               mapParams.Add("FromDate", FromDate);
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("Landmark", landmark);

               ReportPath = CreateReport("rpt_TimeAtLandmark.rpt",
                                          "rptTimeAtLandmark",
                                          dsCrystal,
                                          rFormat,
                                          mapParams
                                           );
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TimeAtLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TimeAtLandmark )), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = landmark;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Landmark"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptLandmarkActivity", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TimeAtLandmark");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<--GetTimeAtLandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3},fleetId={4} )", UserID, FromDate, ToDate, xmlParams, FleetId);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Time At Landmark Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      shows a summary for all trips within interval [FromDate, ToDate]
        ///      GUID: 40
        ///      xmlParams for ReportScheduler 
        ///         SENSOR_NUM=3;LP=LP_8978
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="LicensePlate"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetTripsSummaryReportByLicensePlate(Int32 UserID, string SID, string LicensePlate, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                //string LicensePlate = "";
                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    LicensePlate = json[ReportTemplate.RptParamLicensePlate];
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //LicensePlate =Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);
                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                Log(">> GetTripsSummaryReportByLicensePlate(uId={0}, dtFrom={1}, dtTo={2},LicensePlate={3})",
                                  UserID, FromDate, ToDate, LicensePlate);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripSummaryReportPerVehicle.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetTripsSummaryReport(UserID, LicensePlate, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "TripSummaryReportPerVehicle";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trips Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string,object> mapParams=new Dictionary<string,object>();

               mapParams.Add("FromDate", FromDate); 
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("UnitOfMes", UnitOfMes);
               mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
               mapParams.Add("VolumeUnit", VolumeUnit );

              ReportPath = CreateReport ("rpt_TripSummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripSummaryReportPerVehicle.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripSummaryReportPerVehicle)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("TripSummaryReportPerVehicleII", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TripSummaryExtended");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTripsSummaryReportByLicensePlate(uId={0}, dtFrom={1}, dtTo={2}, LicensePlate={3}, ReportPath={4})",
                                  UserID, FromDate, ToDate, LicensePlate, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trips Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTripsSummaryReportByLicensePlate : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int GetTripsSummaryReportNewStructure(Int32 UserID, string SID, string LicensePlate, int FleetId, string FromDate, string ToDate, Int16 sensorNum, bool showDriver, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                //string LicensePlate = "";
                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    LicensePlate = json[ReportTemplate.RptParamLicensePlate];
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //LicensePlate =Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);
                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                Log(">> GetTripsSummaryReportNewStructure(uId={0}, dtFrom={1}, dtTo={2},LicensePlate={3})",
                                  UserID, FromDate, ToDate, LicensePlate);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripSummaryReportPerVehicle.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    if (LicensePlate != "0")
                        dsCrystal = rpt.GetTripsSummaryReport(UserID, LicensePlate, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    else
                        dsCrystal = rpt.GetTripsSummaryReportByFleet(UserID, FleetId, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                    dsCrystal.Tables[0].TableName = "TripSummaryReportPerVehicle";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trips Summary Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string,object> mapParams=new Dictionary<string,object>();

               mapParams.Add("FromDate", FromDate); 
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("UnitOfMes", UnitOfMes);
               mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
               mapParams.Add("VolumeUnit", VolumeUnit );

              ReportPath = CreateReport ("rpt_TripSummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TripSummaryReportNew.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripSummaryReportPerVehicle)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = showDriver;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DisplayDriver"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("TripSummaryReportPerVehicleII", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TripSummaryDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTripsSummaryReportByLicensePlate(uId={0}, dtFrom={1}, dtTo={2}, LicensePlate={3}, ReportPath={4})",
                                  UserID, FromDate, ToDate, LicensePlate, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trips Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTripsSummaryReportByLicensePlate : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetTripsSummaryReportNewStructure_ByDriver(Int32 UserID, string SID, string LicensePlate, int FleetId, string FromDate, string ToDate, Int16 sensorNum, Int32 DriverId, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                //string LicensePlate = "";
                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    LicensePlate = json[ReportTemplate.RptParamLicensePlate];
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //LicensePlate =Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);
                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                Log(">> GetTripsSummaryReportNewStructure(uId={0}, dtFrom={1}, dtTo={2},LicensePlate={3})",
                                  UserID, FromDate, ToDate, LicensePlate);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTripSummaryReportPerVehicle.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
		string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    if (LicensePlate != "0")
                        dsCrystal = rpt.GetTripsSummaryReport(UserID, LicensePlate, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), DriverId);
                    else
                        dsCrystal = rpt.GetTripsSummaryReportByFleet(UserID, FleetId, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), DriverId);

                    dsCrystal.Tables[0].TableName = "TripSummaryReportPerVehicle";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Consumption Report by Driver doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string,object> mapParams=new Dictionary<string,object>();

               mapParams.Add("FromDate", FromDate); 
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("UnitOfMes", UnitOfMes);
               mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
               mapParams.Add("VolumeUnit", VolumeUnit );

              ReportPath = CreateReport ("rpt_TripSummaryReportPerVehicle.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_FuelConsumed.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripSummaryReportPerVehicle)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = true;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DisplayDriver"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("TripSummaryReportPerVehicleII", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "TripSummaryDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTripsSummaryReportByLicensePlate(uId={0}, dtFrom={1}, dtTo={2}, LicensePlate={3}, ReportPath={4})",
                                  UserID, FromDate, ToDate, LicensePlate, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Consumption Report by Driver Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTripsSummaryReportByLicensePlate : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        /// <summary>
        ///      shows a summary for all trips within interval [FromDate, ToDate]
        ///      GUID: 63
        ///      xmlParams for ReportScheduler 
        ///         SENSOR_NUM=3;LP=LP_8978
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="LicensePlate"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="sensorNum"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod]
        public int GetTransportationMileageReport(Int32 UserID, string SID, string LicensePlate, string FromDate, string ToDate, Int16 sensorNum, int rFormat, string lang, ref string ReportPath)
        {
            try
            {




                Log(">> GetTransportationMileageReport(uId={0}, dtFrom={1}, dtTo={2},LicensePlate={3})",
                                  UserID, FromDate, ToDate, LicensePlate);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstTransportationMileageReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //string ConnnectionString = LoginManager.GetConnnectionString(UserID);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetTransportationMileageReport(UserID, LicensePlate, sensorNum, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    dsCrystal.Tables[0].TableName = "TripSummaryReportPerVehicle";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Transportation Mileage Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string,object> mapParams=new Dictionary<string,object>();

               mapParams.Add("FromDate", FromDate); 
               mapParams.Add("ToDate", ToDate);
               mapParams.Add("UnitOfMes", UnitOfMes);
               mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
               mapParams.Add("VolumeUnit", VolumeUnit );

              ReportPath = CreateReport ("rpt_TransportationMileageReport.rpt",
                                         "TransportationMileageReport",
                                         dsCrystal,
                                         rFormat, 
                                         mapParams
                                          ) ;
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TransportationMileageReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_TripSummaryReportPerVehicle)), lang);


                DataSet dsOrg = new DataSet();

                using (VLF.DAS.Logic.Organization org = new VLF.DAS.Logic.Organization(ConnnectionString))
                {
                    dsOrg = org.GetOrganizationInfoByUserId(UserID);
                }


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = dsOrg.Tables[0].Rows[0]["OrganizationName"].ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["OrganizationName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("TransportationMileageReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "IndividualMileage");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTransportationMileageReport(uId={0}, dtFrom={1}, dtTo={2}, LicensePlate={3}, ReportPath={4})",
                                  UserID, FromDate, ToDate, LicensePlate, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Transportation Mileage Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTransportationMileageReport : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleet(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleet(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Landmark Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleet: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleet_ActiveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 activeVehicles, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleet_ActiveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleet(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, activeVehicles);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Actvity Landscape Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleet_ActiveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Landscape Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleet_ActiveVehicles: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int GetMowerHoursReport_AciveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 activeVehicles, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetMowerHoursReport_AciveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEventsYear.xsd"));

                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtFactEventsYear_Report(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, activeVehicles, 56);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Mower Hours Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_MowerHoursReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptMowerHours", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetMowerHoursReport_AciveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Mower Hours Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetMowerHoursReport_AciveVehicles: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }







        [WebMethod]
        public int GetIdlingDriverReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int driverId, int idlingThreshold, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetIdlingDriverReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEvents.xsd"));

                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetIdlingDriverReport(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), driverId, idlingThreshold, UserID);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Details Driver Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NotFound;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_IdlingDriverReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = idlingThreshold.ToString() == "-1" ? "(Idling Threshold: All)" : "(Idling Threshold: More than: " + idlingThreshold.ToString() + " hrs)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["idlingHrs"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptIdlingDetailsDriver", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetIdlingDriverReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Details Driver Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetIdlingDriverReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetTrucksHoursReport_AciveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, Int16 activeVehicles, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetTrucksHoursReport_AciveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEventsYear.xsd"));

                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtFactEventsYear_Report(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, activeVehicles, 1);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Trucks Hours Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_TruckHoursReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptTrucksHours", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetTrucksHoursReport_AciveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Trucks Hours Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetTrucksHoursReport_AciveVehicles: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int YearOdomEngHoursReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> YearOdomEngHoursReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEventsYear.xsd"));

                // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtFactEventsYear_Report(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, 0);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Annual Mileage Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_YearOdomEngHoursReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptOdomEngHours", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< YearOdomEngHoursReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Odometer - Eng Hours Activity Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< YearOdomEngHoursReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleetSnow(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleetSnow(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleetSnow(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmarkSnow.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleetSnow(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleetSnow: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleetSnow_ActiveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleetSnow(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleetSnow(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, activeVehicles);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmarkSnow.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleetSnow(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleetSnow: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleetSnow_MediaType_ActiveVehicles(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, Int16 activeVehicles,Int16 MediaTypeId, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleetSnow_MediaType_ActiveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleetSnow_MediaType (FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID, activeVehicles,MediaTypeId);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmarkSnow.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleetSnow_MediaType_ActiveVehicles(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Worksite Activity Snow Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleetSnow_MediaType_ActiveVehicles: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleetOnTheFly(Int32 UserID, string SID, long LandmarkId, int FleetId, long FromDate, long ToDate, long JobId, string streetaddress, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleetOnTheFly(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                DateTime from = new DateTime(FromDate);
                DateTime to = new DateTime(ToDate);

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));

                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                // using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleetOnTheFly(LandmarkId, FleetId, from, to, UserID, JobId);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmarkOnTheFly.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = from.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to.ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = streetaddress;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Location"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptWorksiteActivityReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }

                ReportPath = this.GetReportURL(ReportName);

                //ReportPath = @"\\192.168.9.10\TmpReports\"+ReportName;
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Landmark Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleet: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int GetActivityAtLandmarkSummaryReportPerFleet201107(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> GetActivityAtLandmarkSummaryReportPerFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);




                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);


                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySummaryReportPerFleetAtLandmark.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityAtLandmarkSummaryReportPerFleet201107(FleetId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate), UserID);
                    dsCrystal.Tables[0].TableName = "ActivitySummaryReportPerFleet";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW
              Dictionary<string,object> mapParams=new Dictionary<string,object>();
              mapParams.Add("FromDate", FromDate);
              mapParams.Add("ToDate", ToDate);
              mapParams.Add("FleetName", GetFleetName(UserID,FleetId));
              mapParams.Add("UnitOfMes", UnitOfMes);
              mapParams.Add("DistanceType", "(" + FindExistingPreference() + ")" );
              mapParams.Add("VolumeUnit", VolumeUnit);
 
              ReportPath = CreateReport ("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt",
                                         "rptActivitySummaryReportPerVehicle",
                                         dsCrystal,
                                         rFormat,
                                         mapParams
                                          ) ;
#else

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummaryReportPerFleetAtLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // loaded above 
                //               GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "(" + FindExistingPreference() + ")";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);






                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<< GetActivityAtLandmarkSummaryReportPerFleet(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary Per Landmark Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivityAtLandmarkSummaryReportPerFleet: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



     /// <summary>
        ///      Get landmark summary report for fleet
        ///      GUID : 21
        ///      xmlParams : LM=what is there;
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="fleetId"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark summary report for fleet")]
        public int LandmarkFleetReport_Driver(Int32 UserID, string SID, int fleetId, string FromDate, string ToDate,
                                      string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                string landmark = "";

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];              
                //}


                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);


                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                if (String.IsNullOrEmpty(FromDate))
                    throw new ArgumentException("XML Params string error: FromDate is null or empty");
                if (String.IsNullOrEmpty(ToDate))
                    throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //   dsCrystal = rpt.GetLandmarkFleetSummaryReport(UserID, fleetId, landmark,
                //                                             Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //}

                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //   ReportPath = "";
                //   return (int)InterfaceError.NoError;
                //}

                //LocalizeAddress(lang, ref dsCrystal);

                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));
                //dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarksReport.xsd"));
                //oRpt.SetDataSource(dsCrystal);



                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkFleetDetailsReport(UserID, fleetId, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Landmarks_Driver.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Landmarks)), lang);

                # region Report parameters
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarksReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Landmarks" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;

                }

                ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkSummary");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkFleetReport( userId = {0}, fromDate = {1}, toDate={2},FleetId={3} )", UserID, FromDate, ToDate, fleetId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Fleet Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


	  /// <summary>
        ///      Get landmark summary report for vehicle
        ///      GUID : 21
        ///      xmlParams : LM=why is there;LicensePlate=LP_23423
        /// </summary>
        /// <param name="UserID"></param>
        /// <param name="SID"></param>
        /// <param name="FromDate"></param>
        /// <param name="ToDate"></param>
        /// <param name="xmlParams"></param>
        /// <param name="rFormat"></param>
        /// <param name="lang"></param>
        /// <param name="ReportPath"></param>
        /// <returns></returns>
        [WebMethod(Description = "Get landmark summary report for vehicle")]
        public int LandmarkVehicleReport_Driver(Int32 UserID, string SID, string FromDate, string ToDate,
                                         string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->LandmarkVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                string landmark = "", plateNo = "", strFrom = "", strTo = "";
                //long vehicleId = -1;

                //using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                //{
                //   landmark = json[ReportTemplate.RptParamLandmark];
                //   plateNo = json[ReportTemplate.RptParamLicensePlate];
                //}

                landmark = Util.PairFindValue(ReportTemplate.RptParamLandmark, xmlParams);
                plateNo = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, xmlParams);



                if (String.IsNullOrEmpty(plateNo))
                    throw new ArgumentException("XML Params string error: License Plate is null or empty");
                if (String.IsNullOrEmpty(landmark))
                    throw new ArgumentException("XML Params string error: Landmark name is null or empty");
                //if (String.IsNullOrEmpty(strFrom))
                //   throw new ArgumentException("XML Params string error: FromDate is null or empty");
                //if (String.IsNullOrEmpty(strTo))
                //   throw new ArgumentException("XML Params string error: ToDate is null or empty");

                //using (VLF.DAS.Logic.Vehicle vass = new VLF.DAS.Logic.Vehicle(ConnnectionString ))
                //{
                //   vehicleId = vass.GetVehicleIdByLicensePlate(plateNo);
                //}

                //DataSet dsCrystal = new DataSet();
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                //{
                //   dsCrystal = rpt.GetLandmarkVehicleSummaryReport(UserID, plateNo, landmark,
                //                                    Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //}

                //if (!Util.IsDataSetValid(dsCrystal))
                //{
                //   ReportPath = "";
                //   return (int)InterfaceError.NoError;
                //}

                //LocalizeAddress(lang, ref dsCrystal);

                //ReportDocument oRpt = new ReportDocument();

                //DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //oRpt.Load(this.GetReportPath("rpt_Landmarks.rpt"));

                //dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarksReport.xsd"));

                //oRpt.SetDataSource(dsCrystal);




                DataSet dsCrystal = new DataSet();
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetLandmarkVehicleDetailsReport(UserID, plateNo, landmark,
                       Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_Landmarks_Driver.rpt"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstLandmarkDetailsReport.xsd"));
                oRpt.SetDataSource(dsCrystal);


                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Landmarks)), lang);

                # region Report parameters

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                // from date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // to date
                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                // landmark name
                crParameterDiscreteValue.Value = landmark;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["LandmarkName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                # endregion

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptLandmarksReport", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Landmarks" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--HistoryReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptLandmarksReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "LandmarkSummary");
                }
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--LandmarkVehicleReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Landmark Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }

                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetVehiclesStatusReport(Int32 UserID, string SID, Int32 OrgId, int rFormat, string lang, ref string ReportPath)
        {
            try
            {




                Log(">> GetVehiclesStatusReport(uId={0}, OrgId={1})",
                                  UserID, OrgId);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatusReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehiclesStatusReport(OrgId);
                    dsCrystal.Tables[0].TableName = "VehicleStatusReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Status Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string, object> mapParams = new Dictionary<string, object>();

                  ReportPath = CreateReport("rpt_VehicleStatus.rpt",
                                          "dstVehicleStatusReport",
                                          dsCrystal,
                                          rFormat,
                                          mapParams
                                           );
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_VehicleStatus.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<<GetVehiclesStatusReport(uId={0}, OrgId={1})",
                               UserID, OrgId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetVehiclesStatusReport : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetActivitySummarySaltSpreader(Int32 UserID, string SID, int vehicleId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {


                Log(">> GetActivitySummarySaltSpreader(uId={0}, dtFrom={1}, dtTo={2},vehicleId={3})",
                                   UserID, FromDate, ToDate, vehicleId);


                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsVehicle = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString))
                {
                    dsVehicle = dbVehicle.GetVehicleInfoByVehicleId(vehicleId);
                }

                int boxId = 0;
                string vehicleDescription = "";
                if (Util.IsDataSetValid(dsVehicle))
                {
                    boxId = Convert.ToInt32(dsVehicle.Tables[0].Rows[0]["boxId"]);
                    vehicleDescription = dsVehicle.Tables[0].Rows[0]["Description"].ToString();
                }




                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivitySaltSpreader.xsd"));

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivitySummarySaltSpreader(UserID, boxId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                    //dsCrystal.Tables[0].TableName = "VehicleStatusReport";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary for Salt Spreader Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

#if NEW

               Dictionary<string, object> mapParams = new Dictionary<string, object>();

                  ReportPath = CreateReport("rpt_ActivitySummarySaltSpreader.rpt",
                                          "dstActivitySaltSpreader",
                                          dsCrystal,
                                          rFormat,
                                          mapParams
                                           );
#else
                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_ActivitySummarySaltSpreader.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = vehicleDescription;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Description"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = UnitOfMes;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UnitOfMes"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("ActivitySummarySaltSpreader", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
#endif
                Log("<<GetActivitySummarySaltSpreader(uId={0}, boxId={1})",
                               UserID, boxId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Summary for Salt Spreader Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetActivitySummarySaltSpreader : uid={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int GetHOSDetailsReport(int userId, string SID, int driverId, DateTime from, DateTime to, int rFormat, string lang, int ReportGuId, ref string ReportPath)
        {

            try
            {


                Log(">> GetHOSDetailsReport(uId={0}, dtFrom={1}, dtTo={2},driverId={3})",
                                   userId, from, to, driverId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHOSdetailsReport.xsd"));


                string ConnnectionString = GetConnectionStringByDateRange(userId, from, to);
                using (DriverManager driver = new DriverManager(ConnnectionString))
                {
                    dsCrystal = driver.GetHOSbyDateTime(driverId, userId, from, to);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_HOSDetailsReport.rpt"));
                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("ExtendedMonthlyUtilization", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetHOSDetailsReport(uId={0}, driverId={1})",
                            userId, driverId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "HOS Details Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetHOSDetailsReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int VehicleInfoDataDump(int userId, string SID, int OrgId, int rFormat, ref string ReportPath)
        {

            try
            {


                Log(">> VehicleInfoDataDump(uId={0}, OrgId={1})",
                                   userId, OrgId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleInfoDataDump.xsd"));

                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehicleInfoDataDump(OrgId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_VehicleInfoDataDump.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleInfoDataDump", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<VehicleInfoDataDump(uId={0}, OrgId={1})",
                            userId, OrgId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Info Data Dump Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< VehicleInfoDataDump : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int CNElectronicInvoice(int userId, string SID, int rFormat, DateTime from, DateTime to, ref string ReportPath)
        {

            try
            {


                Log(">> CNElectronicInvoice(uId={0}, OrgId={1})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstCNElectronicInvoice.xsd"));

                string ConnnectionString = LoginManager.GetConnnectionString(userId);//GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.CNElectronicInvoice(from, to);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("CNElectronicInvoice.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleInfoDataDump", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<CNElectronicInvoice(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Info Data Dump Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< CNElectronicInvoice : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }






        [WebMethod]
        public int MaintenanceVehicleReport(int userId, string SID, int rFormat, int FleetId, ref string ReportPath)
        {

            try
            {


                Log(">> MaintenanceVehicleReport(uId={0}, OrgId={1})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstMaintenanceReport.xsd"));

                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                using (VLF.DAS.Logic.MCCManager rpt = new VLF.DAS.Logic.MCCManager(ConnnectionString))
                {
                    dsCrystal = rpt.MaintenanceVehicleReport(FleetId, userId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("MaintenanceVehicleReport.rpt"));
                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("MaintenanceVehicleReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<MaintenanceVehicleReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Maintenance Vehicle Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< MaintenanceVehicleReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }






        [WebMethod]
        public int VehicleStartEndOdometerEngHrsReport(int userId, string SID, int rFormat, int FleetId, DateTime fromDate, DateTime toDate, ref string ReportPath)
        {

            try
            {


                Log(">> VehicleStartEndOdometerEngHrsReport(uId={0}, fleetId={1})",
                                   userId, FleetId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleOdometerEngineHrsReport.xsd"));

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetBoxStartEndOdometerEngHrs(fromDate, toDate, FleetId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("VehicleOdometerEngHrsReport.rpt"));
                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("MaintenanceVehicleReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<VehicleStartEndOdometerEngHrsReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicle Start End Odometer/EngHrs Report  failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< VehicleStartEndOdometerEngHrsReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int FleetMembershipReport(int userId, string SID, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> FleetMembershipReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFleetMembershipReport.xsd"));


               // string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                string ConnnectionString = LoginManager.GetConnnectionString(userId);

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetMembershipReport(userId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_FleetMembershipReport.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("FleetMembershipReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<FleetMembershipReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Membership Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FleetMembershipReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int FleetMembershipReport_ActiveVehicles(int userId, string SID, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {

            try
            {


                Log(">> FleetMembershipReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFleetMembershipReport.xsd"));


                //string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                string ConnnectionString = LoginManager.GetConnnectionString(userId);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetMembershipReport(userId, activeVehicles);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_FleetMembershipReport.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("FleetMembershipReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<FleetMembershipReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Membership Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FleetMembershipReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int GetHOSAuditReport(int userId, string SID, int organizationID, DateTime from, DateTime to, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GetHOSAuditReport(uId={0}, dtFrom={1}, dtTo={2},organizationID={3})",
                                   userId, from, to, organizationID);

                // Authenticate 
                //LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHOSAuditReport.xsd"));

                string ConnnectionString = ConfigurationManager.AppSettings["HOSConnectionString"];

                SqlConnection conn = new SqlConnection(ConnnectionString);
                SqlDataAdapter sqlAdapt = new SqlDataAdapter();
                sqlAdapt.SelectCommand = new SqlCommand();
                sqlAdapt.SelectCommand.Connection = conn;
                sqlAdapt.SelectCommand.CommandType = CommandType.StoredProcedure;
                sqlAdapt.SelectCommand.CommandText = "Logdata_Audit_Exception_Report";
                SqlParameter para = new SqlParameter("@LogTimeStart", SqlDbType.DateTime);
                para.Value = from;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@LogTimeEnd", SqlDbType.DateTime);
                para.Value = to;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@OrganizationID", SqlDbType.Int);
                para.Value = organizationID;
                sqlAdapt.SelectCommand.Parameters.Add(para);


                sqlAdapt.Fill(dsCrystal);
                dsCrystal.Tables[0].TableName = "Table";
                //using (DriverManager driver = new DriverManager(ConnnectionString))
                //{
                //    dsCrystal = driver.GetHOSSummarybyDateTime(driverId, from, to);
                //    dsCrystal.Tables[0].TableName = "HOSSummary";
                //}


                // if (!Util.IsDataSetValid(dsCrystal))
                //     ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_HOSAuditReport.rpt"));
                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = GetDriverFullName(userId, driverId);
                //crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("HOSAuditReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "HOSSummaryPerDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetHOSSummaryReport(uId={0}, organizationID={1})",
                            userId, organizationID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "HOS Detail Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetHOSSummaryReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        //HOS Audit Report Added driverId, FleetId, VehicleId and params 2014.01.27
        [WebMethod]
        public int GetHOSAuditReportNew(int userId, string SID, int organizationID, DateTime from, DateTime to,
            int fleetId, string para1,
            int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GetHOSAuditReport(uId={0}, dtFrom={1}, dtTo={2},organizationID={3})",
                                   userId, from, to, organizationID);

                // Authenticate 
                //LoginManager.GetInstance().SecurityCheck(userId, SID);
                int driverId = 0;
                string licensePlate = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, para1);
                if (licensePlate == null) licensePlate = "";

                int.TryParse(Util.PairFindValue(ReportTemplate.RptParamDriverId, para1), out driverId);

                para1 = Util.PairFindValue(ReportTemplate.RpDetailedTripEighthParamName, para1);


                TimeSpan currDuration;

                GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHOSAuditReport.xsd"));

                string ConnnectionString = ConfigurationManager.AppSettings["HOSConnectionString"];

                SqlConnection conn = new SqlConnection(ConnnectionString);
                SqlDataAdapter sqlAdapt = new SqlDataAdapter();
                sqlAdapt.SelectCommand = new SqlCommand();
                sqlAdapt.SelectCommand.CommandTimeout = 300;
                sqlAdapt.SelectCommand.Connection = conn;
                sqlAdapt.SelectCommand.CommandType = CommandType.StoredProcedure;
                sqlAdapt.SelectCommand.CommandText = "Logdata_Audit_Exception_Report_New";
                SqlParameter para = new SqlParameter("@LogTimeStart", SqlDbType.DateTime);
                para.Value = from;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@LogTimeEnd", SqlDbType.DateTime);
                para.Value = to;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@OrganizationID", SqlDbType.Int);
                para.Value = organizationID;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@UserID", SqlDbType.Int);
                para.Value = userId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@DriverId", SqlDbType.Int);
                para.Value = driverId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@FleetId", SqlDbType.Int);
                para.Value = fleetId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@LicensePlate", SqlDbType.VarChar);
                para.Value = licensePlate;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@Para", SqlDbType.VarChar);
                para.Value = para1;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                sqlAdapt.Fill(dsCrystal);
                dsCrystal.Tables[0].TableName = "Table";
                //using (DriverManager driver = new DriverManager(ConnnectionString))
                //{
                //    dsCrystal = driver.GetHOSSummarybyDateTime(driverId, from, to);
                //    dsCrystal.Tables[0].TableName = "HOSSummary";
                //}


                // if (!Util.IsDataSetValid(dsCrystal))
                //     ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_HOSAuditReport.rpt"));
                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetFleetName(userId, Convert.ToInt32(fleetId), lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = GetDriverFullName(userId, driverId);
                //crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("HOSAuditReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "HOSSummaryPerDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetHOSSummaryReport(uId={0}, organizationID={1})",
                            userId, organizationID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "HOS Detail Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetHOSSummaryReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        //HOS Audit Report for multiple fleets 2015.07.10
        [WebMethod]
        public int GetHOSAuditReportForMultiFleets(int userId, string SID, int organizationID, DateTime from, DateTime to,
            string fleetId, string para1, string prefrence,
            int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log(">> GetHOSAuditReport(uId={0}, dtFrom={1}, dtTo={2},organizationID={3})",
                                   userId, from, to, organizationID);

                // Authenticate 
                //LoginManager.GetInstance().SecurityCheck(userId, SID);
                int driverId = 0;
                string licensePlate = Util.PairFindValue(ReportTemplate.RptParamLicensePlate, para1);
                if (licensePlate == null) licensePlate = "";

                int.TryParse(Util.PairFindValue(ReportTemplate.RptParamDriverId, para1), out driverId);

                para1 = Util.PairFindValue(ReportTemplate.RpDetailedTripEighthParamName, para1);


                TimeSpan currDuration;

                GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHOSAuditReport.xsd"));

                string ConnnectionString = ConfigurationManager.AppSettings["HOSConnectionString"];

                SqlConnection conn = new SqlConnection(ConnnectionString);
                SqlDataAdapter sqlAdapt = new SqlDataAdapter();
                sqlAdapt.SelectCommand = new SqlCommand();
                sqlAdapt.SelectCommand.CommandTimeout = 1800;
                sqlAdapt.SelectCommand.Connection = conn;
                sqlAdapt.SelectCommand.CommandType = CommandType.StoredProcedure;
                sqlAdapt.SelectCommand.CommandText = "Logdata_Audit_Exception_Report_For_MultiFleets";
                SqlParameter para = new SqlParameter("@LogTimeStart", SqlDbType.DateTime);
                para.Value = from;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@LogTimeEnd", SqlDbType.DateTime);
                para.Value = to;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@OrganizationID", SqlDbType.Int);
                para.Value = organizationID;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@UserID", SqlDbType.Int);
                para.Value = userId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@DriverId", SqlDbType.Int);
                para.Value = driverId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@FleetId", SqlDbType.VarChar);
                para.Value = fleetId;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@LicensePlate", SqlDbType.VarChar);
                para.Value = licensePlate;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                para = new SqlParameter("@Para", SqlDbType.VarChar);
                para.Value = para1;
                sqlAdapt.SelectCommand.Parameters.Add(para);

                sqlAdapt.Fill(dsCrystal);
                dsCrystal.Tables[0].TableName = "Table";
                //using (DriverManager driver = new DriverManager(ConnnectionString))
                //{
                //    dsCrystal = driver.GetHOSSummarybyDateTime(driverId, from, to);
                //    dsCrystal.Tables[0].TableName = "HOSSummary";
                //}


                // if (!Util.IsDataSetValid(dsCrystal))
                //     ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_HOSAuditReport.rpt"));
                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();
                ParameterDiscreteValue crParameterMultiValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "";
                if (fleetId.Contains(","))
                {
                    string[] split = fleetId.Split(',');
                    foreach (string item in split)
                    {
                        string FleetName = GetFleetName(userId, Convert.ToInt32(item), lang);
                        if (crParameterDiscreteValue.Value == "")
                            crParameterDiscreteValue.Value = FleetName;
                        else crParameterDiscreteValue.Value += "," + FleetName;

                    }
                }
                else
                    crParameterDiscreteValue.Value = GetFleetName(userId, Convert.ToInt32(fleetId), lang);

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = GetDriverFullName(userId, driverId);
                //crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = prefrence;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Prefrence"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("HOSAuditReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "HOSSummaryPerDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetHOSSummaryReport(uId={0}, organizationID={1})",
                            userId, organizationID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "HOS Detail Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetHOSSummaryReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int BrickmanFleetMembershipReport(int userId, string SID, int activeVehicles, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> BrickmanFleetMembershipReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstBrickmanFleetMembershipReport.xsd"));


                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetBrickmanFleetMembershipReport(userId, activeVehicles);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("BrickmanFleetMembershipReport.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("FleetMembershipReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<BrickmanFleetMembershipReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Membership Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FleetMembershipReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int FleetMembershipReportUser(int userId, int orgId, string SID, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> FleetMembershipReportUser(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFleetMembershipReport.xsd"));


                //string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                string ConnnectionString = LoginManager.GetConnnectionString(userId);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetMembershipReportUser(orgId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_FleetMembershipReportUser.rpt"));
                oRpt.SetDataSource(dsCrystal);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("FleetMembershipReportByUser", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<FleetMembershipReportUser(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Membership Report User failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FleetMembershipReportUser : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        // Changes for TimeZone Feature start

        [WebMethod]
        public int GetVehiclesStatusByDateReport_NewTZ(int userId, string SID, int OrgId, int fleetId, int rFormat, string lang, ref string ReportPath)
        {

            try
            {
               

                Log(">> GetVehiclesStatusByDateReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatus.xsd"));


                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                Resolver.Resolver res = new Resolver.Resolver();
                Double latitude = 0;
                Double longitude = 0;
                string resolvedAddress = "";

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehiclesStatusByDateReport_NewTZ(userId, fleetId);
                    dsCrystal.Tables[0].TableName = "VehicleStatus";


                    foreach (DataRow dr in dsCrystal.Tables[0].Rows)
                    {
                        if (dr[9].ToString() == "Address resolution in progress")
                        {
                            latitude = Convert.ToDouble(dr[4]);
                            longitude = Convert.ToDouble(dr[5]);
                            res.StreetAddress(latitude, longitude, ref resolvedAddress);
                            dr[9] = resolvedAddress;
                        }
                    }

                    if ((lang == "fr" && Util.IsDataSetValid(dsCrystal)))
                    {
                        foreach (DataRow dr in dsCrystal.Tables[0].Rows)
                        {
                            dr["VehicleStatus"] = dr["VehicleStatus"].ToString().Replace("Parked", "stationn").Replace("PowerSave", "conomie d'nergie").Replace("Moving", "en mouvement").Replace("Idling", "moteur au ralenti").Replace("Ignition On", "allumage activ");
                            dr["Status"] = dr["Status"].ToString().Replace("Reported withing last day", "A rapport dans les dernires 24 heures").Replace("Reported withing last 2 days", " A rapport dans les 2 derniers jours").Replace("Reported withing last 3 days", "en mouvement").Replace("Reported withing last 7 days", "A rapport dans les 7 derniers jours").Replace("Not reported more than 7 days", "N'a pas rapport depuis plus de 7 jours");
                        }
                    }
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (OrgId == 570)
                    oRpt.Load(this.GetReportPath("BrickmanVehicleStatusReport.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_VehicleStatusByDate.rpt"));


                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_VehicleStatusByDate)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetVehiclesStatusByDateReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicles Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetVehiclesStatusByDateReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        // Changes for TimeZone Feature end

        [WebMethod]
        public int GetVehiclesStatusByDateReport(int userId, string SID, int OrgId, int fleetId, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GetVehiclesStatusByDateReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

               // dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatus.xsd"));


                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                //string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                Resolver.Resolver res = new Resolver.Resolver();
                Double latitude = 0;
                Double longitude = 0;
                string resolvedAddress = "";

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehiclesStatusByDateReport(userId, fleetId);
                    dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatus.xsd"));
                    //dsCrystal.Tables[0].TableName = "VehicleStatus";


                    foreach (DataRow dr in dsCrystal.Tables[0].Rows)
                    {
                        if (dr[9].ToString() == "Address resolution in progress")
                        {
                            latitude = Convert.ToDouble(dr[4]);
                            longitude = Convert.ToDouble(dr[5]);
                            res.StreetAddress(latitude, longitude, ref resolvedAddress);
                            dr[9] = resolvedAddress;
                        }
                    }

                    if ((lang == "fr" &&  Util.IsDataSetValid(dsCrystal)))
                    {
                        foreach (DataRow dr in dsCrystal.Tables[0].Rows)
                        {
                            dr["VehicleStatus"] = dr["VehicleStatus"].ToString().Replace("Parked", "stationn").Replace("PowerSave", "conomie d'nergie").Replace("Moving", "en mouvement").Replace("Idling", "moteur au ralenti").Replace("Ignition On", "allumage activ");
                            dr["Status"] = dr["Status"].ToString().Replace("Reported withing last day", "A rapport dans les dernires 24 heures").Replace("Reported withing last 2 days", " A rapport dans les 2 derniers jours").Replace("Reported withing last 3 days", "en mouvement").Replace("Reported withing last 7 days", "A rapport dans les 7 derniers jours").Replace("Not reported more than 7 days", "N'a pas rapport depuis plus de 7 jours");
                        }
                    }

                    dsCrystal.Tables[1].Merge(dsCrystal.Tables[0], false, MissingSchemaAction.Ignore);
                    dsCrystal.Tables[2].Merge(dsCrystal.Tables[0], false, MissingSchemaAction.Ignore);


                    for (int i = dsCrystal.Tables[2].Rows.Count - 1; i >= 0; i--)
                    {
                        DataRow dr = dsCrystal.Tables[2].Rows[i];
                        if (Convert.ToInt16(dr["VehicleDeviceStatusID"]) == 3)
                            dr.Delete();
                    }
                    dsCrystal.Tables[2].AcceptChanges();
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (OrgId == 570)
                    oRpt.Load(this.GetReportPath("BrickmanVehicleStatusReport.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_VehicleStatusByDate.rpt"));


                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_VehicleStatusByDate)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetVehiclesStatusByDateReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicles Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetVehiclesStatusByDateReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        // Changes for TimeZone Feature start

        [WebMethod]
        public int GetVehiclesStatusByDateReport_ActiveVehicles_NewTZ(int userId, string SID, int OrgId, int fleetId, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {

            try
            {
                

                Log(">> GetVehiclesStatusByDateReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatus.xsd"));



                //  string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehiclesStatusByDateReport_NewTZ(userId, fleetId, activeVehicles);
                    dsCrystal.Tables[0].TableName = "VehicleStatus";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (OrgId == 570)
                    oRpt.Load(this.GetReportPath("BrickmanVehicleStatusReport.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_VehicleStatusByDate.rpt"));


                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_VehicleStatusByDate)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetVehiclesStatusByDateReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicles Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetVehiclesStatusByDateReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        // Changes for TimeZone Feature end

        [WebMethod]
        public int GetVehiclesStatusByDateReport_ActiveVehicles(int userId, string SID, int OrgId, int fleetId, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {

            try
            {


                Log(">> GetVehiclesStatusByDateReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstVehicleStatus.xsd"));



                //  string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetVehiclesStatusByDateReport(userId, fleetId, activeVehicles);
                    dsCrystal.Tables[0].TableName = "VehicleStatus";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                if (OrgId == 570)
                    oRpt.Load(this.GetReportPath("BrickmanVehicleStatusReport.rpt"));
                else
                    oRpt.Load(this.GetReportPath("rpt_VehicleStatusByDate.rpt"));


                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_VehicleStatusByDate)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("VehicleStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetVehiclesStatusByDateReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Vehicles Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetVehiclesStatusByDateReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetVehiclesStatusByDateReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int ActivityOutsideLandmarkReport(int userId, string SID, int fleetId, int vehicleId, string from, string to, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> ActivityOutsideLandmarkReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivityOutsideLandmark.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityOutsideLandmark(userId, fleetId, vehicleId, Convert.ToDateTime(from), Convert.ToDateTime(to));
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rptActivityOutsideLandmark.rpt"));


                oRpt.SetDataSource(dsCrystal);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("ActivityOutsideLandmark", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("ActivityOutsideLandmarkReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<ActivityOutsideLandmarkReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Outside Landmark Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("ActivityOutsideLandmarkReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< ActivityOutsideLandmarkReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int ActivityOutsideLandmarkReport_ActiveVehicles(int userId, string SID, int fleetId, int vehicleId, string from, string to, int rFormat, string lang, Int16 activeVehicles, ref string ReportPath)
        {

            try
            {


                Log(">> ActivityOutsideLandmarkReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivityOutsideLandmark.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityOutsideLandmark(userId, fleetId, vehicleId, Convert.ToDateTime(from), Convert.ToDateTime(to), activeVehicles);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rptActivityOutsideLandmark.rpt"));


                oRpt.SetDataSource(dsCrystal);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("ActivityOutsideLandmark", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("ActivityOutsideLandmarkReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<ActivityOutsideLandmarkReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity Outside Landmark Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("ActivityOutsideLandmarkReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< ActivityOutsideLandmarkReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int ActivityInLandmarkReport(int userId, string SID, int fleetId, int vehicleId, string from, string to, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> ActivityInLandmarkReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstActivityInLandmark.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetActivityInLandmark(userId, fleetId, vehicleId, Convert.ToDateTime(from), Convert.ToDateTime(to));
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_ActivityInLandmark.rpt"));


                oRpt.SetDataSource(dsCrystal);


                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("ActivityInLandmark", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("ActivityInLandmarkReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<ActivityInLandmarkReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Activity In Landmark Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("ActivityInLandmarkReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< ActivityInLandmarkReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        [WebMethod]
        public int GetBoxSettingsReport(int userId, string SID, int OrgId, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GetBoxSettingsReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("BoxSettings.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetBoxSettingsReport(OrgId);
                    dsCrystal.Tables[0].TableName = "rpt_BoxSettings";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rptBoxSettings.rpt"));


                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("BoxSettings", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetBoxSettingsReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetBoxSettingsReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Box Settings Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetBoxSettingsReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetBoxSettingsReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int GetUserSettingsReport(int userId, string SID, int OrgId, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GetUserSettingsReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("UserSettings.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                //using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString ))
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetUserSettingsReport(OrgId);
                    dsCrystal.Tables[0].TableName = "rpt_UserSettings";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rptUserSettings.rpt"));



                oRpt.SetDataSource(dsCrystal);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("UserSettings", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GetUserSettingsReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetUserSettingsReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "User Settings Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GetUserSettingsReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetUserSettingsReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        [WebMethod]
        public int FleetDiagnosticReport(Int32 UserID, string SID, int FleetId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> FleetDiagnosticReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3})",
                                  UserID, FromDate, ToDate, FleetId);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstFleetDiagnosticReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                using (VLF.DAS.Logic.Fleet rpt = new VLF.DAS.Logic.Fleet(ConnnectionString))
                {
                    dsCrystal = rpt.GetFleetDiagnosticReport(FleetId, UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Diagnostic Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptFleetDiagnosticReport.rpt"));

                oRpt.SetDataSource(dsCrystal);

                //               LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_FleetMaintenance)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = GetFleetName(UserID, FleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rptActivitySummaryReportPerVehicle", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< FleetDiagnosticReport(uId={0}, dtFrom={1}, dtTo={2}, FleetId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, FleetId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Fleet Diagnostic Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< FleetDiagnosticReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        private void GetCNFleetMonthlySummaryReport(Int32 UserID, string SID, int FleetId, string FromDate, int rFormat, string lang, int ReportGuId, ref string ReportPath)
        {
            // Authenticate 
            LoginManager.GetInstance().SecurityCheck(UserID, SID);

            TimeSpan currDuration;

            GetUserPreferences(UserID);

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedMonthlySummary.xsd"));
            // string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), DateTime.Now  );
            string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
            using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
            {
                if (ReportGuId == 43)
                    dsCrystal = rpt.CN_GetSummaryActivityPerMonth(FleetId, Convert.ToDateTime(FromDate));
                else
                    dsCrystal = rpt.GetCNGetMonthlyFleetSummary(FleetId, Convert.ToDateTime(FromDate));

                dsCrystal.Tables[0].TableName = "rpt_ExtendedMonthlySummary";
            }


            if (!Util.IsDataSetValid(dsCrystal))
                ReportPath = "";

            ReportDocument oRpt = new ReportDocument();

            DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

            switch (ReportGuId)
            {
                case 42:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyUtilization.rpt"));
                    break;

                case 43:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyDaysUtilized.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedMonthlyDaysUtilized)), lang);
                    break;


                case 44:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyAverageServiceHrs.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedMonthlyAverageServiceHrs)), lang);
                    break;

                case 45:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyAverageEngineOnHrs.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedMonthlyAverageEngineOnHrs)), lang);
                    break;

                case 46:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyUnnecessaryIdlingHrs.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedMonthlyUnnecessaryIdlingHrs)), lang);
                    break;

                case 47:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyUnnecessaryIdlingFuelCost.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedMonthlyUnnecessaryIdlingFuelCost)), lang);
                    break;

                case 48:
                    oRpt.Load(this.GetReportPath("rpt_ExtendedAverageTravelledDistance.rpt"));
                    LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_ExtendedAverageTravelledDistance)), lang);
                    break;
            }

            oRpt.SetDataSource(dsCrystal);

            string fileExt = "";
            switch (rFormat)
            {
                case 1:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                    fileExt = ".pdf";
                    break;
                case 2:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                    fileExt = ".xls";
                    break;
                case 3:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                    fileExt = ".doc";
                    break;
            }
            string ReportName = this.GetReportName("ExtendedMonthlyUtilization", fileExt);

            oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
            diskOpt.DiskFileName = this.GetOutputPath(ReportName);
            oRpt.ExportOptions.DestinationOptions = diskOpt;
            oRpt.Export();
            oRpt.Close();

            ReportPath = this.GetReportURL(ReportName);
        }

        [WebMethod]
        public int UserLoginsReport(Int32 UserID, string SID, int OrgId, string FromDate, string ToDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
                Log(">> UserLoginsReport(uId={0}, dtFrom={1}, dtTo={2}, Org={3})",
                    UserID, FromDate, ToDate, OrgId);

                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstUserLoginReport.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));

                using (VLF.DAS.Logic.Organization rpt = new VLF.DAS.Logic.Organization(ConnnectionString))
                {
                    dsCrystal = rpt.GetOrganizationUserLogins(UserID, OrgId, Convert.ToDateTime(FromDate), Convert.ToDateTime(ToDate));
                }

                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "User Logins Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                if (rFormat == 2)
                    oRpt.Load(this.GetReportPath("rpt_UserLogins_Excel.rpt"));
                else
                {
                    if (OrgId != 1000120)
                        oRpt.Load(this.GetReportPath("rpt_UserLogins.rpt"));
                    else
                        oRpt.Load(this.GetReportPath("rpt_UserLogins_Fleet.rpt"));
                }

                if (lang.ToLower().Contains("fr"))
                {
                    foreach (DataRow dr in dsCrystal.Tables["OrganizationUsersLoginsInfo"].Rows)
                    {
                        dr["LoginDateTime"] = Convert.ToDateTime(dr["LoginDateTime"]).ToString("d/M/yyyy HH:mm:ss");
                    }
                }

                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_UserLogins)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_UserLogins", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< UserLoginsReport(uId={0}, dtFrom={1}, dtTo={2}, OrgId={3}, reportPath={4})",
                                  UserID, FromDate, ToDate, OrgId, ReportPath);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "User Login Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< UserLoginsReport: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

        // Changes for TimeZone Feature start

        [WebMethod]
        public int AHA_Report_NewTZ(Int32 UserID, string SID, int TopFleets, int Hours, int rFormat, string lang, ref string ReportPath)
        {
            try
            {
               
                Log(">> AHA_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstAHA.xsd"));



                string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(-Hours), System.DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.AHA_Report_NewTZ(UserID, TopFleets, Hours);
                    dsCrystal.Tables[0].TableName = "AHA";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "AHA Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("AHA Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_AHA.rpt"));

                oRpt.SetDataSource(dsCrystal);





                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = Convert.ToDateTime(System.DateTime.Now.ToShortDateString() + " 12:00 AM").AddHours(-Convert.ToInt32(Hours)).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = Convert.ToDateTime(System.DateTime.Now.ToShortDateString() + " 12:00 AM").ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserNewFloatTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_AHA", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("AHA_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< AHA_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "AHA Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("AHA Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< AHA Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

       

        // Changes for TimeZone Feature end

        [WebMethod]
        public int AHA_Report(Int32 UserID, string SID, int TopFleets, int Hours, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> AHA_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstAHA.xsd"));



                string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(-Hours), System.DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.AHA_Report(UserID, TopFleets, Hours);
                    dsCrystal.Tables[0].TableName = "AHA";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "AHA Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("AHA Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_AHA.rpt"));

                oRpt.SetDataSource(dsCrystal);





                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = Convert.ToDateTime(System.DateTime.Now.ToShortDateString() + " 12:00 AM").AddHours(-Convert.ToInt32(Hours)).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = Convert.ToDateTime(System.DateTime.Now.ToShortDateString() + " 12:00 AM").ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_AHA", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("AHA_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< AHA_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "AHA Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("AHA Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< AHA Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }

       

        [WebMethod]
        public int evtViolation_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtViolation_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtViolations.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtViolation_Report(fleetId, fromDate, toDate, UserID);
                    dsCrystal.Tables[0].TableName = "evtViolations";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtViolations.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtViolations", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtViolation_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtViolation_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtViolation_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtViolation_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int evtDriverViolationsFleet_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, string xmlParams, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtDriverViolationsFleet_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

               // dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtViolations.xsd"));
                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtDriverScores.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;

                string[] tmpData = xmlParams.Split('|'); 

                //string ViolationMask = xmlParams.Substring(0, xmlParams.IndexOf(";"));
                //string ViolationPoints = xmlParams.Substring(xmlParams.IndexOf(";") + 1);


                string ViolationMask = tmpData[0].Substring(0, tmpData[0].IndexOf(";"));
                string ViolationPoints = tmpData[0].Substring(tmpData[0].IndexOf(";") + 1);

             

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtDriverViolationsFleet_Report(fleetId, fromDate, toDate, UserID,Convert.ToInt32(ViolationMask),  ViolationPoints);
                    dsCrystal.Tables[0].TableName = "evtViolations";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                //oRpt.Load(this.GetReportPath("evtViolationsDriversScores.rpt"));
                oRpt.Load(this.GetReportPath("evtViolationsDriversScores_New.rpt"));
                

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


	        string DistanceType = FindExistingPreference();

                crParameterDiscreteValue.Value = DistanceType;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string[] extraData = tmpData[1].Split(',');



                crParameterDiscreteValue.Value = extraData[0];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Divider"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = extraData[1];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Score1"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = extraData[2];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Score2"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = extraData[3];
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Score3"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.Excel;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtViolations", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtDriverViolationsFleet_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtDriverViolationsFleet_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtDriverViolationsFleet_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtDriverViolationsFleet_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int evtViolationSpeedInLandmark_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtViolationSpeedInLandmark_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationSpeedInLandmarkReport.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtViolationsSpeedInLandmark(UserID,fleetId, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "evtViolations";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtViolationSpeedInLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtViolations", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtViolationSpeedInLandmark_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtViolationSpeedInLandmark_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtViolationSpeedInLandmark_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtViolationSpeedInLandmark_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int evtViolationSpeedInLandmarkHierarchy_Report(Int32 UserID, string SID, string nodeCode, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtViolationSpeedInLandmarkHierarchy_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstViolationSpeedInLandmarkReport.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtViolationsSpeedInLandmark_Hierarchy(UserID, nodeCode, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "evtViolations";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtViolationSpeedInLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = nodeCode ;

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = FindExistingPreference();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["DistanceType"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtViolations", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtViolationSpeedInLandmarkHierarchy_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtViolationSpeedInLandmarkHierarchy_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtViolationSpeedInLandmarkHierarchy_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtViolationSpeedInLandmarkHierarchy_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int evtViolationFuel_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtViolationFuel_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtViolationsFuel.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtViolationsFuel (fleetId, fromDate, toDate, UserID);
                    dsCrystal.Tables[0].TableName = "evtViolations";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Fuel Consumption While Speeding Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtViolationsFuel.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = VolumeUnit;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["VolumeUnit"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtViolations", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtViolationFuel_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtViolationFuel_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Violation Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtViolationFuel_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtViolationFuel_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int MaintenanceSpecialReport(Int32 UserID, string SID, int fleetId, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> MaintenanceSpecialReport(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstMaintenanceSpecialReport.xsd"));
                string ConnnectionString = LoginManager.GetConnnectionString(UserID);

                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.MaintenanceSpecialReport(fleetId, UserID);
                    dsCrystal.Tables[0].TableName = "MaintenanceSpecial";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Maintenance Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Violation Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptMaintenanceSpecial.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();




                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                //GetUserPreferences(UserID);

                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_MaintenanceStatus", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("Maintenance Status Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< Maintenance Status Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Maintenance Status Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("Maintenance StatusReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< Maintenance Status Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int evtFactEvents_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtFactEvents_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEvents.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtFactEvents_Report(fleetId, fromDate, toDate, UserID);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "FactEvents Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("FactEvents Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtIdling.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

	
		   crParameterDiscreteValue.Value ="(Idling Threshold: All)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["idlingHrs"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);




                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtIdling", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtFactEvents_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtFactEvents_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "evtFactEvents_Report Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtFactEvents_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtFactEvents_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int evtFactEventsByIdling_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, Int16 idlingHrs, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtFactEventsByIdling_Report(uId={0}",
                                  UserID);


                //Int16 sensorNum = 0;

                ////using (VLF.CLS.Json json = new Json(xmlParams, ';', '='))
                ////{
                ////    sensorNum = Convert.ToInt16(json[ReportTemplate.RptParamSensorId]);
                ////}

                //sensorNum = Convert.ToInt16(Util.PairFindValue(ReportTemplate.RptParamSensorId, xmlParams));



                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("evtFactEvents.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtFactEvents_Report(fleetId, fromDate, toDate, idlingHrs, UserID);
                    dsCrystal.Tables[0].TableName = "FactEvents";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Idling Details Report by Idling Threshold doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("FactEvents Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtIdling.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = idlingHrs.ToString() == "-1" ? "(Idling Threshold: All)" : "(Idling Threshold: More than: " + idlingHrs.ToString() + " hrs)";
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["idlingHrs"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtIdling", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtFactEventsByIdling_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtFactEventsByIdling_Report(uId={0})",
                                  UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "evtFactEventsByIdling_Report Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtFactEventsByIdling_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtFactEventsByIdling_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod(Description = "")]
        public int OrganizationHistoryDateRangeValidation(int userId, string SID, string from, string to, ref string xml)
        {
            try
            {

                DataSet dsInfo = null;
                string ConnnectionString = GetConnectionStringByDateRange(userId, DateTime.Now.Date.AddDays(-1), DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsInfo = rpt.OrganizationHistoryDateRangeValidation(userId, Convert.ToDateTime(from), Convert.ToDateTime(to));
                }
                if (Util.IsDataSetValid(dsInfo))
                    xml = dsInfo.GetXml();

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                LogException("<< OrganizationHistoryDateRangeValidation : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        private void GetExtendedUnnecessaryIdlingFuelCostsReport(Int32 UserID, string SID, int FleetId, Single Cost, string FromDate, int rFormat, string lang, int ReportGuId, ref string ReportPath)
        {
            // Authenticate 
            LoginManager.GetInstance().SecurityCheck(UserID, SID);

            TimeSpan currDuration;

            GetUserPreferences(UserID);

            DataSet dsCrystal = new DataSet();

            dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstExtendedMonthlySummary.xsd"));
            //string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), DateTime.Now);
            string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["CNReportsConnectionString"].ConnectionString;
            using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
            {
                dsCrystal = rpt.GetCNGetMonthlyFleetSummary(FleetId, Convert.ToDateTime(FromDate));
                dsCrystal.Tables[0].TableName = "rpt_ExtendedMonthlySummary";
            }


            if (!Util.IsDataSetValid(dsCrystal))
                ReportPath = "";

            ReportDocument oRpt = new ReportDocument();

            DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
            oRpt.Load(this.GetReportPath("rpt_ExtendedMonthlyUnnecessaryIdlingFuelCost.rpt"));
            oRpt.SetDataSource(dsCrystal);

            ParameterFieldDefinitions crParameterFieldDefinitions;
            ParameterFieldDefinition crParameterFieldDefinition;
            ParameterValues crParameterValues = new ParameterValues();
            ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

            crParameterDiscreteValue.Value = Cost;
            crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
            crParameterFieldDefinition = crParameterFieldDefinitions["Cost"];
            crParameterValues = crParameterFieldDefinition.CurrentValues;
            crParameterValues.Add(crParameterDiscreteValue);
            crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


            string fileExt = "";
            switch (rFormat)
            {
                case 1:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                    fileExt = ".pdf";
                    break;
                case 2:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                    fileExt = ".xls";
                    break;
                case 3:
                    oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                    fileExt = ".doc";
                    break;
            }
            string ReportName = this.GetReportName("ExtendedMonthlyUtilization", fileExt);

            oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
            diskOpt.DiskFileName = this.GetOutputPath(ReportName);
            oRpt.ExportOptions.DestinationOptions = diskOpt;
            oRpt.Export();
            oRpt.Close();

            ReportPath = this.GetReportURL(ReportName);
        }







        private static void ExportToHTML(ReportDocument oRpt, string fileName, string outputPath, bool seperatePages, bool pageNavigator)
        {
            HTMLFormatOptions htmlOpts = ExportOptions.CreateHTMLFormatOptions();
            DiskFileDestinationOptions diskOpts = ExportOptions.CreateDiskFileDestinationOptions();
            ExportOptions exportOpts = new ExportOptions();

            htmlOpts.HTMLFileName = fileName;
            htmlOpts.HTMLEnableSeparatedPages = seperatePages;
            htmlOpts.HTMLHasPageNavigator = pageNavigator;
            htmlOpts.HTMLBaseFolderName = HttpContext.Current.Server.MapPath(outputPath);
            exportOpts.ExportFormatOptions = htmlOpts;

            diskOpts.DiskFileName = fileName;
            exportOpts.ExportDestinationOptions = diskOpts;

            exportOpts.ExportDestinationType = ExportDestinationType.DiskFile;
            exportOpts.ExportFormatType = ExportFormatType.HTML40;

            oRpt.Export(exportOpts);
        }

        private void UpdateReportStatus(Int64 ReportRepositoryId, string Msg, string Path)
        {

            //Creating Message file in case of error   
            if (Msg != "" && Path == "")
            {
                ReportDocument oRpt = new ReportDocument();
                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_Message.rpt"));
                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = Msg;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["Message"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);
                oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                string fileExt = ".pdf";
                string ReportName = this.GetReportName("Message", fileExt);
                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                Path = this.GetReportURL(ReportName);
            }




            int rowsAffected = 0;
            VLF.DAS.SQLExecuter sqlExec = new VLF.DAS.SQLExecuter(ConfigurationManager.ConnectionStrings["ActiveStateConnectionString"].ConnectionString);
            sqlExec.ClearCommandParameters();
            sqlExec.AddCommandParam("@ReportRepositoryId", SqlDbType.BigInt, ReportRepositoryId);
            sqlExec.AddCommandParam("@Path", SqlDbType.VarChar, Path);
            rowsAffected = sqlExec.SPExecuteNonQuery("UpdateReportRepositoryStatus");




        }


        private static bool IsNumeric(String str)
        {
            try
            {
                Double.Parse(str, System.Globalization.NumberStyles.Any);
                return true;
            }
            catch
            {
                return false;
            }
        }



        [WebMethod]
        public int AlarmsWithNotesReport(Int32 UserID, string SID, string FromDate, string ToDate, string xmlParams, int rFormat, string lang, ref string ReportPath, ref bool requestOverflowed, ref bool outMaxOverflowed)
        {
            try
            {
                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);
                Log("-->AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstAlarmReport.xsd"));
                //StringReader strrXML = null;

                DataSet dsAlarms = GetAlarams(UserID, xmlParams, lang, ref RequestOverflowed, ref outMaxOverflowed);

                if (!Util.IsDataSetValid(dsAlarms))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("UpdateReportStatus-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }

                string LicensePlate = Util.PairFindValue(ReportTemplate.RpAlarmFirstParamName, xmlParams);

                DataSet dsVehicle = null;
                string ConnnectionString = GetConnectionStringByDateRange(UserID, Convert.ToDateTime(FromDate), DateTime.Now);
                using (VLF.DAS.Logic.Vehicle dbVehicle = new VLF.DAS.Logic.Vehicle(ConnnectionString))
                {
                    dsVehicle = dbVehicle.GetVehicleInfoByLicensePlate(LicensePlate);
                }

                if (Util.IsDataSetValid(dsVehicle))
                    //CopyRows(dsVehicle.Tables[0], dsCrystal.Tables["rpt_VechicleInfo"]);
                    dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsVehicle.Tables[0], false, MissingSchemaAction.Ignore);


                // Alarm Severity Name 
                DataColumn dc = new DataColumn();
                dc.ColumnName = "AlarmTypeMsg";
                dc.DataType = Type.GetType("System.String");
                dc.DefaultValue = false;
                dsAlarms.Tables[0].Columns.Add(dc);


                foreach (DataRow rowItem in dsAlarms.Tables[0].Rows)
                {
                    if (Convert.ToInt16(rowItem["AlarmType"]) == 18)
                        rowItem["AlarmTypeMsg"] = "Alarm";
                    else if (Convert.ToInt16(rowItem["AlarmType"]) == 2)
                        rowItem["AlarmTypeMsg"] = "Sensor";
                    else
                        rowItem["AlarmTypeMsg"] = "Message";
                }

                //CopyRows(dsAlarms.Tables[0], dsCrystal.Tables["rpt_AlarmReport"]);
                dsCrystal.Tables["rpt_AlarmReport"].Merge(dsAlarms.Tables[0], false, MissingSchemaAction.Ignore);

                LocalizeAddress(lang, ref dsCrystal);

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_AlarmsWithNotes.rpt"));

                oRpt.SetDataSource(dsCrystal);

                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Alarms)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(FromDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(ToDate, lang);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                string fileExt = "";
                string ReportName = "";

                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;

                    case 4:
                        fileExt = ".htm";
                        ReportName = this.GetReportName("rptAlarmData", fileExt);
                        ExportToHTML(oRpt, ReportName, this.ReportsOutputPath, false, false);
                        ReportName = "rpt_Alarms" + "/" + ReportName;
                        if (IsNumeric(ReportPath))
                        {
                            try
                            {
                                if (ReportName.Trim() != "")
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                                else
                                    UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                            }
                            catch (Exception Ex)
                            {
                                Log("UpdateReportStatus-->" + Ex.Message.ToString());
                            }
                        }
                        ReportPath = this.GetReportURL(ReportName);
                        Log("<--AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                        return (int)InterfaceError.NoError;
                }
                ReportName = this.GetReportName("rptAlarmData", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<--AlarmsReport( userId = {0}, fromDate = {1}, toDate={2},xmlParams={3} )", UserID, FromDate, ToDate, xmlParams);
                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Alarms Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int GetHOSSummaryReport(int userId, string SID, int driverId, DateTime from, DateTime to, int rFormat, string lang, int ReportGuId, ref string ReportPath)
        {

            try
            {


                Log(">> GetHOSSummaryReport(uId={0}, dtFrom={1}, dtTo={2},driverId={3})",
                                   userId, from, to, driverId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);

                TimeSpan currDuration;

                GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstHOSSummaryReport.xsd"));


                string ConnnectionString = ConfigurationManager.AppSettings["HOSConnectionString"];
                using (DriverManager driver = new DriverManager(ConnnectionString))
                {
                    dsCrystal = driver.GetHOSSummarybyDateTime(driverId, from, to);
                    dsCrystal.Tables[0].TableName = "HOSSummary";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rpt_HOSSummaryReport.rpt"));
                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                //crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                //crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                //crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                //crParameterValues = crParameterFieldDefinition.CurrentValues;
                //crParameterValues.Add(crParameterDiscreteValue);
                //crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = GetDriverFullName(userId, driverId);
                crParameterFieldDefinition = crParameterFieldDefinitions["DriverName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("HOSSummaryReport", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();

                if (rFormat == 2)
                {
                    ManipulateExcelFile(diskOpt.DiskFileName, "HOSSummaryPerDriver");
                }

                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("UpdateReportStatus-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GetHOSSummaryReport(uId={0}, driverId={1})",
                            userId, driverId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "HOS Summary Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("UpdateReportStatus-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GetHOSSummaryReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int GarminMessagesReport(int userId, string SID, int fleetId, string from, string to, int rFormat, string lang, ref string ReportPath)
        {

            try
            {


                Log(">> GarminMessagesReport(uId={0})",
                                   userId);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(userId, SID);



                TimeSpan currDuration;

                //GetUserPreferences(userId);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstGarminReport.xsd"));

                GetUserPreferences(userId);

                string ConnnectionString = GetConnectionStringByDateRange(userId, Convert.ToDateTime(from), DateTime.Now);
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GarminMessages_Report(fleetId, Convert.ToDateTime(from), Convert.ToDateTime(to), userId);
                    dsCrystal.Tables[0].TableName = "Table";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                    ReportPath = "";

                ReportDocument oRpt = new ReportDocument();

                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();
                oRpt.Load(this.GetReportPath("rptGarminReport.rpt"));


                oRpt.SetDataSource(dsCrystal);
                LocalizeTextObject(ref oRpt, new ResourceManager(typeof(Resources.Report_Garmin)), lang);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();


                crParameterDiscreteValue.Value = GetFleetName(userId, fleetId);
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = from;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = to;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("GarminMessage", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("GarminMessagesReport-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);
                Log("<<GarminMessagesReport(uId={0})",
                            userId);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Garmin Messages Report", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("GarminMessagesReport-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< GarminMessagesReport : uid={0}, EXC={1}", userId, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        private string GetConnectionStringByDateRange(int userId, DateTime from, DateTime to)
        {
            string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

            //if ((Convert.ToDateTime(Convert.ToDateTime(from).ToShortDateString()) == Convert.ToDateTime(Convert.ToDateTime(DateTime.Now).ToShortDateString()))
            //    || ((Convert.ToDateTime(Convert.ToDateTime(to).ToShortDateString()) == Convert.ToDateTime(Convert.ToDateTime(DateTime.Now).ToShortDateString()))) || (to > DateTime.Now))
            //    ConnnectionString = LoginManager.GetConnnectionString(userId);

            return ConnnectionString;
        }


        [WebMethod]
        public int OnOffRoadMiles_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> RoadMiles_Report(uId={0})", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstOnOffRoadMiles.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetOnOffRoadMilesReport(UserID, fleetId, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "rtp_OnOffRoadMiles";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "On/Off Road Mile Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("On/Off Road Miles Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_OnOffRoadMiles.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("OnOffRoadMiles", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(">> On/Off RoadMiles_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log(">> On/Off RoadMiles_Report(uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "On/Off RoadMiles_Report Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("On/Off RoadMiles_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< On/Off_RoadMiles_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        [WebMethod]
        public int OnOffRoadMiles_Report_Hierarchy(Int32 UserID, string SID, string NodeCode, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> OnOffRoadMiles_Report_Hierarchy(uId={0})", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstOnOffRoadMiles.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetOnOffRoadMilesReport(UserID, NodeCode, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "rtp_OnOffRoadMiles";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "On/Off Road Mile Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("On/Off Road Miles Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_OnOffRoadMiles.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = NodeCode;

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("OnOffRoadMiles", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(">> On/Off RoadMiles_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log(">> On/Off RoadMiles_Report(uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "On/Off RoadMiles_Report Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("On/Off RoadMiles_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< On/Off_RoadMiles_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }



        [WebMethod]
        public int SpeedDistributionReport  (Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> SpeedDistributionReport(uId={0})", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSpeedDistribution.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSpeedDistributionReport(UserID, fleetId, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "SpeedDistribution";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "SpeedDistributionReport Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("SpeedDistributionReport Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_SpeedDistribution.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("SpeedDistribution", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(">> On/Off RoadMiles_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log(">>SpeedDistribution (uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Speed Distribution Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("Speed Distribution Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< Speed Distribution : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }





        [WebMethod]
        public int ReportBoxGeozone(Int32 UserID, string SID,  int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> ReportBoxGeozone(uId={0})", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

              

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("BoxGeozone.xsd"));
                string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(-1), System.DateTime.Now);
                //string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.ReportBoxGeozone(UserID);
                    dsCrystal.Tables[0].TableName = "rpt_BoxGeozone";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "ReportBoxGeozone", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("ReportBoxGeozone Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rptBoxGeozone.rpt"));

                oRpt.SetDataSource(dsCrystal);



                GetUserPreferences(UserID);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

               







                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("SpeedDistribution", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(">> On/Off RoadMiles_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log(">>ReportBoxGeozone (uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "ReportBoxGeozone", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("ReportBoxGeozone->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< ReportBoxGeozone : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int SpeedDistributionReport_Hierarchy(Int32 UserID, string SID, string nodeCode, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> SpeedDistributionReport_Hierarchy(uId={0})", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstSpeedDistribution.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.GetSpeedDistributionReport_Hierarchy(UserID, nodeCode, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "SpeedDistribution";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "SpeedDistributionReport Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("SpeedDistributionReport_Hierarchy Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("rpt_SpeedDistribution.rpt"));

                oRpt.SetDataSource(dsCrystal);



                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = nodeCode;

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);





                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("SpeedDistribution", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log(">> On/Off RoadMiles_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log(">>SpeedDistributionReport_Hierarchy (uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "Speed Distribution Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("SpeedDistributionReport_Hierarchy Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< SpeedDistributionReport_Hierarchy : uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }


        [WebMethod]
        public int evtOverTimeDurationInLandmark_Report(Int32 UserID, string SID, int fleetId, DateTime fromDate, DateTime toDate, int rFormat, string lang, ref string ReportPath)
        {
            try
            {

                Log(">> evtOverTimeDurationInLandmark_Report(uId={0}", UserID);

                // Authenticate 
                LoginManager.GetInstance().SecurityCheck(UserID, SID);

                TimeSpan currDuration;

                GetUserPreferences(UserID);

                DataSet dsCrystal = new DataSet();

                dsCrystal.ReadXmlSchema(this.GetDataSetPath("dstOvertimeDurationInLandmarkReport.xsd"));
                //string ConnnectionString = GetConnectionStringByDateRange(UserID, System.DateTime.Now.AddHours(Hours), System.DateTime.Now);
                string ConnnectionString = ConfigurationManager.ConnectionStrings["DWH"].ConnectionString;
                using (VLF.DAS.Logic.Report rpt = new VLF.DAS.Logic.Report(ConnnectionString))
                {
                    dsCrystal = rpt.evtOverTimeDurationInLandmark(UserID, fleetId, fromDate, toDate);
                    dsCrystal.Tables[0].TableName = "evtOvertimeDuration";
                }


                if (!Util.IsDataSetValid(dsCrystal))
                {
                    if (IsNumeric(ReportPath))
                    {
                        try
                        {
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "Overtime Duration Report doesn't contain any data", "");
                        }
                        catch (Exception Ex)
                        {
                            Log("Overtime Duration Report Status-->" + Ex.Message.ToString());
                        }
                    }
                    ReportPath = "";
                    return (int)InterfaceError.NoError;
                }



                ReportDocument oRpt = new ReportDocument();


                DiskFileDestinationOptions diskOpt = new DiskFileDestinationOptions();

                oRpt.Load(this.GetReportPath("evtOverTimeDurationInLandmark.rpt"));

                oRpt.SetDataSource(dsCrystal);

                ParameterFieldDefinitions crParameterFieldDefinitions;
                ParameterFieldDefinition crParameterFieldDefinition;
                ParameterValues crParameterValues = new ParameterValues();
                ParameterDiscreteValue crParameterDiscreteValue = new ParameterDiscreteValue();

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(fromDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FromDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);

                crParameterDiscreteValue.Value = FormatDateTimeByLanguage(toDate, lang).ToString();
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["ToDate"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                crParameterDiscreteValue.Value = GetFleetName(UserID, fleetId);

                //            if (lang == "fr" && lang != null)
                if (ASIErrorCheck.IsLangSupported(lang))
                {
                    Resources.Const.Culture = new System.Globalization.CultureInfo(lang);
                    crParameterDiscreteValue.Value = crParameterDiscreteValue.Value.ToString().Replace(VLF.CLS.Def.Const.defaultFleetName, Resources.Const.defaultFleetName);
                }

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["FleetName"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                GetUserPreferences(UserID);

                crParameterDiscreteValue.Value = "GMT" + UserTimeZone;
                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["UserTimeZone"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);


                crParameterDiscreteValue.Value = (rFormat == 2) ? "True" : "False";

                crParameterFieldDefinitions = oRpt.DataDefinition.ParameterFields;
                crParameterFieldDefinition = crParameterFieldDefinitions["IsExcel"];
                crParameterValues = crParameterFieldDefinition.CurrentValues;
                crParameterValues.Add(crParameterDiscreteValue);
                crParameterFieldDefinition.ApplyCurrentValues(crParameterValues);



                string fileExt = "";
                switch (rFormat)
                {
                    case 1:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.PortableDocFormat;
                        fileExt = ".pdf";
                        break;
                    case 2:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.ExcelRecord;
                        fileExt = ".xls";
                        break;
                    case 3:
                        oRpt.ExportOptions.ExportFormatType = ExportFormatType.WordForWindows;
                        fileExt = ".doc";
                        break;
                }
                string ReportName = this.GetReportName("rpt_evtOverTimeDuration", fileExt);

                oRpt.ExportOptions.ExportDestinationType = ExportDestinationType.DiskFile;
                diskOpt.DiskFileName = this.GetOutputPath(ReportName);
                oRpt.ExportOptions.DestinationOptions = diskOpt;
                oRpt.Export();
                oRpt.Close();
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        if (ReportName.Trim() != "")
                            UpdateReportStatus(Convert.ToInt64(ReportPath), Msg, this.GetReportURL(ReportName));
                        else
                            UpdateReportStatus(Convert.ToInt64(ReportPath), "No data matching the selected criteria", "");
                    }
                    catch (Exception Ex)
                    {
                        Log("evtOverTimeDurationInLandmark_Report-->" + Ex.Message.ToString());
                    }
                }
                ReportPath = this.GetReportURL(ReportName);

                Log("<< evtOverTimeDurationInLandmark_Report(uId={0})", UserID);

                return (int)InterfaceError.NoError;
            }
            catch (Exception Ex)
            {
                if (IsNumeric(ReportPath))
                {
                    try
                    {
                        UpdateReportStatus(Convert.ToInt64(ReportPath), "OverTime Duration InLandmark Report failed", "");
                    }
                    catch (Exception Ex1)
                    {
                        Log("evtOverTimeDurationInLandmark_Report Report-->" + Ex1.Message.ToString());
                    }
                }
                LogException("<< evtOverTimeDurationInLandmark_Report Report: uId={0}, EXC={1}", UserID, Ex.Message);
                return (int)ASIErrorCheck.CheckError(Ex);
            }
        }




        private Int32 GetOrganizationIdByUserId(Int32 userId)
        {

            string ConnnectionString = ConfigurationManager.ConnectionStrings["DBConnectionString"].ConnectionString;
            Int32 OrganizationId = -1;
            DataSet ds = new DataSet();


            using (VLF.DAS.Logic.User lg = new VLF.DAS.Logic.User(ConnnectionString))
            {

                ds = lg.GetUserInfoById(userId);

                if (Util.IsDataSetValid(ds))
                {
                    OrganizationId =Convert.ToInt32(ds.Tables[0].Rows[0]["OrganizationId"]);   
                }
            }

            return OrganizationId;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="Value"></param>
        /// <param name="Language"></param>
        /// <returns></returns>
        public string FormatDateTimeByLanguage(string Value, string Language)
        {
            string dt = Value;
            string err = "";
            string format = ((Language.ToLower().IndexOf("fr") >= 0) ? "dd/MM/yyyy HH:mm:ss" : "MM/dd/yyyy hh:mm:ss tt");

            try
            {
                dt = Convert.ToDateTime(Value, new CultureInfo("en-US")).ToString(format);
            }
            catch (FormatException fx)
            {
                err = fx.Message;
            }
            catch (Exception ex)
            {
                err = ex.Message;
            }
            finally
            {
            }
            return dt;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="Value"></param>
        /// <param name="Language"></param>
        /// <returns></returns>
        public string FormatDateTimeByLanguage(DateTime Value, string Language)
        {
            string dt = "";
            string err = "";
            string format = ((Language.ToLower().IndexOf("fr") >= 0) ? "dd/MM/yyyy HH:mm:ss" : "MM/dd/yyyy hh:mm:ss tt");

            try
            {
                dt = Value.ToString(format);
            }
            catch (Exception ex)
            {
                err = ex.Message;
                dt = Value.ToString("MM/dd/yyyy hh:mm:ss tt");
            }
            finally
            {
            }
            return dt;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="userid"></param>
        /// <param name="preference"></param>
        /// <returns></returns>
        private string getUserPreference(int userid, int preference)
        {
            string defvalue = "";

            switch (preference) { 
                case 0:         //	MeasurementUnits
                    defvalue = "1";
                    break;
                case 1:         //	TimeZone	
                    defvalue = "0";
                    break;

                //case 2:           // DefaultFleet	
                //case 3:           // DefaultLatitude	
                //case 4:           // DefaultLongitude	
                //5	DefaultZoomLevel	
                //6	ResolveLandmark	
                case 7:             //	DayLightSaving	
                    defvalue = "0";
                    break;
                //8	MapOptShowVehicleName	
                //9	MapOptShowLandmark	
                //10	MapOptShowLandmarkName	
                //11	MapOptShowBreadCrumbTrail	
                //12	MapOptShowStopSequenceNo	
                //13	ShowReadMessages	
                //14	AlarmRefreshFrequency	
                //15	GeneralRefreshFrequency	
                //16	PositionExpiredTime	
                //17	AutoAdjustDayLightSaving	
                //18	MapGridDefaultRows	 
                //19	HistoryGridDefaultRows	 
                //20	ViewMDTMessagesScrolling	 
                //21	ShowMapGridFilter	 
                //22	DefaultMapId	 
                //23	MapOptShowGeoZone	
                //24	MapOptShowLandmarkRadius	 
                case 25:            //	VolumeUnits	 
                    defvalue = "1";
                    break;
                //26	ViewAlarmMessagesScrolling	 
                //27	MetricSystem	 
                //28	TimeZoneId	NULL
                //29	MapAssets	
                //30	MaxVehiclesOnMap	
                //31	DefaultMapView	
                //32	VehicleClustering	
                //33	VehicleClusteringDistance	
                //34	VehicleClusteringThreshold	
                //35	DefaultOrganizationHierarchyNodeCode	
                //36	LoadVehiclesBasedOn	
                case 37:            //	DefaultLanguage	 
                    defvalue = "en-US";
                    break;
                default:
                    defvalue = "";
                    break;
            }

            return getUserPreference(userid, preference, defvalue);

        }


        private DataSet GetViolationInfo_NewSafetyMatrix_WithoutRail(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string lang, int speed, string extraParams, ref DataSet dsCrystal)
        {
            try
            {
                ////DataSet dsFleet = new DataSet();
                //string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
                string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

                // string ConnnectionString = LoginManager.GetConnnectionString(userId);
                ////using (Fleet dbf = new Fleet(ConnnectionString))
                ////{
                ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
                ////}


                //  dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


                string xml = "";
                Int32 orgId = GetOrganizationIdByUserId(userId);

                using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
                {
                    xml = dbReport.GetViolationReportForFleetByLang_NewSafetyMatrix(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed, extraParams);
                }

                if (String.IsNullOrEmpty(xml))
                    return null;

                DataSet ds = new DataSet();
                ds.ReadXml(new StringReader(xml));

                if (!Util.IsDataSetValid(ds))
                    return null;

                //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

                dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

                return dsCrystal;
            }
            catch (Exception Ex)
            {
                return null;
            }
        }




    private DataSet GetViolationInfo_NewSafetyMatrix(Int32 userId, Int32 fleetId, Int32 maskViolations, DateTime dtFrom, DateTime dtTo, string lang, int speed,string extraParams, ref DataSet dsCrystal)
    {
        try
        {
            ////DataSet dsFleet = new DataSet();
            //string ConnnectionString = GetConnectionStringByDateRange(userId, dtFrom, dtTo);
            string ConnnectionString = System.Web.Configuration.WebConfigurationManager.ConnectionStrings["DBReportConnectionString"].ConnectionString;

            // string ConnnectionString = LoginManager.GetConnnectionString(userId);
            ////using (Fleet dbf = new Fleet(ConnnectionString))
            ////{
            ////    dsFleet = dbf.GetVehiclesInfoByFleetId(fleetId);
            ////}


            //  dsCrystal.Tables["rpt_VechicleInfo"].Merge(dsFleet.Tables[0], false, MissingSchemaAction.Ignore);


            string xml = "";
            Int32 orgId = GetOrganizationIdByUserId(userId);

            using (ReportGenerator dbReport = new ReportGenerator(ConnnectionString))
            {
                xml = dbReport.GetViolationReportForFleetByLang_Exteneded_NewSafetyMatrix(fleetId, userId, maskViolations, dtFrom, dtTo, lang, speed, extraParams);
            }

            if (String.IsNullOrEmpty(xml))
                return null;

            DataSet ds = new DataSet();
            ds.ReadXml(new StringReader(xml));

            if (!Util.IsDataSetValid(ds))
                return null;

            //CopyRows(ds.Tables[0], dsCrystal.Tables["rpt_ViolationReport"]);

            dsCrystal.Tables["rpt_ViolationReport"].Merge(ds.Tables[0], false, MissingSchemaAction.Ignore);

            return dsCrystal;
        }
        catch (Exception Ex)
        {
            return null;
        }
    }


  




        /// <summary>
        /// 
        /// </summary>
        /// <param name="userid"></param>
        /// <param name="preference"></param>
        /// <param name="defvalue"></param>
        /// <returns></returns>
        private string getUserPreference(int userid, int preference, string defvalue)
        {
            string value = defvalue;

            try
            {
                string constr = ConfigurationManager.ConnectionStrings["DBConnectionString"].ToString();
                string query = "select preferencevalue from vlfUserPreference where userid = " + userid + " and preferenceid = " + preference;

                using (SqlConnection con = new SqlConnection(constr))
                {
                    con.Open();

                    using (SqlCommand com = new SqlCommand(query, con))
                    {
                        com.CommandType = CommandType.Text;
                        value = com.ExecuteScalar().ToString();
                    }
                }
            }
            catch
            {
            }
            finally {
                if (string.IsNullOrEmpty(value))
                    value = defvalue;
            }

            return value;
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="dt"></param>
        /// <param name="SortFormula"></param>
        /// <returns></returns>
        private DataTable DataTableSorting(DataTable dt, string SortFormula)
        {
            DataView dv = new DataView(dt);
            dv.Sort = SortFormula;
            dv.Table.AcceptChanges(); 
            return dv.ToTable(); 
        }

        /// <summary>
        /// 
        /// </summary>
        /// <param name="dt"></param>
        /// <param name="FieldName"></param>
        /// <param name="Direction"></param>
        /// <returns></returns>
        private DataTable DataTableSorting(DataTable dt, string FieldName, string Direction) 
        {
            return DataTableSorting(dt, FieldName + " " + Direction);        
        }
    }
}


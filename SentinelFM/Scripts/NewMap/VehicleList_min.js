Ext.Loader.setConfig({enabled:true});Ext.Loader.setPath("Ext.ux","./ExtJS/src/ux");Ext.require(["Ext.window.*","Ext.ux.grid.FiltersFeature","Ext.ux.AspWebAjaxProxy"]);Ext.onReady(function(){Ext.tip.QuickTipManager.init();Ext.state.Manager.setProvider(Ext.create("Ext.state.CookieProvider"));var LoadStates={GridLoading:0,MapLoading:1,AlarmLoading:2,FleetsLoading:3,MainStoreLoading:4,GettingUpdates:5,GettingAlarmUpdates:6,MappingVehicles:7,MainStoreLoaded:8,AlarmsLoaded:9};var pagesize=10000,lastProxyFinished=false,mapLoading=false;var wincounter=0,proxyTimeOut=120000;var fleetDefaultText="All Vehicles...",taskRunning=false;var mapHTML='<iframe scrolling="no" src="./MapNew/OpenLayerMaps.aspx"';var mapStyle='style="Height:100%; width:100%;  border:0;margin:0px"';var mapframe="nmapframe",alarminterval=5000;var nframeadded=false,sframeadded=false,eframeadded=false;var dateformat="d/m/Y h:i a",soundPresent=false;var historyPage="./History/frmhistmain_new.aspx?VehicleId=";Ext.define("VehicleList",{extend:"Ext.data.Model",fields:["BoxId","Description","StreetAddress",{name:"OriginDateTime",type:"date",dateFormat:"c"},{name:"convertedDate",type:"date",defaultValue:"",convert:function(value,record){var localDateStr,dt,currentDate;localDateStr=record.get("OriginDateTime").toLocaleString();dt=Ext.Date.parse(localDateStr,"F-d-y g:i:s A");if(dt==undefined){currentDate=record.get("OriginDateTime");dt=new Date(currentDate)}return dt}},{name:"convertedDisplayDate",convert:function(value,record){var currentDate=record.get("OriginDateTime");var dt=new Date(currentDate);var newDt=Ext.Date.format(dt,dateformat);return newDt}},"Speed","BoxArmed","VehicleStatus","PTO","History","VehicleId","LicensePlate",{name:"Latitude",type:"float"},{name:"Longitude",type:"float"},"IconTypeName",{name:"CustomSpeed",type:"int"},"MyHeading","icon"],idProperty:"BoxId"});Ext.define("FleetList",{extend:"Ext.data.Model",fields:["OrganizationName","FleetId","FleetName","Description","IconTypeName","MyHeading"]});var template='<span style="color:{0};">{1}</span>';var selModel=Ext.create("Ext.selection.CheckboxModel",{listeners:{selectionchange:function(selModel,selections){try{vehiclegrid.down("#mapitButton").setDisabled(selections.length==0);vehiclegrid.down("#trackitButton").setDisabled(selections.length==0);vehiclegrid.down("#streetViewButton").setDisabled(selections.length==0);vehiclegrid.down("#streetView2Button").setDisabled(selections.length==0);vehiclegrid.down("#updatePositionButton").setDisabled(selections.length==0)}catch(err){}}}});function mapVehicles(map,vehiclesData,isInitial,zoomVehicles){try{if(map==true){if(zoomVehicles){mapSelecteds(vehiclesData,mapframe)}else{if(isInitial){ShowMapFrameData(vehiclesData,true,mapframe)}else{ShowMapFrameData(vehiclesData,false,mapframe)}}}}catch(err){mapLoading=false}}Ext.define("UpdatePositonData",{extend:"Ext.data.Model",fields:["mesg"]});function onUpdatePositionReceived(operation){try{var data=Ext.decode(operation.response.responseText);if(data.d!="-1"&&data.d!="0"){var retData;if(data.d){retData=eval(data.d);Ext.MessageBox.show({title:"UpdatePosition Command Status",msg:retData,buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.INFO})}}}catch(err){}}var mapit=Ext.create("Ext.Button",{text:"FindIt",id:"mapitButton",tooltip:"Find selected vehicle on map",iconCls:"map",cls:"cmbfonts",textAlign:"left",disabled:true,handler:function(){try{mapLoading=true;var currentTicked=vehiclegrid.getSelectionModel().getSelection();if(currentTicked.length>0){var selectedBoxs=new Array();Ext.each(currentTicked,function(selectedRec,i){selectedBoxs.push(selectedRec.data)});if(selectedBoxs.length>0){mapSelecteds(selectedBoxs,mapframe)}}mapLoading=false}catch(err){mapLoading=false}}});var updatePosition=Ext.create("Ext.Button",{text:"Update Position",id:"updatePositionButton",tooltip:"Map selected vehicle on map",iconCls:"map",cls:"cmbfonts",textAlign:"left",disabled:true,handler:function(){try{var currentTicked=vehiclegrid.getSelectionModel().getSelection();var selectedBoxs="";Ext.each(currentTicked,function(selectedRec,i){selectedBoxs=selectedBoxs+","+selectedRec.data.BoxId+","});var mapstore=new Ext.data.Store({proxy:new Ext.ux.AspWebAjaxProxy({url:"./Vehicles.aspx/UpdatePosition",timeout:proxyTimeOut,actionMethods:{create:"POST",destroy:"DELETE",read:"POST",update:"POST"},extraParams:{boxIDs:selectedBoxs},reader:{type:"json",model:"UpdatePositonData"},headers:{"Content-Type":"application/json; charset=utf-8"}})});var operation=new Ext.data.Operation({action:"read"});mapstore.proxy.read(operation,onUpdatePositionReceived,mapstore)}catch(err){}}});var feedback=Ext.create("Ext.Button",{text:"Feedback",id:"feedbackButton",tooltip:"Want to improve our map please provide feedback..",iconCls:"map",cls:"cmbfonts",textAlign:"left",handler:function(){try{var feedbackURL="./Feedback.aspx";var urlToLoad='<iframe width="100%" height="100%" frameborder="0" scrolling="no" src="'+feedbackURL+'"></iframe>';openWindow("BSM Beta map feedback",urlToLoad,720,360)}catch(err){}}});function openWindow(wintitle,winURL,winWidth,winHeight){var win=new Ext.Window({title:wintitle,width:winWidth,height:winHeight,layout:"fit",maxWidth:window.screen.width,maxHeight:window.screen.height,maximizable:"true",minimizable:"true",resizable:"true",closable:true,border:false,html:winURL});win.show()}var streetView=Ext.create("Ext.Button",{text:"Street view",id:"streetViewButton",tooltip:"Google street view",iconCls:"map",cls:"cmbfonts",textAlign:"left",disabled:true,handler:function(){try{var currentTicked=vehiclegrid.getSelectionModel().getSelection();if(currentTicked.length>1){Ext.MessageBox.alert("Streetview"," Please select only 1 vehicle for street view.")}else{var selectedBoxs=new Array();Ext.each(currentTicked,function(selectedRec,i){selectedBoxs.push(selectedRec.data)});var winurl="./StreetView.aspx?WinId="+wincounter;var htmlNewWin='<iframe width="100%" height="100%" frameborder="0" scrolling="no" src="'+winurl+'"></iframe>';SetWinTrackData2(selectedBoxs);openWindow("Street view",htmlNewWin,1000,480);wincounter++}}catch(err){}}});var streetView2=Ext.create("Ext.Button",{text:"Google Street view",id:"streetView2Button",tooltip:"Google street view",iconCls:"map",cls:"cmbfonts",textAlign:"left",disabled:true,handler:function(){try{var currentTicked=vehiclegrid.getSelectionModel().getSelection();if(currentTicked.length>1){Ext.MessageBox.alert("Streetview"," Please select only 1 vehicle for street view.")}else{var selectedBoxs=new Array();Ext.each(currentTicked,function(selectedRec,i){selectedBoxs.push(selectedRec.data)});var winurl="./StreetView2.aspx?WinId="+wincounter;var htmlNewWin='<iframe width="100%" height="100%" frameborder="0" scrolling="no" src="'+winurl+'"></iframe>';SetWinTrackData2(selectedBoxs);openWindow("Street view",htmlNewWin,830,380);wincounter++}}catch(err){}}});var trackit=Ext.create("Ext.Button",{text:"TrackIt",id:"trackitButton",tooltip:"Track selected vehicle on separate map",iconCls:"map",cls:"cmbfonts",textAlign:"left",disabled:true,handler:function(){try{var currentTicked=vehiclegrid.getSelectionModel().getSelection();var selectedBoxs=new Array();Ext.each(currentTicked,function(selectedRec,i){var newIcon="";var today=new Date();var posExpireDate=new Date();posExpireDate.setTime(today.getTime()-(60*PositionExpiredTime*1000));if(selectedRec.data.OriginDateTime<posExpireDate){newIcon="Grey"+selectedRec.data.IconTypeName+".ico"}else{if(selectedRec.data.CustomSpeed!=0){newIcon="Green"+selectedRec.data.IconTypeName+selectedRec.data.MyHeading+".ico"}else{newIcon="Red"+selectedRec.data.IconTypeName+".ico"}}selectedRec.data.icon=newIcon;selectedBoxs.push(selectedRec.data)});SetWinTrackData2(selectedBoxs);var winurl="./OpenLayerMap.aspx?WinId="+wincounter;var htmlNewWin='<iframe scrolling="no" src="'+winurl+'" style="Height:100%; width:100%;  border:0;margin:0px"></iframe>';openWindow("Track Vehicles",htmlNewWin,600,480);wincounter++}catch(err){}}});var searchMap=Ext.create("Ext.Button",{text:"Search",id:"searchMapButton",tooltip:"Search",iconCls:"map",cls:"cmbfonts",textAlign:"left",handler:function(){try{searchwindow(mapframe)}catch(err){}}});var filters={ftype:"filters",local:true,filters:[{type:"string",dataIndex:"BoxId"},{type:"string",dataIndex:"Description"},{type:"string",dataIndex:"StreetAddress"},{type:"string",dataIndex:"VehicleStatus"},{type:"int",dataIndex:"CustomSpeed"},{type:"date",dataIndex:"convertedDate"},{type:"boolean",dataIndex:"BoxArmed"}]};Ext.define("Alarm",{extend:"Ext.data.Model",fields:["AlarmId",{name:"TimeCreated",type:"date",dateFormat:"c"},"AlarmLevel","vehicleDescription","AlarmDescription"],idProperty:"AlarmId"});var alarmsstore=Ext.create("Ext.data.Store",{model:"Alarm",pageSize:pagesize,autosync:false,autoLoad:false,storeId:"AlarmsStore",proxy:{type:"ajax",url:"./Map/frmAlarmRotatingServerCall_XML.aspx",timeout:proxyTimeOut,reader:{type:"xml",root:"Alarm",record:"AllUserAlarmsInfo"}},listeners:{load:function(store,records,options){currentState=LoadStates.AlarmsLoaded},scope:this},sorters:[{property:"TimeCreated",direction:"DESC"}]});var mainstore=Ext.create("Ext.data.Store",{model:"VehicleList",pageSize:pagesize,autoLoad:false,autosync:false,storeId:"Vehicles",listeners:{load:function(store,records,options){try{if(store.getCount()>0){currentState=LoadStates.GridLoading;var mapJsonData=new Array();Ext.each(records,function(exirecord){var newIcon="";var today=new Date();var posExpireDate=new Date();posExpireDate.setTime(today.getTime()-(60*PositionExpiredTime*1000));if(exirecord.data.OriginDateTime<posExpireDate){newIcon="Grey"+exirecord.data.IconTypeName+".ico"}else{if(exirecord.data.CustomSpeed!=0){newIcon="Green"+exirecord.data.IconTypeName+exirecord.data.MyHeading+".ico"}else{newIcon="Red"+exirecord.data.IconTypeName+".ico"}}exirecord.data.icon=newIcon;mapJsonData.push(exirecord.data)});mainstore.sort("convertedDate","DESC");currentState=LoadStates.MappingVehicles;if(mapJsonData.length>0){mapVehicles(true,mapJsonData,true,false)}if(!taskRunning){taskRunning=true;alarmsstore.load();vehiclerunner.start(vehicletask);alarmrunner.start(alarmtask)}}else{removeMarkersOnMap()}lastProxyFinished=true}catch(err){}currentState=LoadStates.MainStoreLoaded},scope:this},proxy:{type:"ajax",url:"Vehicles.aspx",timeout:proxyTimeOut,reader:{type:"xml",root:"Fleet",record:"VehiclesLastKnownPositionInformation"}},sorters:[{property:"convertedDate",direction:"DESC"}]});var vehiclePager=new Ext.PagingToolbar({store:mainstore,displayInfo:true,displayMsg:"Displaying vehicles {0} - {1} of {2}",emptyMsg:"No vehicles to display"});var alarmsPager=new Ext.PagingToolbar({store:alarmsstore,displayInfo:true,displayMsg:"Displaying alarms {0} - {1} of {2}",emptyMsg:"No alarms to display"});var recordUpdater=Ext.create("Ext.data.Store",{model:"VehicleList",autoLoad:false,listeners:{load:function(store,records,options){try{if(store.getCount()>0){currentState=LoadStates.GettingUpdates;var modified=store.getRange();var newRecToMap=new Array();Ext.each(modified,function(modrecord,i){var newIcon="";var today=new Date();var posExpireDate=new Date();posExpireDate.setTime(today.getTime()-(60*PositionExpiredTime*1000));if(modrecord.data.OriginDateTime<posExpireDate){newIcon="Grey"+modrecord.data.IconTypeName+".ico"}else{if(modrecord.data.CustomSpeed!=0){newIcon="Green"+modrecord.data.IconTypeName+modrecord.data.MyHeading+".ico"}else{newIcon="Red"+modrecord.data.IconTypeName+".ico"}}modrecord.data.icon=newIcon;var tests=mainstore.findExact("BoxId",modrecord.data.BoxId,0);if(tests!=-1){mainstore.getAt(tests).data=modrecord.data;newRecToMap.push(modrecord.data)}});currentState=LoadStates.MainStoreLoading;mainstore.sort("convertedDate","DESC");currentState=LoadStates.MappingVehicles;mapVehicles(true,newRecToMap,false,"")}}catch(err){}currentState=LoadStates.MainStoreLoaded}},proxy:{type:"ajax",url:"Vehicles.aspx",timeout:proxyTimeOut,reader:{type:"xml",root:"Fleet",record:"VehiclesLastKnownPositionInformation"}}});var vehicletask={run:function(){try{if(!mainstore.isLoading()&&!recordUpdater.isLoading()){if(IsSyncOn){currentState=LoadStates.GettingUpdates;recordUpdater.removeAll(true);recordUpdater.load({params:{QueryType:"GetVehiclePosition",start:0,limit:pagesize}})}}}catch(err){}},interval:parseInt(vehinterval)};var vehiclerunner=new Ext.util.TaskRunner();var alarmupdater=Ext.create("Ext.data.Store",{model:"Alarm",autoLoad:false,proxy:{type:"ajax",url:"./Map/frmAlarmRotatingServerCall_XML.aspx",timeout:proxyTimeOut,reader:{type:"xml",root:"Alarm",record:"AllUserAlarmsInfo"}},autoLoad:false,listeners:{load:function(store,records,options){try{if(store.getCount()>0){currentState=LoadStates.GettingAlarmUpdates;var modified=store.getRange();var newRecords=new Array();Ext.each(modified,function(modrecord,i){var tests=alarmsstore.findExact("AlarmId",modrecord.data.AlarmId,0);if(tests==-1){newRecords.push(modrecord)}});if(newRecords.length>0){alarmsstore.insert(alarmsstore.getCount()+1,newRecords);alarmsstore.sort("TimeCreated","DESC")}}}catch(err){}currentState=LoadStates.AlarmsLoaded}}});var alarmtask={run:function(){try{if(!alarmsstore.isLoading()&&!alarmupdater.isLoading()){currentState=LoadStates.GettingAlarmUpdates;alarmupdater.removeAll(true);alarmupdater.load()}}catch(err){}},interval:parseInt(alarminterval)};var alarmrunner=new Ext.util.TaskRunner();var fleetstore=Ext.create("Ext.data.Store",{model:"FleetList",autoLoad:false,storeId:"FleetStore",listeners:{load:function(store,records,options){try{if(DefaultFleetID!=-1){fleets.setValue(DefaultFleetID)}var selFleet=fleets.getValue();currentState=LoadStates.MainStoreLoading;mainstore.load({params:{QueryType:"GetfleetPosition",fleetID:selFleet,start:0,limit:pagesize}});currentState=LoadStates.MainStoreLoaded}catch(err){}},scope:this},proxy:{type:"ajax",url:"Vehicles.aspx?QueryType=GetAllFleets",timeout:proxyTimeOut,reader:{type:"xml",root:"Fleet",record:"FleetsInformation"}}});var fleets=Ext.create("Ext.form.ComboBox",{store:"FleetStore",displayField:"FleetName",valueField:"FleetId",typeAhead:true,fieldStyle:"cmbfonts",labelCls:"cmbLabel",queryMode:"local",triggerAction:"all",fieldLabel:" Fleets ",emptyText:fleetDefaultText,tooltip:"Select group of vehicles to show",selectOnFocus:true,width:300,labelWidth:40,listeners:{scope:this,select:function(combo,value){currentState=LoadStates.MainStoreLoading;try{var selFleet=combo.getValue();if(selFleet!=""&&selFleet.length>0){mainstore.load({params:{QueryType:"GetVehiclePosition",fleetID:selFleet,start:0,limit:pagesize}})}}catch(err){}currentState=LoadStates.MainStoreLoaded}}});var southmappanel=Ext.create("Ext.Panel",{region:"south",id:"smappanel",split:true,titleCollapse:true,collapsible:true,animCollapse:true,autoScroll:true,border:false,height:window.screen.height/2,autoHeight:true,minHeight:150,minSize:150,html:mapHTML+' id="smapframe" name="smapframe" '+mapStyle+"></iframe>",listeners:{afterrender:function(){fleetstore.load()}}});var northmappanel=Ext.create("Ext.Panel",{region:"north",id:"nmappanel",split:true,titleCollapse:true,autoScroll:true,border:false,height:window.screen.height/2,autoHeight:true,collapsible:true,animCollapse:true,minHeight:150,minSize:150,html:mapHTML+' id="nmapframe" name="nmapframe" '+mapStyle+"></iframe>",listeners:{afterrender:function(){fleetstore.load()}}});var eastmappanel=Ext.create("Ext.Panel",{region:"east",id:"emappanel",titleCollapse:true,split:true,border:false,width:window.screen.width/2,collapsible:true,animCollapse:true,minSize:150,autoWidth:true,minWidth:150,html:mapHTML+' id="emapframe" name="emapframe" '+mapStyle+"></iframe>",listeners:{afterrender:function(){fleetstore.load()}}});var vehiclegrid=Ext.create("Ext.grid.Panel",{id:"vehiclesgrid",enableColumnHide:true,title:"Vehicles",autoLoad:false,autoScroll:true,maxWidth:window.screen.width,maxHeight:window.screen.height,enableSorting:true,stateful:true,stateId:"stateVehicleGrid",closable:false,columnLines:true,width:window.screen.width,autoHeight:true,store:mainstore,collapsible:true,animCollapse:true,split:true,features:[filters],viewConfig:{emptyText:"No vehicles to display",useMsg:false},columns:[{text:"UnitID",align:"left",width:70,dataIndex:"BoxId",filterable:true,sortable:true,hidden:false},{text:"Description",align:"left",width:150,renderer:function(value,p,record){return Ext.String.format('<a href="#" OnClick="SensorInfoWindow(\'{0}\')">{1}</a>',Ext.String.escape(record.data.LicensePlate),value)},dataIndex:"Description",filterable:true,sortable:true},{text:"Status",align:"left",width:120,renderer:function(value){var fontColor="black";if(value.indexOf("Parked")!=-1){fontColor="red"}else{if(value.indexOf("Idling")!=-1){fontColor="orange"}else{if(value.indexOf("Moving")!=-1){fontColor="green"}}}return Ext.String.format(template,fontColor,value)},dataIndex:"VehicleStatus",filterable:true,sortable:true},{text:"Speed",align:"left",width:50,dataIndex:"CustomSpeed",filterable:true,sortable:true},{text:"Date/Time",align:"left",width:120,xtype:"datecolumn",format:dateformat,dataIndex:"convertedDate",filterable:true,sortable:true},{text:"Address",align:"left",width:300,dataIndex:"StreetAddress",filterable:true,sortable:true},{text:"Armed",align:"left",width:40,dataIndex:"BoxArmed",filterable:true,sortable:true},{text:"History",align:"left",width:90,renderer:function(value){return Ext.String.format('<a href="#" OnClick="NewWindow(\'{0}\',{1})">History</a>',historyPage,Ext.String.format(value))},dataIndex:"VehicleId",filterable:false,sortable:true}],dockedItems:[{xtype:"toolbar",dock:"top",items:[fleets,{xtype:"cycle",text:"Reading Pane",prependText:"Map: ",showText:true,scope:this,changeHandler:readingPaneChange,menu:{id:"reading-menu",items:[{text:"Top",checked:true,iconCls:"preview-top"},{text:"Bottom",iconCls:"preview-bottom"},{text:"Right",iconCls:"preview-right"},{text:"Hide",iconCls:"preview-hide"}]}},"-",mapit,trackit,streetView,streetView2,updatePosition,searchMap,{itemId:"AutoSync",boxLabel:"AutoSync",boxLabelCls:"cmbfonts",xtype:"checkboxfield",checked:IsSyncOn,tooltip:"Refresh the map and grid automatically",handler:function(){IsSyncOn=!IsSyncOn}},feedback]}],selModel:selModel,bbar:vehiclePager});var alarmgrid=Ext.create("Ext.grid.Panel",{id:"alarmgrid",animCollapse:false,autoLoad:false,autoScroll:true,maxWidth:window.screen.width,maxHeight:window.screen.height,stateful:true,stateId:"stateAlarmsGrid",closable:false,enableColumnHide:false,enableSorting:false,closable:false,width:window.screen.width,autoHeight:true,title:"Alarms",store:alarmsstore,columnLines:true,viewConfig:{emptyText:"No alarms to display",useMsg:false,getRowClass:function(rec,rowIdx,params,store){if(rec.get("AlarmDescription").indexOf("CIA")!=-1){return"grid-row-red"}if(rec.get("AlarmDescription").indexOf("VIA")!=-1){return"grid-row-yellow"}}},columns:[{text:"Number",align:"left",width:80,renderer:function(value){return Ext.String.format('<a href="#" OnClick="NewAlarmWindow({0})">{1}</a>',value,value)},dataIndex:"AlarmId",sortable:false},{text:"Alarm Time",align:"left",width:120,xtype:"datecolumn",format:dateformat,dataIndex:"TimeCreated",sortable:false},{text:"Alarm Priority",align:"left",width:80,dataIndex:"AlarmLevel",sortable:false},{text:"Alarm Description",align:"left",width:120,renderer:function(value){if(value.indexOf("CIA")!=-1&&soundPresent!=true){soundPresent=true;return Ext.String.format('{0} <object><embed src="../../sounds/FireAlarm.wav" hidden="true" autostart="True" loop="true" type="audio/wav" pluginspage="http://www.apple.com/quicktime/download/" /></object>',value)}else{return value}},dataIndex:"AlarmDescription",sortable:false},{text:"Vehicle Description",align:"left",width:120,dataIndex:"vehicleDescription",sortable:false}],bbar:alarmsPager});var tabs=Ext.create("Ext.tab.Panel",{region:"center",deferredRender:false,activeTab:0,items:[vehiclegrid,alarmgrid]});var viewport=Ext.create("Ext.Viewport",{layout:"border",border:false,items:[northmappanel,tabs]});function readingPaneChange(cycle,activeItem){switch(activeItem.text){case"Top":eastmappanel.hide();southmappanel.hide();northmappanel.show();mapframe="nmapframe";if(!nframeadded){nframeadded=true;viewport.add(northmappanel)}break;case"Bottom":eastmappanel.hide();northmappanel.hide();southmappanel.show();mapframe="smapframe";if(!sframeadded){viewport.add(southmappanel);sframeadded=true}break;case"Right":southmappanel.hide();northmappanel.hide();eastmappanel.show();mapframe="emapframe";if(!eframeadded){viewport.add(eastmappanel);eframeadded=true}break;default:southmappanel.hide();eastmappanel.hide();northmappanel.hide();break}}});
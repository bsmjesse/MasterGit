var format="image/png";var geoserver="http://geomap.sentinelfm.com:9090/geoserver/wms";var layerURL="http://services.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer";var map,layer,newl,markers,currentMarkerIndex=0,arcgisLayer;var currentMarkers=new Array(),finishedLastTimer=false,timer_is_on=0;var size,offset,icon,allVehicles,myWinID;var infocontrols,highlightlayer;var interval="<%=sn.User.GeneralRefreshFrequency %>";OpenLayers.ProxyHost="/proxy/?url=";interval=interval/2;OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;var qsParm=new Array();function qs(){var d=window.location.search.substring(1);if(d.indexOf("Id")!=-1){if(d.indexOf("&")!=-1){var c=d.split("&");for(var b=0;b<c.length;b++){var f=c[b].indexOf("=");if(f>0){var a=c[b].substring(0,f);var e=c[b].substring(f+1);qsParm[a]=e}}}else{var f=d.indexOf("=");if(f>0){var a=d.substring(0,f);var e=d.substring(f+1);qsParm[a]=e}}}}function init(){var a=layerURL+"?f=json&pretty=true&callback=?";$.getJSON(a,function(b){initMap(b)})}function initMap(o){try{var F=new OpenLayers.Bounds(layerInfo.fullExtent.xmin,layerInfo.fullExtent.ymin,layerInfo.fullExtent.xmax,layerInfo.fullExtent.ymax);var s=[];for(var D=0;D<layerInfo.tileInfo.lods.length;D++){s.push(layerInfo.tileInfo.lods[D].resolution)}arcgisLayer=new OpenLayers.Layer.ArcGISCache("Arcgis","http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",{isBaseLayer:true,resolutions:s,tileSize:new OpenLayers.Size(layerInfo.tileInfo.cols,layerInfo.tileInfo.rows),tileOrigin:new OpenLayers.LonLat(layerInfo.tileInfo.origin.x,layerInfo.tileInfo.origin.y),maxExtent:F,projection:"EPSG:"+layerInfo.spatialReference.wkid});var x=new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),b=x.clone(),z=126543.0339;var e={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",numZoomLevels:20,maxResolution:z,maxExtent:x,restrictedExtent:b,controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanZoomBar(),new OpenLayers.Control.LayerSwitcher({ascending:true}),new OpenLayers.Control.ScaleLine(),new OpenLayers.Control.MousePosition(),new OpenLayers.Control.KeyboardDefaults()]};var f=new OpenLayers.Layer.OSM("Base Map");var E=new OpenLayers.Layer.CloudMade("Base Map2",{key:"8ee2a50541944fb9bcedded5165f09d9"});var k=new OpenLayers.Layer.Google("Google Streets",{sphericalMercator:true});var I=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,sphericalMercator:true,numZoomLevels:20});var d=new OpenLayers.Layer.VirtualEarth("Bing Roads",{type:VEMapStyle.Road,sphericalMercator:true});var u=new OpenLayers.Layer.VirtualEarth("Bing Hybrid",{type:VEMapStyle.Hybrid,sphericalMercator:true});var A=new OpenLayers.Layer.WMS("Nexrad Weather Radar","http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?",{layers:"nexrad-n0r",transparent:"TRUE",format:"image/png"},{isBaseLayer:false,buffer:0,singleTile:false,opacity:0.5,visibility:false});var r=new OpenLayers.Layer.WMS("Water",geoserver,{layers:"oiltrax:oiltrax_poi_water",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var p=new OpenLayers.Layer.WMS("Wellsite",geoserver,{layers:"oiltrax:oiltrax_poi_wellsite",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var v=new OpenLayers.Layer.WMS("Batteries",geoserver,{layers:"oiltrax:oiltrax_poi_batteries",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var n=new OpenLayers.Layer.WMS("Other Facilities",geoserver,{layers:"oiltrax:oiltrax_poi_otherfacilities",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var H=new OpenLayers.Layer.WMS("Sasktel LSD",geoserver,{layers:"oiltrax:sask_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var c=new OpenLayers.Layer.WMS("Man-BC LSD",geoserver,{layers:"oiltrax:manbc_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var q=new OpenLayers.Layer.WMS("Alberta LSD",geoserver,{layers:"oiltrax:alberta_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var y=new OpenLayers.Layer.WMS("Trails",geoserver,{layers:"oiltrax:trail",transparent:true,format:format},{visibility:false,opacity:0.5,singleTile:true,ratio:1});var w=new OpenLayers.Layer.WMS("Additional Roads",geoserver,{layers:"oiltrax:goat",transparent:true,format:format},{visibility:false,opacity:1,singleTile:true,ratio:1});var h=new OpenLayers.Layer.WMS("Additional Roads 2",geoserver,{layers:"oiltrax:goat2",transparent:true,format:format},{visibility:false,opacity:1,singleTile:true,ratio:1});map=new OpenLayers.Map("map",e);highlightLayer=new OpenLayers.Layer.Vector("Highlighted Features",{displayInLayerSwitcher:false,isBaseLayer:false});infoControls={click:new OpenLayers.Control.WMSGetFeatureInfo({url:geoserver,title:"Identify features by clicking",layers:[r],queryVisible:true}),hover:new OpenLayers.Control.WMSGetFeatureInfo({url:geoserver,title:"Identify features by clicking",layers:[r],hover:true,queryVisible:true})};map.addLayers([f,E,arcgisLayer,k,I,d,u]);if(!map.getCenter()){map.zoomToMaxExtent();map.setCenter(transformCoords(-72.872559,46.767074),8)}if(orgid==727){var g=new OpenLayers.Layer.WMS("TQ (blue)",geoserver,{layers:"fcmq:TQ_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var C=new OpenLayers.Layer.WMS("Local (orange)",geoserver,{layers:"fcmq:Local_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var m=new OpenLayers.Layer.WMS("N (pink)",geoserver,{layers:"fcmq:N_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var a=new OpenLayers.Layer.WMS("Reg (green)",geoserver,{layers:"fcmq:REG_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var G=new OpenLayers.Layer.WMS("Trails No",geoserver,{layers:"fcmq:NSentiers_REG",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var B=new OpenLayers.Layer.WMS("Trails No",geoserver,{layers:"fcmq:NSentiers_TQ",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});map.addLayers([g,C,m,a,B,G])}else{map.addLayers([r,p,v,n,H,q,c,y,w,h,A,highlightLayer])}for(var D in infoControls){infoControls[D].events.register("getfeatureinfo",this,showInfo);map.addControl(infoControls[D])}markers=new OpenLayers.Layer.Markers("Vehicles",{displayInLayerSwitcher:false,isBaseLayer:false});size=new OpenLayers.Size(8,16);offset=new OpenLayers.Pixel(-(size.w/2),-size.h);qs();myWinID=qsParm.WinId;var t=window.opener;if(t==null){t=window.parent}var l=false;if(t!=null){if(myWinID&&myWinID!=""){allVehicles=t.GetWinInitialTrackData(myWinID)}else{if(!allVehicles||allVehicles==""){allVehicles=t.GetTelogisMapData();l=true}}if(allVehicles&&(l==true||myWinID!="")){if(allVehicles!=""){ShowMultipleAssets(allVehicles)}}}}catch(j){}}function showInfo(a){if(a.features&&a.features.length){highlightLayer.destroyFeatures();highlightLayer.addFeatures(a.features);highlightLayer.redraw()}else{$("responseText").innerHTML=a.text}}function zoomMap(fleet){try{if(fleet!=null){fleet=eval(fleet);if(fleet!=null&&fleet!=""){var bounds=new OpenLayers.Bounds();for(i=0;i<fleet.length;i++){try{bounds.extend(transformCoords(fleet[i].Longitude,fleet[i].Latitude))}catch(err1){}}map.zoomToExtent(bounds,true);var currentZoom=map.getZoom();map.zoomTo(currentZoom-2)}}}catch(err){}}function showVehiclePopups(){popup=new OpenLayers.Popup.FramedCloud("featurePopup",this.location,new OpenLayers.Size(100,100),this.featureHTML,this.icon,true,null);map.addPopup(popup,true)}function closeVehiclePopups(){var a=map.popups;for(i=0;i<a.length;i++){map.removePopup(a[i])}}function removeMarkersOnMap(){currentMarkers=new Array();if(markers){markers.clearMarkers();if(map.getLayerIndex(markers)!=-1){map.removeLayer(markers)}}}function ShowMultipleAssets(k){try{if(k!=null&&k!=""){var d=0;allVehicles=k;var a=new OpenLayers.Bounds();currentMarkers=new Array();currentMarkerIndex=0;if(markers&&map){markers.clearMarkers();if(map.getLayerIndex(markers)!=-1){map.removeLayer(markers)}}for(d=0;d<k.length;d++){var b=k[d];var f=new OpenLayers.Icon("../New20x20/"+b.icon);var g=transformCoords(b.Longitude,b.Latitude);if(k.length==1){map.setCenter(g,4)}else{try{if((b.convertedDisplayDate>="01/01/2000 00:00 am")&&b.Longitude!=0&&b.Latitude!=0){a.extend(g)}else{}}catch(j){}}var e=new OpenLayers.Marker(g,f);var h=new Object();h.icon=f;h.location=g;h.featureHTML="<h2>"+b.Description+"</h2>"+b.StreetAddress+"<br />Time: "+b.convertedDisplayDate+"<br />Heading: "+b.MyHeading+"<br />Speed: "+b.CustomSpeed+"<br />Status: "+b.VehicleStatus;e.events.register("mousedown",h,showVehiclePopups);currentMarkers[currentMarkerIndex]=e;currentMarkerIndex++;markers.addMarker(e)}map.addLayer(markers);if(k.length>1){map.zoomToExtent(a,true);map.setCenter(a.getCenterLonLat());var l=map.getZoom();map.zoomTo(l-1)}}}catch(c){}}function removeMapWindow(){var a=window.opener;if(a==null){a=window.parent}if(a!=null){if(myWinID&&myWinID!=""){a.removeMapWindow(myWinID)}}}function transformCoords(b,a){return new OpenLayers.LonLat(b,a).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject())}function getPixelValues(c,b){var a=new OpenLayers.LonLat(c,b).transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));return new OpenLayers.Pixel(a.lon,a.lat)}function UpdateMultipleAssets(b){try{if(b!=null&&b!=""&&allVehicles.length>0){var e=0,d=0;for(e=0;e<b.length;e++){for(d=0;d<allVehicles.length;d++){if(allVehicles[d].BoxId==b[e].BoxId){try{currentVehicle=b[e];var c=transformCoords(currentVehicle.Longitude,currentVehicle.Latitude);var h=new OpenLayers.Icon("../New20x20/"+currentVehicle.icon);markers.removeMarker(currentMarkers[d]);var a=new OpenLayers.Marker(c,h);var g=new Object();g.icon=h;g.location=c;g.featureHTML="<h2>"+currentVehicle.Description+"</h2>"+currentVehicle.StreetAddress;if(!currentVehicle.convertedDisplayDate){g.featureHTML=g.featureHTML+"<br />Time: "+currentVehicle.OriginDateTime}else{g.featureHTML=g.featureHTML+"<br />Time: "+currentVehicle.convertedDisplayDate}g.featureHTML=g.featureHTML+"<br />Heading: "+currentVehicle.MyHeading+"<br />Speed: "+currentVehicle.CustomSpeed+"<br />Status: "+currentVehicle.VehicleStatus;a.events.register("mousedown",g,showVehiclePopups);markers.addMarker(a);currentMarkers[d]=a;allVehicles[d]=currentVehicle}catch(f){}break}}}closeVehiclePopups()}}catch(f){}};
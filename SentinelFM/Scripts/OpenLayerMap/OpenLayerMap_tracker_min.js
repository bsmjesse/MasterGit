var format="image/png";var geoserver="http://geomap.sentinelfm.com:9090/geoserver/wms";var map,layer,newl,markers,currentMarkerIndex=0;var currentMarkers=new Array();var finishedLastTimer=false;var timer_is_on=0;var size,offset,icon,allVehicles,myWinID;var infocontrols,highlightlayer;OpenLayers.ProxyHost="/proxy/?url=";interval=interval/2;OpenLayers.IMAGE_RELOAD_ATTEMPTS=3;var qsParm=new Array();function qs(){var d=window.location.search.substring(1);if(d.indexOf("Id")!=-1){if(d.indexOf("&")!=-1){var c=d.split("&");for(var b=0;b<c.length;b++){var f=c[b].indexOf("=");if(f>0){var a=c[b].substring(0,f);var e=c[b].substring(f+1);qsParm[a]=e}}}else{var f=d.indexOf("=");if(f>0){var a=d.substring(0,f);var e=d.substring(f+1);qsParm[a]=e}}}}function init(){try{var q=new OpenLayers.Bounds(-20037508,-20037508,20037508,20037508),b=q.clone(),r=126543.0339;var d={projection:new OpenLayers.Projection("EPSG:900913"),displayProjection:new OpenLayers.Projection("EPSG:4326"),units:"m",numZoomLevels:20,maxResolution:r,maxExtent:q,restrictedExtent:b};map=new OpenLayers.Map("map",d);map.addControl(new OpenLayers.Control.Navigation());map.addControl(new OpenLayers.Control.LayerSwitcher({ascending:true}));map.addControl(new OpenLayers.Control.ScaleLine());map.addControl(new OpenLayers.Control.MousePosition());map.addControl(new OpenLayers.Control.KeyboardDefaults());var e=new OpenLayers.Layer.OSM("Base Map");var z=new OpenLayers.Layer.Google("Google Hybrid",{type:google.maps.MapTypeId.HYBRID,sphericalMercator:true,numZoomLevels:20});var e=new OpenLayers.Layer.OSM("Base Map");var s=new OpenLayers.Layer.WMS("Nexrad Weather Radar","http://mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?",{layers:"nexrad-n0r",transparent:"TRUE",format:"image/png"},{isBaseLayer:false,buffer:0,singleTile:false,opacity:0.5,visibility:false});var m=new OpenLayers.Layer.WMS("Water",geoserver,{layers:"oiltrax:oiltrax_poi_water",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var l=new OpenLayers.Layer.WMS("Wellsite",geoserver,{layers:"oiltrax:oiltrax_poi_wellsite",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var p=new OpenLayers.Layer.WMS("Batteries",geoserver,{layers:"oiltrax:oiltrax_poi_batteries",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var k=new OpenLayers.Layer.WMS("Other Facilities",geoserver,{layers:"oiltrax:oiltrax_poi_otherfacilities",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var y=new OpenLayers.Layer.WMS("Sasktel LSD",geoserver,{layers:"oiltrax:sask_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var c=new OpenLayers.Layer.WMS("Man-BC LSD",geoserver,{layers:"oiltrax:manbc_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var n=new OpenLayers.Layer.WMS("Alberta LSD",geoserver,{layers:"oiltrax:alberta_lsd",transparent:true,format:format},{visibility:true,opacity:0.5,singleTile:true,ratio:1});var w=new OpenLayers.Layer.WMS("Polygon",geoserver,{layers:"oiltrax:oiltrax_polygon",transparent:true,format:format},{visibility:false,opacity:0.5,singleTile:true,ratio:1});highlightLayer=new OpenLayers.Layer.Vector("Highlighted Features",{displayInLayerSwitcher:false,isBaseLayer:false});infoControls={click:new OpenLayers.Control.WMSGetFeatureInfo({url:geoserver,title:"Identify features by clicking",layers:[m],queryVisible:true}),hover:new OpenLayers.Control.WMSGetFeatureInfo({url:geoserver,title:"Identify features by clicking",layers:[m],hover:true,queryVisible:true})};map.addLayers([e,z]);if(orgid==727){var f=new OpenLayers.Layer.WMS("TQ (blue)",geoserver,{layers:"fcmq:TQ_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var u=new OpenLayers.Layer.WMS("Local (orange)",geoserver,{layers:"fcmq:Local_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var j=new OpenLayers.Layer.WMS("N (pink)",geoserver,{layers:"fcmq:N_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var a=new OpenLayers.Layer.WMS("Reg (green)",geoserver,{layers:"fcmq:REG_4326",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var x=new OpenLayers.Layer.WMS("Trails No",geoserver,{layers:"fcmq:NSentiers_REG",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});var t=new OpenLayers.Layer.WMS("Trails No",geoserver,{layers:"fcmq:NSentiers_TQ",transparent:true,format:format},{visibility:true,opacity:1,singleTile:true,ratio:1});map.addLayers([f,u,j,a,t,x])}else{map.addLayers([m,l,p,k,y,n,c,s,highlightLayer])}for(var v in infoControls){infoControls[v].events.register("getfeatureinfo",this,showInfo);map.addControl(infoControls[v])}markers=new OpenLayers.Layer.Markers("Vehicles",{displayInLayerSwitcher:false,isBaseLayer:false});size=new OpenLayers.Size(8,16);offset=new OpenLayers.Pixel(-(size.w/2),-size.h);if(!map.getCenter()){map.setCenter(transformCoords(-72.872559,46.767074),4)}qs();myWinID=qsParm.WinId;var o=window.opener;if(o==null){o=window.parent}var h=false;if(o!=null){if(myWinID&&myWinID!=""){allVehicles=o.GetWinInitialTrackData(myWinID)}else{if(!allVehicles||allVehicles==""){allVehicles=o.GetTelogisMapData();h=true}}if(allVehicles&&(h==true||myWinID!="")){if(allVehicles!=""){ShowMultipleAssets(allVehicles);if(!timer_is_on){timer_is_on=1;finishedLastTimer=true;CheckAndUpdateMap()}}}}}catch(g){}}function showInfo(a){if(a.features&&a.features.length){highlightLayer.destroyFeatures();highlightLayer.addFeatures(a.features);highlightLayer.redraw()}else{$("responseText").innerHTML=a.text}}function zoomMap(fleet){try{if(fleet!=null){fleet=eval(fleet);if(fleet!=null&&fleet!=""){var bounds=new OpenLayers.Bounds();for(i=0;i<fleet.length;i++){try{bounds.extend(transformCoords(fleet[i].Longitude,fleet[i].Latitude))}catch(err1){}}map.zoomToExtent(bounds,true);var currentZoom=map.getZoom();map.zoomTo(currentZoom-2)}}}catch(err){}}function showVehiclePopups(){popup=new OpenLayers.Popup.FramedCloud("featurePopup",this.location,new OpenLayers.Size(100,100),this.featureHTML,this.icon,true,null);map.addPopup(popup,true)}function closeVehiclePopups(){var a=map.popups;for(i=0;i<a.length;i++){map.removePopup(a[i])}}function ShowMultipleAssets(b){if(b!=null&&b!=""){var d=0;allVehicles=b;var e=new OpenLayers.Bounds();for(d=0;d<b.length;d++){var g=b[d];var h=new OpenLayers.Icon("./New20x20/"+g.icon);var c=transformCoords(g.Longitude,g.Latitude);if(b.length==1){map.setCenter(c,14)}else{e.extend(c)}var a=new OpenLayers.Marker(c,h);var f=new Object();f.icon=h;f.location=c;f.featureHTML="<h2>"+g.Description+"</h2>"+g.StreetAddress+"<br />Time: "+g.convertedDisplayDate+"<br />Heading: "+g.MyHeading+"<br />Speed: "+g.CustomSpeed+"<br />Status: "+g.VehicleStatus;a.events.register("mousedown",f,showVehiclePopups);currentMarkers[currentMarkerIndex]=a;currentMarkerIndex++;markers.addMarker(a)}map.addLayer(markers);if(b.length>1){map.zoomToExtent(e,true);map.setCenter(e.getCenterLonLat())}}}function removeMapWindow(){var a=window.opener;if(a==null){a=window.parent}if(a!=null){if(myWinID&&myWinID!=""){a.removeMapWindow(myWinID)}}}function transformCoords(b,a){return new OpenLayers.LonLat(b,a).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject())}function getPixelValues(c,b){var a=new OpenLayers.LonLat(c,b).transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));return new OpenLayers.Pixel(a.lon,a.lat)}function ResetTimer(){finishedLastTimer=false;CheckAndUpdateMap()}var timers;function CheckAndUpdateMap(){if(allVehicles.length>0){try{if(!finishedLastTimer){var d=window.opener;if(d==null){d=window.parent}if(d!=null){var a=0;for(a=0;a<allVehicles.length;a++){var c=d.GetWinTrackData(allVehicles[a].BoxId);if(c!=null&&c!=""){allVehicles[a]=c}}UpdateMultipleAssets(allVehicles);finishedLastTimer=true}}if(finishedLastTimer){finishedLastTimer=false;timers=setTimeout("CheckAndUpdateMap()",interval)}else{setTimeout("ResetTimer()",interval*2)}}catch(b){clearTimeout(timers);timer_is_on=0}}}function UpdateMultipleAssets(k){try{if(k!=null&&k!=""&&allVehicles.length>0){var d=0,c=0;var a=new OpenLayers.Bounds();for(d=0;d<k.length;d++){for(c=0;c<allVehicles.length;c++){if(allVehicles[c].BoxId==k[d].BoxId){try{currentVehicle=k[d];var g=transformCoords(currentVehicle.Longitude,currentVehicle.Latitude);var f=new OpenLayers.Icon("./New20x20/"+currentVehicle.icon);if(k.length==1){map.setCenter(g,14)}else{a.extend(g)}markers.removeMarker(currentMarkers[c]);var e=new OpenLayers.Marker(g,f);var h=new Object();h.icon=f;h.location=g;h.featureHTML="<h2>"+currentVehicle.Description+"</h2>"+currentVehicle.StreetAddress+"<br />Time: "+currentVehicle.convertedDisplayDate+"<br />Heading: "+currentVehicle.MyHeading+"<br />Speed: "+currentVehicle.CustomSpeed+"<br />Status: "+currentVehicle.VehicleStatus;e.events.register("mousedown",h,showVehiclePopups);markers.addMarker(e);currentMarkers[c]=e;allVehicles[c]=currentVehicle}catch(b){}break}}}closeVehiclePopups();if(k.length>1){map.zoomToExtent(a,true);map.setCenter(a.getCenterLonLat())}}}catch(b){}};